{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020/05/01/kubernetes-native-ci-with-argo/","result":{"data":{"site":{"siteMetadata":{"title":"5π Consulting","author":"Johannes 'fish' Ziemke"}},"markdownRemark":{"id":"97dbe3ae-5ca9-5c2a-b226-b0b6934ed629","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 458px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a099ca3512e83579d67b0aa9ede5261a/f7a31/argo.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.079754601226995%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABwklEQVR42p2Sz24SURTGeR+egSeYuHfjlihCAgtpSZAN1aSSdKEL3bCqUkKCcYPdEFmxI1FMIymNGWZMGxwWxRn+DMzc+Tn3AnVqFyaeZO45c+8937nfd06MiAkRIIKAIPT/azG5hBj8cn1GC8HQ8bl0Be5aqAuBOt8UkH73Rf+J3FGAzkrw3V7z4/SEn6/2OT87C8HB9zegi8UCy7JUPJvNsG2byWSi9qWNx2Nc190Aep6P4QguhhdYzx9h5zT0d6/5NvW4nnusVy4HB8/IZDK0Wi3K5TKlUolsNkulUqHZbJJKpVQsXxlbe4LRdIU5HHL16SOz4yNGXz5zrl8yCyv2w3hvb59er0c8HqfRaCjQTqdDoVAgkUgwGAxIp9OYpikpB9ghM0MfMTl8jFm4j/W+ih6yEb6vaFSrVZWQz+fp9/t0u131Qk3TqNfr5HI5arXaVkMprNTG1DGePqCXvsf1yUuWSmlxq4P+tkC73SaZTFIsFm+0+9OUbSAmVyxePGT5RMM9PYZd+8NyQgiVsPPSDMPAcZwbMHl2CzBwpiw/vGH+9hDvazcCeNf+HpU7c7hLDtYugTuX3P45wNEZjAL+Bp8p1IRaOXgfAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"argo\"\n        title=\"\"\n        src=\"/static/a099ca3512e83579d67b0aa9ede5261a/f7a31/argo.png\"\n        srcset=\"/static/a099ca3512e83579d67b0aa9ede5261a/222b7/argo.png 163w,\n/static/a099ca3512e83579d67b0aa9ede5261a/ff46a/argo.png 325w,\n/static/a099ca3512e83579d67b0aa9ede5261a/f7a31/argo.png 458w\"\n        sizes=\"(max-width: 458px) 100vw, 458px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h1>\n<p>As I discussed in <a href=\"/2018/12/18/why-kubernetes-at-small-scale/\">Why Kubernetes at small\nscale</a>, Kubernetes is\nmore an infrastructure framework than just a container scheduler.</p>\n<p>Every resource in your infrastructure is a Kubernetes Object and new Resources\ncan be defined using <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources\">Custom Controllers and\nResources</a>.</p>\n<h2 id=\"argo\" style=\"position:relative;\"><a href=\"#argo\" aria-label=\"argo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Argo</h2>\n<p>One of the custom controllers I’m most excited about\n<a href=\"https://argoproj.github.io/\">Argo</a>. It extends the Kubernetes API by providing\na <a href=\"https://github.com/argoproj/argo/tree/master/examples#welcome\">Workflow\nObject</a> in which\neach task is a command running in a container. It supports defining dependencies,\ncontrol structures, loops and recursion and parallelize execution. To capture\nworkflow artifacts, it supports <a href=\"https://argoproj.github.io/docs/argo/configure-artifact-repository.html\">various\nbackends</a>.</p>\n<p>I’ve built the machine learning / training infrastructure for <a href=\"/case-studies/koko/\">one of my\nclients</a> around Argo with great success. So when we looked\ninto options for CI/CD, we doubled down on Argo and build that on top of it as\nwell.</p>\n<p>Argo already supports git input artifacts, as shown in this example:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">apiVersion: argoproj.io/v1alpha1\nkind: Workflow\nmetadata:\n  generateName: input-artifact-git-\nspec:\n  entrypoint: git-clone\n  templates:\n  - name: git-clone\n    inputs:\n      artifacts:\n      - name: argo-source\n        path: /src\n        git:\n          repo: https://github.com/argoproj/argo.git\n          revision: \"v2.1.1\"\n    container:\n      image: golang:1.10\n      command: [sh, -c]\n      args: [\"git status &amp;&amp; ls &amp;&amp; cat VERSION\"]\n      workingDir: /src</code></pre></div>\n<h2 id=\"k8s-webhook-handler\" style=\"position:relative;\"><a href=\"#k8s-webhook-handler\" aria-label=\"k8s webhook handler permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>k8s-webhook-handler</h2>\n<p>Creating a workflow to build a code repository is straight forward. But how to\ndo it automatically when you push new code to GitHub?</p>\n<p>There is <a href=\"https://github.com/argoproj/argo-events/\">argo-events</a> but it was in\nvery early development and seemed concerned with many things beyond what we\nneeded. There also exists <a href=\"https://github.com/argoproj/argo-ci\">argo-ci</a> but\nthat project got stale and since was removed from the official argo docs.</p>\n<p>So I’ve created the\n<a href=\"https://github.com/airbnb/k8s-webhook-handler\">k8s-webhook-handler</a><sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>. It’s a\nwebhook-handler that handles incoming webhooks from GitHub by checking out a\nKubernetes manifests (<code class=\"language-text\">.ci/workflow.yaml</code> by default) and applies it to\nKubernetes with the following annotations set:</p>\n<ul>\n<li><code class=\"language-text\">k8s-webhook-handler.io/ref</code>: Git reference (e.g. refs/heads/master)</li>\n<li><code class=\"language-text\">k8s-webhook-handler.io/revision</code>: The SHA of the most recent commit on ref after the push.</li>\n<li><code class=\"language-text\">k8s-webhook-handler.io/before</code>: The SHA of the most recent commit on ref before the push.</li>\n<li><code class=\"language-text\">k8s-webhook-handler.io/repo_name</code>: Repo name including user (e.g. airbnb/k8s-webhook-handler)</li>\n<li><code class=\"language-text\">k8s-webhook-handler.io/repo_url</code>: git URL (e.g. git://github.com/airbnb/k8s-webhook-handler.git)</li>\n<li><code class=\"language-text\">k8s-webhook-handler.io/repo_ssh</code>: ssh URL (e.g. <a href=\"mailto:git@github.com\">git@github.com</a>:airbnb/k8s-webhook-handler.git)</li>\n<li><code class=\"language-text\">k8s-webhook-handler.io/event_type</code>: Event type (e.g. <code class=\"language-text\">push</code> or <code class=\"language-text\">delete</code>)</li>\n<li><code class=\"language-text\">k8s-webhook-handler.io/event_action</code>: Event type specific action (e.g. <code class=\"language-text\">created</code> or <code class=\"language-text\">deleted</code>)</li>\n</ul>\n<p>This is kept very generic. You could use this to apply any kind of resource but\nwe’re using it to submit an Argo workflow.</p>\n<h1 id=\"ci-workflow\" style=\"position:relative;\"><a href=\"#ci-workflow\" aria-label=\"ci workflow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CI workflow</h1>\n<h2 id=\"building-binaries\" style=\"position:relative;\"><a href=\"#building-binaries\" aria-label=\"building binaries permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Building binaries</h2>\n<p>Now we can create an Argo Workflow that uses the annotations to checkout the code\nas the desired revision and build it. Let’s take the k8s-webhook-handler itself\nas an example.</p>\n<p>First we need to create <code class=\"language-text\">.ci/workflow.yaml</code> in the repository:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">apiVersion: argoproj.io/v1alpha1\nkind: Workflow\nmetadata:\n  generateName: ci-k8s-webhook-handler-\nspec:\n  entrypoint: build\n  templates:\n    - name: build\n      inputs:\n        artifacts:\n          - name: source\n            path: /src\n            git:\n              repo: \"{{workflow.annotations.k8s-webhook-handler.io/repo_ssh}}\"\n              revision: \"{{workflow.annotations.k8s-webhook-handler.io/revision}}\"\n      container:\n        image: golang:1.14\n        command: [\"go\", \"install\", \"./...\" ]\n        workingDir: /src\n      outputs:\n        artifacts:\n        - name: binaries\n          path: /go/bin</code></pre></div>\n<p>Now the repository needs to be configured to send webhook requests for push\nevents to the k8s-webhook-handler as described in the <a href=\"https://developer.github.com/webhooks/creating/\">GitHub\nDocs</a>.</p>\n<p>If we push code to the repository now, it will execute the workflow above to\ncheckout the code, build it and capture the build artifacts in Argo’s artifacts\nrepository.</p>\n<h2 id=\"building-docker-images-with-kaniko\" style=\"position:relative;\"><a href=\"#building-docker-images-with-kaniko\" aria-label=\"building docker images with kaniko permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Building Docker images with Kaniko</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/54a2fe072c7e19200e97cdb2b4d7bc45/2e367/kaniko.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.901840490797547%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA+ElEQVR42lWQz06EMBDG96pPs/Gmd30An8Wzr7O6x/XgiU38FyMXWSAISC0tFKSSLAlJCQFax2JM/aWZTr72a2dmoQykXj+JlOM4zsl8NE2T1Jj3F7/764XaninrWJLV1158oHfOORhGTd/3TdMQQoQQIHZdZ5jlIG+Wan1Ar052z7cI061lgScIgiRJ3jR5nnueF0VRlmWO47Rta5g3S3V9yFZHgb3BhD09PlRVFYahbdsQ0zR1XfdFgzGO47gsS6Ns91Ldn6u7U5Wv673g/BP+BBtEeKWua0ppURSMMYSQ7/tQv2Gex6Tk38CAYRigQ/UfUECfe/4GlAtGQVCMlswAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"kaniko\"\n        title=\"\"\n        src=\"/static/54a2fe072c7e19200e97cdb2b4d7bc45/a6d36/kaniko.png\"\n        srcset=\"/static/54a2fe072c7e19200e97cdb2b4d7bc45/222b7/kaniko.png 163w,\n/static/54a2fe072c7e19200e97cdb2b4d7bc45/ff46a/kaniko.png 325w,\n/static/54a2fe072c7e19200e97cdb2b4d7bc45/a6d36/kaniko.png 650w,\n/static/54a2fe072c7e19200e97cdb2b4d7bc45/e548f/kaniko.png 975w,\n/static/54a2fe072c7e19200e97cdb2b4d7bc45/2e367/kaniko.png 1066w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Now we have binaries but running everything on Kubernetes means we need\ndocker/container images. There is <a href=\"https://github.com/kubernetes/kubernetes/issues/1806\">no native build support in\nKubernetes</a> and the\nsuggested solution is using unprivileged build tools.</p>\n<p>We opted for <a href=\"https://github.com/GoogleContainerTools/kaniko\">Kaniko</a>. It\nsupports the Dockerfile format our developers are familiar with and doesn’t\nrequire any elevated permissions, making it possible to run in a regular\nKubernetes pod.</p>\n<aside>Caveat: Since Kaniko runs unprivileged, it can't use layered filesystems\nlike Docker does, it needs to copy the files after each step which is slower\nwhen many files are involved. A better solution for this would be\nadding build primitives like the ability of snapshotting image layers to the\nKubernetes API.</aside>\n<p>Now with Kaniko we can use the following workflow to build the\nk8s-webhook-handler Dockerfile:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">apiVersion: argoproj.io/v1alpha1\nkind: Workflow\nmetadata:\n  generateName: ci-k8s-webhook-handler-\nspec:\n  entrypoint: build\n  volumes:\n    - name: docker-config\n      configMap:\n        name: docker-config\n  templates:\n    - name: build\n      metadata:\n        annotations:\n          iam.amazonaws.com/role: ci-role\n      inputs:\n        artifacts:\n          - name: source\n            path: /src\n            git:\n              repo: \"{{workflow.annotations.k8s-webhook-handler.io/repo_ssh}}\"\n              revision: \"{{workflow.annotations.k8s-webhook-handler.io/revision}}\"\n      container:\n        image: gcr.io/kaniko-project/executor\n        args:\n          - \"--context=/src\"\n          - \"--destination=xxx.dkr.ecr.us-east-1.amazonaws.com/k8s-webhook-handler:{{workflow.annotations.k8s-webhook-handler.io/revision}}\"\n        volumeMounts:\n          - name: docker-config\n            mountPath: /kaniko/.docker/</code></pre></div>\n<p>Since we’re using ECR, the docker-config volume just contains <code class=\"language-text\">config.json</code> with\nthe content <code class=\"language-text\">{ \"credsStore\": \"ecr-login\" }</code> to make kaniko use the <code class=\"language-text\">ecr-login</code>\ncredential helper. See the <a href=\"https://github.com/GoogleContainerTools/kaniko#pushing-to-different-registries\">kaniko\ndocs</a>\nfor more details. To grant the pod IAM permissions to do that, we’re using\n<a href=\"https://github.com/jtblin/kube2iam\">kube2iam</a> and the <code class=\"language-text\">iam.amazonaws.com/role</code>\nannotation.</p>\n<h2 id=\"deployment\" style=\"position:relative;\"><a href=\"#deployment\" aria-label=\"deployment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deployment</h2>\n<p>Now we got a image, but how to deploy it? Argo supports workflows that consist\nof a list of steps or a\n<a href=\"https://en.wikipedia.org/wiki/Directed_acyclic_graph\">DAG</a>. While a list of\nsteps would be sufficient for a simple build-then-deploy workflow, we generally\nprefer DAGs for their flexibility, so let’s use it in this example as well.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">apiVersion: argoproj.io/v1alpha1\nkind: Workflow\nmetadata:\n  generateName: ci-k8s-webhook-handler-\nspec:\n  entrypoint: ci\n  serviceAccountName: ci-workflow\n  arguments:\n    parameters:\n      - name: image\n        value: \"xxx.dkr.ecr.us-east-1.amazonaws.com/k8s-webhook-handler:{{workflow.annotations.k8s-webhook-handler.io/revision}}\"\n  volumes:\n    - name: docker-config\n      configMap:\n        name: docker-config\n  templates:\n    - name: ci\n      dag:\n        tasks:\n          - name: build\n            template: build\n          - name: deploy\n            template: deploy\n            dependencies: [build]\n    - name: build\n      metadata:\n        annotations:\n          iam.amazonaws.com/role: ci-role\n      inputs:\n        artifacts:\n          - name: source\n            path: /src\n            git:\n              repo: \"{{workflow.annotations.k8s-webhook-handler.io/repo_ssh}}\"\n              revision: \"{{workflow.annotations.k8s-webhook-handler.io/revision}}\"\n      container:\n        image: gcr.io/kaniko-project/executor\n        args:\n          - \"--context=/src\"\n          - \"--destination={{workflow.parameters.image}}\"\n        volumeMounts:\n          - name: docker-config\n            mountPath: /kaniko/.docker/\n    - name: deploy\n      container:\n        image: bitnami/kubectl:1.17.4\n        args: [\"kubectl\", \"set\", \"image\", \"deployment/k8s-webhook-handler\", \"k8s-webhook-handler={{workflow.parameters.image}}\"]</code></pre></div>\n<p>This workflow defines a DAG in the <code class=\"language-text\">ci</code> template with two tasks where deploy\ndepends on build, so it runs after that. To allow the workflow to change\nresources in Kubernetes, we specify <code class=\"language-text\">serviceAccountName: ci-workflow</code>. Follow\nthe <a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/\">Kubernetes\nDocs</a>\nfor details on how to create service accounts.</p>\n<p>On push, this workflow will now build the image and update the\n<code class=\"language-text\">k8s-webhook-handler</code> container in the <code class=\"language-text\">k8s-webhook-handler</code> deployment to use\nthe new image.</p>\n<h2 id=\"branch-based-continuous-integration\" style=\"position:relative;\"><a href=\"#branch-based-continuous-integration\" aria-label=\"branch based continuous integration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Branch based continuous integration</h2>\n<p>The above example would update the <code class=\"language-text\">k8s-webhook-handler</code> in the default\nnamespace on every push, no matter which branch. It also doesn’t handle the\ninitial creation of the deployment. That’s probably not what you want in\nproduction.</p>\n<p>What we are doing is using a custom deployment image with scripts\nthat render templates from the source repository. Beside using the image name\nfrom the workflow in the deployment manifests, we deploy all resources in a\nKubernetes namespace based on the branch name. This allows developers to test\ntheir changes in a separate namespace before merging and deploying to the\nproduction namespace.</p>\n<p>But what happens if a developer deletes their branch? k8s-webhook-handler\nsupports any kind of GitHub events, so we actually send many more events to it\nand use the <code class=\"language-text\">k8s-webhook-handler.io/event_type</code> annotations to distinguish\nbetween them. That allows us to run a separated <code class=\"language-text\">push</code> and <code class=\"language-text\">delete</code> DAG in the\nworkflow:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">...\n  templates:\n    - name: ci\n      dag:\n        tasks:\n          - name: push\n            template: push\n            when: \"'{{workflow.annotations.k8s-webhook-handler.io/event_type}}' == 'push'\"\n          - name: delete\n            template: delete\n            when: \"'{{workflow.annotations.k8s-webhook-handler.io/event_type}}' == 'delete'\"\n    - name: push\n      dag:\n        tasks:\n          - name: build\n            template: build\n          - name: deploy\n            template: deploy\n            dependencies: [build]\n    - name: delete\n      container:\n        image: custom-ci-tools-image\n        command: [ \"delete-namespace-for-ref\", \"{{workflow.annotations.k8s-webhook-handler.io/ref}}\"]\n...</code></pre></div>\n<h2 id=\"advanced-builds-github-checks-slack-notifications-and-more\" style=\"position:relative;\"><a href=\"#advanced-builds-github-checks-slack-notifications-and-more\" aria-label=\"advanced builds github checks slack notifications and more permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Advanced builds, GitHub checks, Slack notifications and more</h2>\n<p>The generic nature of the Argo workflow allows it to handle pretty much any build\nand deployment needs. We have additional steps that use our custom ci scripts\nto:</p>\n<ul>\n<li>Ensure the ECR repositories exist</li>\n<li>Sending build notifications to Slack and update <a href=\"https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/about-status-checks\">GitHub’s status\nchecks</a></li>\n<li>Add deployment annotations to our monitoring system</li>\n<li>Calculate image tags based on file checksums to avoid unnecessary builds</li>\n</ul>\n<p>Here is an example of one of our more sophisticated CI workflows that builds\nmultiple variants of an project based on multiple base images, to support GPU\nand non-GPU deployments:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e7c53a5a4cbff2c265f5e0064b0c1265/3cd52/koko-ci.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 116.56441717791411%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAAClElEQVR42p1Uy27TUBT017JgQTew4gv4AbZIXVSwgIhX2w0bxKIkaVUKTdrYru34ce3r96NP2g7n3NQiRE0jvDiSZfvMnTMz52onQYzFMqlckeHp4D22pof4fXqJtCgRpgVMX+K+nra0ZR8ckWLjaIgdz0KSVgjiDNMoJcC4GyCzTKIabpBhPBXQPbmS3YOAtkiwZYzwI/AgEx63hBtl3UZuNXz8/S0+OAfALXB9e4OkqGF4HTW0qEZeAEOwngmcMFXvOo3cMlzr9/CZXL6qz1E2DWJm2NVl1rCnH6Dv2hCSHU7uXO4IqJg6EQIyIkxy5NUp/KRDDv/mLMG+7mAaxkjzEs3ZOaK8hu5K9Y95J81SQD55MbSGF6nRbTKGx+XneyfxlwD+4zI17x1Z8IhhWdWo69OlsWGjzFWAXLobqahwoH0qm9axjRQDOCSLTWXeEVCARjBDXwRs3/NO9x0Hz3Y/Yix8pGRQWla0PRVe7H/BhjFEndVI8gJxXkHzw1xlbkJseBwuDrKICvVs+WSO4+Ll4TeYUpJBFeWxAvetjwbYtkYoigaSjBN0G2m9yQG+OjpyOoV/jGhvB8To9WQPIs4hmBFpJ6NSMR87Akd2oJqLjIDiQmnYlvZ8dxOvJjvA5Q0ur6/R1BfY1kdYG/ZUXIqqwdnFFayQdSJAAhudeMhLOiSdHcZr2TqtqVUSs9y1Tk28EL88H1PeECpuOPHn4yWVCTbv90KUNGsuSyYZwdp8Ov6JR/03KOsaGd3UKQnOWZzPWwv84KYwQ47Bvuth0ziET7e0L2dlLQn16tUjlh65nstGOc839Xxw/wuQm6YqdzbWj/vK4UCmFIlq6dqtAJxpuG2M8WT4TjmcU4j5Yph38iHAP+Aql3/swcuOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"koko-ci\"\n        title=\"\"\n        src=\"/static/e7c53a5a4cbff2c265f5e0064b0c1265/a6d36/koko-ci.png\"\n        srcset=\"/static/e7c53a5a4cbff2c265f5e0064b0c1265/222b7/koko-ci.png 163w,\n/static/e7c53a5a4cbff2c265f5e0064b0c1265/ff46a/koko-ci.png 325w,\n/static/e7c53a5a4cbff2c265f5e0064b0c1265/a6d36/koko-ci.png 650w,\n/static/e7c53a5a4cbff2c265f5e0064b0c1265/3cd52/koko-ci.png 857w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li><em>init</em> adds a GitHub status check indicating that the build is running</li>\n<li><em>calculate-tags</em> creates checksums from various files to determine what needs to\nget rebuild which leads to skipping rebuild of both base images</li>\n<li><em>update-kubeflow</em> adds new Jupyter notebook builds to kubeflow</li>\n<li><em>report-status</em> updates the GitHub status check and notifies Slack</li>\n</ul>\n<h1 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h1>\n<p>Argo is a relatively small but very powerful extension of the Kubernetes API.\nI’ve been using various CI/CD systems over the years and while most are easier\nto use for simple use cases, things tend to get tedious for more advanced and\nless anticipated use cases. Argo gets away with much less complexity than most\nof these systems as well, since all the heavy lifting of scheduling and\nabstraction of build steps is done by Kubernetes. It’s a shining example of what\nis so great about Kubernetes: It’s not just the datacenter as a computer idea,\nbut also the building blocks that <em>are</em> complex but only need to be solved once,\nby Kubernetes, to benefit many different use cases on top of it.</p>\n<hr>\n<p>CI setup is still being used.</small></p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\"><small>Koko has been acquired by Airbnb where a modified version of this<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a></li>\n</ol>\n</div>","frontmatter":{"title":"Kubernetes Native CI With Argo","date":"May 01, 2020","image":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB+UlEQVR42t1Uv+upYRR/pQx8kYFSslA2gxgMLBaTUgzKItmYsDGwkfIjQmFhMUgyKAuTEoMd+QckE/n5uT1Pve99fd1b95bhdp/lPX3O53ye857nnMPgw4f59wWfz+cbSDAW59u/47wIPh4P3G43DiA2wQiZ2OTL53zH7/f7u+D3GwmJxa/X64sYy7lcLpwYP1NGq9Uil8txwfF4HDKZDIPBAPl8HiqVChqNBsVikXLO5zPC4TCUSiV0Oh263S7F2QSYSqUCoVCI4XCITCYDqVSKfr+PVCoFsViMZrOJUqkEgUCA0WiEdDoNuVyOXq+HRCIBkUiE+XzOidJXDgaD8Hq9sFqtyGaz1EnsaDTK/Yrf74fH44HZbEa9Xudwu92OWCzGlYoK2mw2uFwuWCwWVKtV6iTBDoeDIxqNRvh8PjidTgQCAYrv93uo1WqUy+WfggaDAQzD0AxMJhNqtRp1brdb6PV6Wj9SK8IJhUJYrVaQSCQgcQqFgmZ4Op24x2EajQam0ykWiwXG4zF2ux11bjYbzGYztNttipOSuN1u6luv17Q0nU7nReyXk8K2QqFQoBksl0tMJhOaVavV4nqVPWzPvvQhC7I2GxSJRPD19UXbKJlMvkwJv1f/aJbZWw+HA47H41sD//VyYLPgj9tHtg2/DP/JPvy04A+UeYzD6oOvfAAAAABJRU5ErkJggg==","width":458,"height":458,"src":"/static/a099ca3512e83579d67b0aa9ede5261a/1caf2/argo.png","srcSet":"/static/a099ca3512e83579d67b0aa9ede5261a/1caf2/argo.png 1x"}}}}}},"pageContext":{"slug":"/2020/05/01/kubernetes-native-ci-with-argo/","previous":{"fields":{"slug":"/2019/05/10/k8s-on-openwrt/"},"frontmatter":{"title":"Running Kubernetes on OpenWrt"}},"next":{"fields":{"slug":"/2021/05/11/homelab-upgrades-hardware/"},"frontmatter":{"title":"Kubernetes at Home: Hardware"}}}},"staticQueryHashes":[],"slicesMap":{}}