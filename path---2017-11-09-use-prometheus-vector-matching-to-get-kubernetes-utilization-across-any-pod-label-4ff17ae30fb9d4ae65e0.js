webpackJsonp([0xefbd5ea46e68],{510:function(e,a){e.exports={data:{site:{siteMetadata:{title:"5π - fish's blog",author:"Johannes 'fish' Ziemke"}},markdownRemark:{id:"/usr/src/src/pages/2017/11/09/use-prometheus-vector-matching-to-get-kubernetes-utilization-across-any-pod-label/index.md absPath of file >>> MarkdownRemark",html:'<p>Prometheus was designed for dynamic environments like Kubernetes. Its powerful\nservice discovery and query language allows you to answer all kind of questions\nthat come up while operating a Kubernetes cluster.</p>\n<p>This flexibility comes with a somewhat steeper learning curve than some\nalternatives and hosted services, with <a href="https://prometheus.io/docs/prometheus/latest/querying/operators/#vector-matching">Vector\nMatching</a>\nbeing one of the more advanced topics.</p>\n<p>I’m not going into the details which the excellent <a href="https://prometheus.io/docs/prometheus/latest/querying/operators/#vector-matching">Prometheus\nDocumentation</a>\nhas already covered but walk you through some useful queries to get resource\nutilization in a Kubernetes cluster.</p>\n<h2>Aggregated memory usage per label</h2>\n<p>Kubernetes provides a <code>container_memory_usage_bytes</code> metric reflecting each pods\nmemory usage, e.g:</p>\n<div class="gatsby-highlight">\n      <pre class="language-none"><code>...\ncontainer_memory_usage_bytes{beta_kubernetes_io_arch="amd64",beta_kubernetes_io_fluentd_ds_ready="true",beta_kubernetes_io_instance_type="g1-small",beta_kubernetes_io_os="linux",cloud_google_com_gke_nodepool="small-preemptible",cloud_google_com_gke_preemptible="true",container_name="POD",failure_domain_beta_kubernetes_io_region="us-east1",failure_domain_beta_kubernetes_io_zone="us-east1-c",id="/kubepods/burstable/pod13d4221c-c484-11e7-bff5-42010af0018b/67e5bb069ab9881ff8a55b8628ef4935b0d1ace09c18df20db059522bdfd5b7d",image="gcr.io/google_containers/pause-amd64:3.0",instance="gke-latency-at-small-preemptible-0c981b61-9489",job="kubernetes-cadvisor",kubernetes_io_hostname="gke-latency-at-small-preemptible-0c981b61-9489",name="k8s_POD_latency-api-971504058-jzs5h_default_13d4221c-c484-11e7-bff5-42010af0018b_0",namespace="default",pod_name="latency-api-971504058-jzs5h"}\t389120\ncontainer_memory_usage_bytes{beta_kubernetes_io_arch="amd64",beta_kubernetes_io_fluentd_ds_ready="true",beta_kubernetes_io_instance_type="g1-small",beta_kubernetes_io_os="linux",cloud_google_com_gke_nodepool="small-preemptible",cloud_google_com_gke_preemptible="true",container_name="POD",failure_domain_beta_kubernetes_io_region="us-east1",failure_domain_beta_kubernetes_io_zone="us-east1-c",id="/kubepods/burstable/pod81d0f651-c500-11e7-bff5-42010af0018b/309e05b118e618122c70ccf88538d13ca41c3b5a770d5d67882426854391c23c",image="gcr.io/google_containers/pause-amd64:3.0",instance="gke-latency-at-small-preemptible-0c981b61-9489",job="kubernetes-cadvisor",kubernetes_io_hostname="gke-latency-at-small-preemptible-0c981b61-9489",name="k8s_POD_latency-api-971504058-gszpw_default_81d0f651-c500-11e7-bff5-42010af0018b_0",namespace="default",pod_name="latency-api-971504058-gszpw"}\t372736\ncontainer_memory_usage_bytes{beta_kubernetes_io_arch="amd64",beta_kubernetes_io_fluentd_ds_ready="true",beta_kubernetes_io_instance_type="g1-small",beta_kubernetes_io_os="linux",cloud_google_com_gke_nodepool="small-preemptible",cloud_google_com_gke_preemptible="true",container_name="latency-api",failure_domain_beta_kubernetes_io_region="us-east1",failure_domain_beta_kubernetes_io_zone="us-east1-c",id="/kubepods/burstable/pod13d4221c-c484-11e7-bff5-42010af0018b/497e6fdf2217771cb3f52e6fef93734d023f0e7f23f92c58d22139fc18dc5f13",image="registry.gitlab.com/latency.at/latencyat@sha256:8ea057e064b64cc9c8459a68ef3f6d0fc26169b4f57aef193831779e1fe713d4",instance="gke-latency-at-small-preemptible-0c981b61-9489",job="kubernetes-cadvisor",kubernetes_io_hostname="gke-latency-at-small-preemptible-0c981b61-9489",name="k8s_latency-api_latency-api-971504058-jzs5h_default_13d4221c-c484-11e7-bff5-42010af0018b_1",namespace="default",pod_name="latency-api-971504058-jzs5h"}\t11014144\ncontainer_memory_usage_bytes{beta_kubernetes_io_arch="amd64",beta_kubernetes_io_fluentd_ds_ready="true",beta_kubernetes_io_instance_type="g1-small",beta_kubernetes_io_os="linux",cloud_google_com_gke_nodepool="small-preemptible",cloud_google_com_gke_preemptible="true",container_name="latency-api",failure_domain_beta_kubernetes_io_region="us-east1",failure_domain_beta_kubernetes_io_zone="us-east1-c",id="/kubepods/burstable/pod81d0f651-c500-11e7-bff5-42010af0018b/7b438a8e9df0cf1ab29d067fd36c97099f9f5e7e9257f6187c5be6bff846a62c",image="registry.gitlab.com/latency.at/latencyat@sha256:8ea057e064b64cc9c8459a68ef3f6d0fc26169b4f57aef193831779e1fe713d4",instance="gke-latency-at-small-preemptible-0c981b61-9489",job="kubernetes-cadvisor",kubernetes_io_hostname="gke-latency-at-small-preemptible-0c981b61-9489",name="k8s_latency-api_latency-api-971504058-gszpw_default_81d0f651-c500-11e7-bff5-42010af0018b_0",namespace="default",pod_name="latency-api-971504058-gszpw"}\t11448320\n...</code></pre>\n      </div>\n<p>Unfortunately it doesn’t contain the pod labels. For that there is the\n<code>kube_pod_labels</code> though which includes a static timeseries with all labels and\nthe pod name. This metric is provided by\n<a href="https://github.com/kubernetes/kube-state-metrics">kube-state-metrics</a>.</p>\n<p>We can use it to look up the labels for the pod from the\ntimeseries (<code>pod_name="latency-api-971504058-jzs5h"</code>):</p>\n<div class="gatsby-highlight">\n      <pre class="language-none"><code>kube_pod_labels{instance="10.116.0.12:8080",job="kubernetes-service-endpoints",k8s_app="kube-state-metrics",kubernetes_name="kube-state-metrics",kubernetes_namespace="kube-system",label_app="latency-api",label_pod_template_hash="971504058",namespace="default",pod="latency-api-971504058-jzs5h"} 1\nkube_pod_labels{instance="10.116.1.26:8080",job="kubernetes-service-endpoints",k8s_app="kube-state-metrics",kubernetes_name="kube-state-metrics",kubernetes_namespace="kube-system",label_app="latency-api",label_pod_template_hash="971504058",namespace="default",pod="latency-api-971504058-jzs5h"} 1</code></pre>\n      </div>\n<p>Both metrics can be merged by using vector matching. We get this metric twice\nbecause there are two instances of kube-state-metrics running. So before we\ncontinue further, we aggregate both. Since they should be identical, we can use\nmin/max to aggregate. Since we later want to aggregate on <code>label_app</code>, we need\nto keep that label. We also need to keep the <code>pod</code> label to join both metrics\non. We can preserve them by specifying them in the BY clause. Since the pod\nlabel is called <code>pod</code> in <code>kube_pod_labels</code> but <code>pod_name</code> in\n<code>container_memory_usage_bytes</code>, we need to also use label_replace to rename the\nlabel. This gives us:</p>\n<div class="gatsby-highlight">\n      <pre class="language-none"><code>max by (pod_name,label_app) (\n  label_replace(kube_pod_labels{label_app!=""},"pod_name","$1","pod","(.*)")\n)</code></pre>\n      </div>\n<p>Which returns something like:</p>\n<div class="gatsby-highlight">\n      <pre class="language-none"><code>...\n{label_app="latency-api",pod_name="latency-api-971504058-n8k6d"}  1\n{label_app="latency-api",pod_name="latency-api-971504058-jzs5h"}  1\n...</code></pre>\n      </div>\n<p>Now we can use vector matching to join <code>container_memory_usage_bytes</code> with the\nresult of our expression. We use the <code>*</code> operator which effectivly is a no-op\nsince it will multiply the memory usage by the matched timeseries value in\n<code>kube_pod_labels</code> which is always 1.</p>\n<p>We need to specify <code>group_left</code> because there are multiple\n<code>container_memory_usage_bytes</code> timeseries for each pod, one for each container.\nSince we want to preserve the <code>label_app</code> label, we specify it as argument to <code>group_left</code>.</p>\n<p>This gives us:</p>\n<div class="gatsby-highlight">\n      <pre class="language-none"><code>  container_memory_usage_bytes * on (pod_name) group_left(label_app)\n  max by (pod_name,label_app) (\n    label_replace(kube_pod_labels{label_app!=""},"pod_name","$1","pod","(.*)")\n  )</code></pre>\n      </div>\n<p>To aggregated the memory usage of all your pods, summed by a <code>k8s-app</code> label you\ncan use the following expression:</p>\n<div class="gatsby-highlight">\n      <pre class="language-none"><code>sum by (label_app,namespace) (\n  container_memory_usage_bytes * on (pod_name) group_left(label_app)\n  max by (pod_name,label_app) (\n    label_replace(kube_pod_labels{label_app!=""},"pod_name","$1","pod","(.*)")\n  )\n)</code></pre>\n      </div>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/mem_per_app-0f0a37acb794c49740014ce150e3ae1f-0a8a9.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 79.38144329896907%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAABzElEQVQ4y5WSS47aQBCGuQ0rNrBAgg3ibYMUQOI0GQgjRUqugwRbrsABZoZhwDw2WUTY7ocff6rLMSEaNAwl/Sq5q/qrqi5n4jiG1hq+7yMMQwghWK7r4nQ6QUp5Pjc5Sin2nufhmmUMMAgCVhRFH8qAb+UwUAkJ6QncMpN7zbRUzAipqYyhmpEZ6tJIvvwrwYBLpV2k8TQ3CqNznDs0o/ABBVLzfp+gvORSoDS0SC5roZDeiaKQcw0oji9GllKw1IV832X/a3+E8D2K+//yFBUJNC3K4xwpzLIEn2V4XNpcUiX+ULdyzh1q+iVCqnJNsRlNq/cx6vr/bz9ZigHujgc8rVesZ9YLnl5J5J3dFs5hg81xi82edHDwtnew2q3xvF3hxVnjlbRy3uBSEQYul0tMp1PMZjPM5/N3WiwWyXbpaW79iwycTMbodm1YlsXqdDpot9uoVCooFAqoVqv4rDHwYfSNQDZs20ar1SJ4l4GlUgn5fP5+4PjxAS2rgUajgVqtxt6oWCwim83eDxyNCNhsokmq1+tnaLlcRi6Xux/4dTyhDi0e00CNN1DzfmZk8wx3AX/++I5+/wupj16vh8FgwN7ILGk4HH4a+AfcsHNPIKcvvwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="mem_per_app"\n        title=""\n        src="/static/mem_per_app-0f0a37acb794c49740014ce150e3ae1f-fb8a0.png"\n        srcset="/static/mem_per_app-0f0a37acb794c49740014ce150e3ae1f-1a291.png 148w,\n/static/mem_per_app-0f0a37acb794c49740014ce150e3ae1f-2bc4a.png 295w,\n/static/mem_per_app-0f0a37acb794c49740014ce150e3ae1f-fb8a0.png 590w,\n/static/mem_per_app-0f0a37acb794c49740014ce150e3ae1f-526de.png 885w,\n/static/mem_per_app-0f0a37acb794c49740014ce150e3ae1f-0a8a9.png 970w"\n        sizes="(max-width: 590px) 100vw, 590px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2>CPU and IO usage per label</h2>\n<p>Now that we know how to join the <code>kube_pod_labels</code> metric with cadvisor metrics,\nwe can figure out usage of other resources too.</p>\n<h3>CPU</h3>\n<div class="gatsby-highlight">\n      <pre class="language-none"><code>sum by (label_app,namespace) (\n  rate(container_cpu_usage_seconds_total[2m]) * on (pod_name) group_left(label_app)\n  max by (pod_name,label_app) (\n    label_replace(kube_pod_labels{label_app!=""},"pod_name","$1","pod","(.*)")\n  )\n)</code></pre>\n      </div>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/cpu_per_app-ee8bde4b930678ada8505a9cc8e749ba-0a8a9.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 79.38144329896907%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAAB+0lEQVQ4y6WS224SURSGeRuuuIELErghnAdIBBKexoI0MdGnMSEBtIlBo/HCtjAYS0oFQeuBMaW2MucD/K61ie1F7YF0J3/+NXvW/matvca3Wq3gOA4Mw4DneTBNU0jTNKiqCsuyLvY5x7Zt4bqu43/Lx8mcxH5fLZcefFwhP7Dftm7LcV0HvuVyKVpm5wM36aYc17WJY122fF+gpp7Q3Z6vK3Rd99p2HIeH5YrYtnWYdMjzHIo1+oAL1zFpcAsoswMa1O9LILthaFeqsSwVujYXyYoyEAcXixnUhSL2z86OMT8ZYTp5s66QW9YXGow/Gk5nCgyKTVXH/OdM7H2byBgfvYPy4xCj4St8Hr3F8XSP1MWXyS75PsbD1xge7MDQz9dT/qV8x9fpJ0zHA0zGH3E07JIP6MAh+r0d7O238KH/kryNXrcNufcc73efQaa432ujS+973RdU+ekaKMsyGo0Gms0mWq3WFXU6HXEF//5Xjq+TANbrNRQKOUiSJJTP55HNZhGLxRAKhRCPx3HXJYBb1UcEyiGXyyGTyRC8IICRSATBYHBzYG17CxkphVQqhUQiIZwVDofh9/s3B1arBEynkSYlk8kLaDQaRSAQ2Bz4sFanCiXRJkPZGcr3xy3zNWwEfPrkMUqlB6QSisUiyuWycBYPqVKp3Bn4F21qaOyyTJbXAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="cpu_per_app"\n        title=""\n        src="/static/cpu_per_app-ee8bde4b930678ada8505a9cc8e749ba-fb8a0.png"\n        srcset="/static/cpu_per_app-ee8bde4b930678ada8505a9cc8e749ba-1a291.png 148w,\n/static/cpu_per_app-ee8bde4b930678ada8505a9cc8e749ba-2bc4a.png 295w,\n/static/cpu_per_app-ee8bde4b930678ada8505a9cc8e749ba-fb8a0.png 590w,\n/static/cpu_per_app-ee8bde4b930678ada8505a9cc8e749ba-526de.png 885w,\n/static/cpu_per_app-ee8bde4b930678ada8505a9cc8e749ba-0a8a9.png 970w"\n        sizes="(max-width: 590px) 100vw, 590px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3>Disk IO</h3>\n<p>I wanted to show you some disk IO stats too. Unfortunately these are\n<a href="https://github.com/kubernetes/kubernetes/issues/55397">broken</a> once\n<a href="https://github.com/kubernetes/kubernetes/issues/55398">again</a> in Kubernetes.</p>\n<h3>Network</h3>\n<div class="gatsby-highlight">\n      <pre class="language-none"><code>sum by (label_app,namespace) (\n  rate(container_network_transmit_bytes_total[2m]) * on (pod_name) group_left(label_app)\n  max by (pod_name,label_app) (\n    label_replace(kube_pod_labels{label_app!=""},"pod_name","$1","pod","(.*)")\n  )\n)</code></pre>\n      </div>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/net_per_app-9cdc5336080b286047c358a645a9a8ed-0a8a9.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 79.38144329896907%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAABjUlEQVQ4y6WSzWrCQBDHfRtPXvQg6EXUGBOFquDTVK2FQvs6gl59Bd+g2NKLH/nSJGoS8+/OUCXaWAwd+Gd2wuxvZ2Y3FYYhPM+D67oIggC73Y5l2za22y32+/35P+UcDgf2juMgzlKUTEnk/6vj8YgUVUgB+ZMFjh17ejQnzhhIH6qQPG3gEVjmeU3yXYd9NCdONyv0TP3iZDrgusJQbI6t8C7gTxzN8bebeKDv+3zL0XYOAhBt5RT/lZOs5ZgKr3MuWt6IGZm6DlPTYJkGtK9P6MsVx6a2xvpjDsvQoC0WHOtCy/k7r431imUZOjxxuQyczWYYjUYYj8eYTCa/NJ1OcXoNp/d2SwwcDgdoNlUoisJqNBqo1+solUrI5XIol8u41xjY6z8JkApVVSHLsoA3GVgoFJDNZpMDB889yIoESZJQqVTYk/L5PNLpdHJgvy+AtRpqQtVq9QwtFovIZDLJgY+DoahQ4TYJSp6gND9qmcaQCPj2+oJ2+0GojVarhU6nw55El9Ttdu8GfgOQsnhxJhI4PwAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="net_per_app"\n        title=""\n        src="/static/net_per_app-9cdc5336080b286047c358a645a9a8ed-fb8a0.png"\n        srcset="/static/net_per_app-9cdc5336080b286047c358a645a9a8ed-1a291.png 148w,\n/static/net_per_app-9cdc5336080b286047c358a645a9a8ed-2bc4a.png 295w,\n/static/net_per_app-9cdc5336080b286047c358a645a9a8ed-fb8a0.png 590w,\n/static/net_per_app-9cdc5336080b286047c358a645a9a8ed-526de.png 885w,\n/static/net_per_app-9cdc5336080b286047c358a645a9a8ed-0a8a9.png 970w"\n        sizes="(max-width: 590px) 100vw, 590px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>',frontmatter:{title:"Use Prometheus Vector Matching to get Kubernetes Utilization across any Pod Label",date:"2017-11-08T23:00:00.000Z"}}},pathContext:{slug:"/2017/11/09/use-prometheus-vector-matching-to-get-kubernetes-utilization-across-any-pod-label/",previous:{fields:{slug:"/2017/04/17/selenium-webdriver-chromedriver-nightwatch-chrome-headless/"},frontmatter:{title:"Frontend Testing Zoo - Or, Nightwatch without Selenium"}},next:{fields:{slug:"/2017/12/15/production-grade-kubernetes/"},frontmatter:{title:"Production Grade Kubernetes"}}}}}});
//# sourceMappingURL=path---2017-11-09-use-prometheus-vector-matching-to-get-kubernetes-utilization-across-any-pod-label-4ff17ae30fb9d4ae65e0.js.map