{"componentChunkName":"component---src-templates-blog-post-js","path":"/2018/12/10/prometheus-blackbox-exporter-lambda/","result":{"data":{"site":{"siteMetadata":{"title":"5π Consulting","author":"Johannes 'fish' Ziemke"}},"markdownRemark":{"id":"2cf58f79-e096-5f95-8717-7a8aa0df98b8","html":"<h1 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"></a>Introduction</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/867486a1cfca72c0aefe8faa3aa54a18/2c288/lambda-designer.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 85.88957055214723%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAACJElEQVQ4y32T227TQBCG8/4vwStwW7go5SJQIXqgTVAr2gQ3jh07e549r21mnaQNh2J9Wo1s/zvzz85OHLDqfrqtGpCsCy55m7wZsXvcc5zfdzHErhflg95Uk+iMVUSSxmsTrQlWPxNHkg/xEEcDmKAbhsX5++r7xaQLQdKqvP+0WtZyS5wGCwoxSkVntRLF/FQxijGmyXrv8KlbwqWaRG+NElZyI4UHFjTfYSTHUiWhV9O3tKl3YrQgGC3Xaw1qGPqxbFBtuVxcn0jCg2JecQT3CuhCw+KxkFyi2zCKJadciJRS13WTHuvQeluVd5dnrGydoE4wRHPuATpjRduil+fMKGaMxRizuCqfaNvUq6JZN1GroMUO9JKCA06vTt+QDZbt9mJ2JDYgQWCRFH16eEFLgZ6xxrvZJWna3K2/xdh6C9JjNuAZvV+typ5ztSYEY1/Ex2VjJzC5UXvsATwqFOc+AcS8y7/E+9Nz5jUC6N/Ex2XjOUen0/jhD7IAM2v9n8w4dDJaeI2Ao2bGAFd0mDPzg+fo4/E1QMJIDlyKLpqcM4908H0KUvCjhqXUH57UjcQOJcHj/emix83T0A/4N6UMh4tKKQQPO7EC8fnmhBCGN61+mj/NP3gRfOzJbMqKRT8MQrLz2bum2XIFsljyb1fNlqWdmBP65fpjXW8AzPJh/uN2itPlQlzeft38fByGgRNyfnFWlhX+3q6KYnZDGMNbgeJfyPTJl+SSQg0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lambda-designer\"\n        title=\"lambda-designer\"\n        src=\"/static/867486a1cfca72c0aefe8faa3aa54a18/a6d36/lambda-designer.png\"\n        srcset=\"/static/867486a1cfca72c0aefe8faa3aa54a18/222b7/lambda-designer.png 163w,\n/static/867486a1cfca72c0aefe8faa3aa54a18/ff46a/lambda-designer.png 325w,\n/static/867486a1cfca72c0aefe8faa3aa54a18/a6d36/lambda-designer.png 650w,\n/static/867486a1cfca72c0aefe8faa3aa54a18/2c288/lambda-designer.png 684w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>When providing any service to a global customer base, you are probably\ninterested in measuring the performance and availability of your site from\nmultiple global locations.</p>\n<p>For this, I’ve created <a href=\"https://latency.at\">latency.at</a> which unfortunately\ndidn’t get the traction I hoped it would. (See\n<a href=\"https://blog.latency.at/2018-05-24-shutting-down-latency-at/\">this</a> for more\ndetails).</p>\n<p>So today, we’re back where we were before: If you want your performance and\navailability metrics in <a href=\"https://prometheus.io\">Prometheus</a> your best option is\nto run a bunch of snowflake VMs with the prometheus blackbox exporter in\ndifferent regions and glue some authenticating reverse proxy to it.</p>\n<p>Wouldn’t it be nice if we could run this without having to mange servers? Like\nserver<em>less</em>?</p>\n<p>Introducing\n<a href=\"https://github.com/discordianfish/blackbox-exporter-lambda\">blackbox-exporter-lambda</a>!</p>\n<h1 id=\"how-does-it-work\" style=\"position:relative;\"><a href=\"#how-does-it-work\" aria-label=\"how does it work permalink\" class=\"anchor before\"></a>How does it work?</h1>\n<p>When working on latency.at, <a href=\"https://github.com/prometheus/blackbox_exporter/pull/214\">I’ve\nrefactored</a> the\nblackbox-exporter to make it possible to use it’s probers and config as packages\nin downstream project.</p>\n<p>This allowed me to create a new project which runs the probers on <a href=\"https://aws.amazon.com/lambda/\">AWS\nLambda</a>.</p>\n<p>The project contains <a href=\"https://aws.amazon.com/cloudformation/\">Cloudformation\ntemplates</a> to create the Lambda and\nexpose it via the <a href=\"https://aws.amazon.com/api-gateway/\">Amazon API Gateway</a>.</p>\n<p>For authorization, we require an authorization header to match the <code class=\"language-text\">AUTH_TOKEN</code>\nenvironment variable.</p>\n<h1 id=\"deployment\" style=\"position:relative;\"><a href=\"#deployment\" aria-label=\"deployment permalink\" class=\"anchor before\"></a>Deployment</h1>\n<h2 id=\"bootstrapping\" style=\"position:relative;\"><a href=\"#bootstrapping\" aria-label=\"bootstrapping permalink\" class=\"anchor before\"></a>Bootstrapping</h2>\n<p><img src=\"/297788a4dcf5dd03aa9a6fe753bb8619/new.gif\" alt=\"new\">\nDownload or checkout the\n<a href=\"https://github.com/discordianfish/blackbox-exporter-lambda\">blackbox-exporter-lambda</a> and change to the directory:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">git clone https://github.com/discordianfish/blackbox-exporter-lambda.git\ncd blackbox-exporter-lambda</code></pre></div>\n<p>Create the Cloudformation Stack. On the first run, this will create a S3 bucket\ncalled <code class=\"language-text\">blackbox-exporter-[AWS AccountId]</code>. You might want to use a different\nprefix for reach region you deploy this to.</p>\n<p>This won’t include the lambda since\nwe first need to upload the code.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">make new</code></pre></div>\n<h2 id=\"upload-code\" style=\"position:relative;\"><a href=\"#upload-code\" aria-label=\"upload code permalink\" class=\"anchor before\"></a>Upload Code</h2>\n<p><img src=\"/8be4627e4a0e08ef00807514abbad070/upload-update.gif\" alt=\"new\">\nNow upload the code. This uses the aws cli to get your Account ID. You can also\nset this using the <code class=\"language-text\">ACCOUNT_ID</code> environment variable.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">make upload</code></pre></div>\n<p>To finialize this and create the lambda run:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">AUTH_TOKEN=foobar23 make update</code></pre></div>\n<p><code class=\"language-text\">AUTH_TOKEN</code> specifies which auth token to require when handling requests. You\ncan make Prometheus use this token by configuring <code class=\"language-text\">bearer_token</code> in the <a href=\"https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config\">scrape\nconfig</a></p>\n<h2 id=\"test-lambda\" style=\"position:relative;\"><a href=\"#test-lambda\" aria-label=\"test lambda permalink\" class=\"anchor before\"></a>Test Lambda</h2>\n<p><img src=\"/d490d740700a92ddf861d23bbe7b84e3/test.gif\" alt=\"test\">\nNow we can run <code class=\"language-text\">make endpoint</code> to get the URL to invoke the blackbox-exporter\nand use curl for testing this. You use the <code class=\"language-text\">config</code> parameter for\nblackbox-exporter configuration. Each probe takes different configuration\nparameters. See the <a href=\"https://github.com/prometheus/blackbox_exporter/blob/master/CONFIGURATION.md#http_probe\">blackbox-exporter configuration\ndocumentation</a>\nfor more details.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl -L -G \\\n  -H &#39;Authorization: Bearer foobar23&#39; \\\n  --data-urlencode &#39;target=https://www.google.com&#39; \\\n  --data-urlencode &#39;config={&quot;preferred_ip_protocol&quot;: &quot;ip4&quot;}&#39; \\\n  $(make endpoint)/http</code></pre></div>\n<h2 id=\"updates\" style=\"position:relative;\"><a href=\"#updates\" aria-label=\"updates permalink\" class=\"anchor before\"></a>Updates</h2>\n<p>To change the <code class=\"language-text\">AUTH_TOKEN</code> or roll out any other Cloudformation change, you can\nrun <code class=\"language-text\">AUTH_TOKEN=xx make update</code> again.</p>\n<p>When changing the lambda code itself, run <code class=\"language-text\">make upload</code> to upload it to the code\nbucket and run <code class=\"language-text\">make bump</code> to notify Lambda that the code base changed.</p>\n<h2 id=\"prometheus-configuration\" style=\"position:relative;\"><a href=\"#prometheus-configuration\" aria-label=\"prometheus configuration permalink\" class=\"anchor before\"></a>Prometheus Configuration</h2>\n<p>The configuration is similar to the one used for the regular blackbox-exporter.\nIt also uses relabling to configure multiple targets easily:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">- job_name: &#39;blackbox-exporter-lambda-us-central-1&#39;\n  metrics_path: /probe/http\n  bearer_token: foobar23\n  scheme: https\n  params:\n    config:\n      - |\n        preferred_ip_protocol: ip4\n  static_configs:\n    - targets:\n      - https://5pi.de\n      - https://www.google.com\n  relabel_configs:\n    - target_label: __param_target\n      source_labels: [__address__]\n    - target_label: instance\n      source_labels: [__param_target]\n    - target_label: __address__\n      replacement: 5v5jaus0zj.execute-api.eu-central-1.amazonaws.com</code></pre></div>\n<p>Use your token for <code class=\"language-text\">bearer_token</code> and the output of <code class=\"language-text\">make endpoint</code> for the <code class=\"language-text\">__address__</code>\nreplacement and <code class=\"language-text\">metrics_path</code>. This should get you something like this:</p>\n<p><strong><code class=\"language-text\">probe_http_duration_seconds{instance=&quot;https://5pi.de&quot;,job=&quot;blackbox-exporter-lambda-us-central-1&quot;}</code></strong>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 603px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/364937c94659b580a3a99cb7eea04e80/9128f/graph.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 86.50306748466258%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsTAAALEwEAmpwYAAACTElEQVQ4y51Rz2vTYBjOvyEevMmoMIQiFNMf+Z01bT14UtquR0eXduum4kmQtmtlMsrYaTg2YcLK0NnCtGFzB+0QHe0mMtlB60Up1CFu2rRJmsY3Kd26rQ7xIV/yfM/7vN/zhg8RRVGSJKUNWZb/xk+WEFiqqmqa1myjk58CsCG1Wq3RaKgdgIL6DwAbAgP8f3K9XofkA6l1ZFd+snQ8GUTgpfJeXW6cPkKX5IZxULFUrtblzuZjyUZzE4F7OpLc1PnHSrGmVA/EI6cY28/ln5LS6N68XXlbU35rTa2ldCa2/uvNTlmUFL1ZVmBYfTD4AIf2rfK6KP/SDOzuiztffwCBEhjAC0H57W/VunKY3AKE6WPvrktqdV9UgH/fEwufKkDU9vyHyWubXyazxYmnhVj6XSqzOSN8mF5+H116eG/h1fD06/EnhVSmeGc2P5UpTjwrppYKDxY3JrNbt2bz9xc3kOVCCb373JkU2ESOjgt0LEdHV70zU67xLDf20pkQuDGBS6xQ0RwdE5i4bmPiOU9S4JKryIu1lauBYCAU8fG8b3DEG4xcH7gdGB7oD/Pe4KifH+oPDnn5m77BUX0bGvGHwv5wJMCHrt0IIY/m5kw9vSxFYlaUITAHaqEwK0tQuM1K43bSYcNsKInZoERhdnhAt6MWU8/5c2fPIPPzjy9YLjJ9DEEQFEXZHQ6cIGmGAULRNEGSOE7gBEFSFKyWjmHYZRQ1mUzIQjptvdR7xeNyOp1ut5tlWY7jPB4PEKeBPgMul26AN9uG2Wz+A+6FGWiJ0/JdAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"graph\"\n        title=\"graph\"\n        src=\"/static/364937c94659b580a3a99cb7eea04e80/9128f/graph.png\"\n        srcset=\"/static/364937c94659b580a3a99cb7eea04e80/222b7/graph.png 163w,\n/static/364937c94659b580a3a99cb7eea04e80/ff46a/graph.png 325w,\n/static/364937c94659b580a3a99cb7eea04e80/9128f/graph.png 603w\"\n        sizes=\"(max-width: 603px) 100vw, 603px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>","frontmatter":{"title":"Run Prometheus Blackbox Exporter as Lambda","date":"December 10, 2018","image":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAACrUlEQVQ4y21TyW4TQRCd/79zgBM3OCAhcUAgJDggEApBQoBNFicBMnZmn16qqvcx1WMnchBWq1Rd06/ecy1FDP73j9eqqUjL6AyfNNs7J/036O00pSJYInEzdl1braPDYDEaCPOJFmdnDjrD1s9XzxHSKfgiOorO15ef2k3V3QxGgSEiRINISN7wV0NK9tU1Kj2noMDkBrfMzDIIYNws2/VVXV5bNTgQTo9srR4NQHKubzbf3z2QfR+sZbJgDYvSSmYwOw7JAnhUHqVH4UGww3iDMHnb39THRx/7rks+MzO/AyXGMcvmUoE2i49PL7++ka32TCtHp4SVIykIRA7g6vzK6N0/34OlEMU2ekdoNK1+fvn1cwlN77T4B+wVdnVjUDMyV8uyTJnBVflnaJu+uqk2a9mNISu/Jzt5J5rNt3cPRTcEZ+MtM1MXom/kMKi+wbENtC/VQcGYzTRV+/3zm76tuc4HzGOx5WyIXKowU+047zHzd637WoCAw4JlZr5zP4wWFkY7s91Zw8yI82BRRNpX6xAcHDkCQmCF5p7VnNRSFuktOg1+N1uHsndzl9NbuutEvGXYBx15yJh/mfPEcMrbHtxZnwebOfMwcjOdnt/MeI7Y3Oc9M8xDh4eWMzLJ3vJKAOTg/pDVcmb2brc6Mb+bMZT3Kbndde8HrQPHDU6Ott5yXElZTNO0zb8pxphSmv1tiin6MEXe2SmFGF1ILu6e8cppraUGweAQ4iBbqXTGTJMSHYguucQAUkq3DaueQrTWdmNF6PquV9z2dUlCFQj08sPjb6fHfTtqtMuj5yefnsFgWU998eP67RMwnvNW9ebF+0fnFysG8719+6pdLAqUcHp6Ul7XrMcYs1qdXV6ccUUYUJbl2WLJu8H+0HSL5bIs65QiIK5W5+W6/Atk33OCI3KyrgAAAABJRU5ErkJggg==","width":684,"height":684,"src":"/static/867486a1cfca72c0aefe8faa3aa54a18/b1cdb/lambda-designer.png","srcSet":"/static/867486a1cfca72c0aefe8faa3aa54a18/b1cdb/lambda-designer.png 1x"}}}}}},"pageContext":{"slug":"/2018/12/10/prometheus-blackbox-exporter-lambda/","previous":{"fields":{"slug":"/2018/10/31/fluentd-for-data-warehousing-with-athena/"},"frontmatter":{"title":"fluentd for data warehousing with athena"}},"next":{"fields":{"slug":"/2018/12/18/why-kubernetes-at-small-scale/"},"frontmatter":{"title":"Why Kubernetes at small scale?"}}}}}