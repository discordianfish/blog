{"componentChunkName":"component---src-templates-blog-post-js","path":"/2015/01/26/monitor-docker-containers-with-prometheus/","result":{"data":{"site":{"siteMetadata":{"title":"5π Consulting","author":"Johannes 'fish' Ziemke"}},"markdownRemark":{"id":"03114194-fba2-536f-9cfa-d2d5ce7afeac","html":"<h3 id=\"monitoring-docker\" style=\"position:relative;\"><a href=\"#monitoring-docker\" aria-label=\"monitoring docker permalink\" class=\"anchor before\"></a>Monitoring Docker</h3>\n<p>Running all your services in containers makes it possible to get in-depth resource and performance characteristics, since every container runs in their own cgroup and the Linux kernel provides us with all kind of useful metrics.</p>\n<p>Although there are a few other Docker monitoring tools out there, I’ll show you why I think that SoundCloud’s <a href=\"https://developers.soundcloud.com/blog/prometheus-monitoring-at-soundcloud\">newly released</a> <a href=\"https://prometheus.github.io/\">Prometheus</a> is a perfect fit for monitoring container-based infrastructures.</p>\n<p>Prometheus features a highly dimensional <a href=\"http://prometheus.github.io/docs/concepts/data_model/\">data model</a> in which a time series is identified by a metric name and a set of key-value pairs. A flexible <a href=\"http://prometheus.github.io/docs/querying/basics/\">query language</a> allows querying and graphing this data. It features advanced <a href=\"http://prometheus.github.io/docs/concepts/metric_types/\">metric types</a> like summaries, building <a href=\"http://prometheus.github.io/docs/querying/functions/#rate()\">rates</a> from totals over specified time spans or <a href=\"http://prometheus.github.io/docs/querying/rules/\">alerting</a> on any expression and has no dependencies, making it a dependable system for debugging during outages.</p>\n<p>I will focus on why especially the data model and query language makes it such a good fit in a containerized, dynamic infrastructure where you think in clusters of services instead of single instances and servers as cattle instead of pets.</p>\n<h3 id=\"classic-approach\" style=\"position:relative;\"><a href=\"#classic-approach\" aria-label=\"classic approach permalink\" class=\"anchor before\"></a>Classic Approach</h3>\n<p>Let’s say you want to monitor the memory usage of your containers. Without support for dimensional data, such a metric for the container named <code class=\"language-text\">webapp123</code> might be called <code class=\"language-text\">container_memory_usage_bytes_webapp123</code>.</p>\n<p>But what if you want to show the memory usage of all your <code class=\"language-text\">webapp123</code> containers? More advanced monitoring solutions like <a href=\"https://github.com/graphite-project\">graphite</a> support that. It features a hierarchic, tree-like data model in which such metric might be called <code class=\"language-text\">container.memory_usage_bytes.webapp123</code>. Now you can use wildcards like <code class=\"language-text\">container.memory_usage_bytes.webapp*</code> to graph the memory usage of all your ‘webapp’ containers. Graphite also supports functions like <code class=\"language-text\">sum()</code> to aggregate the memory usage of your application across all your machines by using an expression like <code class=\"language-text\">sum(container.memory_usage_bytes.webapp*)</code>.</p>\n<p>That’s all great and very useful, but limited. What if you don’t want to aggregate all containers with a given name but with a given image? Or you want to compare the deployments to your canary with those on your prod machines?</p>\n<p>It’s possible to come up with a hierarchy for each use case, but not one to support them all. And reality shows, you often don’t know in advance which questions you need to answer once things go dark and you start investigating.</p>\n<h3 id=\"prometheus\" style=\"position:relative;\"><a href=\"#prometheus\" aria-label=\"prometheus permalink\" class=\"anchor before\"></a>Prometheus</h3>\n<p>With Prometheus’s support for dimensional data, you can have global and straightforward metric names like <code class=\"language-text\">container_memory_usage_bytes</code> with multiple dimensions to identify the specific instances of your service.</p>\n<p>I’ve created a simple <a href=\"https://github.com/docker-infra/container_exporter\">container-exporter</a> to gather Docker Container metrics and expose them for Prometheus to consume. This exporter uses the container’s name, id and image as dimensions. Additional per-exporter dimension can be set in the <code class=\"language-text\">prometheus.conf</code>.\nIf you use the metric name directly as a query expression, it will return all time series with their labels for this metric name:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">container_memory_usage_bytes{env=&quot;prod&quot;,id=&quot;23f731ee29ae12fef1ef6726e2fce60e5e37342ee9e35cb47e3c7a24422f9e88&quot;,instance=&quot;http://1.2.3.4:9088/metrics&quot;,job=&quot;container-exporter&quot;,name=&quot;haproxy-exporter-int&quot;,image=&quot;prom/haproxy-exporter:latest&quot;}\t11468800.000000\ncontainer_memory_usage_bytes{env=&quot;prod&quot;,id=&quot;57690ddfd3bb954d59b2d9dcd7379b308fbe999bce057951aa3d45211c0b5f8c&quot;,instance=&quot;http://1.2.3.5:9088/metrics&quot;,job=&quot;container-exporter&quot;,name=&quot;haproxy-exporter&quot;,image=&quot;prom/haproxy-exporter:latest&quot;}\t16809984.000000\ncontainer_memory_usage_bytes{env=&quot;prod&quot;,id=&quot;907ac267ebb3299af08a276e4ea6fd7bf3cb26632889d9394900adc832a302b4&quot;,instance=&quot;http://1.2.3.2:9088/metrics&quot;,job=&quot;container-exporter&quot;,name=&quot;node-exporter&quot;,image=&quot;prom/container-exporter:latest&quot;}\n...\n...</code></pre></div>\n<p>If you run lot of containers, this looks something like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/065a19374aba5620f406a9361ff35444/2e237/container_memory_usage_bytes.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.16564417177914%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACGklEQVQoz4VR2W7aUBD1H/Yb+kl97x/0oVWVhbKENA5LCAlWqHAwYJYEgvF+fX13m47tplJaVT06uvfOmbE8Z0YzTXNkGA8lDMNYr9eUUoxx+gp4ckr2Pnr3Yfz+o5kSyNM8zy3L0lzPdQ4OwHXdOI6hWgGy7BcrZJlUKkI8xhwiIcTxeFzYtrbbboMg3O22K8ByOZvNLGv6G0VUhnAt7fliPoM3NGvbC13XNWe/dz3/4Hoowdvdfrna7B03jGKgH4TrzfPeOXh+AFzYS0glCYliRJmYTEyNEEIZQ+CRsiQlmJAUJMYqQlgojEEWF1laiSrPH6dTDUxKCU6AApgVJ5flqQpdFNmSWSaqUAgGnsFR8XGWZcd/I8//VKr6YmDQI+E0IgixNHlLVDKm+I0IISXqeDRhVWBRKimLVrl6bayyoEpFSsYlK/SqBjYlKfzemj3+v+2/UdXbVduY4BfnefuyQTjyva3ne0yIJHbjcAdDCiLvabeKkXc4OEEYSgFDVeXAZprgcv00H45a40n3ZnR196PTG9b695f3427//qJ3174dNQajdmdQNybXhtm9Hevj6fBhelNrftEY45xhSiJCQkoRFymlIUI+7ENKEoWOFImSKedYqVSKGJiSIEncycQoBmaurJPrxle9ddZptgaN1uCi3m/XB+16/7I11M96l7Veu3nTPL+qn37/dq7XT65qtf7Fp9PPPwEqYAWEaDEQMwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"container_memory_usage_bytes.png\"\n        title=\"container_memory_usage_bytes.png\"\n        src=\"/static/065a19374aba5620f406a9361ff35444/a6d36/container_memory_usage_bytes.png\"\n        srcset=\"/static/065a19374aba5620f406a9361ff35444/222b7/container_memory_usage_bytes.png 163w,\n/static/065a19374aba5620f406a9361ff35444/ff46a/container_memory_usage_bytes.png 325w,\n/static/065a19374aba5620f406a9361ff35444/a6d36/container_memory_usage_bytes.png 650w,\n/static/065a19374aba5620f406a9361ff35444/2e237/container_memory_usage_bytes.png 790w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>To help you make sense of this data, you can filter and/or aggregate these metrics</p>\n<h4 id=\"slice--dice\" style=\"position:relative;\"><a href=\"#slice--dice\" aria-label=\"slice  dice permalink\" class=\"anchor before\"></a>Slice &#x26; Dice</h4>\n<p>With Prometheus’s query language, you can slice and dice data by any dimension you want. If you’re interested in all containers with a given name, you can use an expression like <code class=\"language-text\">container_memory_usage_bytes{name=&quot;consul-server&quot;}</code>, which would show only the time series for which <code class=\"language-text\">name == &quot;consul-server&quot;</code>.\nPrometheus also supports regular expressions, so instead of matching the full script you can do <code class=\"language-text\">container_memory_usage_bytes{name=~&quot;^consul&quot;}</code>, which would show something like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2a7a760e3618b0ac5e2f4d9ba57082c5/0fcea/container_memory_usage_bytes_consul.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.25766871165644%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABeElEQVQoz4VSW27CMBDMeXuNXqVH6FUKSVClIoQohcQhD9u7azudjVtA7QeriTN+rHc8dtH3l9Pp1DZt0zRt2xpjegxdLiwSQkAzp3ju6enl/fl1N89zSnOOlFLRdd3hcDh+HhFIG4bBOWet9d4TkV/COm86ZzrrNNDz+GG8QNnz6bzf73e7XVmWq9WqLKu6rquqAl+v1yDolOu3TV1t6jqjKsuP7bYYhxHFp2nEdm3bGNNiWyYCjOmGvp8mO4zT8fhl+nF0PFjfW7KeY4wFPkdsSQDHQHDgnh0tHJDoOBIJWcvTyHbS1jscW5MRcAEf2owbR4gkZ5N3KQS1awG4Gqaz8CZv+Yu7rhIRoRh9CFeQiFbGhBrH0EloM+65puHGVF26IsSlcpY9PwosjQEpMSPkyqof++JFsMSF3HMQlQEDPQvdwMSajGfEaiUk0m0OPK9mSTH9l4YxlS3LM3yk+e+IXlB2O+hphGFh5KxbIDf88Ny95wv0zN9r5fEh8xVSsAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"container_memory_usage_bytes_consul.png\"\n        title=\"container_memory_usage_bytes_consul.png\"\n        src=\"/static/2a7a760e3618b0ac5e2f4d9ba57082c5/a6d36/container_memory_usage_bytes_consul.png\"\n        srcset=\"/static/2a7a760e3618b0ac5e2f4d9ba57082c5/222b7/container_memory_usage_bytes_consul.png 163w,\n/static/2a7a760e3618b0ac5e2f4d9ba57082c5/ff46a/container_memory_usage_bytes_consul.png 325w,\n/static/2a7a760e3618b0ac5e2f4d9ba57082c5/a6d36/container_memory_usage_bytes_consul.png 650w,\n/static/2a7a760e3618b0ac5e2f4d9ba57082c5/0fcea/container_memory_usage_bytes_consul.png 851w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>You can use any other dimension for filtering as well, so you can get metrics about all containers on a given host, in a given environment or zone.</p>\n<h4 id=\"aggregation\" style=\"position:relative;\"><a href=\"#aggregation\" aria-label=\"aggregation permalink\" class=\"anchor before\"></a>Aggregation</h4>\n<p>Similar to Graphite, Prometheus supports aggregation functions but due to its dimensions this gets even more powerful. Summing up the memory usage of all your “consul-*” works as expected with <code class=\"language-text\">sum(container_memory_usage_bytes{name=~&quot;^consul&quot;})</code>.</p>\n<p>Now let’s say you want to see the difference in average memory usage between your ‘consul’ and ‘consul-server’ containers. This is achieved by providing the dimensions to keep in the aggregated result like this <code class=\"language-text\">avg(container_memory_usage_bytes{name=~&quot;^consul&quot;}) by (name)</code>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b0d3d92bda3203b73787ae1285ca75bc/b2cef/container_memory_usage_bytes_consul_by_name-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.07361963190185%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAABlElEQVQoz5WSy0rDQBSG84x2IT6AuvMRBAtVEStSXfgGWgviShAFF76BQi4KQqXS5p4m6SQzc2bimcS2USvYP3/gn8uXcyaJFkWR67q+7wdBEIYhhjEqjjHjEsmyQkKQ5lvnb9vX/aKQdWm4c2SPHNfxPC8tldfEGAPOKeNOmHlRzjlnpXgpzXEc27YHg0G//26apq7rppJlWS+GYRo63paFY0N/tcxqg1EKsxaPx9hxkiSEENdzPc8nE7zSeBINnQ/HHwaxFyb+YNgPogCAF6WwZ1VZoECUE8ogIQeSwwQkF1IICWipgpCFMCy9tdvaO2g9PN4joQGHnBEKysggibtnjy+mqrI9snu9Xvei+/T8pGB1cKiKKBeyakJ+Z7/42VQVFAwAPyr8zrMZKIUvfDm4PqyQ/8L1npeG/6yMEnPV4B8HruU5jMS3V8KoYAwNlHL6ldGc5rMlmmfq30bg7vbmuL1/dnraaR9eXXZ5RqA0BpomMB3SNOVkUmWWESyp4JPO0drqyvrGZqPR2Gk2F36khfoExtdVxGghHGUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"container_memory_usage_bytes_consul_by_name\"\n        title=\"container_memory_usage_bytes_consul_by_name\"\n        src=\"/static/b0d3d92bda3203b73787ae1285ca75bc/a6d36/container_memory_usage_bytes_consul_by_name-1.png\"\n        srcset=\"/static/b0d3d92bda3203b73787ae1285ca75bc/222b7/container_memory_usage_bytes_consul_by_name-1.png 163w,\n/static/b0d3d92bda3203b73787ae1285ca75bc/ff46a/container_memory_usage_bytes_consul_by_name-1.png 325w,\n/static/b0d3d92bda3203b73787ae1285ca75bc/a6d36/container_memory_usage_bytes_consul_by_name-1.png 650w,\n/static/b0d3d92bda3203b73787ae1285ca75bc/b2cef/container_memory_usage_bytes_consul_by_name-1.png 847w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>If you have services in multiple zones and configure the zone name as an additional label pair, you can also keep that dimension to show the memory usage per name and zone by using an expression like <code class=\"language-text\">avg(container_memory_usage_bytes{name=~&quot;^consul&quot;}) by (name,zone)</code>.</p>\n<h4 id=\"using-prometheus--container-exporter\" style=\"position:relative;\"><a href=\"#using-prometheus--container-exporter\" aria-label=\"using prometheus  container exporter permalink\" class=\"anchor before\"></a>Using Prometheus + Container-Exporter</h4>\n<p>As you know, I like to run everything in containers, including the container-exporter and Prometheus itself. Running the <a href=\"https://github.com/docker-infra/container_exporter\">container-exporter</a> should be as easy as this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker run -p 8080:8080 -v /sys/fs/cgroup:/cgroup \\\n           -v /var/run/docker.sock:/var/run/docker.sock prom/container-exporter</code></pre></div>\n<p>Now you need to install Prometheus. For that refer to the <a href=\"http://prometheus.github.io/docs/introduction/install/\">official documentation</a>. To make Prometheus pull the metrics from the container-exporter, you need to add it as a target to the configuration. For example:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">job: {\n  name: &quot;container-exporter&quot;\n  scrape_interval: &quot;1m&quot;\n  target_group: {\n  \tlabels: {\n\t    label: {\n    \t\tname: &quot;zone&quot;\n        \tvalue: &quot;us-east-1&quot;\n\t    }\n        label: {\n        \tname: &quot;env&quot;\n            value: &quot;prod&quot;\n        }\n    }\n    target: &quot;http://1.2.3.4:8080/metrics&quot;\n  }\n}</code></pre></div>\n<p>Now rebuild your image as described in the documentation and start it. Prometheus should now poll your container-exporter every 60s.</p>\n<h3 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"></a>Conclusion</h3>\n<p>Because of Prometheus flexibility, its performance and minimal requirements, it’s the monitoring system of my choice.\nThis is why I introduced Prometheus beginning last year at Docker where we use it as our primary monitoring system.</p>","frontmatter":{"title":"Monitor Docker Containers with Prometheus","date":"January 26, 2015","image":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAAC3ElEQVQ4y4VRi27bRhC87wr6f0XRGI5s1f6FxE0NIUBRIGgKOLWiyNSLpKTIok0yFHW0RPKOInl3fJ6zUhLHrR1kOFjszs09lou63a6iKJ3O+3a7ralqHMeb74DQqM6S4zfmT78oT35WXqse8gDYW2IcRRE4pJS338HnlTnOXl1Q4A0tUBAEhJAwJJzzZAf2X6Rpei9nZc5vpbitRSYYcl13NpvZtj2dTic76Lquad8IyniHL4o+1scTVdNVVUNhGFBCoFXLNA3DWDgfPYx9f+1vsQ4C/8owXHeBl8vVagXS0l3M55dwJaUErcIoSvgmFTcBxevQpzFNeMLzO4IYRkkYpeCBEpLljQ+R5RUqiiLL8ywXIuNlVQrBGE+A257YNpZVVZRFDr4SnAJY7hLOGcozVuQcTgApz3ldF1UF/hKUuq7KEg5mQJGlGTgLAfrODKdl6LGRPDYt+YgNFZV8fKBf07KWRVVDfGhDQUIoTyPB7vit5ClhG5JSkhA/ppR/9fAvNiRlJYo0K9gdRX5Xcrhy92JZVfk9G/9sQ1L+oGeo6lo+/BHbnh/ukfJ/Vrn9dsp9va5rFKcbb41jlkDNUhrHUZYXkMN0C5HUJdttljDmkAZlVVRlRqMIBngrazTSO6p61h8P1On7/uh8pLfV2eDauTJNXRn8o2rnHjYM+/Ls3at3vbP+8O1Q62jj3kjrTWY6urxS7MVkOu9o0/4Hazg2e0rvz/bF667WcVZWZ/T2TffvjvLXlT2YzpWh/u/F5Px60Z87g+HsHMXxCkiIyxm8eZ0mPqV4s/HTlDIWMBZGZJlsvExsElhNg0xQzgnjIWMEWZ576Tgjw7p2Hdv7aHuOhRcWXlrYNbeJa6+w6WETu5bn2d7CWrrgNUzDcW309EVj76TReNlsnh4ctfaPWweHfzT2njcOW83D1m8Hp0fN1tGz0+O9F43935vN1n7z5bP9k8OnJ0e/Pm9+AoAWSWCzqfBYAAAAAElFTkSuQmCC","width":790,"height":790,"src":"/static/065a19374aba5620f406a9361ff35444/fc072/container_memory_usage_bytes.png","srcSet":"/static/065a19374aba5620f406a9361ff35444/fc072/container_memory_usage_bytes.png 1x"}}}}}},"pageContext":{"slug":"/2015/01/26/monitor-docker-containers-with-prometheus/","previous":{"fields":{"slug":"/2015/01/08/containerized-infrastructure/"},"frontmatter":{"title":"Containerize your Infrastructure"}},"next":{"fields":{"slug":"/2015/01/27/find-ghosts-in-your-docker-images/"},"frontmatter":{"title":"Find GHOSTs in your Docker images"}}}}}