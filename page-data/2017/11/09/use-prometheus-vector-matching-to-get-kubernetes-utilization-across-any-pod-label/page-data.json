{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017/11/09/use-prometheus-vector-matching-to-get-kubernetes-utilization-across-any-pod-label/","result":{"data":{"site":{"siteMetadata":{"title":"5π Consulting","author":"Johannes 'fish' Ziemke"}},"markdownRemark":{"id":"21b75828-4319-5f03-b011-11a7bff52344","html":"<p>Prometheus was designed for dynamic environments like Kubernetes. Its powerful\nservice discovery and query language allows you to answer all kind of questions\nthat come up while operating a Kubernetes cluster.</p>\n<p>This flexibility comes with a somewhat steeper learning curve than some\nalternatives and hosted services, with <a href=\"https://prometheus.io/docs/prometheus/latest/querying/operators/#vector-matching\">Vector\nMatching</a>\nbeing one of the more advanced topics.</p>\n<p>I’m not going into the details which the excellent <a href=\"https://prometheus.io/docs/prometheus/latest/querying/operators/#vector-matching\">Prometheus\nDocumentation</a>\nhas already covered but walk you through some useful queries to get resource\nutilization in a Kubernetes cluster.</p>\n<h2 id=\"aggregated-memory-usage-per-label\" style=\"position:relative;\"><a href=\"#aggregated-memory-usage-per-label\" aria-label=\"aggregated memory usage per label permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Aggregated memory usage per label</h2>\n<p>Kubernetes provides a <code class=\"language-text\">container_memory_usage_bytes</code> metric reflecting each pods\nmemory usage, e.g:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">...\ncontainer_memory_usage_bytes{beta_kubernetes_io_arch=\"amd64\",beta_kubernetes_io_fluentd_ds_ready=\"true\",beta_kubernetes_io_instance_type=\"g1-small\",beta_kubernetes_io_os=\"linux\",cloud_google_com_gke_nodepool=\"small-preemptible\",cloud_google_com_gke_preemptible=\"true\",container_name=\"POD\",failure_domain_beta_kubernetes_io_region=\"us-east1\",failure_domain_beta_kubernetes_io_zone=\"us-east1-c\",id=\"/kubepods/burstable/pod13d4221c-c484-11e7-bff5-42010af0018b/67e5bb069ab9881ff8a55b8628ef4935b0d1ace09c18df20db059522bdfd5b7d\",image=\"gcr.io/google_containers/pause-amd64:3.0\",instance=\"gke-latency-at-small-preemptible-0c981b61-9489\",job=\"kubernetes-cadvisor\",kubernetes_io_hostname=\"gke-latency-at-small-preemptible-0c981b61-9489\",name=\"k8s_POD_latency-api-971504058-jzs5h_default_13d4221c-c484-11e7-bff5-42010af0018b_0\",namespace=\"default\",pod_name=\"latency-api-971504058-jzs5h\"}\t389120\ncontainer_memory_usage_bytes{beta_kubernetes_io_arch=\"amd64\",beta_kubernetes_io_fluentd_ds_ready=\"true\",beta_kubernetes_io_instance_type=\"g1-small\",beta_kubernetes_io_os=\"linux\",cloud_google_com_gke_nodepool=\"small-preemptible\",cloud_google_com_gke_preemptible=\"true\",container_name=\"POD\",failure_domain_beta_kubernetes_io_region=\"us-east1\",failure_domain_beta_kubernetes_io_zone=\"us-east1-c\",id=\"/kubepods/burstable/pod81d0f651-c500-11e7-bff5-42010af0018b/309e05b118e618122c70ccf88538d13ca41c3b5a770d5d67882426854391c23c\",image=\"gcr.io/google_containers/pause-amd64:3.0\",instance=\"gke-latency-at-small-preemptible-0c981b61-9489\",job=\"kubernetes-cadvisor\",kubernetes_io_hostname=\"gke-latency-at-small-preemptible-0c981b61-9489\",name=\"k8s_POD_latency-api-971504058-gszpw_default_81d0f651-c500-11e7-bff5-42010af0018b_0\",namespace=\"default\",pod_name=\"latency-api-971504058-gszpw\"}\t372736\ncontainer_memory_usage_bytes{beta_kubernetes_io_arch=\"amd64\",beta_kubernetes_io_fluentd_ds_ready=\"true\",beta_kubernetes_io_instance_type=\"g1-small\",beta_kubernetes_io_os=\"linux\",cloud_google_com_gke_nodepool=\"small-preemptible\",cloud_google_com_gke_preemptible=\"true\",container_name=\"latency-api\",failure_domain_beta_kubernetes_io_region=\"us-east1\",failure_domain_beta_kubernetes_io_zone=\"us-east1-c\",id=\"/kubepods/burstable/pod13d4221c-c484-11e7-bff5-42010af0018b/497e6fdf2217771cb3f52e6fef93734d023f0e7f23f92c58d22139fc18dc5f13\",image=\"registry.gitlab.com/latency.at/latencyat@sha256:8ea057e064b64cc9c8459a68ef3f6d0fc26169b4f57aef193831779e1fe713d4\",instance=\"gke-latency-at-small-preemptible-0c981b61-9489\",job=\"kubernetes-cadvisor\",kubernetes_io_hostname=\"gke-latency-at-small-preemptible-0c981b61-9489\",name=\"k8s_latency-api_latency-api-971504058-jzs5h_default_13d4221c-c484-11e7-bff5-42010af0018b_1\",namespace=\"default\",pod_name=\"latency-api-971504058-jzs5h\"}\t11014144\ncontainer_memory_usage_bytes{beta_kubernetes_io_arch=\"amd64\",beta_kubernetes_io_fluentd_ds_ready=\"true\",beta_kubernetes_io_instance_type=\"g1-small\",beta_kubernetes_io_os=\"linux\",cloud_google_com_gke_nodepool=\"small-preemptible\",cloud_google_com_gke_preemptible=\"true\",container_name=\"latency-api\",failure_domain_beta_kubernetes_io_region=\"us-east1\",failure_domain_beta_kubernetes_io_zone=\"us-east1-c\",id=\"/kubepods/burstable/pod81d0f651-c500-11e7-bff5-42010af0018b/7b438a8e9df0cf1ab29d067fd36c97099f9f5e7e9257f6187c5be6bff846a62c\",image=\"registry.gitlab.com/latency.at/latencyat@sha256:8ea057e064b64cc9c8459a68ef3f6d0fc26169b4f57aef193831779e1fe713d4\",instance=\"gke-latency-at-small-preemptible-0c981b61-9489\",job=\"kubernetes-cadvisor\",kubernetes_io_hostname=\"gke-latency-at-small-preemptible-0c981b61-9489\",name=\"k8s_latency-api_latency-api-971504058-gszpw_default_81d0f651-c500-11e7-bff5-42010af0018b_0\",namespace=\"default\",pod_name=\"latency-api-971504058-gszpw\"}\t11448320\n...</code></pre></div>\n<p>Unfortunately it doesn’t contain the pod labels. For that there is the\n<code class=\"language-text\">kube_pod_labels</code> though which includes a static timeseries with all labels and\nthe pod name. This metric is provided by\n<a href=\"https://github.com/kubernetes/kube-state-metrics\">kube-state-metrics</a>.</p>\n<p>We can use it to look up the labels for the pod from the\ntimeseries (<code class=\"language-text\">pod_name=\"latency-api-971504058-jzs5h\"</code>):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kube_pod_labels{instance=\"10.116.0.12:8080\",job=\"kubernetes-service-endpoints\",k8s_app=\"kube-state-metrics\",kubernetes_name=\"kube-state-metrics\",kubernetes_namespace=\"kube-system\",label_app=\"latency-api\",label_pod_template_hash=\"971504058\",namespace=\"default\",pod=\"latency-api-971504058-jzs5h\"} 1\nkube_pod_labels{instance=\"10.116.1.26:8080\",job=\"kubernetes-service-endpoints\",k8s_app=\"kube-state-metrics\",kubernetes_name=\"kube-state-metrics\",kubernetes_namespace=\"kube-system\",label_app=\"latency-api\",label_pod_template_hash=\"971504058\",namespace=\"default\",pod=\"latency-api-971504058-jzs5h\"} 1</code></pre></div>\n<p>Both metrics can be merged by using vector matching. We get this metric twice\nbecause there are two instances of kube-state-metrics running. So before we\ncontinue further, we aggregate both. Since they should be identical, we can use\nmin/max to aggregate. Since we later want to aggregate on <code class=\"language-text\">label_app</code>, we need\nto keep that label. We also need to keep the <code class=\"language-text\">pod</code> label to join both metrics\non. We can preserve them by specifying them in the BY clause. Since the pod\nlabel is called <code class=\"language-text\">pod</code> in <code class=\"language-text\">kube_pod_labels</code> but <code class=\"language-text\">pod_name</code> in\n<code class=\"language-text\">container_memory_usage_bytes</code>, we need to also use label_replace to rename the\nlabel. This gives us:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">max by (pod_name,label_app) (\n  label_replace(kube_pod_labels{label_app!=\"\"},\"pod_name\",\"$1\",\"pod\",\"(.*)\")\n)</code></pre></div>\n<p>Which returns something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">...\n{label_app=\"latency-api\",pod_name=\"latency-api-971504058-n8k6d\"}  1\n{label_app=\"latency-api\",pod_name=\"latency-api-971504058-jzs5h\"}  1\n...</code></pre></div>\n<p>Now we can use vector matching to join <code class=\"language-text\">container_memory_usage_bytes</code> with the\nresult of our expression. We use the <code class=\"language-text\">*</code> operator which effectivly is a no-op\nsince it will multiply the memory usage by the matched timeseries value in\n<code class=\"language-text\">kube_pod_labels</code> which is always 1.</p>\n<p>We need to specify <code class=\"language-text\">group_left</code> because there are multiple\n<code class=\"language-text\">container_memory_usage_bytes</code> timeseries for each pod, one for each container.\nSince we want to preserve the <code class=\"language-text\">label_app</code> label, we specify it as argument to <code class=\"language-text\">group_left</code>.</p>\n<p>This gives us:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  container_memory_usage_bytes * on (pod_name) group_left(label_app)\n  max by (pod_name,label_app) (\n    label_replace(kube_pod_labels{label_app!=\"\"},\"pod_name\",\"$1\",\"pod\",\"(.*)\")\n  )</code></pre></div>\n<p>To aggregated the memory usage of all your pods, summed by a <code class=\"language-text\">k8s-app</code> label you\ncan use the following expression:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sum by (label_app,namespace) (\n  container_memory_usage_bytes * on (pod_name) group_left(label_app)\n  max by (pod_name,label_app) (\n    label_replace(kube_pod_labels{label_app!=\"\"},\"pod_name\",\"$1\",\"pod\",\"(.*)\")\n  )\n)</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0f0a37acb794c49740014ce150e3ae1f/587b0/mem_per_app.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.14110429447852%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACVUlEQVR42pVUS24aQRDlHkiIHdvIIrBhIEL8BAryghUYuEAUywoiyjYLH8SRI0GOkGTjXCThY1s2AUdmZrp7Pi9VNQQT2xtGeuqq6q5XVY9uYggBz/fgKhe+70MpBcdxYNs21us1jDHwPE/iruuKz/tsh2G4BX+cH2PHaEoyHoIgkKBPK5Mw2N/GvciWONm7hMJDxYRQOS60o6QKdxwGD1V3v8exkMhDnwooA6M0tNaIBX5U3bgaylbwqFtNK/ucgPCBjP2AzwqB2RAZMAc3se2Qx+CAZ6JNTnJIP71W0rnRXIynIA1JSz7H4EaifF8ghKyXph/EaErewGiXRLeF9O5mAeU6AmO0nPM8TTAUs+k8FVLOJp9GZlZGiPCJXtL5TvyJhuH/Wm9HNnwdHFugeaUrY7gjAmvq0Zi+QMOnLgKyGSHtBQIt+yyNEK7uVrj5fYvb5QKLFWFJNvm82vY9/twvMb+eYXY1w/xqjimtk8sJfs1/EiaYzqeYXs5gUzMxbvXixwXOPp1h/GWM8XiM0XgUYTTC+edzfPv+lS4/XWjRjLQykdaK9IugIn15ZCY8Pn6Dg4MXKBRewcpZyOVyyOfzyGQySCQSaLVaz2r4+JOXwsa7wXtY+QKazdeo1+uCRqNBBQpIpVLodrv7EQ4/DGAVckJUrVZRq9UE3GE8HsfR0dGehIMB8pa1JWRUKhVks1kkk0l0Op39CN+enOAlJZfLZRSLRZRKJVhUIJ1Oy8h7E56efsThYRO9Xk+SecR2u41+v0+6NjEcDiXh37/Pc+BHwC/lLzgPcpKg3PltAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"mem_per_app\"\n        title=\"\"\n        src=\"/static/0f0a37acb794c49740014ce150e3ae1f/a6d36/mem_per_app.png\"\n        srcset=\"/static/0f0a37acb794c49740014ce150e3ae1f/222b7/mem_per_app.png 163w,\n/static/0f0a37acb794c49740014ce150e3ae1f/ff46a/mem_per_app.png 325w,\n/static/0f0a37acb794c49740014ce150e3ae1f/a6d36/mem_per_app.png 650w,\n/static/0f0a37acb794c49740014ce150e3ae1f/587b0/mem_per_app.png 970w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"cpu-and-io-usage-per-label\" style=\"position:relative;\"><a href=\"#cpu-and-io-usage-per-label\" aria-label=\"cpu and io usage per label permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CPU and IO usage per label</h2>\n<p>Now that we know how to join the <code class=\"language-text\">kube_pod_labels</code> metric with cadvisor metrics,\nwe can figure out usage of other resources too.</p>\n<h3 id=\"cpu\" style=\"position:relative;\"><a href=\"#cpu\" aria-label=\"cpu permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CPU</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sum by (label_app,namespace) (\n  rate(container_cpu_usage_seconds_total[2m]) * on (pod_name) group_left(label_app)\n  max by (pod_name,label_app) (\n    label_replace(kube_pod_labels{label_app!=\"\"},\"pod_name\",\"$1\",\"pod\",\"(.*)\")\n  )\n)</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ee8bde4b930678ada8505a9cc8e749ba/587b0/cpu_per_app.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.14110429447852%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACUklEQVR42pVUS08aURTmf5AYdm4bI7DhkRAUIilxwQoE/kBjY0pouu3CP1LDorjrCuujr5jWGFGKFltsoI3DG3nNDMMAX8+94xhwoeUmH+dx7/3OY87FAFqqqkKWZQyHQ/T7fa6Looher4fBYMD3dT+zJUni+v3F7hvYDzvE5Gg04pIRMOj+Sd+kzs5Pgp036CT/s8bj8YN7iqJoGT5GqBOx4GRx6Nz6nqr2qS2SRsjSf4hsOrPxhE8H0G4L1POb2wzV4STDlFSUHlUw4NkxXZKaZCuki+RjH6vDURIy6HYb0xnKskg8o9vytCCydEORa4Q6yuVzlErsYgUi2Yy8Uc+jWvmBYuGQJqOlEfY6XYitLqqCgHaTCNpd1K4FtGoNFPJHuLw4wN9CGr9yu8hfHqD4+yv5D1G8+sbl5XkKPy/eE2EbBtaLTquBZk3gqFeKqJQLaFavSf+DwtURcrmPyGb2cXKyg8zZLs5OUzg+fodMegdZsk/TKWS/f0CvS4SsrM9fPmFr6w22t5NIJt9q4HoSiUQCe3v7fBJkGu7BgM0gtYm3Sp9JzeZzyAifrz/DwsITOJ1O2Gw2DofdAbPZgrm5OQQCgUfn8O6lMOVF7CXsDif8/qdYWVnh8Pl8PMD8/DzC4fBshPFXMdidNk7k8Xjg9Xo5LBYLjEYj1tbWZiSMxahE+x0hw/LyMqxWK0wmE0Kh0GyE6xsbMNPlpaUluFwuuN1u2CnA4uIiL3lmws3N11hd9SMSifDLrMRgMIhoNEp99SMej0P/m9Pf/n1oL0nBPzCdaEPlmdyaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cpu_per_app\"\n        title=\"\"\n        src=\"/static/ee8bde4b930678ada8505a9cc8e749ba/a6d36/cpu_per_app.png\"\n        srcset=\"/static/ee8bde4b930678ada8505a9cc8e749ba/222b7/cpu_per_app.png 163w,\n/static/ee8bde4b930678ada8505a9cc8e749ba/ff46a/cpu_per_app.png 325w,\n/static/ee8bde4b930678ada8505a9cc8e749ba/a6d36/cpu_per_app.png 650w,\n/static/ee8bde4b930678ada8505a9cc8e749ba/587b0/cpu_per_app.png 970w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3 id=\"disk-io\" style=\"position:relative;\"><a href=\"#disk-io\" aria-label=\"disk io permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disk IO</h3>\n<p>I wanted to show you some disk IO stats too. Unfortunately these are\n<a href=\"https://github.com/kubernetes/kubernetes/issues/55397\">broken</a> once\n<a href=\"https://github.com/kubernetes/kubernetes/issues/55398\">again</a> in Kubernetes.</p>\n<h3 id=\"network\" style=\"position:relative;\"><a href=\"#network\" aria-label=\"network permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Network</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sum by (label_app,namespace) (\n  rate(container_network_transmit_bytes_total[2m]) * on (pod_name) group_left(label_app)\n  max by (pod_name,label_app) (\n    label_replace(kube_pod_labels{label_app!=\"\"},\"pod_name\",\"$1\",\"pod\",\"(.*)\")\n  )\n)</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9cdc5336080b286047c358a645a9a8ed/587b0/net_per_app.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.14110429447852%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACAUlEQVR42pWUyW4aQRCG5z2QEDeuScRyYRgJsQlk5AMn1heIHFlGRL764BfJnOAVuPEsVqQkMAzMvv2pamh7iB0JWvyiu6j6uqqmGCVJEgRBANd1EUURPM+D4ziwbRuWZcH3fYRhKOzsw778O4tjpXhxvMLOHMSHOI4R0TmkILZzMNtZfGal9+yfFvsrAkJOciUc5Ln4aMlM/rcEUN4oV8wlWgdJOJbiUnl08UXAfzOMfQ/hYX8GDPc7AUylSp/4UqD/HmgaBEz5BNRzxz7zeQUGpwdwnqF5DtwRkC+VLaAeSx+RKdtP06JwX6LorT8RjUewN8Enzp6/fWMrgDKZ2PNSwOR9yTwmMWXJQZxhZFtUFj1tKo0prrHBbvNHyKRsjd+/YPx8gWkYMLcbsm1xoD7zrCpMXq/X0PUfWC4XWCwWWLJOe13XsVqtqIqQBtuhmaUK6CLOJqB+S4Xh0SaA3+6+4svnT9A0DZVKRUhVqygWS8hms+j3+xfNofin8OZh9h1qVUOvd4NOpyPU7XbFBfl8HuPx+Drg/HEGVasIUKvVQrvdFiqVSshkMhiNRlcCZzNUVfUVyGo2myiXy8jlchgOh9cB7+7vUaTgRqOBWq2Ger1OPVRRKBREyVcDn5+fcHvbw2QyEcFc4mAwwHQ6pb72MJ/PjwN+ett8JB4/fmv9BQQLd2I/xMCtAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"net_per_app\"\n        title=\"\"\n        src=\"/static/9cdc5336080b286047c358a645a9a8ed/a6d36/net_per_app.png\"\n        srcset=\"/static/9cdc5336080b286047c358a645a9a8ed/222b7/net_per_app.png 163w,\n/static/9cdc5336080b286047c358a645a9a8ed/ff46a/net_per_app.png 325w,\n/static/9cdc5336080b286047c358a645a9a8ed/a6d36/net_per_app.png 650w,\n/static/9cdc5336080b286047c358a645a9a8ed/587b0/net_per_app.png 970w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>","frontmatter":{"title":"Use Prometheus Vector Matching to get Kubernetes Utilization across any Pod Label","date":"November 09, 2017","image":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC80lEQVR42pVUS0+aURDlf7hQN7pSQkmlgBSjgg8QFo2SdOPCx19TsVvbP6FxYd1JKA9FSivyvd+nMwNYNGrtR05m7uvMuWduCAVBAN/3YZomLMt6lOu6Dk3ToKqqjHkvR17nNdd1Yds2er2e5PyFeJPneXAcRzCa8+Yh+MDTNZ7jnItwzmJCzOpYNkzVgOd6UoWLvPaNrj/dKwqlEpFauvmwySc1ru28SPiUKCB1fCbEMm3H7ntHKk1Vh22YBAtGT5ODHhUMfCLBXxLfIwK6kWOSJSTEMWw58+Ahb2VSz/GkGh9mxZZORRSDbuD0yWmdiwo0HQ57OfA+CNhDYnJdhybpypZBIHU2gaJp6DAMFYai4e7mJ3RFgdK9k3nbtqghDLMfaWzoKkKO49LTUIXAk071FXIhVsTzhq4JfFIw9C+Q9UFTgqENAw+5KY86ByB4pqvD+dGmPJqjX//ZsA+kwFI12OSLbxo01iVneHTFgHwSkGKfHrZrMAz4NEd+AfzwCULYVe7x46aORvsajVaT8gZqNK63ONYIDXQ6HXR+tVFv077bBprtJsUmao0aKrUrVJpVXDUqfcJejwirVVQrFTQbdKBeE3AuY8J16xqt2xvc97riebf7m6ICjW6mUFTUHkHpE56cnKBQzKFUKmFzc1OwtcXYkrlCoYDV1VXMJ+dx+f1SvPPoHT73CeHhwQGikTAWFxeRTqexsLAg4JwxNzeHaDSKsbExnJ2dDQi9lwnL5WN8iH9EPp/D2toa1tfXRdEwj8ViiEQimJycxPn5ef+J+K8oLH8pI51NoVgsIpfPI5fLyTU3NjaENBwOY2pqCuPj428kLB9hPhETNZlMRtRls1msrKzIOB6PY2Zm5n8IjxF7Hxc17COTLC0tSUylUqJwdnYWExMTbyM8ODrEu8QcMsvLQjQkZSQSCVGYTCYxPT2N09PTfzfl27ev+Fz6hN3dXezs7Ejc29uTnLG/v4/t7W1qWh4XFxdykP+lh//eo/gDoMhpMExMvy0AAAAASUVORK5CYII=","width":970,"height":970,"src":"/static/0f0a37acb794c49740014ce150e3ae1f/0600f/mem_per_app.png","srcSet":"/static/0f0a37acb794c49740014ce150e3ae1f/0600f/mem_per_app.png 1x"}}}}}},"pageContext":{"slug":"/2017/11/09/use-prometheus-vector-matching-to-get-kubernetes-utilization-across-any-pod-label/","previous":{"fields":{"slug":"/2017/04/17/selenium-webdriver-chromedriver-nightwatch-chrome-headless/"},"frontmatter":{"title":"Frontend Testing Zoo - Or, Nightwatch without Selenium"}},"next":{"fields":{"slug":"/2017/12/15/production-grade-kubernetes/"},"frontmatter":{"title":"Production Grade Kubernetes"}}}},"staticQueryHashes":[],"slicesMap":{}}