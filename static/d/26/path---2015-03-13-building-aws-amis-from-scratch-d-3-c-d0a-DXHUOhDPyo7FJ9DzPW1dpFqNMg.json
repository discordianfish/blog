{"data":{"site":{"siteMetadata":{"title":"5π Consulting","author":"Johannes 'fish' Ziemke"}},"markdownRemark":{"id":"29d318d4-77ab-5b05-af3b-104d568cd50a","html":"<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/Rahn_Kloster_Sanct_Gallen_nach_Lasius_700-7183da7353128252eb634f7ebc882360-ebf7e.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 650px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 60%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHYW6QGD//EABgQAAMBAQAAAAAAAAAAAAAAAAABAhEQ/9oACAEBAAEFAqvBU2aOV3//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAaEAEAAwADAAAAAAAAAAAAAAABABEhEDFh/9oACAEBAAE/IbCV1NQL8gq0jEU0lHH/2gAMAwEAAgADAAAAEEAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAAIDAQEAAAAAAAAAAAAAAQARIUFRMYH/2gAIAQEAAT8Qe1Crt2TLIL41GlUeDA2OA+wsCgDkCp//2Q=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Image\"\n        title=\"\"\n        src=\"/static/Rahn_Kloster_Sanct_Gallen_nach_Lasius_700-7183da7353128252eb634f7ebc882360-b80fa.jpg\"\n        srcset=\"/static/Rahn_Kloster_Sanct_Gallen_nach_Lasius_700-7183da7353128252eb634f7ebc882360-cf410.jpg 163w,\n/static/Rahn_Kloster_Sanct_Gallen_nach_Lasius_700-7183da7353128252eb634f7ebc882360-62f2a.jpg 325w,\n/static/Rahn_Kloster_Sanct_Gallen_nach_Lasius_700-7183da7353128252eb634f7ebc882360-b80fa.jpg 650w,\n/static/Rahn_Kloster_Sanct_Gallen_nach_Lasius_700-7183da7353128252eb634f7ebc882360-ebf7e.jpg 700w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h1>Why?</h1>\n<p>I’m a big fan of what some might call “immutable infrastructures” which, to me, boils down to manging complexity by isolating change to specific points in the life cycle of your services.\nIn practice this might mean you build your application image once and just recreate it if you need to update it.\nOr you install your complete server once and just recreate it if you need to update it. Where this is harder on bare metal, AWS is a nice platform for this kind of immutable servers since it supports creating and running pre-built Amazon Machine Images.</p>\n<p>In general there are two ways to build AMIs: Spinning up a new instance, customize it and create a snapshot or build the AMI from scratch.</p>\n<p>The first option seems to be the most common case. There are several tools like <a href=\"https://www.packer.io/\">packer</a> or Netflix’ <a href=\"https://github.com/Netflix/aminator\">aminator</a> but since it requires to actually boot a existing AMIs, it has a few downsides. For once it requires a existing AMI which might include things you don’t need but I’m more worried about the fact that it requires to actually boot a machine. This breaks the clean separation of build- and runtime and might mess up your build artefacts. Think logfiles, dhcp/cloud-init configuration and so on. Sure, you can clean up those things but I prefer avoiding it in the first place by never entering the runtime before actual deployment.\nUnfortunately, there isn’t very good tooling nor documentation around that, so I thought I share my findings with you.\nMaybe it sparks the interest in building some good tooling around that - or maybe I get to it at some point.</p>\n<h1>Building the image</h1>\n<p>There are <a href=\"http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/virtualization_types.html\">PV and HVM instances</a> where from a AMI building perspective the biggest difference is that PV AMIs consist of a <em>filesystem</em> image and a AKI (Amazon “kernel” image) reference. That kernel isn’t really a kernel but in fact pv-grub, a modified grub which, depending on the AKI, assumes a grub config in <code class=\"language-text\">(hd0)/boot/grub/menu.lst</code> to chainload the specified kernel.</p>\n<p>A HVM image on the other hand is a <em>disk</em> image with a MBR that gets executed on boot.</p>\n<h2>Paravirtual</h2>\n<p>Apparently HVM is the future, so feel free to skip this section.</p>\n<p>Creating a PV image is simple. This creates a 10G sparse file with ext4 filesystem and a label ‘root’. </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">dd if=/dev/zero of=filesystem.img bs=1 count=0 seek=10G\nmkfs.ext4 -L root -F filesystem.img</code></pre></div>\n<p>Now you you can mount that image, install your OS (debootstrap comes handy) and create a menu.lst. You probably also want to install cloud-init to take care of your networking and fstab setup. You need to refer to the filesystem label you specified running <code class=\"language-text\">mkfs.ext4 -L</code>. Something like this should do it:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">default 0\nfallback 1\ntimeout 0\nhiddenmenu\n\ntitle My-AMI\nroot (hd0)\nkernel /boot/vmlinuz root=LABEL=root console=hvc0\ninitrd /boot/initrd.gz</code></pre></div>\n<h2>HVM</h2>\n<p>HVM images are a bit more tricky, since we need to create a complete disk image including partition and MBR:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">dd if=/dev/zero of=disk.img bs=1 count=0 seek=$SIZE \nfdisk filesystem.img &lt;&lt; EOF\nn\np\n1\n\n\nw\nEOF\nDEV_DISK=$(losetup -f --show disk.img)\nDEV=/dev/mapper/$(kpartx -av $DEV_DISK | cut -d&#39; &#39; -f3)</code></pre></div>\n<p>Now you can mount <code class=\"language-text\">$DEV</code> and install your OS. Running <code class=\"language-text\">update-grub</code>/<code class=\"language-text\">grub-mkconfig</code> should detect and use the disk images UUID. On some systems it seems to require a unmount/detach and remount of the disk image, otherwise you end up with <code class=\"language-text\">root=</code> pointing <code class=\"language-text\">/dev/loopX</code>. To detach the mappings and loop device once you’re done, run:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kpartx -d $DEV_DISK\nlosetup -d $DEV_DISK</code></pre></div>\n<p>After that, you need to install grub to the MBR of the disk image by running:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">grub-install disk.img --root-directory $PWD/mnt</code></pre></div>\n<p><em>Note: Took me some time to figure out that —root-directory needs an absolute path.</em></p>\n<h1>Bundle, Upload and register AMI</h1>\n<p>For some reasons there is no way to bundle and upload images with the new <code class=\"language-text\">aws</code> cli, so we’re using the old AWS tools.\n<code class=\"language-text\">ec2-bundle-image</code> will turn the disk or filesystem images into bundles ready to be uploaded to S3 by <code class=\"language-text\">ec2-upload-bundle</code>. Now you just need to register your AMI with <code class=\"language-text\">aws ec2 register-image</code> and make sure <code class=\"language-text\">--virtualization-type</code> matches the kind of image you built.\nIf you run in multiple regions, you can use <code class=\"language-text\">aws ec2 copy-image</code> to replicate your AMIs across regions.</p>\n<h1>Debugging</h1>\n<p>If you’re AMI doesn’t boot, you can get the console output by running <code class=\"language-text\">aws ec2 get-console-output --instance-id ...</code>. This is encoded as json but you can use the great tool <code class=\"language-text\">jq</code> to get just the output including all it’s ANSI colored glory like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aws ec2 get-console-output --instance-id ... | jq -r .Output</code></pre></div>\n<p>If you don’t want to wait for your ec2 instance at all, you can also just test the images locally. For HVM this is trivial. Just run <code class=\"language-text\">kvm disk.img</code> or <code class=\"language-text\">qemu disk.img</code>.</p>\n<h1>Automation and Integration</h1>\n<p>Right now I’m using a, pretty messy, Makefile to automate all this. It takes some files and a provisioner script to customize the AMIs. The general idea is to use some CI server to build fresh AMIs on every push and to just recreate your EC2 instances with the new AMIs once you want to roll out your changes.\nIt would be great to have proper tooling for all this. Packer looks promising, just misses a way to build from scratch.</p>","frontmatter":{"title":"Building AWS AMIs from Scratch for Immutable Infrastructures","date":"March 13, 2015","image":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHYW6QGD//EABgQAAMBAQAAAAAAAAAAAAAAAAABAhEQ/9oACAEBAAEFAqvBU2aOV3//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAaEAEAAwADAAAAAAAAAAAAAAABABEhEDFh/9oACAEBAAE/IbCV1NQL8gq0jEU0lHH/2gAMAwEAAgADAAAAEEAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAAIDAQEAAAAAAAAAAAAAAQARIUFRMYH/2gAIAQEAAT8Qe1Crt2TLIL41GlUeDA2OA+wsCgDkCp//2Q==","width":700,"height":700,"src":"/static/Rahn_Kloster_Sanct_Gallen_nach_Lasius_700-7183da7353128252eb634f7ebc882360-d811c.jpg","srcSet":"/static/Rahn_Kloster_Sanct_Gallen_nach_Lasius_700-7183da7353128252eb634f7ebc882360-d811c.jpg 1x"}}}}}},"pageContext":{"slug":"/2015/03/13/building-aws-amis-from-scratch/","previous":{"fields":{"slug":"/2015/02/10/prometheus-on-raspberry-pi/"},"frontmatter":{"title":"Prometheus on Raspberry Pi"}},"next":{"fields":{"slug":"/2015/04/22/scope-and-ownership-in-tech-companies/"},"frontmatter":{"title":"Scope and Ownership in Tech Companies"}}}}