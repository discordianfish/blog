{"componentChunkName":"component---src-templates-blog-post-js","path":"/2015/02/10/prometheus-on-raspberry-pi/","result":{"data":{"site":{"siteMetadata":{"title":"5π Consulting","author":"Johannes 'fish' Ziemke"}},"markdownRemark":{"id":"4370d429-e2c3-563a-94ed-1ac5e17ffec9","html":"<h1 id=\"prometheus\" style=\"position:relative;\"><a href=\"#prometheus\" aria-label=\"prometheus permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Prometheus</h1>\n<p><a href=\"http://prometheus.io\">Prometheus</a> is a new open-source service monitoring system and time series database written in Go.</p>\n<p>Check out the <a href=\"https://developers.soundcloud.com/blog/prometheus-monitoring-at-soundcloud\">announcement</a> and my article about <a href=\"/2015/01/26/monitor-docker-containers-with-prometheus\">monitoring Docker Containers with Prometheus</a> if you don’t know what I’m talking about.</p>\n<h1 id=\"my-stack\" style=\"position:relative;\"><a href=\"#my-stack\" aria-label=\"my stack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>My Stack</h1>\n<p><img src=\"http://upload.wikimedia.org/wikipedia/commons/thumb/d/d2/Raspberry_Pi_Photo.jpg/800px-Raspberry_Pi_Photo.jpg\" alt=\"RaspberryPi\">\nI stopped running my own full blown server(s) a while ago. Nowadays I just have a old Raspberry Pi at home and two tiny DigitalOcean instances to host this blog and for general R&#x26;D stuff.</p>\n<p>But I still want to monitor all this and, as showed earlier, Prometheus is the way to go. So I could now spin up another DigitalOcean instance and pay another $5/Mo, but given how cheap I am, I’d rather want to run it on my Raspberry Pi.</p>\n<h1 id=\"cross-compiling-go\" style=\"position:relative;\"><a href=\"#cross-compiling-go\" aria-label=\"cross compiling go permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cross-Compiling Go</h1>\n<p>First you need to build Go with support for your target OS and architecture. If you installed Go from sources, you can do this by running:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cd $GOROOT/src\nGOARCH=arm ./make.bash</code></pre></div>\n<p>With pure Go, cross compilation is trivial. This example:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">package main\n\nimport \"fmt\"\n\nfunc main() {\n\tfmt.Println(\"Hello World\")\n}</code></pre></div>\n<p>can be cross-compiling for arm with <code class=\"language-text\">GOARCH=arm go build test.go</code>.</p>\n<p>Now things get much more complicated once you use CGO, meaning Go code calling C functions.</p>\n<p>The Prometheus server uses the <a href=\"https://github.com/prometheus/client_golang\">Prometheus Go Client Library</a> to provide metrics about itself. This client library uses <a href=\"https://github.com/prometheus/procfs\">prometheus/procfs</a> which requires CGO to get process metrics from procfs. Cross-compiling this for Raspberry Pi is a pain. ARM != ARM, there are several variants and when I tried to cross-compiling Prometheus with CGO, it just lead to segfaults or invalid instructions. It should be possible to cross-compile it with the CGO dependency, it’s just painful and I quickly gave up.</p>\n<p>Fortunately, we found an easy way to remove the dependency on procfs if CGO is disabled: <a href=\"https://github.com/prometheus/client_golang/commit/93d11c8e35ffcd969fd881efe1873e715a6ef93b\">https://github.com/prometheus/client_golang/commit/93d11c8e35ffcd969fd881efe1873e715a6ef93b</a>. This removes some useful process level metrics about prometheus itself, but it makes cross compiling prometheus is as easy as in the example above:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cd $GOPATH/src/github.com/prometheus/prometheus\ngo get -u # Update your dependencies\nGOARCH=arm go build -o prometheus.arm</code></pre></div>\n<p>Since cross-compilation by default disables CGO, this builds a statically linked prometheus binary ready to be run on a Raspberry Pi. If you’re running a newer Pi, you can set GOARM to the version of your ARM processor. See <a href=\"https://code.google.com/p/go-wiki/wiki/GoArm#Supported_architectures\">this</a> for supported architectures.</p>\n<h1 id=\"performance\" style=\"position:relative;\"><a href=\"#performance\" aria-label=\"performance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Performance</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0c0309899e4000452ea789b5324129b0/e088a/rpi_gorouting.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.16564417177914%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsTAAALEwEAmpwYAAACGElEQVR42nWS224TMRCG804IgQTqAVIq9R16V0RS+gy94EV4BMQVVYVUVFChpIGegLZJlWyT5rDd7MZ78PgwYyN7QRRKP1ny2t4Z//N7Kk8WF5eWlhYWFqrVxyXVanX+0fzszOx15uZm795/eOfeg3I5M+OOK0Weh2E4mcRCCK010n/QiNbaV42Ll+/a9hoVRCyKnHOulCIiezvGWOM/iChljHNeEUKAUKDIH9/KX1mIAEBpXSEi4dFaA3DudhGNQWNACCGlUgoAsiy7mcvJ1gAkALUirXVRKJa4kTEUXGUpaS1ZglKiAGeAMSpLZRKbMjg7PxX9rowjnTHoB5hnpBQJYVDLKETg6bd9GPR0OrXeFOgHMOi5YCKaHjXT46+81+XddnZ6bLy3pTYVR3qaJHs7bL/BLzqaJSRl3j4pgvNfsvmgx4PzvNtiB42ic2ZK5/wlKo6yk+N4dzt6v5keNvPWD7gMis4Z7wfGGHczIdry7xsOI/Dpl0/xx61w83XS3GFHzcmHt0W3xS8DUsoFa619hrIj/rSJS4iaHe5NdrfZ/md20MjbJ9HWm7z1XU6uqHyqsjf+eUzrl8aQGPah15HRGHx1KAB5QVI62YgYXV2Nx+HIE4bh2I3xcDh002g06vcGg0GeppZQpVOv0akzRBWl1Iv19acrK6urz+ueVU+t9qxer9dqtbW1teXl5Y2NDWvt7wKxLOonpsfjmKMDY7oAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"goroutines\"\n        title=\"\"\n        src=\"/static/0c0309899e4000452ea789b5324129b0/a6d36/rpi_gorouting.png\"\n        srcset=\"/static/0c0309899e4000452ea789b5324129b0/222b7/rpi_gorouting.png 163w,\n/static/0c0309899e4000452ea789b5324129b0/ff46a/rpi_gorouting.png 325w,\n/static/0c0309899e4000452ea789b5324129b0/a6d36/rpi_gorouting.png 650w,\n/static/0c0309899e4000452ea789b5324129b0/e548f/rpi_gorouting.png 975w,\n/static/0c0309899e4000452ea789b5324129b0/e088a/rpi_gorouting.png 1015w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\nI didn’t have time to benchmark it yet, but it seems to perform much better than I expected. Right now, it only scrapes itself, giving us ~250 time series. After running it for a few hours it already collected 137806 samples. Graphing a simple time series like <code class=\"language-text\">process_goroutines</code> for the past hour takes between 150-170ms. The probably most expensive operation you can do (and definitely shouldn’t do on a production system) is graphing <em>all</em> time series by executing <code class=\"language-text\">{job=~\".*\"}</code> this returns in about 30s on the Raspberry Pi.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/41ee3e1033ec4be8cbd8b134b87fc946/46e51/rpi_all-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.25766871165644%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAABxElEQVR42o2R70tTURjH758VBEERCnrZL/bSfyATEhuNahqEvxWMGFZGJJcNfJEbOhC3KRSKexXoi5DSV27OYbuzu7Zzz855nufEvbvVVkZ+Xn45z/N9vt+jBUOhcDgcDDj4/QG/i8/n6+vr70TX+6/f7Ll247au67qn6FqLc9u2AQARiUhdRlvdOKgk94qduoYAzWaTMcY5R0R1BXirZdZqjDHHmfEWE54t/Y0iIbHOBKDzQIIUwjkXETUi4s7lXEpp2zZjTAgBLrYLgTgsXbzMfy6Zjfb2dhAipUkX/B8AoJSyGtbz9OLo8lhiK+Fk9k77udJrqLu5X2/KZjk0Guy53/t0edwtzKUro1J/KESEbuBipRq48+LWQDw6lyFCrR3visOnZ+cjsclI7Mn43ES1dv7Ps3+PEQKCBKmUKuwXXi0NJozhhBExzbJXGHRAiKr7w11np7Cd3fXU6lAu+zCfjVnW2eXOQMQBGpx9+259vaiWKqWjk+Odj3vp9ZmtbCS3+WA7/7herzjDh18+7Rbeb3/Y3MilUpnkyrs3RjL++u384tLks/jYzEJ0YnZ4evbe1PRdwxjJrD1Kr0Yza7Fi8egHFp+hS61ugTgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"goroutines\"\n        title=\"\"\n        src=\"/static/41ee3e1033ec4be8cbd8b134b87fc946/a6d36/rpi_all-1.png\"\n        srcset=\"/static/41ee3e1033ec4be8cbd8b134b87fc946/222b7/rpi_all-1.png 163w,\n/static/41ee3e1033ec4be8cbd8b134b87fc946/ff46a/rpi_all-1.png 325w,\n/static/41ee3e1033ec4be8cbd8b134b87fc946/a6d36/rpi_all-1.png 650w,\n/static/41ee3e1033ec4be8cbd8b134b87fc946/e548f/rpi_all-1.png 975w,\n/static/41ee3e1033ec4be8cbd8b134b87fc946/46e51/rpi_all-1.png 1003w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1 id=\"downloads\" style=\"position:relative;\"><a href=\"#downloads\" aria-label=\"downloads permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Downloads</h1>\n<p><strong>Update:</strong> There are now official images available:\n<a href=\"https://prometheus.io/download/\">https://prometheus.io/download/</a></p>\n<h3 id=\"checksums\" style=\"position:relative;\"><a href=\"#checksums\" aria-label=\"checksums permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Checksums</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ shasum prometheus.armv?.gz\ndb42a3f568bbab1d8a7d183b336d0b50dccc80b6  prometheus.armv5.gz\nb6fdd3a77e16359631a0daaf9c06cd93a9948932  prometheus.armv6.gz\n8d3e6580ee4ed3d10b93d60c13009156a5600193  prometheus.armv7.gz\n\n$  sha256sum prometheus.armv?.gz\ne206202bb07cc139eaabac4c51c07f0a332337eb331bd79f19294c558fb3de62  prometheus.armv5.gz\n99d864e4fee8ded6b0f9c117f839fdf0fa9d12fadfe27b98090bee04b88c48c0  prometheus.armv6.gz\nbaf550448174198c57f3a28e2b86d49ba523e5b15d9d4c087267021e4785299b  prometheus.armv7.gz</code></pre></div>","frontmatter":{"title":"Prometheus on Raspberry Pi","date":"February 10, 2015","image":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAACvklEQVR42o1T204TURSdn0ClKTHxd3hwaB/8A3n12Q/woQHa6pPR0kpMfJEXExsTRUCLFGppCiVcawult+ncL2fPnNuY6UBRBHVlcjJnn732WjN7HyEajUYngiUSiYyNjd26AXej4/cmIuN3bv+aIeQukM1m569Ddn7+xcvMw8eJB4+ezD57/nrhVTYbJOdyOcH/KzgPVkzZm43u06XTxgD5vs/CqO8L9P/AOfN9xtj5Vtc1WVb+oXzFwoWkb5qmpmmBMmOM/4IwEgZDrSsJIQLblmUBAKF09NiOgwBsx8EYIwBZlgFgKDvCeS2BEooBPFPHyPZskwDCgIjrUkIoYxgQJYQQTD0vtEMZowRjx8YAgidLnjLwFAlriqcMiGkQy8Ca7Ml9zpj94wCbOiOYmHogzpjv+26vDZ2Wp2uCtVdlgEauwv/BAEH7lFOqbRXNWmVYThmRodWAVjMgG9USRSg8CM6GfAoIndQ5pWqpMFjOo7Om22sTx6aeSzF2msfW/rZn6IK68YX+qYw9c6dMAWnf1/r5RfugZuyUsa66nZYrdVGrYR/uuqosuL02Rc415L2qUS2pG6u9/Ftl7bO+VUStpl5et4733H4HtRogdYXLxg/5F+TAm1b+pq6vSB/fDZbe61vr1v62Uvg0WPngyZLTOIJ+R+DDAbii7HPunNTVzYJSXDW2y4PlvF4pWvs7erXUXlxAZ0102ghs/z6Dl0PoyX2zVlE3C3b9wGkem7WKUS0RQ1M3vzrNI+i0CKDLi0GGCN8o5yBLSOqa9UOQelhXoX1i7laCL6KEM8qHlBuVmWNzjMMWMoI5pW6/yygZjX1ATqWSqSHSqdTMzMzs3Fw6nU4mk6lkMp1OJxKJTCYT3hDiQngjXdcNSwiiKMZisXg8HovFpsQpcSqAKN4XRTEej09OTk5PT1/pxWj7E8BTC8CSZ3KcAAAAAElFTkSuQmCC","width":1015,"height":1015,"src":"/static/0c0309899e4000452ea789b5324129b0/c9f7c/rpi_gorouting.png","srcSet":"/static/0c0309899e4000452ea789b5324129b0/c9f7c/rpi_gorouting.png 1x"}}}}}},"pageContext":{"slug":"/2015/02/10/prometheus-on-raspberry-pi/","previous":{"fields":{"slug":"/2015/01/27/find-ghosts-in-your-docker-images/"},"frontmatter":{"title":"Find GHOSTs in your Docker images"}},"next":{"fields":{"slug":"/2015/03/13/building-aws-amis-from-scratch/"},"frontmatter":{"title":"Building AWS AMIs from Scratch for Immutable Infrastructures"}}}},"staticQueryHashes":[],"slicesMap":{}}