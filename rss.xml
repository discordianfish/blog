<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[5π Consulting]]></title><description><![CDATA[Outside the box, no one can hear you scream.]]></description><link>https://5pi.de</link><generator>GatsbyJS</generator><lastBuildDate>Mon, 05 Jul 2021 16:22:41 GMT</lastBuildDate><item><title><![CDATA[Koko: AI-Powered Community Moderation]]></title><description><![CDATA[From legacy infrastructure to over 100 million content moderation decisions per
day. Building an agile cloud native infrastructure for a high velocity AI based
content moderation startup.]]></description><link>https://5pi.de/case-studies/koko/</link><guid isPermaLink="false">https://5pi.de/case-studies/koko/</guid><content:encoded>&lt;p&gt;From legacy infrastructure to over 100 million content moderation decisions per
day.&lt;/p&gt;
&lt;p&gt;Building an agile cloud native infrastructure for a high velocity AI based
content moderation startup.&lt;/p&gt;
&lt;!--end--&gt;
&lt;blockquote class=&quot;testimonial&quot;&gt;
  &lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 643px; &quot;&gt;
      &lt;a class=&quot;gatsby-resp-image-link&quot; href=&quot;/static/edae78162912c3d499b8203214ecc783/e3f06/kareem.jpg&quot; style=&quot;display: block&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
    &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom: 94.47852760736197%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAATABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAUEBv/EABQBAQAAAAAAAAAAAAAAAAAAAAL/2gAMAwEAAhADEAAAAa2DbKK6AI5JwHZDH//EAB4QAAIBAwUAAAAAAAAAAAAAAAIDAQAEERITIjEy/9oACAEBAAEFAnloWo5FlXI5Wnm6rjyuI3B6/8QAFhEAAwAAAAAAAAAAAAAAAAAAARAx/9oACAEDAQE/AREIv//EABYRAAMAAAAAAAAAAAAAAAAAAAEQMf/aAAgBAgEBPwE1Gr//xAAcEAABAwUAAAAAAAAAAAAAAAABABEhAhAgIlL/2gAIAQEABj8ChDZwbPzKpEY//8QAHBABAQACAgMAAAAAAAAAAAAAAREAMRAhQVFh/9oACAEBAAE/IXoorLm2xk4p+ej3hNS3184TZesAYTGpXP/aAAwDAQACAAMAAAAQp8B8/8QAFxEBAAMAAAAAAAAAAAAAAAAAEQABEP/aAAgBAwEBPxAJ2uf/xAAVEQEBAAAAAAAAAAAAAAAAAAARIP/aAAgBAgEBPxBQP//EABsQAQACAwEBAAAAAAAAAAAAAAERIQAxURBB/9oACAEBAAE/EFsRzxOFCQFKd1O/DtND46Mqo0u4WjwwEQGB3eOYJZkq4xWJe5//2Q==&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;Kareem Kouddous&quot; title=&quot;Kareem Kouddous&quot; src=&quot;/static/edae78162912c3d499b8203214ecc783/e3f06/kareem.jpg&quot; srcset=&quot;/static/edae78162912c3d499b8203214ecc783/d2f63/kareem.jpg 163w,
/static/edae78162912c3d499b8203214ecc783/c989d/kareem.jpg 325w,
/static/edae78162912c3d499b8203214ecc783/e3f06/kareem.jpg 643w&quot; sizes=&quot;(max-width: 643px) 100vw, 643px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot; loading=&quot;lazy&quot;&gt;
  &lt;/a&gt;
    &lt;/span&gt;
  &lt;code&gt;Working with Johannes enabled us to dramatically accelerate product
development by having the rest of the engineering team focus 100% on feature
development, deploying many times a day despite supporting a very high
throughput application.
  &lt;/code&gt;
  &lt;footer&gt;&lt;cite&gt;Kareem Kouddous, CTO at Koko AI&lt;/cite&gt;&lt;/footer&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;about-koko&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#about-koko&quot; aria-label=&quot;about koko permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;About Koko&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://koko.ai&quot;&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; &quot;
    &gt;
      &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 14.723926380368097%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAO0lEQVQI12NgwA2YgVgBylYHYm8om5GBTCAMxClA7A/E+UCcCjWUj1wD2YFYA4jtoIYaALEqELPi0wQAk0gDoAlOQyYAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Logo&quot;
        title=&quot;Logo&quot;
        src=&quot;/static/1bc80e2cb128767187e1830cdeb8d580/0a47e/logo-wide.png&quot;
        srcset=&quot;/static/1bc80e2cb128767187e1830cdeb8d580/222b7/logo-wide.png 163w,
/static/1bc80e2cb128767187e1830cdeb8d580/ff46a/logo-wide.png 325w,
/static/1bc80e2cb128767187e1830cdeb8d580/0a47e/logo-wide.png 600w&quot;
        sizes=&quot;(max-width: 600px) 100vw, 600px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
    &lt;/span&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;The Internet can be a scary place. Koko keeps your community safe by using AI to
identify bad actors and damaging content. Koko detects issues in real time and
notifies your moderation system.&lt;/p&gt;
&lt;p&gt;Koko is already used by several top online communities to support over 100
million moderation decisions per day.&lt;/p&gt;
&lt;h2 id=&quot;rancher-to-kubernetes-migration&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#rancher-to-kubernetes-migration&quot; aria-label=&quot;rancher to kubernetes migration permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Rancher to Kubernetes migration&lt;/h2&gt;
&lt;p&gt;When Koko contacted me, their infrastructure was running on an old version of
&lt;a href=&quot;https://rancher.com/&quot;&gt;Rancher&lt;/a&gt; which should be replaced by a Kubernetes
cluster. I’ve migrated all deployment manifests to Kubernetes manifests and
wrote scripts for &lt;a href=&quot;https://circleci.com/&quot;&gt;CircleCI&lt;/a&gt; to continuously deploy code
changes to the cluster. New branches get deployed to their own namespace with
own ingresses to allow developers to worker independently while also allowing
cross team and code base feature work.&lt;/p&gt;
&lt;p&gt;To cleanup existing branches, I’ve developed
&lt;a href=&quot;https://github.com/itskoko/k8s-ci-purger&quot;&gt;k8s-ci-purger&lt;/a&gt; which cleans up
Kubernetes resources on branch deletion.&lt;/p&gt;
&lt;p&gt;Since self-service is paramount, Koko needed a safe and reliable way for
developers to use internal services. This was solved by using
&lt;a href=&quot;https://github.com/bitly/oauth2_proxy&quot;&gt;oauth2_proxy&lt;/a&gt; to authenticate against
GitHub. Additional changes to support Websockets for Jupyter Notebooks were
added.&lt;/p&gt;
&lt;h2 id=&quot;kubecfn---cloudformation-kubernetes-installer&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kubecfn---cloudformation-kubernetes-installer&quot; aria-label=&quot;kubecfn   cloudformation kubernetes installer permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;kubecfn - Cloudformation Kubernetes Installer&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;/2f7d38406a33c80962b9131bc20ee2bf/kubecfn.svg&quot; alt=&quot;kubecfn architecture diagram&quot;&gt;
Initially, Koko used &lt;a href=&quot;https://github.com/kubernetes/kops&quot;&gt;kops&lt;/a&gt; to deploy the
Kubernetes cluster. Customizing Kubernetes component configuration often
required upstream changes in a rapidly evolving code base. That didn’t only
slowed us down but also caused reliability issues due the dependency on unstable
versions. After investigating alternatives, which I also &lt;a href=&quot;https://5pi.de/2017/12/15/production-grade-kubernetes/&quot;&gt;blogged
about&lt;/a&gt;, I proposed to
create a &lt;a href=&quot;https://aws.amazon.com/cloudformation/&quot;&gt;Cloudformation&lt;/a&gt; based
Kubernetes Installer around
&lt;a href=&quot;https://kubernetes.io/docs/setup/independent/&quot;&gt;kubeadm&lt;/a&gt;. The safety
first-design gave us the confidence required to quickly iterate by ensuring safe
rollouts of version and configuration changes.
The project was made open source and can be &lt;a href=&quot;https://github.com/itskoko/kubecfn&quot;&gt;found
here&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;argo-machine-learning-pipeline&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#argo-machine-learning-pipeline&quot; aria-label=&quot;argo machine learning pipeline permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Argo Machine Learning Pipeline&lt;/h2&gt;
&lt;p&gt;The next thing to solve was how to run machine learning pipelines on the new
cluster. There are several options but &lt;a href=&quot;https://github.com/argoproj/argo&quot;&gt;Argo&lt;/a&gt;
seemed like the best fit. Being a generic workflow engine it extends the
existing Kubernetes API allowing developers to use the same API and declarative
manifests to run the pipelines.&lt;/p&gt;
&lt;p&gt;The custom built Kubernetes installer made it easy to add another GPU-enabled worker
instance group that automatically gets scaled up when a Argo pipeline requires
GPU instances and back to zero after the jobs finished.&lt;/p&gt;
&lt;h2 id=&quot;autoscaling&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#autoscaling&quot; aria-label=&quot;autoscaling permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Autoscaling&lt;/h2&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/11142449492391c031ce5b468b20afc4/218a4/autoscaling.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 47.852760736196316%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABr0lEQVQozz1Su64UMQydL4Gdl+0kzjs72Xns3EUIQYGAEgmJ6kq0lHwHQtDQICoaKj4Qjy5COrEcv+LjuMll8jHFXHzMLsQRqTtB30L7eOxPkH1mdmyddd6wNeyUZh+i80GURg6gartBITsbhx7tB9bvVLpP06ccPjpIxPrI7PpRKWb2Ej8C9QM0pUwxlr4Dfm3DvcdV3b5t29d5+hGf/tkvvxIuquZFGpRo79N82YiMpISQGx+S5djxGN77y7OF3tL+eb19ucbv9u73Un6GsWL2k/A6tb3WttYFQKV8LqU2fQ8PED4l1ZEIXiA8B3qp8Q2qV2rQ2J4G6VOeVcRtO0gLQlNqNUIDUQvEceigsTPYamjV8AhFOSyopVVj3P9guY4jNaIZZ0nJRYEAlFhkJA9TQdLasEix/3OJhMM4jNj4HFzykq+ZibTSRhtDSltvUUpaKxAjaSMlkMRlAOW7HCA1aa55rWmtZZ/zdinX+cC+nG8rAJ2Xc92naSvzk6Vea92m+a7WdVpuF/bchBBlEj4WtuEoTHxAuBHLFGUfUowiQjrLtihlFBlpRLZjGPAvJN9vHGWv5y8AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Autoscaling Dashboard&quot;
        title=&quot;Autoscaling Dashboard&quot;
        src=&quot;/static/11142449492391c031ce5b468b20afc4/a6d36/autoscaling.png&quot;
        srcset=&quot;/static/11142449492391c031ce5b468b20afc4/222b7/autoscaling.png 163w,
/static/11142449492391c031ce5b468b20afc4/ff46a/autoscaling.png 325w,
/static/11142449492391c031ce5b468b20afc4/a6d36/autoscaling.png 650w,
/static/11142449492391c031ce5b468b20afc4/e548f/autoscaling.png 975w,
/static/11142449492391c031ce5b468b20afc4/218a4/autoscaling.png 1052w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;
As in most infrastructures, Koko’s traffic pattern is diurnal with much higher
traffic during the (US) day than the night. Due to the nature of the service, it
fluctuates even more with short peaks and troughs when customers batch process
workloads. While Kubernetes provides simple CPU based autoscaling out the box,
this wasn’t sufficient to scale up quickly enough while preventing it from scale
down too early when a customer briefly stops sending requests.&lt;/p&gt;
&lt;p&gt;To solve that, I’ve introduced the &lt;a href=&quot;https://prometheus.io/&quot;&gt;Prometheus Monitoring
System&lt;/a&gt; and used
the
&lt;a href=&quot;https://github.com/DirectXMan12/k8s-prometheus-adapter&quot;&gt;k8s-prometheus-adapter&lt;/a&gt;
to provide the metrics as Kubernetes Custom Metrics. This allowed me to create
scaling rules for rapid scaling up while preventing underprovisioning by looking
at past traffic patterns.&lt;/p&gt;
&lt;h2 id=&quot;observability&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#observability&quot; aria-label=&quot;observability permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Observability&lt;/h2&gt;
&lt;p&gt;Koko used &lt;a href=&quot;https://www.datadoghq.com/&quot;&gt;Datadog&lt;/a&gt; for monitoring and, once it was
available, logging too. Since we weren’t very happy with the service and
struggled to integrate custom metrics as well as metrics provided by
infrastructure services, we decided to move all our monitoring to Prometheus.
I’ve introduced &lt;a href=&quot;https://grafana.org/&quot;&gt;Grafana&lt;/a&gt; with statically provisioned and
CI deployed dashboards for system and infrastructure metrics, while also
allowing developers to create their own dashboards ad-hoc, allowing for a
self-service monitoring experience. I’ve built
&lt;a href=&quot;https://github.com/itskoko/prometheus-renderer&quot;&gt;prometheus-renderer&lt;/a&gt; to render
alerting expressions to provide graph previews in our slack alerts.&lt;/p&gt;
&lt;p&gt;Since no logging services provided structured logging at a reasonable price,
I’ve integrated the &lt;a href=&quot;https://aws.amazon.com/elasticsearch-service/&quot;&gt;AWS Elasticsearch
Service&lt;/a&gt; with
&lt;a href=&quot;https://fluentbit.io/&quot;&gt;fluent-bit&lt;/a&gt; which allowed us to browse, filter and graph
logs as well as integrate them into Grafana dashboards.&lt;/p&gt;
&lt;h2 id=&quot;stream-processing&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#stream-processing&quot; aria-label=&quot;stream processing permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Stream processing&lt;/h2&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 69.32515337423312%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsTAAALEwEAmpwYAAACh0lEQVQozz2Sa0/bMBSG80cmoE18i53Yca7NrbeEtlxaVtCgYozLKgpjGpuYQNokPmz/ZdrnaZ/313ZKN6Q3R6/tY5+TxzZcVzEmbNuJolaSZEmSah0wyjl3KeWrJYhCyKfVDAwMQZBgwNc0iWlRiM0mboBnwiQcZhpNhDEDIURBlkVME4NZzRBiG1q6LY+3ONc2Z8Qug2C21dkfZAqKY2pahMD+pw2QvTprOUSUwuZuEp4P8+NhMavii1F2s9d+OOxe7hSLcSfVLjRiE5thRjGDo5fxSUtDubHTS+9OBp9fD26PqvuTzbvj+sNR/WlWfzkdlKGCf1k1aa06/2/+td2K/P1hMamz6SDf2wQVLwdLHYxKLR1IFdwFZs8CRitgIEO6UvuxUj4IjHA1tV1mu5hw4OcIEYaJJ71AB1qHwpFSapsJBCygMucOwVRKz/N8xjhCwNzCGOAjIVyoA8yeOYMXjqLMWW9YCFPD5u6aSdabZK2BQRsNbCECLWHEEGbQg8dtuDbLosp1tWCC2oGvM18vaSulFuP2xbhzvlWcDMs3Wz14GZyL1OEtxrdD76L2BSINE4+K+GrSWUzat/vdh1m1mQZGGYc/r8a/301+3Uz/3E5/zHcxIuMiup927qa9+9ng2+n2WZW82LCqIr4+qucH/bcH1eKwHrUjI9D+4qD38bD//lX18Lq6nrZNk+z28++LyeN8/PVs9DjfuZz21hpIuspxHFc6SgEheKTcgLfdzaJeHvfyqCpb7TQ2LaykrMtWv4j7RVIXSayliWicpHGc+V4QR2kUpZQKIwzjvOjFrUJKpbxIqhBQw/WkeReuQHoh42p9A2GL5FnZ6fbDMCrLTlG0AepfdFO0K28O5UQAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Stream Processing Dashboard&quot;
        title=&quot;Stream Processing Dashboard&quot;
        src=&quot;/static/87a6eb80f7df852d72c949c282e58488/a6d36/streamprocessing.png&quot;
        srcset=&quot;/static/87a6eb80f7df852d72c949c282e58488/222b7/streamprocessing.png 163w,
/static/87a6eb80f7df852d72c949c282e58488/ff46a/streamprocessing.png 325w,
/static/87a6eb80f7df852d72c949c282e58488/a6d36/streamprocessing.png 650w,
/static/87a6eb80f7df852d72c949c282e58488/e548f/streamprocessing.png 975w,
/static/87a6eb80f7df852d72c949c282e58488/2bef9/streamprocessing.png 1024w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
    &lt;/span&gt;
When Koko’s API receives content to classify, it needs to archive to S3 them for
running machine learning on it. Initially &lt;a href=&quot;https://aws.amazon.com/kinesis/data-firehose/&quot;&gt;AWS Kinesis
Firehose&lt;/a&gt; was being used for
that. That allowed buffering and batching the data, even though further
processing to shard the data was necessary. Since it also doesn’t support &lt;a href=&quot;https://docs.aws.amazon.com/vpc/latest/userguide/vpc-endpoints.html&quot;&gt;VPC
Endpoints&lt;/a&gt;
Koko incurred high traffic costs.&lt;/p&gt;
&lt;p&gt;I’ve proposed and implemented a custom solution by using
&lt;a href=&quot;https://www.fluentd.org/&quot;&gt;fluentd&lt;/a&gt; and Kubernetes statefulsets to replace
Kinesis Firehose. This reduced Koko’s EC2 traffic costs by 80%. You can read
more about the details in &lt;a href=&quot;/2018/10/31/fluentd-for-data-warehousing-with-athena/&quot;&gt;this blog article&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#conclusion&quot; aria-label=&quot;conclusion permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Koko’s ability to rapidly and reliably build new features helped it to attract
some of the largest social networks.&lt;/p&gt;
&lt;p&gt;I’m proud to have built the infrastructure that allowed Koko to be confident in
change and deliver it fast.&lt;/p&gt;
&lt;p&gt;Do you want to accelerate your product development by building upon or migrating
to modern cloud native infrastructure? &lt;a href=&quot;/hire-me&quot;&gt;Let me know!&lt;/a&gt;.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Styla: Content Experience Engine]]></title><description><![CDATA[Advising a content commerce startup on Docker migration, AWS deployment and
DevOps strategy. Debugging a ELB/ECS based pilot deployment. Implementation of and migration to lambda based machine learning pipeline.]]></description><link>https://5pi.de/case-studies/styla/</link><guid isPermaLink="false">https://5pi.de/case-studies/styla/</guid><content:encoded>&lt;p&gt;Advising a content commerce startup on Docker migration, AWS deployment and
DevOps strategy. Debugging a ELB/ECS based pilot deployment.&lt;/p&gt;
&lt;p&gt;Implementation of and migration to lambda based machine learning pipeline.&lt;/p&gt;
&lt;!--end--&gt;
&lt;blockquote class=&quot;testimonial&quot;&gt;
  &lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 268px; &quot;&gt;
      &lt;a class=&quot;gatsby-resp-image-link&quot; href=&quot;/static/6fa4911f9f1160805ce38ae20d7a3b1e/6b6e1/alex.jpg&quot; style=&quot;display: block&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
    &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAAIDAAAAAAAAAAAAAAAAAAQFAQMG/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQAC/9oADAMBAAIQAxAAAAG30SK8bRho52aFLDf/xAAbEAEBAAIDAQAAAAAAAAAAAAADAgASAQQRE//aAAgBAQABBQJb+cQib4k7SflNi9hKpkqTC+UL/8QAFREBAQAAAAAAAAAAAAAAAAAAIEH/2gAIAQMBAT8Bg//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EACAQAAEEAgEFAAAAAAAAAAAAAAEAAhExECEDEhNBUXH/2gAIAQEABj8CmJ9BdPKG7qMfNoQKxcQfC7jdOKDja//EABwQAAIBBQEAAAAAAAAAAAAAAAERABAhMUFRcf/aAAgBAQABPyHfRroYtBbjweUFdDZIOPRflNFrQgSIgGovFuT/2gAMAwEAAgADAAAAEKzIQP/EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/EAFMJ//EABYRAQEBAAAAAAAAAAAAAAAAAAERIP/aAAgBAgEBPxBW4//EAB0QAQACAQUBAAAAAAAAAAAAAAEAESEQMUFRYbH/2gAIAQEAAT8QFSnBOTYhhiMh2Wv6aU64Aem0AwFNzbvF37FiMc8NRY4XlhIrgGO9mCeLBrRP/9k=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;Alexander Kong&quot; title=&quot;Alexander Kong&quot; src=&quot;/static/6fa4911f9f1160805ce38ae20d7a3b1e/6b6e1/alex.jpg&quot; srcset=&quot;/static/6fa4911f9f1160805ce38ae20d7a3b1e/d2f63/alex.jpg 163w,
/static/6fa4911f9f1160805ce38ae20d7a3b1e/6b6e1/alex.jpg 268w&quot; sizes=&quot;(max-width: 268px) 100vw, 268px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot; loading=&quot;lazy&quot;&gt;
  &lt;/a&gt;
    &lt;/span&gt;
  &lt;code&gt;
    We worked with Johannes on two projects and greatly benefited from his knowledge and experience.
  &lt;/code&gt;
  &lt;footer&gt;&lt;cite&gt;Alexander Kong, CTO at Styla.com&lt;/cite&gt;&lt;/footer&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;about-styla&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#about-styla&quot; aria-label=&quot;about styla permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;About Styla&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;/40c7d3d40842ccd99311f9b8157b07be/styla.svg&quot; alt=&quot;Logo&quot;&gt;
&lt;a href=&quot;https://www.styla.com/&quot;&gt;Styla&lt;/a&gt; offers a Content Experience Engine that
automatically designs your content and makes it shoppable, inspiring your
customers to buy more.&lt;/p&gt;
&lt;p&gt;Styla’s automation technology designs your content in real-time and enhances the
user experience on every device.&lt;/p&gt;
&lt;h2 id=&quot;docker-migration-and-aws-devops-strategy-consulting&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#docker-migration-and-aws-devops-strategy-consulting&quot; aria-label=&quot;docker migration and aws devops strategy consulting permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Docker migration and AWS DevOps strategy consulting&lt;/h2&gt;
&lt;p&gt;Before they contacted me, Styla’s stack consisted of Ansible managed AWS EC2
instances with their applications directly deployed to the machine ad-hoc.&lt;/p&gt;
&lt;p&gt;When expanding their product to more markets, Styla contracted me for a day to
discuss their challenges and advise them on further and more robust automation,
with the goal of having all the infrastructure as code.&lt;/p&gt;
&lt;p&gt;Styla already experimented with Docker and wanted to deploy on &lt;a href=&quot;https://aws.amazon.com/ecs/&quot;&gt;AWS
ECS&lt;/a&gt; but had severe issues with a python based data
dashboard. The application, running behind an AWS ELB, became unresponsive about
every minute. My investigations showed that their application used blocking IO
and was single threaded. Since the AWS ELB health checks didn’t close the
connection, the application didn’t respond to request until it timed out.
Running the application as workers under a pre-forking HTTP server solved this
problem.&lt;/p&gt;
&lt;p&gt;After discussing the goals and specifics of the infrastructure, I recommended
using Cloudformation for the deployment of the ECS cluster and other
infrastructure. This allows to keep all stack configuration in simple JSON/YAML
documents that can be used to rollout changes to the infrastructure in a
controlled fashion. To keep the existing workflows, the template can be executed
by Ansible.&lt;/p&gt;
&lt;p&gt;Over the course of the next months, Styla implemented the recommended
infrastructure which is powering the platform ever since.&lt;/p&gt;
&lt;blockquote class=&quot;float-right&quot;&gt;
  &lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 268px; &quot;&gt;
      &lt;a class=&quot;gatsby-resp-image-link&quot; href=&quot;/static/6fa4911f9f1160805ce38ae20d7a3b1e/6b6e1/alex.jpg&quot; style=&quot;display: block&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;
    &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAAIDAAAAAAAAAAAAAAAAAAQFAQMG/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQAC/9oADAMBAAIQAxAAAAG30SK8bRho52aFLDf/xAAbEAEBAAIDAQAAAAAAAAAAAAADAgASAQQRE//aAAgBAQABBQJb+cQib4k7SflNi9hKpkqTC+UL/8QAFREBAQAAAAAAAAAAAAAAAAAAIEH/2gAIAQMBAT8Bg//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EACAQAAEEAgEFAAAAAAAAAAAAAAEAAhExECEDEhNBUXH/2gAIAQEABj8CmJ9BdPKG7qMfNoQKxcQfC7jdOKDja//EABwQAAIBBQEAAAAAAAAAAAAAAAERABAhMUFRcf/aAAgBAQABPyHfRroYtBbjweUFdDZIOPRflNFrQgSIgGovFuT/2gAMAwEAAgADAAAAEKzIQP/EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/EAFMJ//EABYRAQEBAAAAAAAAAAAAAAAAAAERIP/aAAgBAgEBPxBW4//EAB0QAQACAQUBAAAAAAAAAAAAAAEAESEQMUFRYbH/2gAIAQEAAT8QFSnBOTYhhiMh2Wv6aU64Aem0AwFNzbvF37FiMc8NRY4XlhIrgGO9mCeLBrRP/9k=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;Alexander Kong&quot; title=&quot;Alexander Kong&quot; src=&quot;/static/6fa4911f9f1160805ce38ae20d7a3b1e/6b6e1/alex.jpg&quot; srcset=&quot;/static/6fa4911f9f1160805ce38ae20d7a3b1e/d2f63/alex.jpg 163w,
/static/6fa4911f9f1160805ce38ae20d7a3b1e/6b6e1/alex.jpg 268w&quot; sizes=&quot;(max-width: 268px) 100vw, 268px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot; loading=&quot;lazy&quot;&gt;
  &lt;/a&gt;
    &lt;/span&gt;
  &lt;code&gt;
    We were impressed how Johannes gathered insights into our application on a system level and quickly solved our application issue.
  &lt;/code&gt;
  &lt;footer&gt;&lt;cite&gt;Alexander Kong, CTO at Styla.com&lt;/cite&gt;&lt;/footer&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;machine-learning-stack&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#machine-learning-stack&quot; aria-label=&quot;machine learning stack permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Machine Learning Stack&lt;/h2&gt;
&lt;p&gt;As a data driven platform, there is a strong need for a reliable machine
learning pipeline.&lt;/p&gt;
&lt;p&gt;After Styla successfully adopted the discussed infrastructure changes, revamping
the machine learning pipeline was the next project I was involved with.&lt;/p&gt;
&lt;p&gt;The first step in the pipeline is structuring the data. To minimize ongoing
operational costs, we decided to use &lt;a href=&quot;https://aws.amazon.com/lambda&quot;&gt;AWS Lambda&lt;/a&gt;
to automatically run Styla’s structuring code when new data gets written to a S3
bucket. This code uploads the results to a new bucket which triggers another
Lambda to load the structured data into various data stores.&lt;/p&gt;
&lt;p&gt;Beside the Lambda based pipeline, the stack consist of a Spark cluster for
further processing and data stores that can be queries from Styla’s backend services.&lt;/p&gt;
&lt;p&gt;I configured and deployed the stack as Cloudformation templates wrapped in
Ansible roles, consistent with Styla’s general deployment workflow.&lt;/p&gt;
&lt;p&gt;Especially when it comes to data warehousing and analysis, security is of utmost
importance. Therefor the stack follows the security best practices by using
individual IAM roles for each Lambda and data store with tightly locked down
policies that grant only the necessary permissions.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#conclusion&quot; aria-label=&quot;conclusion permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Whether you need consulting, troubleshooting or hands-on help with building your
infrastructure, &lt;a href=&quot;/hire-me&quot;&gt;let me know&lt;/a&gt;.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Kubernetes at Home: Hardware]]></title><description><![CDATA[Diagram of Rack
Disclaimer: While writing this article, I realize I could use Affiliate
Links to the stuff I bought. So I gave it a try…]]></description><link>https://5pi.de/2021/05/11/homelab-upgrades-hardware/</link><guid isPermaLink="false">https://5pi.de/2021/05/11/homelab-upgrades-hardware/</guid><pubDate>Mon, 11 May 2020 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;img src=&quot;/cf961ab6f525e753f89b5214b319e447/rack.svg&quot; alt=&quot;Diagram of Rack&quot;&gt;
&lt;strong&gt;Disclaimer:&lt;/strong&gt; &lt;em&gt;While writing this article, I realize I could use Affiliate
Links to the stuff I bought. So I gave it a try. Lemme know if that bothers
you&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;I’ve been running &lt;a href=&quot;/2019/05/10/k8s-on-openwrt/&quot;&gt;Kubernetes on
OpenWrt&lt;/a&gt; at home for two years now.
Although I already believed that &lt;a href=&quot;/2018/12/18/why-kubernetes-at-small-scale/&quot;&gt;Kubernetes makes sense at small
scale&lt;/a&gt; this was
intended as experiment about how small it can be.&lt;/p&gt;
&lt;p&gt;What started as a silly experiment turned out to be totally worth it.
This has been to be the most reliable and convient to manage home (lab)
infrastructure I have been running.&lt;/p&gt;
&lt;p&gt;There were issues for sure, but putting my efforts into building a reliable
Kubernetes infrastructure that allows to cleanly deploy and remove applications
at will was a great improvement over all a typial, manual and distribution
specific homelab setup that required me to “start over” quite frequently.&lt;/p&gt;
&lt;p&gt;Beside that, it’s also the ideal test bed to experiment with novel configuration
and automation strategies as well as explore Kubernetes edge cases. If something
works under the constraints of a homelab setup, it will work for your cloud
native apps on the usual platforms as well.&lt;/p&gt;
&lt;p style=&quot;text-align: right; margin-left: 10em; font-style: italic&quot;&gt;Of course we&apos;re not talking about scaling edge cases with 1k
node cluster sizes&lt;/p&gt;
&lt;p&gt;While running everything on my OpenWrt router served me well so far, I need more
disk space and want to run more applications. So I decided to double down on
my Kubernetes-At-Home setup and start a blog series about it.&lt;/p&gt;
&lt;p&gt;This is the first part talking about the hardware and storage setup.&lt;/p&gt;
&lt;h2 id=&quot;hardware&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#hardware&quot; aria-label=&quot;hardware permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Hardware&lt;/h2&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 74.84662576687117%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIFBP/EABQBAQAAAAAAAAAAAAAAAAAAAAL/2gAMAwEAAhADEAAAAZrPoCnlIR//xAAaEAADAAMBAAAAAAAAAAAAAAAAAgMBERRB/9oACAEBAAEFAkZteYJzyctGOOh//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGxAAAgEFAAAAAAAAAAAAAAAAAAEQITEyQZH/2gAIAQEABj8CmjuaZiun/8QAHBAAAgICAwAAAAAAAAAAAAAAAAERIUFRYYGR/9oACAEBAAE/IW4JeUU2w+XRdXsw/oR6cG2JIf/aAAwDAQACAAMAAAAQON//xAAXEQADAQAAAAAAAAAAAAAAAAAAAREh/9oACAEDAQE/EI5pGf/EABcRAQEBAQAAAAAAAAAAAAAAAAEAESH/2gAIAQIBAT8Q0Xlpf//EAB0QAQEAAgEFAAAAAAAAAAAAAAERACExQWFxwdH/2gAIAQEAAT8Qd2SwBoeDNI7ygVduMQjI0SGKEGvl6vWG6BxfrgiKZ//Z&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Photo of Rack&quot;
        title=&quot;Photo of Rack&quot;
        src=&quot;/static/b65430bbc3db885e329c7095246c11f7/6aca1/rack.jpg&quot;
        srcset=&quot;/static/b65430bbc3db885e329c7095246c11f7/d2f63/rack.jpg 163w,
/static/b65430bbc3db885e329c7095246c11f7/c989d/rack.jpg 325w,
/static/b65430bbc3db885e329c7095246c11f7/6aca1/rack.jpg 650w,
/static/b65430bbc3db885e329c7095246c11f7/7c09c/rack.jpg 975w,
/static/b65430bbc3db885e329c7095246c11f7/01ab0/rack.jpg 1300w,
/static/b65430bbc3db885e329c7095246c11f7/d2602/rack.jpg 4032w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;While I’d love to have a full rack with real network gear and servers as much as
the next nerd, I’d find that extremly wasteful. Therefor my first goal is that
this setup should use as little power as possible.&lt;/p&gt;
&lt;p&gt;Secondly, I still live for rent in Berlin so a small physical footprint was
another consideration.&lt;/p&gt;
&lt;div style=&quot;display: flex&quot;&gt;
  &lt;p style=&quot;width: 50%&quot;&gt;Therefor I went with this small(ish) 19&quot; Wall Mount Network Cabinate.
  The maximum installation depth is just 32cm though, so a extra short server case
  is needed. Unfortunately it doesn&apos;t seem to be available on US Amazon but there
  are plenty of other options like &lt;a href=&quot;https://amzn.to/3t3uzXe&quot;&gt;this&lt;/a&gt;
  &lt;/p&gt;
  &lt;p&gt;
  &lt;a href=&quot;https://www.amazon.de/Good-Connections%C2%AE-Wandgeh%C3%A4use-unmontiert-tiefschwarz/dp/B08FTH3ZBJ/ref=as_li_ss_il?crid=3CV1OP8QINXMK&amp;dchild=1&amp;keywords=good+connections+19%22+wandgeh%C3%A4use&amp;qid=1619774239&amp;sprefix=good+connections+19,aps,192&amp;sr=8-3&amp;th=1&amp;linkCode=li3&amp;tag=5pi-21&amp;linkId=3935e1373aedb1f800abbbe0bec6fe9e&amp;language=de_DE&quot; target=&quot;_blank&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;//ws-eu.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=B08FTH3ZBJ&amp;Format=_SL250_&amp;ID=AsinImage&amp;MarketPlace=DE&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=5pi-21&amp;language=de_DE&quot; &gt;&lt;/a&gt;&lt;img src=&quot;https://ir-de.amazon-adsystem.com/e/ir?t=5pi-21&amp;language=de_DE&amp;l=li3&amp;o=3&amp;a=B08FTH3ZBJ&quot; width=&quot;1&quot; height=&quot;1&quot; border=&quot;0&quot; alt=&quot;&quot; style=&quot;border:none !important; margin:0px !important;&quot; /&gt;
  &lt;/p&gt;
&lt;/div&gt;
&lt;div style=&quot;display: flex&quot;&gt;
  &lt;p style=&quot;width: 50%&quot;&gt;I found this server case which is just 25cm deep.
That case fits mini ITX boards only which is fine for a low power board.
Unfortunately I can&apos;t find anything similar on US Amazon. This was also the
hardest to find component. So if you have the space, just go with a bigger rack
and case&lt;/p&gt;
  &lt;p&gt;
  &lt;a href=&quot;https://www.amazon.de/gp/product/B072F4CYKP/ref=as_li_ss_il?ie=UTF8&amp;linkCode=li3&amp;tag=5pi-21&amp;linkId=a4bb79f1379ca883ece0bdb284260ae2&amp;language=de_DE&quot; target=&quot;_blank&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;//ws-eu.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=B072F4CYKP&amp;Format=_SL250_&amp;ID=AsinImage&amp;MarketPlace=DE&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=5pi-21&amp;language=de_DE&quot; &gt;&lt;/a&gt;&lt;img src=&quot;https://ir-de.amazon-adsystem.com/e/ir?t=5pi-21&amp;language=de_DE&amp;l=li3&amp;o=3&amp;a=B072F4CYKP&quot; width=&quot;1&quot; height=&quot;1&quot; border=&quot;0&quot; alt=&quot;&quot; style=&quot;border:none !important; margin:0px !important;&quot; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div style=&quot;display: flex&quot;&gt;
  &lt;p style=&quot;width: 50%&quot;&gt;I&apos;ve decided to use the Super Micro A2SDi-2C-HLN4F-B
has Intel Atom C3338 onboard which should be sufficent and has a TDP of just 9W.
It supports 8 SATA3 ports which allows me to connect plenty of disks.
and can power it directly from 12V,
so bought a &lt;a href=&quot;https://amzn.to/3gR28sU&quot;&gt;80W 12V MeanWell PSU&lt;/a&gt; (&lt;a href=&quot;https://amzn.to/2RafV3d&quot;&gt;DE&lt;/a&gt;)
  &lt;/p&gt;
  &lt;p&gt;
  &lt;a href=&quot;https://www.amazon.com/Supermicro-Motherboard-MBD-A2SDI-4C-HLN4F-B-Mini-ITX-Express/dp/B077BHMN8X?dchild=1&amp;keywords=A2SDi-2C-HLN4F-B&amp;qid=1619774725&amp;sr=8-1&amp;linkCode=li3&amp;tag=5pi-20&amp;linkId=59609640fb184ba633fe6353d29fea8e&amp;language=en_US&amp;ref_=as_li_ss_il&quot; target=&quot;_blank&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=B077BHMN8X&amp;Format=_SL250_&amp;ID=AsinImage&amp;MarketPlace=US&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=5pi-20&amp;language=en_US&quot; &gt;&lt;/a&gt;&lt;img src=&quot;https://ir-na.amazon-adsystem.com/e/ir?t=5pi-20&amp;language=en_US&amp;l=li3&amp;o=1&amp;a=B077BHMN8X&quot; width=&quot;1&quot; height=&quot;1&quot; border=&quot;0&quot; alt=&quot;&quot; style=&quot;border:none !important; margin:0px !important;&quot; /&gt;
&lt;br /&gt;(&lt;a href=&quot;https://amzn.to/3nBPuzC&quot;&gt;DE&lt;/a&gt;)
  &lt;/p&gt;
&lt;/div&gt;
&lt;div style=&quot;display: flex&quot;&gt;
  &lt;p style=&quot;width: 50%&quot;&gt;To house the disks I bought a ICY BOX 8x 2.5&quot; Backplane which fits the 2u 5.25&quot; drive
bay, currently with 4x5TB disks and enough room for upgrades
  &lt;/p&gt;
  &lt;p&gt;
  &lt;a href=&quot;https://www.amazon.de/gp/product/B082BR71DY/ref=as_li_ss_il?ie=UTF8&amp;linkCode=li3&amp;tag=5pi-21&amp;linkId=b0227785164e228e852a35fc66c69e4a&amp;language=de_DE&quot; target=&quot;_blank&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;//ws-eu.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=B082BR71DY&amp;Format=_SL250_&amp;ID=AsinImage&amp;MarketPlace=DE&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=5pi-21&amp;language=de_DE&quot; &gt;&lt;/a&gt;&lt;img src=&quot;https://ir-de.amazon-adsystem.com/e/ir?t=5pi-21&amp;language=de_DE&amp;l=li3&amp;o=3&amp;a=B082BR71DY&quot; width=&quot;1&quot; height=&quot;1&quot; border=&quot;0&quot; alt=&quot;&quot; style=&quot;border:none !important; margin:0px !important;&quot; /&gt;
  &lt;/p&gt;
&lt;/div&gt;
Also bought patch panel, PDU and a tray to mount the non-rackable equipment.
&lt;p&gt;Finally all my equipment is nice and tidy contained in the cabinate with just
two uplink connect, the link to the other rooms and a power input draining
typically around 60W.&lt;/p&gt;
&lt;h2 id=&quot;kubernetes-storage&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kubernetes-storage&quot; aria-label=&quot;kubernetes storage permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Kubernetes Storage&lt;/h2&gt;
&lt;p&gt;The Kubernetes setup itself hasn’t changed much since my first blog article about &lt;a href=&quot;/2019/05/10/k8s-on-openwrt/&quot;&gt;Kubernetes on
OpenWrt&lt;/a&gt;. To make use of the new storage I’ve
decided to run &lt;a href=&quot;https://wiki.debian.org/ZFS&quot;&gt;ZFS&lt;/a&gt; and use &lt;a href=&quot;https://docs.openebs.io/docs/next/localpv.html&quot;&gt;OpenEBS’ Local
PV&lt;/a&gt; provisionier. As the name
implies, this is not a networking filesystem. Your pods effectivly get pinned to
whereever the PV gets created. That means in my case, all pods requesting
storage end up on this server. Still much better than using static hostPath
mounts as I did before and more appropriate than a brittle network filesystem.
But I might explore that eventually.&lt;/p&gt;
&lt;h2 id=&quot;next-software&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#next-software&quot; aria-label=&quot;next software permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Next: Software&lt;/h2&gt;
&lt;p&gt;In the next part of this series I’ll talk about what I spent most time on in
this iteration: Using &lt;a href=&quot;&quot;&gt;jsonnet&lt;/a&gt; and
&lt;a href=&quot;https://jsonnet-libs.github.io/k8s-alpha/&quot;&gt;k8s-alpha&lt;/a&gt; to generate all
configuration in a way that is hopefully reusable on any Kubernetes home (lab)
setup. Stay tuned!&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Kubernetes Native CI With Argo]]></title><description><![CDATA[Introduction As I discussed in Why Kubernetes at small
scale, Kubernetes is
more an infrastructure framework than just a container scheduler…]]></description><link>https://5pi.de/2020/05/01/kubernetes-native-ci-with-argo/</link><guid isPermaLink="false">https://5pi.de/2020/05/01/kubernetes-native-ci-with-argo/</guid><pubDate>Fri, 01 May 2020 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 458px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a099ca3512e83579d67b0aa9ede5261a/f7a31/argo.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 49.079754601226995%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABtElEQVQoz31STUsCYRD23/hLolM3TxIKmadC7SCCkAfBKMlDHoLCIuzgxUNI3aKUEPESHQoJk3Qto9b8aDfdz/dp913frS1oYJZn5h2emZ1nXIQQUCM6oM/cDOmHgPzjVokTu0ygqDpeJaD1CXSmgChpNqnOGhjFDDPTNM3G7M1FDNAzSFoPTfSOttC6OMP9h4aJrLE5IUmSg8QkZzmTSFVVG7veBQXNsQrueAdieA5viSXcPT6hPVZoUaVSQSAQQD6fR6lUQjweRzKZRDgcRq1WozgUCqHdblsT9gTdCJ7weHON8cEmnq/O0by9Q3NoEQaDy6jX6/B6vfB4PCgUCpTEbOR2u5HL5WizdDptEaqajo6ggi/u42V9EYNsDA+dHoaStZPLyzKdxu/3I5vNgud5pFIp2iASiSCTydB3juMsQlNJ0VhV/3AD1ZUFcAkfRq9vM+EtUlmW7R0OBgNEo1H4fD6Uy2WaUxTle4dM8klxF+LaPMTtVZAhPzslp7IMd7tdNBoNW32nyrOEXD2FsBvD9GQPZCI6buyn/27w5w7tYCpCH/WhCyP7V/87YEb2c0rTvgD9d9LwP1fZRgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;argo&quot;
        title=&quot;argo&quot;
        src=&quot;/static/a099ca3512e83579d67b0aa9ede5261a/f7a31/argo.png&quot;
        srcset=&quot;/static/a099ca3512e83579d67b0aa9ede5261a/222b7/argo.png 163w,
/static/a099ca3512e83579d67b0aa9ede5261a/ff46a/argo.png 325w,
/static/a099ca3512e83579d67b0aa9ede5261a/f7a31/argo.png 458w&quot;
        sizes=&quot;(max-width: 458px) 100vw, 458px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h1 id=&quot;introduction&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#introduction&quot; aria-label=&quot;introduction permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Introduction&lt;/h1&gt;
&lt;p&gt;As I discussed in &lt;a href=&quot;/2018/12/18/why-kubernetes-at-small-scale/&quot;&gt;Why Kubernetes at small
scale&lt;/a&gt;, Kubernetes is
more an infrastructure framework than just a container scheduler.&lt;/p&gt;
&lt;p&gt;Every resource in your infrastructure is a Kubernetes Object and new Resources
can be defined using &lt;a href=&quot;https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources&quot;&gt;Custom Controllers and
Resources&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;argo&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#argo&quot; aria-label=&quot;argo permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Argo&lt;/h2&gt;
&lt;p&gt;One of the custom controllers I’m most excited about
&lt;a href=&quot;https://argoproj.github.io/&quot;&gt;Argo&lt;/a&gt;. It extends the Kubernetes API by providing
a &lt;a href=&quot;https://github.com/argoproj/argo/tree/master/examples#welcome&quot;&gt;Workflow
Object&lt;/a&gt; in which
each task is a command running in a container. It supports defining dependencies,
control structures, loops and recursion and parallelize execution. To capture
workflow artifacts, it supports &lt;a href=&quot;https://argoproj.github.io/docs/argo/configure-artifact-repository.html&quot;&gt;various
backends&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I’ve built the machine learning / training infrastructure for &lt;a href=&quot;/case-studies/koko/&quot;&gt;one of my
clients&lt;/a&gt; around Argo with great success. So when we looked
into options for CI/CD, we doubled down on Argo and build that on top of it as
well.&lt;/p&gt;
&lt;p&gt;Argo already supports git input artifacts, as shown in this example:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: input-artifact-git-
spec:
  entrypoint: git-clone
  templates:
  - name: git-clone
    inputs:
      artifacts:
      - name: argo-source
        path: /src
        git:
          repo: https://github.com/argoproj/argo.git
          revision: &quot;v2.1.1&quot;
    container:
      image: golang:1.10
      command: [sh, -c]
      args: [&quot;git status &amp;amp;&amp;amp; ls &amp;amp;&amp;amp; cat VERSION&quot;]
      workingDir: /src&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;k8s-webhook-handler&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#k8s-webhook-handler&quot; aria-label=&quot;k8s webhook handler permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;k8s-webhook-handler&lt;/h2&gt;
&lt;p&gt;Creating a workflow to build a code repository is straight forward. But how to
do it automatically when you push new code to GitHub?&lt;/p&gt;
&lt;p&gt;There is &lt;a href=&quot;https://github.com/argoproj/argo-events/&quot;&gt;argo-events&lt;/a&gt; but it was in
very early development and seemed concerned with many things beyond what we
needed. There also exists &lt;a href=&quot;https://github.com/argoproj/argo-ci&quot;&gt;argo-ci&lt;/a&gt; but
that project got stale and since was removed from the official argo docs.&lt;/p&gt;
&lt;p&gt;So I’ve created the
&lt;a href=&quot;https://github.com/airbnb/k8s-webhook-handler&quot;&gt;k8s-webhook-handler&lt;/a&gt;&lt;sup id=&quot;fnref-1&quot;&gt;&lt;a href=&quot;#fn-1&quot; class=&quot;footnote-ref&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;. It’s a
webhook-handler that handles incoming webhooks from GitHub by checking out a
Kubernetes manifests (&lt;code class=&quot;language-text&quot;&gt;.ci/workflow.yaml&lt;/code&gt; by default) and applies it to
Kubernetes with the following annotations set:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;k8s-webhook-handler.io/ref&lt;/code&gt;: Git reference (e.g. refs/heads/master)&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;k8s-webhook-handler.io/revision&lt;/code&gt;: The SHA of the most recent commit on ref after the push.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;k8s-webhook-handler.io/before&lt;/code&gt;: The SHA of the most recent commit on ref before the push.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;k8s-webhook-handler.io/repo_name&lt;/code&gt;: Repo name including user (e.g. airbnb/k8s-webhook-handler)&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;k8s-webhook-handler.io/repo_url&lt;/code&gt;: git URL (e.g. git://github.com/airbnb/k8s-webhook-handler.git)&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;k8s-webhook-handler.io/repo_ssh&lt;/code&gt;: ssh URL (e.g. git@github.com:airbnb/k8s-webhook-handler.git)&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;k8s-webhook-handler.io/event_type&lt;/code&gt;: Event type (e.g. &lt;code class=&quot;language-text&quot;&gt;push&lt;/code&gt; or &lt;code class=&quot;language-text&quot;&gt;delete&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;k8s-webhook-handler.io/event_action&lt;/code&gt;: Event type specific action (e.g. &lt;code class=&quot;language-text&quot;&gt;created&lt;/code&gt; or &lt;code class=&quot;language-text&quot;&gt;deleted&lt;/code&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is kept very generic. You could use this to apply any kind of resource but
we’re using it to submit an Argo workflow.&lt;/p&gt;
&lt;h1 id=&quot;ci-workflow&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ci-workflow&quot; aria-label=&quot;ci workflow permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;CI workflow&lt;/h1&gt;
&lt;h2 id=&quot;building-binaries&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#building-binaries&quot; aria-label=&quot;building binaries permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Building binaries&lt;/h2&gt;
&lt;p&gt;Now we can create an Argo Workflow that uses the annotations to checkout the code
as the desired revision and build it. Let’s take the k8s-webhook-handler itself
as an example.&lt;/p&gt;
&lt;p&gt;First we need to create &lt;code class=&quot;language-text&quot;&gt;.ci/workflow.yaml&lt;/code&gt; in the repository:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: ci-k8s-webhook-handler-
spec:
  entrypoint: build
  templates:
    - name: build
      inputs:
        artifacts:
          - name: source
            path: /src
            git:
              repo: &quot;{{workflow.annotations.k8s-webhook-handler.io/repo_ssh}}&quot;
              revision: &quot;{{workflow.annotations.k8s-webhook-handler.io/revision}}&quot;
      container:
        image: golang:1.14
        command: [&quot;go&quot;, &quot;install&quot;, &quot;./...&quot; ]
        workingDir: /src
      outputs:
        artifacts:
        - name: binaries
          path: /go/bin&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now the repository needs to be configured to send webhook requests for push
events to the k8s-webhook-handler as described in the &lt;a href=&quot;https://developer.github.com/webhooks/creating/&quot;&gt;GitHub
Docs&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;If we push code to the repository now, it will execute the workflow above to
checkout the code, build it and capture the build artifacts in Argo’s artifacts
repository.&lt;/p&gt;
&lt;h2 id=&quot;building-docker-images-with-kaniko&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#building-docker-images-with-kaniko&quot; aria-label=&quot;building docker images with kaniko permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Building Docker images with Kaniko&lt;/h2&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/54a2fe072c7e19200e97cdb2b4d7bc45/2e367/kaniko.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 31.901840490797547%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8UlEQVQY02VQvU7DMBjsC8CjdGCBoSw8EFOfiAVBOxIGoM3SIiVFVaIo5EeB2ImbH0ciS6oMSfzxKa6qVD1Zp7N1953tEQwg+nXQQhz5XEgeHbzbKSzu4ONa0MeirEn4k+c5Orquk1yWJaW0rmv0Nk0jQ31YNOJlDLML9nRj68oviVV12bat7/uEENd1HcdJksS27SAI4jg2DKOqqkFYGcP8kj1PvjevhO4+16uiKNCt6zqOwE7LsjRNw20URTgiy7LBtb/u4f0W3q6APPC/Pc9Tz/MwjJymKec8DEPGGNbiLNM0B81nHyZ6yAfDKeS51P/jQ0ZTBztmbgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;kaniko&quot;
        title=&quot;kaniko&quot;
        src=&quot;/static/54a2fe072c7e19200e97cdb2b4d7bc45/a6d36/kaniko.png&quot;
        srcset=&quot;/static/54a2fe072c7e19200e97cdb2b4d7bc45/222b7/kaniko.png 163w,
/static/54a2fe072c7e19200e97cdb2b4d7bc45/ff46a/kaniko.png 325w,
/static/54a2fe072c7e19200e97cdb2b4d7bc45/a6d36/kaniko.png 650w,
/static/54a2fe072c7e19200e97cdb2b4d7bc45/e548f/kaniko.png 975w,
/static/54a2fe072c7e19200e97cdb2b4d7bc45/2e367/kaniko.png 1066w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Now we have binaries but running everything on Kubernetes means we need
docker/container images. There is &lt;a href=&quot;https://github.com/kubernetes/kubernetes/issues/1806&quot;&gt;no native build support in
Kubernetes&lt;/a&gt; and the
suggested solution is using unprivileged build tools.&lt;/p&gt;
&lt;p&gt;We opted for &lt;a href=&quot;https://github.com/GoogleContainerTools/kaniko&quot;&gt;Kaniko&lt;/a&gt;. It
supports the Dockerfile format our developers are familiar with and doesn’t
require any elevated permissions, making it possible to run in a regular
Kubernetes pod.&lt;/p&gt;
&lt;aside&gt;Caveat: Since Kaniko runs unprivileged, it can&apos;t use layered filesystems
like Docker does, it needs to copy the files after each step which is slower
when many files are involved. A better solution for this would be
adding build primitives like the ability of snapshotting image layers to the
Kubernetes API.&lt;/aside&gt;
&lt;p&gt;Now with Kaniko we can use the following workflow to build the
k8s-webhook-handler Dockerfile:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: ci-k8s-webhook-handler-
spec:
  entrypoint: build
  volumes:
    - name: docker-config
      configMap:
        name: docker-config
  templates:
    - name: build
      metadata:
        annotations:
          iam.amazonaws.com/role: ci-role
      inputs:
        artifacts:
          - name: source
            path: /src
            git:
              repo: &quot;{{workflow.annotations.k8s-webhook-handler.io/repo_ssh}}&quot;
              revision: &quot;{{workflow.annotations.k8s-webhook-handler.io/revision}}&quot;
      container:
        image: gcr.io/kaniko-project/executor
        args:
          - &quot;--context=/src&quot;
          - &quot;--destination=xxx.dkr.ecr.us-east-1.amazonaws.com/k8s-webhook-handler:{{workflow.annotations.k8s-webhook-handler.io/revision}}&quot;
        volumeMounts:
          - name: docker-config
            mountPath: /kaniko/.docker/&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Since we’re using ECR, the docker-config volume just contains &lt;code class=&quot;language-text&quot;&gt;config.json&lt;/code&gt; with
the content &lt;code class=&quot;language-text&quot;&gt;{ &quot;credsStore&quot;: &quot;ecr-login&quot; }&lt;/code&gt; to make kaniko use the &lt;code class=&quot;language-text&quot;&gt;ecr-login&lt;/code&gt;
credential helper. See the &lt;a href=&quot;https://github.com/GoogleContainerTools/kaniko#pushing-to-different-registries&quot;&gt;kaniko
docs&lt;/a&gt;
for more details. To grant the pod IAM permissions to do that, we’re using
&lt;a href=&quot;https://github.com/jtblin/kube2iam&quot;&gt;kube2iam&lt;/a&gt; and the &lt;code class=&quot;language-text&quot;&gt;iam.amazonaws.com/role&lt;/code&gt;
annotation.&lt;/p&gt;
&lt;h2 id=&quot;deployment&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#deployment&quot; aria-label=&quot;deployment permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Deployment&lt;/h2&gt;
&lt;p&gt;Now we got a image, but how to deploy it? Argo supports workflows that consist
of a list of steps or a
&lt;a href=&quot;https://en.wikipedia.org/wiki/Directed_acyclic_graph&quot;&gt;DAG&lt;/a&gt;. While a list of
steps would be sufficient for a simple build-then-deploy workflow, we generally
prefer DAGs for their flexibility, so let’s use it in this example as well.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: ci-k8s-webhook-handler-
spec:
  entrypoint: ci
  serviceAccountName: ci-workflow
  arguments:
    parameters:
      - name: image
        value: &quot;xxx.dkr.ecr.us-east-1.amazonaws.com/k8s-webhook-handler:{{workflow.annotations.k8s-webhook-handler.io/revision}}&quot;
  volumes:
    - name: docker-config
      configMap:
        name: docker-config
  templates:
    - name: ci
      dag:
        tasks:
          - name: build
            template: build
          - name: deploy
            template: deploy
            dependencies: [build]
    - name: build
      metadata:
        annotations:
          iam.amazonaws.com/role: ci-role
      inputs:
        artifacts:
          - name: source
            path: /src
            git:
              repo: &quot;{{workflow.annotations.k8s-webhook-handler.io/repo_ssh}}&quot;
              revision: &quot;{{workflow.annotations.k8s-webhook-handler.io/revision}}&quot;
      container:
        image: gcr.io/kaniko-project/executor
        args:
          - &quot;--context=/src&quot;
          - &quot;--destination={{workflow.parameters.image}}&quot;
        volumeMounts:
          - name: docker-config
            mountPath: /kaniko/.docker/
    - name: deploy
      container:
        image: bitnami/kubectl:1.17.4
        args: [&quot;kubectl&quot;, &quot;set&quot;, &quot;image&quot;, &quot;deployment/k8s-webhook-handler&quot;, &quot;k8s-webhook-handler={{workflow.parameters.image}}&quot;]&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This workflow defines a DAG in the &lt;code class=&quot;language-text&quot;&gt;ci&lt;/code&gt; template with two tasks where deploy
depends on build, so it runs after that. To allow the workflow to change
resources in Kubernetes, we specify &lt;code class=&quot;language-text&quot;&gt;serviceAccountName: ci-workflow&lt;/code&gt;. Follow
the &lt;a href=&quot;https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/&quot;&gt;Kubernetes
Docs&lt;/a&gt;
for details on how to create service accounts.&lt;/p&gt;
&lt;p&gt;On push, this workflow will now build the image and update the
&lt;code class=&quot;language-text&quot;&gt;k8s-webhook-handler&lt;/code&gt; container in the &lt;code class=&quot;language-text&quot;&gt;k8s-webhook-handler&lt;/code&gt; deployment to use
the new image.&lt;/p&gt;
&lt;h2 id=&quot;branch-based-continuous-integration&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#branch-based-continuous-integration&quot; aria-label=&quot;branch based continuous integration permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Branch based continuous integration&lt;/h2&gt;
&lt;p&gt;The above example would update the &lt;code class=&quot;language-text&quot;&gt;k8s-webhook-handler&lt;/code&gt; in the default
namespace on every push, no matter which branch. It also doesn’t handle the
initial creation of the deployment. That’s probably not what you want in
production.&lt;/p&gt;
&lt;p&gt;What we are doing is using a custom deployment image with scripts
that render templates from the source repository. Beside using the image name
from the workflow in the deployment manifests, we deploy all resources in a
Kubernetes namespace based on the branch name. This allows developers to test
their changes in a separate namespace before merging and deploying to the
production namespace.&lt;/p&gt;
&lt;p&gt;But what happens if a developer deletes their branch? k8s-webhook-handler
supports any kind of GitHub events, so we actually send many more events to it
and use the &lt;code class=&quot;language-text&quot;&gt;k8s-webhook-handler.io/event_type&lt;/code&gt; annotations to distinguish
between them. That allows us to run a separated &lt;code class=&quot;language-text&quot;&gt;push&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;delete&lt;/code&gt; DAG in the
workflow:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;...
  templates:
    - name: ci
      dag:
        tasks:
          - name: push
            template: push
            when: &quot;&apos;{{workflow.annotations.k8s-webhook-handler.io/event_type}}&apos; == &apos;push&apos;&quot;
          - name: delete
            template: delete
            when: &quot;&apos;{{workflow.annotations.k8s-webhook-handler.io/event_type}}&apos; == &apos;delete&apos;&quot;
    - name: push
      dag:
        tasks:
          - name: build
            template: build
          - name: deploy
            template: deploy
            dependencies: [build]
    - name: delete
      container:
        image: custom-ci-tools-image
        command: [ &quot;delete-namespace-for-ref&quot;, &quot;{{workflow.annotations.k8s-webhook-handler.io/ref}}&quot;]
...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;advanced-builds-github-checks-slack-notifications-and-more&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#advanced-builds-github-checks-slack-notifications-and-more&quot; aria-label=&quot;advanced builds github checks slack notifications and more permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Advanced builds, GitHub checks, Slack notifications and more&lt;/h2&gt;
&lt;p&gt;The generic nature of the Argo workflow allows it to handle pretty much any build
and deployment needs. We have additional steps that use our custom ci scripts
to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Ensure the ECR repositories exist&lt;/li&gt;
&lt;li&gt;Sending build notifications to Slack and update &lt;a href=&quot;https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/about-status-checks&quot;&gt;GitHub’s status
checks&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Add deployment annotations to our monitoring system&lt;/li&gt;
&lt;li&gt;Calculate image tags based on file checksums to avoid unnecessary builds&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Here is an example of one of our more sophisticated CI workflows that builds
multiple variants of an project based on multiple base images, to support GPU
and non-GPU deployments:
&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e7c53a5a4cbff2c265f5e0064b0c1265/3cd52/koko-ci.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 116.56441717791411%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAACmUlEQVQ4y5VU2W7TUBD139JnQDzzFXwAgheCUFkESBR4ACGUsISqLWm8JPG++9pO6ZJWh5mb2iSuHdqHkey7zJx7zplRdCdEW0zdGLcH23hvjXBcHiNKM7hRJvcMN0LXPYU3m1Fd4qSGE0Gzw5X1EG13quhMyDGjhBP6H5setMu11YLXSrj65K2vPezYI+ACWJyfI8wKQhvcDGGVkJFtj3fx0zYRpyUCSmYGyUZ0/0348KCPH66FOMkRpDnsML1ewjbl+Ml3v73AjjlCmc0RZQI+JV4VSG/hVdlE9MSOMPNiTCnMIMXEu3qumbQTIf9/HxlwghgiL7BYLBCJEuqlKKvnOhE2Q7V8iWrmx7AkwrjT0DXC6oe5aT5nVzVhE8IwyRCLHF4i1s6wN7UG0n8JWyru6RZMQpeQZYrsCE6Y1YU5bC8l8yeShrr15Id7FXpdlVrvl2mjdziE6vrEaQI3zqhQglfqHr6YBjyiw4lSWGQrRfYrXVytUvXxmNZMQvBpomGr34Me+chFgXw+hx8K3Bu8xGNtgJPiD1ISLqY95bftUeWlkatQnQC8znZhUTiYEhal4mpGCCdEhyH3l9aSHN4ZPMcjtQ+cXuDs4hxH5QmejobYGvRQkE2Kco7Ts0V9gXk90E1khChJBfGbr9GkvFb30bemiJJCqsjED00LH4wxfTM3NAdjUSMbk5XYTjwbmTfeX/Oh42VSKeaLD/PI+qgd4sH+Z6luQJbxSASjIRpzLm1jN3y4NufcpRXeaAe4P3wLQU9mD3LSytRdQ6Gzl5eDNYHnixqFvqE9my2otDX5oe1j17JJiKXCUz/+76RunYeMxvUzPCMT3+o/QVnMiUeBo+MTmfTGCas5yCq/00ckhpBd0VRyU/wF7O+VrEeBZIEAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;koko-ci&quot;
        title=&quot;koko-ci&quot;
        src=&quot;/static/e7c53a5a4cbff2c265f5e0064b0c1265/a6d36/koko-ci.png&quot;
        srcset=&quot;/static/e7c53a5a4cbff2c265f5e0064b0c1265/222b7/koko-ci.png 163w,
/static/e7c53a5a4cbff2c265f5e0064b0c1265/ff46a/koko-ci.png 325w,
/static/e7c53a5a4cbff2c265f5e0064b0c1265/a6d36/koko-ci.png 650w,
/static/e7c53a5a4cbff2c265f5e0064b0c1265/3cd52/koko-ci.png 857w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;init&lt;/em&gt; adds a GitHub status check indicating that the build is running&lt;/li&gt;
&lt;li&gt;&lt;em&gt;calculate-tags&lt;/em&gt; creates checksums from various files to determine what needs to
get rebuild which leads to skipping rebuild of both base images&lt;/li&gt;
&lt;li&gt;&lt;em&gt;update-kubeflow&lt;/em&gt; adds new Jupyter notebook builds to kubeflow&lt;/li&gt;
&lt;li&gt;&lt;em&gt;report-status&lt;/em&gt; updates the GitHub status check and notifies Slack&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;conclusion&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#conclusion&quot; aria-label=&quot;conclusion permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Conclusion&lt;/h1&gt;
&lt;p&gt;Argo is a relatively small but very powerful extension of the Kubernetes API.
I’ve been using various CI/CD systems over the years and while most are easier
to use for simple use cases, things tend to get tedious for more advanced and
less anticipated use cases. Argo gets away with much less complexity than most
of these systems as well, since all the heavy lifting of scheduling and
abstraction of build steps is done by Kubernetes. It’s a shining example of what
is so great about Kubernetes: It’s not just the datacenter as a computer idea,
but also the building blocks that &lt;em&gt;are&lt;/em&gt; complex but only need to be solved once,
by Kubernetes, to benefit many different use cases on top of it.&lt;/p&gt;
&lt;hr&gt;
&lt;div class=&quot;footnotes&quot;&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id=&quot;fn-1&quot;&gt;
&lt;p&gt;&lt;small&gt;Koko has been acquired by Airbnb where a modified version of this
CI setup is still being used.&lt;/small&gt;&lt;/p&gt;
&lt;a href=&quot;#fnref-1&quot; class=&quot;footnote-backref&quot;&gt;↩&lt;/a&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</content:encoded></item><item><title><![CDATA[Running Kubernetes on OpenWrt]]></title><description><![CDATA[Why.. 
Me, better with clean software than clean hardware As you might know, I’m living in Berlin, Germany. Maybe you also know that our…]]></description><link>https://5pi.de/2019/05/10/k8s-on-openwrt/</link><guid isPermaLink="false">https://5pi.de/2019/05/10/k8s-on-openwrt/</guid><pubDate>Fri, 10 May 2019 00:00:00 GMT</pubDate><content:encoded>&lt;h1 id=&quot;why&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#why&quot; aria-label=&quot;why permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Why..&lt;/h1&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/d2602/homeinfra.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 74.84662576687117%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABpux5hgoP/8QAGxAAAQQDAAAAAAAAAAAAAAAAAAECAxEEFCH/2gAIAQEAAQUC2FVJZ2ux74WWf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABoQAAICAwAAAAAAAAAAAAAAAAERAAISIGH/2gAIAQEABj8CSqBwTBF6/wD/xAAZEAADAQEBAAAAAAAAAAAAAAAAARFhITH/2gAIAQEAAT8hTTPQHJYJ0SJKVo8aUf/aAAwDAQACAAMAAAAQxx//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8QrX//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPxBH/8QAGxAAAgMBAQEAAAAAAAAAAAAAAREAIUExUWH/2gAIAQEAAT8QGsRYCtl7GfMhAJg3TrYBGZHkBDjdP6eRfChP/9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;&amp;quot;Home Infrastructure&amp;quot;&quot;
        title=&quot;&amp;quot;Home Infrastructure&amp;quot;&quot;
        src=&quot;/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/6aca1/homeinfra.jpg&quot;
        srcset=&quot;/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/d2f63/homeinfra.jpg 163w,
/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/c989d/homeinfra.jpg 325w,
/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/6aca1/homeinfra.jpg 650w,
/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/7c09c/homeinfra.jpg 975w,
/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/01ab0/homeinfra.jpg 1300w,
/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/d2602/homeinfra.jpg 4032w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;
&lt;em&gt;Me, better with clean software than clean hardware&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;As you might know, I’m living in Berlin, Germany. Maybe you also know that &lt;a href=&quot;https://www.npr.org/2019/01/03/678803790/berlin-is-a-tech-hub-so-why-are-germanys-internet-speeds-so-slow&quot;&gt;our
Internet is
slow&lt;/a&gt;.
But I finally found a cable internet provider which is supposed to deliver up to
400 MBit to my home. Unfortunately &lt;a href=&quot;https://www.trustpilot.com/review/pyur.com&quot;&gt;their service seems to be really bad&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;So instead of canceling my old DSL aka copper aka phone line based internet,
I’m using both for redundancy reasons.&lt;/p&gt;
&lt;p&gt;To make use of both providers, I’d needed a new router.&lt;/p&gt;
&lt;p&gt;About 13 years ago I came across &lt;a href=&quot;https://www.openwrt.org&quot;&gt;OpenWrt&lt;/a&gt; and loved
it. I’ve even made it my &lt;a href=&quot;router.pdf&quot;&gt;final project as school (German)&lt;/a&gt;. So I
wanted to use it for this project again.&lt;/p&gt;
&lt;p&gt;As hardware I wanted something that has enough power to do VPN and NAT
operations at line speed and has at least 3x 1GBit ports. After heaving heard
good things about “PC Engines” (thanks to &lt;a href=&quot;https://twitter.com/zekjur&quot;&gt;Michael
Stapelberg&lt;/a&gt; for the recommendation!), I’ve decided
to buy a &lt;a href=&quot;https://pcengines.ch/apu2d4.htm&quot;&gt;apu2d4&lt;/a&gt; with 16GB mSATA SSD.
Unfortunately there are no well supported and fast wifi chipsets, so I’ve
decided to use a Unifi AP for Wifi.&lt;/p&gt;
&lt;p&gt;Setting this up was a matter of minutes:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Write openwrt &lt;code class=&quot;language-text&quot;&gt;x86_64&lt;/code&gt; image with &lt;code class=&quot;language-text&quot;&gt;dd&lt;/code&gt; to a USB drive&lt;/li&gt;
&lt;li&gt;Boot the apu2 from it&lt;/li&gt;
&lt;li&gt;Use &lt;code class=&quot;language-text&quot;&gt;dd&lt;/code&gt; to write USB drive to SSD&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;That’s it. But now that I have this powerful router, I might as well run
&lt;a href=&quot;https://prometheus.io&quot;&gt;Prometheus&lt;/a&gt; and other services not directly related to
routing on it. I could run these directly on OpenWrt but that would require packaging them as OpenWrt packages and requiring to build everything from source to be properly integrated with their buildroot. This, and for all other reasons containers are great I want to run these things as container images.&lt;/p&gt;
&lt;h1 id=&quot;custom-kernel&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#custom-kernel&quot; aria-label=&quot;custom kernel permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Custom Kernel&lt;/h1&gt;
&lt;p&gt;The default OpenWrt Kernel for &lt;code class=&quot;language-text&quot;&gt;x86_64&lt;/code&gt; doesn’t include the necessary features,
so I had to build my own image. I’ve disabled some features I won’t use and
enabled options for cgroups, namespaces, overlayfs and the required networking
options. You can find my config diff
&lt;a href=&quot;https://github.com/5pi-home/openwrt/blob/master/config&quot;&gt;here&lt;/a&gt; (created by
&lt;code class=&quot;language-text&quot;&gt;./scripts/diffconfig.sh&lt;/code&gt;). If you want to create your own image, you need the
following options:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;For process and resource isolation:&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;CONFIG_KERNEL_BLK_CGROUP=y
CONFIG_KERNEL_CGROUPS=y
CONFIG_KERNEL_CGROUP_CPUACCT=y
CONFIG_KERNEL_CGROUP_DEVICE=y
CONFIG_KERNEL_CGROUP_FREEZER=y
CONFIG_KERNEL_CGROUP_PIDS=y
CONFIG_KERNEL_CGROUP_SCHED=y
CONFIG_KERNEL_CPUSETS=y
CONFIG_KERNEL_DEVPTS_MULTIPLE_INSTANCES=y
CONFIG_KERNEL_FAIR_GROUP_SCHED=y
CONFIG_KERNEL_FREEZER=y
CONFIG_KERNEL_IPC_NS=y
CONFIG_KERNEL_KEYS=y
CONFIG_KERNEL_LXC_MISC=y
CONFIG_KERNEL_MEMCG=y
CONFIG_KERNEL_NAMESPACES=y
CONFIG_KERNEL_NETPRIO_CGROUP=y
CONFIG_KERNEL_NET_CLS_CGROUP=y
CONFIG_KERNEL_NET_NS=y
CONFIG_KERNEL_PID_NS=y
CONFIG_KERNEL_POSIX_MQUEUE=y
CONFIG_KERNEL_PROC_PID_CPUSET=y
CONFIG_KERNEL_RESOURCE_COUNTERS=y
CONFIG_KERNEL_SECCOMP=y
CONFIG_KERNEL_SECCOMP_FILTER=y
CONFIG_KERNEL_USER_NS=y
CONFIG_KERNEL_UTS_NS=y&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;For networking:&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;CONFIG_PACKAGE_ip-bridge=y
CONFIG_PACKAGE_ip-full=y
CONFIG_PACKAGE_ipset=y
CONFIG_PACKAGE_iptables-mod-conntrack-extra=y
CONFIG_PACKAGE_iptables-mod-extra=y
CONFIG_PACKAGE_iptables-mod-ipopt=y
CONFIG_PACKAGE_kmod-asn1-decoder=y
CONFIG_PACKAGE_kmod-br-netfilter=y
CONFIG_PACKAGE_kmod-ikconfig=y
CONFIG_PACKAGE_kmod-ipt-conntrack-extra=y
CONFIG_PACKAGE_kmod-ipt-extra=y
CONFIG_PACKAGE_kmod-ipt-ipopt=y
CONFIG_PACKAGE_kmod-ipt-ipset=y
CONFIG_PACKAGE_kmod-ipt-raw=y
CONFIG_PACKAGE_kmod-iptunnel=y
CONFIG_PACKAGE_kmod-nf-conntrack-netlink=y
CONFIG_PACKAGE_kmod-nf-ipvs=y
CONFIG_PACKAGE_kmod-nfnetlink=y
CONFIG_PACKAGE_kmod-nls-base=y
CONFIG_PACKAGE_kmod-udptunnel4=y
CONFIG_PACKAGE_kmod-udptunnel6=y
CONFIG_PACKAGE_kmod-veth=y
CONFIG_PACKAGE_kmod-vxlan=y
CONFIG_PACKAGE_libnetfilter-conntrack=y
CONFIG_PACKAGE_libnfnetlink=y&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The required &lt;code class=&quot;language-text&quot;&gt;overlayfs&lt;/code&gt; module for the container engines storage driver should
be already enabled.&lt;/p&gt;
&lt;h2 id=&quot;build-it-yourself&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#build-it-yourself&quot; aria-label=&quot;build it yourself permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Build it yourself&lt;/h2&gt;
&lt;p&gt;To build your own image, start by cloning &lt;code class=&quot;language-text&quot;&gt;git@github.com:openwrt/openwrt.git&lt;/code&gt;
and run &lt;code class=&quot;language-text&quot;&gt;./scripts/feeds update -a&lt;/code&gt; to include the package feeds.&lt;/p&gt;
&lt;p&gt;Then run &lt;code class=&quot;language-text&quot;&gt;make menuconfig&lt;/code&gt; to set your target hardware, exit again and run &lt;code class=&quot;language-text&quot;&gt;make
defconfig&lt;/code&gt;. That will set the default config for the target hardware.&lt;/p&gt;
&lt;p&gt;Now you can either run &lt;code class=&quot;language-text&quot;&gt;make menuconfig&lt;/code&gt; again and select the options from above
manually or just edit &lt;code class=&quot;language-text&quot;&gt;.config&lt;/code&gt; to paste the options from above.&lt;/p&gt;
&lt;p&gt;After that you should be able to build your image by running &lt;code class=&quot;language-text&quot;&gt;make&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;You should save the output of &lt;code class=&quot;language-text&quot;&gt;./scripts/diffconfig.sh&lt;/code&gt; somewhere so be able to
recreate your image in the future.&lt;/p&gt;
&lt;p&gt;Now it’s time to upgrade OpenWrt. I just &lt;code class=&quot;language-text&quot;&gt;scp&lt;/code&gt; the image to the router and use
&lt;a href=&quot;https://openwrt.org/docs/guide-user/installation/sysupgrade.cli&quot;&gt;sysupgrade&lt;/a&gt; to
apply the new image.&lt;/p&gt;
&lt;p&gt;If you still have trouble starting docker you can run Docker’s &lt;a href=&quot;https://github.com/moby/moby/blob/master/contrib/check-config.sh&quot;&gt;check-config.sh
script&lt;/a&gt; to
make sure all necessary features are enabled. You’d need to install bash first
and have &lt;code class=&quot;language-text&quot;&gt;CONFIG_PACKAGE_kmod-ikconfig=y&lt;/code&gt; enabled.&lt;/p&gt;
&lt;h2 id=&quot;automate-it&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#automate-it&quot; aria-label=&quot;automate it permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Automate it&lt;/h2&gt;
&lt;p&gt;There is nothing more frustrating than having such setup run for a few month,
then need to change something and realize there is no way to reproduce what you
did without starting all over. Many thing we learned when building resilient
infrastructure at scale can be applied at home too. Therefor &lt;a href=&quot;https://github.com/5pi-home/openwrt&quot;&gt;I’ve codified the
setup and added it to CI&lt;/a&gt;.
All I need to upgrade is bumping the version in the
&lt;a href=&quot;https://github.com/5pi-home/openwrt/blob/master/Dockerfile#L14&quot;&gt;Dockerfile&lt;/a&gt; and
wait for CircleCI to get a new OpenWrt image.&lt;/p&gt;
&lt;h1 id=&quot;packaging&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#packaging&quot; aria-label=&quot;packaging permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Packaging&lt;/h1&gt;
&lt;h2 id=&quot;docker&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#docker&quot; aria-label=&quot;docker permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Docker&lt;/h2&gt;
&lt;p&gt;Initially I thought, all I want is Docker. And while it’s possible to use just
extract the official Docker binaries to /usr/bin and bring up Docker that way,
using proper packages for OpenWrt’s &lt;code class=&quot;language-text&quot;&gt;opkg&lt;/code&gt; package manager is a cleaner
solution. For that I’ve created
&lt;a href=&quot;https://github.com/discordianfish/docker-on-openwrt&quot;&gt;docker-on-openwrt&lt;/a&gt; which
creates a &lt;code class=&quot;language-text&quot;&gt;opkg&lt;/code&gt; package for docker from the official Docker binaries and adds
an init script and config to it. You can check it out and run &lt;code class=&quot;language-text&quot;&gt;make&lt;/code&gt; to build it
yourself or one of use my
&lt;a href=&quot;https://github.com/discordianfish/docker-on-openwrt/releases&quot;&gt;releases&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;kubernetes-k3s&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kubernetes-k3s&quot; aria-label=&quot;kubernetes k3s permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Kubernetes (k3s)&lt;/h2&gt;
&lt;p&gt;But then &lt;a href=&quot;https://k3s.io/&quot;&gt;k3s&lt;/a&gt; was born. It’s lightweight Kubernetes which
replaces etcd3 by sqlite3 which trades high availability by easier operations.
It also includes containerd, so no need to install Docker.&lt;/p&gt;
&lt;p&gt;I already blogged about &lt;a href=&quot;/2018/12/18/why-kubernetes-at-small-scale/&quot;&gt;why Kubernetes makes sense at small
scale&lt;/a&gt;, so this seems perfect!&lt;/p&gt;
&lt;p&gt;Similar to the Docker packages, I’ve created
&lt;a href=&quot;https://github.com/discordianfish/k3s-openwrt&quot;&gt;k3s-openwrt&lt;/a&gt; which builds
OpenWrt packages from k3s binaries. Again, feel free to use my
&lt;a href=&quot;https://github.com/discordianfish/k3s-openwrt/releases&quot;&gt;releases&lt;/a&gt; if you don’t
want to build it yourself.&lt;/p&gt;
&lt;p&gt;Depending on your setup, you might need to configure your firewall properly to
allow traffic from and to the pod network. In my case I’ve created a new
interface definition for the cni0 interface:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;/etc/config/network&lt;/strong&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;config interface &apos;k8s&apos;
	option proto &apos;none&apos;
	option ifname &apos;cni0&apos;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And a zone which allows input/output/forward traffic:
&lt;strong&gt;/etc/config/firewall&lt;/strong&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;config zone
	option name &apos;k8s&apos;
	option input &apos;ACCEPT&apos;
	option output &apos;ACCEPT&apos;
	option forward &apos;ACCEPT&apos;
	option network &apos;k8s&apos;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h1 id=&quot;summary&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#summary&quot; aria-label=&quot;summary permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Summary&lt;/h1&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0dfbce4d4f1b5751a08a7e3a269d237d/0d98f/grafana.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 85.2760736196319%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsTAAALEwEAmpwYAAACZUlEQVQ4y1VTS27dMAz0OfJ+tmV9qb8l2+8hyCJAlt20BdpLdNET9Ood2WmbAgOBokhxOKK6um65LCHmXMpcqvNRSCWVPqC0cT44F2KaERN3hJCCT3B2/SSv/Xi99afz5el0xnq+3HZcT+d/eDpdcPTRc770nZDa2mjIMyb7gffDdGAcuVJWKRoGfrtNw8gbhmnYT9vas05pisEHb5yldfG1+Dm7OcNjawnbGpelrc/P6X6PKfmcfal+2yKa6pQyxlhjCIi4ALYmMqR18zhnU7Qx2Bytd1ZrRCKGvHPTJDvOFWyQPF3YtQe9d9rN6BkI3/o/eGf7TvvWjx0uEMJwTa8vrTDaHsdpZJyPyobg5sCFHlvDuwqGwpIgEmwAlSUT+udX+vXNvm1GScOFEoOmN+u+u+CoBngMCEo0WEknu2ay2jDQHpkMTv/4pB9WB62j1iOXvFf0hcxnUlEv1kxCMQZ+Sgdzv78kIq/UOImOMQ7BJ0kwpNSQpHEWCgYSGIpqh+3+coTiOBUCYdRos0mEkIOPQ89w4zxX5CAOI9X4C43RQw6c1gbID0Mb61xsyahQly3lAhdUGXadd80Z1D5weP7DMSQQDPmYMynNMUDHMTw7T0L9Dzms3zFMAi/XHe2BHpIRjf4xNrDJOguxfSTrsdWGsGJb69q+R1mVcZgwCnMONaZ1TiuM5GtyOaZ7zo/Zl5geM059SfkBbyxl9T7hYyERH8OE9sdsrancaw62ZIy3r3NbS3I1u5zDel8w2CD4F1AO78wxzTXaOoNBKjCiQ+1WPlCJriQ7R7ctOXlILTGRDVwi8Tc7oaX0C8EeGgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;grafana&quot;
        title=&quot;grafana&quot;
        src=&quot;/static/0dfbce4d4f1b5751a08a7e3a269d237d/a6d36/grafana.png&quot;
        srcset=&quot;/static/0dfbce4d4f1b5751a08a7e3a269d237d/222b7/grafana.png 163w,
/static/0dfbce4d4f1b5751a08a7e3a269d237d/ff46a/grafana.png 325w,
/static/0dfbce4d4f1b5751a08a7e3a269d237d/a6d36/grafana.png 650w,
/static/0dfbce4d4f1b5751a08a7e3a269d237d/e548f/grafana.png 975w,
/static/0dfbce4d4f1b5751a08a7e3a269d237d/0d98f/grafana.png 1276w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;
All this turned out to be very useful. It was never more fun to build things for
my home network. I’m running an ingress controller with the wildcard DNS record
&lt;code class=&quot;language-text&quot;&gt;*.d.42o.d&lt;/code&gt; pointing to it, which means I can just create an ingress
&lt;code class=&quot;language-text&quot;&gt;foo.d.42o.de&lt;/code&gt; for a new service without having to update DNS records.&lt;/p&gt;
&lt;p&gt;You might ask what services could I possibly be reasonable to run here. Here is
what I managed to squeeze on this box:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;unifi-controller&lt;/li&gt;
&lt;li&gt;Prometheus, not only monitoring my systems but also temperature, humidity and
air pressure using &lt;a href=&quot;https://github.com/vonneudeck/mouldy&quot;&gt;mouldy&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Grafana for nice dashboards&lt;/li&gt;
&lt;li&gt;openhab2 to integrate 433Mhz RF sockets with Amazon Alexa&lt;/li&gt;
&lt;li&gt;Plex with sonarr, radarr and nzbget&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;While I spend a few days getting the setup working, this works so reliable so
far, that it might actually pay off going forward.&lt;/p&gt;
&lt;p&gt;Next I’ve planned to switch all services to HTTPS because it’s about damn time
to stop using HTTP event at home. Thanks to &lt;a href=&quot;https://letsencrypt.org/&quot;&gt;let’s encrypt&lt;/a&gt; and &lt;a href=&quot;https://github.com/jetstack/cert-manager&quot;&gt;cert-manager&lt;/a&gt; that should be feasible.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Why Kubernetes at small scale?]]></title><description><![CDATA[Google Scale Wannabes 
I’ve frequently hear people say something like this: The number of people who adopt complicated stuff like Kubernetes…]]></description><link>https://5pi.de/2018/12/18/why-kubernetes-at-small-scale/</link><guid isPermaLink="false">https://5pi.de/2018/12/18/why-kubernetes-at-small-scale/</guid><pubDate>Tue, 18 Dec 2018 17:00:00 GMT</pubDate><content:encoded>&lt;h2 id=&quot;google-scale-wannabes&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#google-scale-wannabes&quot; aria-label=&quot;google scale wannabes permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Google Scale Wannabes&lt;/h2&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/634d60838678047c8b9f6f323a3a9be1/00d43/wannabe.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 33.74233128834356%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB2ElEQVQoz02RS08TARSF528Yf4VrF8YtMcZE0KSJEhYGBV1gxZZEfCHGlmihiMFIUhRaLdbGyMPKosVHhUK0KRUwKDFIW8UySKfT13RmPtspRu9Nbk7uOfcs7hHs40UuuPO0e/KsJFVAq3StdE1D13X0Kq4y2l+mVq4lP5tyuqbd1Qv+BcVYyEUoKbqB1a00emrj32VuGcoZA+ZLGutbGmrF+/JcH4nSNvxKo0o7Bi9Ux9qmhnMqy9B7SM1Gka5Z+NFxHikQoJx0IEXqUWImxPQaV56VuOqTaR/JYY3cZ2XCQ9pqRjSfpvztK0L8u8LzJyOYux9T118gdMbKO7sF//gMyZZjiDP7cd4cIOiqw/vQTNeYTDT+icMdsxxwnGT6xCGizS2IFQ8tlUBoe5SjuStAa98SvSGFKfsAHw7uY7HJxOLtO6wGTUScewnf28Op1jYsoxKOyd8cvRjh+K0jvL3bzXJjI6lBJ/rPFIKYVTlnC2PumWY+9pmJl2Fe1Z8lNuQywtlIrOPpb+Dp8A06baNccq3S1BOloTNGr91G8GOcOfcY229C1VRqP0QvkpezZCQZtayQ03QK/6WZVzDMy5Ux/LrAdV+GyYUd5qNf8Ppe8MDtRdnV/gEjFtKhxCfkQAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Google - Wannabe&quot;
        title=&quot;Google - Wannabe&quot;
        src=&quot;/static/634d60838678047c8b9f6f323a3a9be1/a6d36/wannabe.png&quot;
        srcset=&quot;/static/634d60838678047c8b9f6f323a3a9be1/222b7/wannabe.png 163w,
/static/634d60838678047c8b9f6f323a3a9be1/ff46a/wannabe.png 325w,
/static/634d60838678047c8b9f6f323a3a9be1/a6d36/wannabe.png 650w,
/static/634d60838678047c8b9f6f323a3a9be1/e548f/wannabe.png 975w,
/static/634d60838678047c8b9f6f323a3a9be1/00d43/wannabe.png 1000w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;
I’ve frequently hear people say something like this:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The number of people who adopt complicated stuff like Kubernetes for what is
essentially a couple of web servers and a database is too high. They’re Google
wannabies that thinks in Google’s scale but forget that it is utterly
unnecessary in their case.&lt;/p&gt;
&lt;p&gt;&lt;cite&gt;reacharavindh, &lt;a href=&quot;https://news.ycombinator.com/item?id=18128235&quot;&gt;https://news.ycombinator.com/item?id=18128235&lt;/a&gt;&lt;/cite&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;They have a point. Kubernetes is touted as container orchestration system. You
request resources for your container and it will automatically figure out where
to run it. This is important once you have more than a handful of systems to
ensure good utilization without having a human to play tetris shuffling your
applications around. It’s API and &lt;a href=&quot;https://kubernetes.io/docs/reference/access-authn-authz/rbac/&quot;&gt;Role-based access
control&lt;/a&gt; allows
you to support many developer without a Ops person or team becoming the
bottleneck.&lt;/p&gt;
&lt;p&gt;These things are certainly more important at Google’s scale than in a small
shop. You might have just 4 VMs, an application and a reverse proxy. A typical
small web startup, maybe 2-3 developer. At that scale it wouldn’t be a problem
to manually update the operating system, figure out where to run your
application and move it around when needed.&lt;/p&gt;
&lt;p&gt;That’s why people think introducing a complex system like Kubernetes can’t be
possible worth it. I believe they miss something: Kubernetes is not only a
cluster scheduler, it’s also an opinionated infrastructure framework.&lt;/p&gt;
&lt;h2 id=&quot;kubernetes-love&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kubernetes-love&quot; aria-label=&quot;kubernetes love permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Kubernetes love&lt;/h2&gt;
&lt;p&gt;Let’s get this out the way first: I love Kubernetes and these days I make most
of my money helping companies to build their infrastructure around Kubernetes.
Not primarily because it’s hyped and lot of people want help migrating to it but
because it’s my tool of choice after building infrastructure for a decade
without it:
I’ve built infrastructure in pre-config management enterprise environments, used
chef to built infrastructure serving millions of
users and dabbled in Ansible and Salt.&lt;/p&gt;
&lt;p&gt;I concluded that robust abstractions are the key to manage large and complex
infrastructure. Making your &lt;a href=&quot;https://5pi.de/2015/03/13/building-aws-amis-from-scratch/&quot;&gt;(virtual) machines
immutable&lt;/a&gt; limits
change to your machines to the build time of your images. Running your
application in
&lt;a href=&quot;https://5pi.de/2015/01/08/containerized-infrastructure/&quot;&gt;containers&lt;/a&gt; does the
same for your application. For configuration, you can &lt;a href=&quot;https://5pi.de/2015/08/31/dont-manage-config-unless-you-have-to/&quot;&gt;bake
in&lt;/a&gt; site
specific config at build time to reduce what you need to worry about at runtime.&lt;/p&gt;
&lt;p&gt;These patterns are largely deployment agnostic. While immutable machine images
are common on cloud providers, it’s reasonable to do the same when provisioning
bare metal. Application images are made popular by Docker, but people used
&lt;a href=&quot;https://en.wikipedia.org/wiki/Chroot&quot;&gt;chroot&lt;/a&gt; based deployment long before that
to achieve similar goals.&lt;/p&gt;
&lt;p&gt;But Kubernetes is a opinionated, vendor agnostic framework based on all the
concepts I learned to help with managing infrastructure.&lt;/p&gt;
&lt;h2 id=&quot;snowflake-infrastructure&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#snowflake-infrastructure&quot; aria-label=&quot;snowflake infrastructure permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Snowflake Infrastructure&lt;/h2&gt;
&lt;p&gt;Let’s stay with the small web shop example for a moment:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;2x reverse proxies, terminating TLS and sending requests to..&lt;/li&gt;
&lt;li&gt;2x webservers which connect to..&lt;/li&gt;
&lt;li&gt;1x database&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For the sake of the argument, let say the database is a managed service. If it’s
not, even more reason to use Kubernetes. Let say you’re on AWS, but that doesn’t
really matter either.&lt;/p&gt;
&lt;h3 id=&quot;provisioning&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#provisioning&quot; aria-label=&quot;provisioning permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Provisioning&lt;/h3&gt;
&lt;p&gt;Without Kubernetes, you could click yourself two VMs and an ALB or ELB. Next you
configure your TLS certificates, either by purchasing them or using AWS
Certificate Manager to create one automatically.
Or use Cloudformation to manage this if you want infrastructure-as-code. Now you
can give your VMs well-known DNS names and use rsync to deploy to it. Or do you
appreciate Docker’s isolation? Then build, push, pull and run your images. Maybe
write a shell script for that.&lt;/p&gt;
&lt;p&gt;Now copy your database secrets there somehow. You probably want to monitor this
with the tool of your choice.  Where to deploy it? Maybe create a new VM. Make
sure it can reach the systems by allowing whatever protocol it uses. Hardcode
the well-known VM names into your monitoring. Or maybe use the AWS API to
automatically update this. You could write a small shell script for that. You
might also consider using configuration management at this time. Maybe you come
up with good roles/cookbooks/scripts to configure monitoring, after deciding how
to lay out your deployment. Maybe you create systemd unit, maybe you deploy
runit..&lt;/p&gt;
&lt;h3 id=&quot;access-on-offboarding&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#access-on-offboarding&quot; aria-label=&quot;access on offboarding permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Access, On-/Offboarding&lt;/h3&gt;
&lt;p&gt;Maybe you’re the move-fast-break-things kind of person and
grant each developer full access, so they can work on their own. At this point
you probably already need an informal ‘process’ like: “Ping people in #infra
slack channel before deploying so we know what is going on.”.&lt;/p&gt;
&lt;p&gt;Maybe you’re more paranoid and you decide there is one person which full access
acting as gatekeeper. But since you’re paranoid, you worry about the &lt;a href=&quot;https://en.wikipedia.org/wiki/Bus_factor&quot;&gt;bus
factor&lt;/a&gt;. You still need some sort of
process to make sure changes aren’t conflicting.&lt;/p&gt;
&lt;p&gt;Now an engineer leaves the company. You need to rotate all secrets. You need to
make sure you remember all the secrets that are used. At this point you have
written thousand lines of configuration management scripts that manages among
others all application secrets, managed database secrets, TLS keys. Or you have
up-to-date documentation. Or you don’t and you need to think hard about all
places you might have configured secrets.&lt;/p&gt;
&lt;p&gt;A new engineer needs onboarding. Maybe he is a senior engineer who did DevOps at
many places. If you have good, up-to-date documentation you might be able to
figure out how to contribute and deploy. With configuration management, he might
take a few days to understand how things are be done from that. Without any of
these, he’ll just pair with other engineers and eventually figure out how things
are done. He needs to be careful to understand all the decisions implied by how
things are setup or risks driving development in the opposite direction.&lt;/p&gt;
&lt;h3 id=&quot;no-problem-at-small-scale&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#no-problem-at-small-scale&quot; aria-label=&quot;no problem at small scale permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;No Problem at small scale&lt;/h3&gt;
&lt;p&gt;You’ll probably find a good way to make this work. New employees are onboarded
quickly, everyone can work distraction free without stepping on each other toes.
It’s just a small team after all, especially if you’re sitting all in one office
this isn’t too hard.&lt;/p&gt;
&lt;p&gt;But given all the decisions you had to make, you certainly end up with a
cloud provider specific &lt;em&gt;snowflake infrastructure&lt;/em&gt;. Even in this small problem
space, there is probably not a single company out there with exactly your setup.&lt;/p&gt;
&lt;h2 id=&quot;kubernetes-infrastructure&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kubernetes-infrastructure&quot; aria-label=&quot;kubernetes infrastructure permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Kubernetes Infrastructure&lt;/h2&gt;
&lt;p&gt;Kubernetes is an opinionated framework. Every resource in your infrastructure is
abstracted as a &lt;a href=&quot;https://kubernetes.io/docs/concepts/#kubernetes-objects&quot;&gt;Kubernetes
Object&lt;/a&gt;. Deployable
workloads on a single system are Pods. ReplicaSets are workloads that should be
replicated across systems. Deployments are versioned, replicated workloads.
Services provide Endpoints which is how you connect to the Pods in your cluster.&lt;/p&gt;
&lt;p&gt;All these are complex, layered but powerful abstractions. They are powerful
because from the infrastructure management perspective they cover all aspects of
all possible resources in your cluster. If an abstraction doesn’t provide the
behaviour needed for your resources, you can define &lt;a href=&quot;https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/&quot;&gt;Custom
Resources&lt;/a&gt;
and deploy/write an &lt;a href=&quot;https://coreos.com/operators/&quot;&gt;Operator&lt;/a&gt; for this.&lt;/p&gt;
&lt;h3 id=&quot;now-how-does-this-help-with-the-concerns-a-small-shop-has&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#now-how-does-this-help-with-the-concerns-a-small-shop-has&quot; aria-label=&quot;now how does this help with the concerns a small shop has permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Now how does this help with the concerns a small shop has?&lt;/h3&gt;
&lt;p&gt;Kubernetes is workload agnostic, so it allows you to deploy whatever you want on
it. That means all Kubernetes cluster is all you need. You don’t need to setup
VMs, ALB/EBS or any other infrastructure beside the Kubernetes cluster itself.
There is no need to run anything outside of Kubernetes. And most cloud providers
these days provide the cluster management to you for free.&lt;/p&gt;
&lt;p&gt;The biggest advantage though is that it’s not a &lt;em&gt;snowflake infrastructure&lt;/em&gt;
anymore:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;For everything in your infrastructure, you have a (ideally) version controlled
manifest&lt;/li&gt;
&lt;li&gt;Ingress objects are used to configure what can be reached under which names&lt;/li&gt;
&lt;li&gt;The TLS certificate is referred to explicitly and easy to find&lt;/li&gt;
&lt;li&gt;A deployment is always an image with a version/tag.&lt;/li&gt;
&lt;li&gt;The API tells you what is running and what is suppose to be running&lt;/li&gt;
&lt;li&gt;It also allows you to configure your monitoring automatically&lt;/li&gt;
&lt;li&gt;You allow developers to update their application without granting them access
to secrets&lt;/li&gt;
&lt;li&gt;You have access to plenty of operators should you want to operate your own
database or want to automate and abstract message queue management&lt;/li&gt;
&lt;li&gt;Migrating to other cloud providers or bare metal is much easier&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A new hire who is familiar with Kubernetes will understand what deployments you
have, how much resources they need, how they access other systems and how
requests are routed. They know how to deploy changes and how to debug their
application.&lt;/p&gt;
&lt;p&gt;Since Kubernetes resources are configured entirely by YAML manifests, all
configuration management need you might have boils down to manifest generation.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#conclusion&quot; aria-label=&quot;conclusion permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;With Kubernetes we can build solution to infrastructure management problems that
work for everyone without having to resort to &lt;a href=&quot;/2015/08/31/dont-manage-config-unless-you-have-to#issues-with-chef&quot;&gt;weak abstractions that regular
infrastructure-as-code solutions
have&lt;/a&gt;.
There is no such thing as free lunch but these are ramp-up costs. The patterns
you applied to solve a problem once, can be applied to all future problems. And
this goes both ways: Engineers familiar with Kubernetes will benefit from that
in all Kubernetes infrastructures. Companies that adopt Kubernetes will be able
to hire people who know how their infrastructure work before you even started
onboarding.&lt;/p&gt;
&lt;p&gt;So should &lt;em&gt;you&lt;/em&gt; run on Kubernetes? It still depends. Maybe you want to do
something more serverless. Then have a look at
&lt;a href=&quot;https://www.heroku.com/&quot;&gt;Heroku&lt;/a&gt; or &lt;a href=&quot;https://cloud.google.com/appengine/&quot;&gt;Google App
Engine&lt;/a&gt;. If your service is mostly a backendless
web project, check out &lt;a href=&quot;https://www.netlify.com/&quot;&gt;netlify&lt;/a&gt; and use &lt;a href=&quot;https://aws.amazon.com/lambda/&quot;&gt;AWS
Lambda&lt;/a&gt; for the necessary logic.&lt;/p&gt;
&lt;p&gt;But if you need to build, deploy, update, configure and monitor applications
running on servers spend time understanding what it really takes to get you
where you want and whether it’s really less work than adopting Kubernetes.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Run Prometheus Blackbox Exporter as Lambda]]></title><description><![CDATA[Introduction  When providing any service to a global customer base, you are probably
interested in measuring the performance and…]]></description><link>https://5pi.de/2018/12/10/prometheus-blackbox-exporter-lambda/</link><guid isPermaLink="false">https://5pi.de/2018/12/10/prometheus-blackbox-exporter-lambda/</guid><pubDate>Mon, 10 Dec 2018 14:00:00 GMT</pubDate><content:encoded>&lt;h1 id=&quot;introduction&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#introduction&quot; aria-label=&quot;introduction permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Introduction&lt;/h1&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/867486a1cfca72c0aefe8faa3aa54a18/2c288/lambda-designer.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 85.88957055214723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsTAAALEwEAmpwYAAACPUlEQVQ4y3WT23LTMBCG8/4vwRMUZrjvAFdQeoAWSiFNICfb8dk6rbRa2WYVTyeEaWd+Z1aOPv272vUMjcyXn/MkU23ZIwRrgtNRHMQ4LukQk+WXOnikYSznN/L3wyygY15UO6scaoMAk7wFcvyrEZwHQ+4gq3vvxnHc3F0kv25nfJJq8mTxabdKuqJwWloprBJ8IMOg1eL6TVfuyTlecgpoQSlV1q0GOyO0ViunjFWdN0fxMqA1nfh6cV7us0g6CAiya9IsA2PGcZhgWabr+eXrZl+h7CaBEN5wqZDuMi0kH8SFBAdKtJ0QRNT3fYQ5jzovFj9uRFaibFC2LBBdhAHqdH0owXoXYXZu2tZ7H+Fku6mLvEi2dZ57I70Rk9gipi3E9fkrzosQKd78KXxwlk7HOlEfxbsoJqm3q3VT1Uw+4xxrVsKpEzLCSsQi0QawwdrYtqcLO4GdVlw2d4Vln8RxbDUCKu15Qib4f2dnufVTJ54RgtfmZRgZNi/BsUOGZ4Mxztz2aGXX/uts+JIJdPQH5UHFwGofY85Io+IWqOkNz/aJcwjUk+chZfWEMaYp9ofYB+viv4c9QyAlZXt0JuLvhCjwuHsK6HlTT7EU5HqJQUfeE7+v67rip20lD98EKy3fXZ2lacrfUrr6vrx5Cw1gGMu7D9XifhhHdnp/fbbbJdKASbbN5ccsr9ixDwx38v7htigq69xu+2c5vwO+XqL14898s+Z0eMO3+y9Zlg/DUO73m8e5kHIcBnb+C/9syQ9N02Z/AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;lambda-designer&quot;
        title=&quot;lambda-designer&quot;
        src=&quot;/static/867486a1cfca72c0aefe8faa3aa54a18/a6d36/lambda-designer.png&quot;
        srcset=&quot;/static/867486a1cfca72c0aefe8faa3aa54a18/222b7/lambda-designer.png 163w,
/static/867486a1cfca72c0aefe8faa3aa54a18/ff46a/lambda-designer.png 325w,
/static/867486a1cfca72c0aefe8faa3aa54a18/a6d36/lambda-designer.png 650w,
/static/867486a1cfca72c0aefe8faa3aa54a18/2c288/lambda-designer.png 684w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;When providing any service to a global customer base, you are probably
interested in measuring the performance and availability of your site from
multiple global locations.&lt;/p&gt;
&lt;p&gt;For this, I’ve created &lt;a href=&quot;https://latency.at&quot;&gt;latency.at&lt;/a&gt; which unfortunately
didn’t get the traction I hoped it would. (See
&lt;a href=&quot;https://blog.latency.at/2018-05-24-shutting-down-latency-at/&quot;&gt;this&lt;/a&gt; for more
details).&lt;/p&gt;
&lt;p&gt;So today, we’re back where we were before: If you want your performance and
availability metrics in &lt;a href=&quot;https://prometheus.io&quot;&gt;Prometheus&lt;/a&gt; your best option is
to run a bunch of snowflake VMs with the prometheus blackbox exporter in
different regions and glue some authenticating reverse proxy to it.&lt;/p&gt;
&lt;p&gt;Wouldn’t it be nice if we could run this without having to mange servers? Like
server&lt;em&gt;less&lt;/em&gt;?&lt;/p&gt;
&lt;p&gt;Introducing
&lt;a href=&quot;https://github.com/discordianfish/blackbox-exporter-lambda&quot;&gt;blackbox-exporter-lambda&lt;/a&gt;!&lt;/p&gt;
&lt;h1 id=&quot;how-does-it-work&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#how-does-it-work&quot; aria-label=&quot;how does it work permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;How does it work?&lt;/h1&gt;
&lt;p&gt;When working on latency.at, &lt;a href=&quot;https://github.com/prometheus/blackbox_exporter/pull/214&quot;&gt;I’ve
refactored&lt;/a&gt; the
blackbox-exporter to make it possible to use it’s probers and config as packages
in downstream project.&lt;/p&gt;
&lt;p&gt;This allowed me to create a new project which runs the probers on &lt;a href=&quot;https://aws.amazon.com/lambda/&quot;&gt;AWS
Lambda&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The project contains &lt;a href=&quot;https://aws.amazon.com/cloudformation/&quot;&gt;Cloudformation
templates&lt;/a&gt; to create the Lambda and
expose it via the &lt;a href=&quot;https://aws.amazon.com/api-gateway/&quot;&gt;Amazon API Gateway&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;For authorization, we require an authorization header to match the &lt;code class=&quot;language-text&quot;&gt;AUTH_TOKEN&lt;/code&gt;
environment variable.&lt;/p&gt;
&lt;h1 id=&quot;deployment&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#deployment&quot; aria-label=&quot;deployment permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Deployment&lt;/h1&gt;
&lt;h2 id=&quot;bootstrapping&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#bootstrapping&quot; aria-label=&quot;bootstrapping permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Bootstrapping&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;/297788a4dcf5dd03aa9a6fe753bb8619/new.gif&quot; alt=&quot;new&quot;&gt;
Download or checkout the
&lt;a href=&quot;https://github.com/discordianfish/blackbox-exporter-lambda&quot;&gt;blackbox-exporter-lambda&lt;/a&gt; and change to the directory:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;git clone https://github.com/discordianfish/blackbox-exporter-lambda.git
cd blackbox-exporter-lambda&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Create the Cloudformation Stack. On the first run, this will create a S3 bucket
called &lt;code class=&quot;language-text&quot;&gt;blackbox-exporter-[AWS AccountId]&lt;/code&gt;. You might want to use a different
prefix for reach region you deploy this to.&lt;/p&gt;
&lt;p&gt;This won’t include the lambda since
we first need to upload the code.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;make new&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;upload-code&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#upload-code&quot; aria-label=&quot;upload code permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Upload Code&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;/8be4627e4a0e08ef00807514abbad070/upload-update.gif&quot; alt=&quot;new&quot;&gt;
Now upload the code. This uses the aws cli to get your Account ID. You can also
set this using the &lt;code class=&quot;language-text&quot;&gt;ACCOUNT_ID&lt;/code&gt; environment variable.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;make upload&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To finialize this and create the lambda run:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;AUTH_TOKEN=foobar23 make update&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;AUTH_TOKEN&lt;/code&gt; specifies which auth token to require when handling requests. You
can make Prometheus use this token by configuring &lt;code class=&quot;language-text&quot;&gt;bearer_token&lt;/code&gt; in the &lt;a href=&quot;https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config&quot;&gt;scrape
config&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;test-lambda&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#test-lambda&quot; aria-label=&quot;test lambda permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Test Lambda&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;/d490d740700a92ddf861d23bbe7b84e3/test.gif&quot; alt=&quot;test&quot;&gt;
Now we can run &lt;code class=&quot;language-text&quot;&gt;make endpoint&lt;/code&gt; to get the URL to invoke the blackbox-exporter
and use curl for testing this. You use the &lt;code class=&quot;language-text&quot;&gt;config&lt;/code&gt; parameter for
blackbox-exporter configuration. Each probe takes different configuration
parameters. See the &lt;a href=&quot;https://github.com/prometheus/blackbox_exporter/blob/master/CONFIGURATION.md#http_probe&quot;&gt;blackbox-exporter configuration
documentation&lt;/a&gt;
for more details.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;curl -L -G \
  -H &apos;Authorization: Bearer foobar23&apos; \
  --data-urlencode &apos;target=https://www.google.com&apos; \
  --data-urlencode &apos;config={&quot;preferred_ip_protocol&quot;: &quot;ip4&quot;}&apos; \
  $(make endpoint)/http&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;updates&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#updates&quot; aria-label=&quot;updates permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Updates&lt;/h2&gt;
&lt;p&gt;To change the &lt;code class=&quot;language-text&quot;&gt;AUTH_TOKEN&lt;/code&gt; or roll out any other Cloudformation change, you can
run &lt;code class=&quot;language-text&quot;&gt;AUTH_TOKEN=xx make update&lt;/code&gt; again.&lt;/p&gt;
&lt;p&gt;When changing the lambda code itself, run &lt;code class=&quot;language-text&quot;&gt;make upload&lt;/code&gt; to upload it to the code
bucket and run &lt;code class=&quot;language-text&quot;&gt;make bump&lt;/code&gt; to notify Lambda that the code base changed.&lt;/p&gt;
&lt;h2 id=&quot;prometheus-configuration&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#prometheus-configuration&quot; aria-label=&quot;prometheus configuration permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Prometheus Configuration&lt;/h2&gt;
&lt;p&gt;The configuration is similar to the one used for the regular blackbox-exporter.
It also uses relabling to configure multiple targets easily:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;- job_name: &apos;blackbox-exporter-lambda-us-central-1&apos;
  metrics_path: /probe/http
  bearer_token: foobar23
  scheme: https
  params:
    config:
      - |
        preferred_ip_protocol: ip4
  static_configs:
    - targets:
      - https://5pi.de
      - https://www.google.com
  relabel_configs:
    - target_label: __param_target
      source_labels: [__address__]
    - target_label: instance
      source_labels: [__param_target]
    - target_label: __address__
      replacement: 5v5jaus0zj.execute-api.eu-central-1.amazonaws.com&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Use your token for &lt;code class=&quot;language-text&quot;&gt;bearer_token&lt;/code&gt; and the output of &lt;code class=&quot;language-text&quot;&gt;make endpoint&lt;/code&gt; for the &lt;code class=&quot;language-text&quot;&gt;__address__&lt;/code&gt;
replacement and &lt;code class=&quot;language-text&quot;&gt;metrics_path&lt;/code&gt;. This should get you something like this:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code class=&quot;language-text&quot;&gt;probe_http_duration_seconds{instance=&quot;https://5pi.de&quot;,job=&quot;blackbox-exporter-lambda-us-central-1&quot;}&lt;/code&gt;&lt;/strong&gt;
&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 603px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/364937c94659b580a3a99cb7eea04e80/9128f/graph.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 86.50306748466258%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsTAAALEwEAmpwYAAACW0lEQVQ4y51SS28SURSen1KXxVQ3xo0D8+KtCzuPC4Xp1NTE1JSFC+MvMDFAx0RbwUdSf0BxI2ChCrQlmhijkcT62KgRrU1qLS2PgRkGPMy0FRtjgl9OZs4593z3O+feiymKommaruvtAQEUzGR2u93OgAAK1mg0YBsI9AEBFExVVSD/pzLMbCqbMLdUjVkOVfdn/q5szv++vF1T1H+388fMJtoGufSlXFUUk6wbdkhZVbU95f7T1juG8ubLurpzkOxvAXaA8G15q97UsGazeXDaxrc3wtrGi1qr0u10IaW120pL27+Ovdaef9ioNlpwz9BCW9/vGXzglL4/65ENbO02Sp82wVF7DwNqespP361XFRWr7NY047lohj40CGuv14sV5efXH/Wa0tquKqADSd2YXVM18Itr3yr1Jvbk1efpWD4UX568kZu+vXxlfvXy3WLo/tzkbMoXXpqKFS7dWx2Xs6F4/mK8EIoVpmbzoTsrE9cfX5jLYStvPnqvptBMGskPuUiai6RGry2dn78VuLngi2bRTApFkkjOsOE0F37ER9OCnOSjqTE56ZczWDaXdZ9h0bjEBf2CKLEBkRs7h6SAIPq5gCSIIgoEuaDEixN8UIIyXoQlqPF5zrJYYiFhOX7S6znNUJTb5aRIwmmnvW4PQzMup8PB2GmadtgZj8vpcjjAICYJ4tjIyJGhISyReHD0xDDjZAiSpGgat1ptBMEwDI7jFEWTFAUhGDhQwDD2UzhutdnAhi0WbHEx4yatfiSwHIcQYln4/3Y4nmcNQIbneUEQwB81QFHUL0GSFESGg3IJAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;graph&quot;
        title=&quot;graph&quot;
        src=&quot;/static/364937c94659b580a3a99cb7eea04e80/9128f/graph.png&quot;
        srcset=&quot;/static/364937c94659b580a3a99cb7eea04e80/222b7/graph.png 163w,
/static/364937c94659b580a3a99cb7eea04e80/ff46a/graph.png 325w,
/static/364937c94659b580a3a99cb7eea04e80/9128f/graph.png 603w&quot;
        sizes=&quot;(max-width: 603px) 100vw, 603px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[fluentd for data warehousing with athena]]></title><description><![CDATA[Or how I replaced AWS Firehose by fluentd instances and saved >80% EC2 traffic
costs. Using AWS Kinesis Firehose koko is one of my current…]]></description><link>https://5pi.de/2018/10/31/fluentd-for-data-warehousing-with-athena/</link><guid isPermaLink="false">https://5pi.de/2018/10/31/fluentd-for-data-warehousing-with-athena/</guid><pubDate>Wed, 31 Oct 2018 14:11:28 GMT</pubDate><content:encoded>&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/d8a7d70f8cee9fbbacce4fcac00fb6cc/1f368/firehose.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 71.16564417177914%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAf/EABUBAQEAAAAAAAAAAAAAAAAAAAID/9oADAMBAAIQAxAAAAFusYxKVlB//8QAGhAAAQUBAAAAAAAAAAAAAAAAAAECERIiE//aAAgBAQABBQJ2TRzUmVuXcf/EABcRAAMBAAAAAAAAAAAAAAAAAAABEiH/2gAIAQMBAT8Bawg//8QAGBEAAgMAAAAAAAAAAAAAAAAAAAECEyH/2gAIAQIBAT8BU9LT/8QAGBAAAwEBAAAAAAAAAAAAAAAAABAxAUH/2gAIAQEABj8CmKEXD//EABsQAAICAwEAAAAAAAAAAAAAAAERADEQIWFB/9oACAEBAAE/IRKGzwlTcI3yd0sJGYYGqxP/2gAMAwEAAgADAAAAEKwf/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAR/9oACAEDAQE/EFcE/wD/xAAVEQEBAAAAAAAAAAAAAAAAAAAREP/aAAgBAgEBPxAFH//EAB0QAQACAQUBAAAAAAAAAAAAAAEAESExQVFxgeH/2gAIAQEAAT8Qwr5VcJz3wRpKCKQ48gpinpi0utAWafYWlu9g02izg9XP/9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;By English: Petty Officer 2nd Class Casey H. Kyhl, U.S. Navy (www.defense.gov), Public domain, via Wikimedia Commons&quot;
        title=&quot;By English: Petty Officer 2nd Class Casey H. Kyhl, U.S. Navy (www.defense.gov), Public domain, via Wikimedia Commons&quot;
        src=&quot;/static/d8a7d70f8cee9fbbacce4fcac00fb6cc/6aca1/firehose.jpg&quot;
        srcset=&quot;/static/d8a7d70f8cee9fbbacce4fcac00fb6cc/d2f63/firehose.jpg 163w,
/static/d8a7d70f8cee9fbbacce4fcac00fb6cc/c989d/firehose.jpg 325w,
/static/d8a7d70f8cee9fbbacce4fcac00fb6cc/6aca1/firehose.jpg 650w,
/static/d8a7d70f8cee9fbbacce4fcac00fb6cc/7c09c/firehose.jpg 975w,
/static/d8a7d70f8cee9fbbacce4fcac00fb6cc/01ab0/firehose.jpg 1300w,
/static/d8a7d70f8cee9fbbacce4fcac00fb6cc/1f368/firehose.jpg 2100w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Or how I replaced AWS Firehose by fluentd instances and saved &gt;80% EC2 traffic
costs.&lt;/em&gt;&lt;/p&gt;
&lt;h1 id=&quot;using-aws-kinesis-firehose&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#using-aws-kinesis-firehose&quot; aria-label=&quot;using aws kinesis firehose permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Using AWS Kinesis Firehose&lt;/h1&gt;
&lt;p&gt;&lt;a href=&quot;https://www.koko.ai/&quot;&gt;koko&lt;/a&gt; is one of my current clients. They are running on
the &lt;a href=&quot;/2018/02/01/kubecfn-cloudformation-installer-for-reasonably-secure-multi-master-kubernetes-cluster/&quot;&gt;Kubernetes
infrastructure I
built&lt;/a&gt;
earlier this year.
For analytics purposes with &lt;a href=&quot;https://aws.amazon.com/athena/&quot;&gt;AWS Athena&lt;/a&gt;, the
backend services use &lt;a href=&quot;https://aws.amazon.com/kinesis/data-firehose/&quot;&gt;AWS Kinesis
Firehose&lt;/a&gt; to ship messages to S3.
Basically it receives messages via HTTP, batches them based on time or size and
uploads them to S3.&lt;/p&gt;
&lt;p&gt;We isolated the Kubernetes VMs a VPC for security reasons, so they need to use a
NAT Gateway to connect to Kinesis Firehose. This was responsible for most of the
traffic handled by the NAT Gateways and made up a significant portion of the
monthly EC2 costs.  To allow systems in a VPC to reach AWS Services without
having to pass a NAT Gateway, AWS provides &lt;em&gt;VPC Endpoints&lt;/em&gt; for various services.
Unfortunately not for Firehose.&lt;/p&gt;
&lt;p&gt;Beside that, the files produced by Firehose still needed
processing to shard them by customer for efficient Athena querying, which
involved downloading the files from S3 to process them and upload them again.
Moreover, Firehose wasn’t as reliable as we hoped.&lt;/p&gt;
&lt;p&gt;We discussed introducing Kafka to process the streams, but ideally wanted to
avoid running a complex, distributed system like this. Fortunately, since
all messages shipped are independent of each other and get deduplicated in
Athena anyway, we shouldn’t need expensive coordination. So what alternatives do
we have?&lt;/p&gt;
&lt;h1 id=&quot;warehousing-with-fluentd&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#warehousing-with-fluentd&quot; aria-label=&quot;warehousing with fluentd permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Warehousing with Fluentd&lt;/h1&gt;
&lt;p&gt;Having introduced &lt;a href=&quot;https://www.fluentd.org/&quot;&gt;fluentd&lt;/a&gt; for shipping logs
recently, I realized it might check all the boxes.&lt;/p&gt;
&lt;p&gt;Most people probably use &lt;a href=&quot;https://www.fluentd.org/&quot;&gt;fluentd&lt;/a&gt; for shipping logs.
These days it’s the de facto standard for log shipping on Kubernetes. For that
it reads the local container logs and ships them to a central logging service,
like &lt;a href=&quot;https://www.elastic.co/products/elasticsearch&quot;&gt;Elasticsearch&lt;/a&gt;. Then you’d
use something like &lt;a href=&quot;https://www.elastic.co/products/kibana&quot;&gt;Kibana&lt;/a&gt;. That
completes the so called &lt;em&gt;EFK Stack&lt;/em&gt;.&lt;/p&gt;
&lt;h2 id=&quot;configuration&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#configuration&quot; aria-label=&quot;configuration permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Configuration&lt;/h2&gt;
&lt;p&gt;Fluentd allows use to define a source for receiving messages from the
application. Each message contains a shard key that’s used as path prefix on S3.
Fluentd allows parsing this with a custom regexp:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;&amp;lt;source&gt;
  @type http
  port 8888
  bind 0.0.0.0
  body_size_limit 32m
  keepalive_timeout 10s
  &amp;lt;parse&gt;
    @type regexp
    expression /^(?&amp;lt;path&gt;[^\s]+) (?&amp;lt;content&gt;.+)$/m
  &amp;lt;/parse&gt;
&amp;lt;/source&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we can use the s3 output to send the messages to s3.
Since we need to batch up the files, we use a &lt;em&gt;file buffer&lt;/em&gt;. This buffers the
messages to a local directory until either the &lt;code class=&quot;language-text&quot;&gt;chunk_limit_size&lt;/code&gt; or the
&lt;code class=&quot;language-text&quot;&gt;timekey&lt;/code&gt; is reached, after which the file gets uploaded to s3.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;&amp;lt;match **&gt;
  @type s3

  s3_bucket the-output-bucket
  s3_region us-east-1

  path ${path}
  s3_object_key_format &quot;%{path}/#{Socket.gethostname}_%{time_slice}_%{index}.%{file_extension}&quot;

  store_as gzip_command
  &amp;lt;buffer path,time&gt;
    @type file
    timekey 3600
    chunk_limit_size 25MB
  &amp;lt;/buffer&gt;
  &amp;lt;format&gt;
    @type single_value
    message_key content
  &amp;lt;/format&gt;
&amp;lt;/match&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;code class=&quot;language-text&quot;&gt;path&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;time&lt;/code&gt; arguments to &lt;code class=&quot;language-text&quot;&gt;&amp;lt;buffer path,time&gt;&lt;/code&gt; groups the chunks by
time and path. This allows us to set &lt;code class=&quot;language-text&quot;&gt;s3_object_key_format&lt;/code&gt; to add &lt;code class=&quot;language-text&quot;&gt;path&lt;/code&gt; to
the destination path as prefix when flushing the buffer to S3.&lt;/p&gt;
&lt;p&gt;We also add the hostname to the destination path by using
&lt;code class=&quot;language-text&quot;&gt;#{Socket.gethostname}&lt;/code&gt;. This prevents conflicts when running multiple instance
without requiring any coordination between the instances. Since the messages are
independent of each other and their order is irrelevant, this is all we need to
process them in parallel.&lt;/p&gt;
&lt;h2 id=&quot;monitoring&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#monitoring&quot; aria-label=&quot;monitoring permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Monitoring&lt;/h2&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/87a6eb80f7df852d72c949c282e58488/2bef9/dashboard.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 69.32515337423312%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsTAAALEwEAmpwYAAACh0lEQVQozz2Sa0/bMBSG80cmoE18i53Yca7NrbeEtlxaVtCgYozLKgpjGpuYQNokPmz/ZdrnaZ/313ZKN6Q3R6/tY5+TxzZcVzEmbNuJolaSZEmSah0wyjl3KeWrJYhCyKfVDAwMQZBgwNc0iWlRiM0mboBnwiQcZhpNhDEDIURBlkVME4NZzRBiG1q6LY+3ONc2Z8Qug2C21dkfZAqKY2pahMD+pw2QvTprOUSUwuZuEp4P8+NhMavii1F2s9d+OOxe7hSLcSfVLjRiE5thRjGDo5fxSUtDubHTS+9OBp9fD26PqvuTzbvj+sNR/WlWfzkdlKGCf1k1aa06/2/+td2K/P1hMamz6SDf2wQVLwdLHYxKLR1IFdwFZs8CRitgIEO6UvuxUj4IjHA1tV1mu5hw4OcIEYaJJ71AB1qHwpFSapsJBCygMucOwVRKz/N8xjhCwNzCGOAjIVyoA8yeOYMXjqLMWW9YCFPD5u6aSdabZK2BQRsNbCECLWHEEGbQg8dtuDbLosp1tWCC2oGvM18vaSulFuP2xbhzvlWcDMs3Wz14GZyL1OEtxrdD76L2BSINE4+K+GrSWUzat/vdh1m1mQZGGYc/r8a/301+3Uz/3E5/zHcxIuMiup927qa9+9ng2+n2WZW82LCqIr4+qucH/bcH1eKwHrUjI9D+4qD38bD//lX18Lq6nrZNk+z28++LyeN8/PVs9DjfuZz21hpIuspxHFc6SgEheKTcgLfdzaJeHvfyqCpb7TQ2LaykrMtWv4j7RVIXSayliWicpHGc+V4QR2kUpZQKIwzjvOjFrUJKpbxIqhBQw/WkeReuQHoh42p9A2GL5FnZ6fbDMCrLTlG0AepfdFO0K28O5UQAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Dashboard&quot;
        title=&quot;Dashboard&quot;
        src=&quot;/static/87a6eb80f7df852d72c949c282e58488/a6d36/dashboard.png&quot;
        srcset=&quot;/static/87a6eb80f7df852d72c949c282e58488/222b7/dashboard.png 163w,
/static/87a6eb80f7df852d72c949c282e58488/ff46a/dashboard.png 325w,
/static/87a6eb80f7df852d72c949c282e58488/a6d36/dashboard.png 650w,
/static/87a6eb80f7df852d72c949c282e58488/e548f/dashboard.png 975w,
/static/87a6eb80f7df852d72c949c282e58488/2bef9/dashboard.png 1024w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;The
&lt;a href=&quot;https://github.com/fluent/fluent-plugin-prometheus&quot;&gt;fluent-plugin-prometheus&lt;/a&gt;
plugin provides metrics about the throughput and output buffer length which can
be used to alert on. The dashboard above also shows cAdvisor and kubelet metrics
for the fluent pods to monitor disk, CPU and network usage.&lt;/p&gt;
&lt;h2 id=&quot;deployment&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#deployment&quot; aria-label=&quot;deployment permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Deployment&lt;/h2&gt;
&lt;p&gt;We deploy this on Kubernetes with a &lt;a href=&quot;https://kubernetes.io/docs/concepts/storage/persistent-volumes/&quot;&gt;Persistent
Volume&lt;/a&gt; for
each instance to persist the buffer even if a pod crashes or gets recreated.&lt;/p&gt;
&lt;p&gt;Since a single instance of fluentd isn’t able to handle the message throughput,
we need to run multiple instances. Since we use volumes, we need to use a
&lt;a href=&quot;https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/&quot;&gt;StatefulSet&lt;/a&gt;
for this.&lt;/p&gt;
&lt;p&gt;To have a endpoint for the application to connect to, we use a
&lt;a href=&quot;https://kubernetes.io/docs/concepts/services-networking/service/&quot;&gt;Service&lt;/a&gt;
which routes request in round robin. This means one message for a batch might
end up on a different instance than the next message, which fortunately is no
problem even without a complex, coordinated system like kafka.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#conclusion&quot; aria-label=&quot;conclusion permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;It took us just two days to implement and rollout this change and it’s been
working well for several weeks now without requiring any maintenance so far. It
simplified the setup, removed the dependency on Firehose and cut over 80% of the
traffic costs.&lt;/p&gt;
&lt;p&gt;Often the question running something yourself vs using a managed service. But
sometimes operating something simple yourself is better than using something
complex managed by a 3rd party.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Found severe Azure Kubernetes Bug but ain't even got a lousy T-Shirt]]></title><description><![CDATA[About half a year ago at one of my last gigs, I built a Kubernetes Cluster on
Azure. On Azure, the Kubernetes Volume Claims are commonly…]]></description><link>https://5pi.de/2018/02/17/found-severe-azure-kubernetes-bug-and-aint-even-got-a-lousy-t-shirt/</link><guid isPermaLink="false">https://5pi.de/2018/02/17/found-severe-azure-kubernetes-bug-and-aint-even-got-a-lousy-t-shirt/</guid><pubDate>Sat, 17 Feb 2018 13:19:27 GMT</pubDate><content:encoded>&lt;p&gt;About half a year ago at one of my last gigs, I built a Kubernetes Cluster on
Azure.&lt;/p&gt;
&lt;p&gt;On Azure, the Kubernetes Volume Claims are commonly implemented by a “Virtual
Hard Disk” (VHD) file stored on the &lt;a href=&quot;https://azure.microsoft.com/en-us/services/storage/blobs/&quot;&gt;Azure
Blob Storage
Service&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The Kubernetes “cloud provider intergration” takes care of allocating and
managing these disks.&lt;/p&gt;
&lt;p&gt;While I was working on some issues we had with the cloud provider intergration,
I realized that the VHDs related error messages include a full URL like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;https://abc1234.blob.core.windows.net/5678901234/example-dynamic-pvc-834987df-ffe3-12d3-9dec-feaab9e30f09.vhd&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Curious about this API semantics, I tried it download it with curl. And it
worked.&lt;/p&gt;
&lt;p&gt;First I though I made some mistake setting up the storage account or Kubernetes
itself, but I quickly realized that all of the dozens of VHD urls I found in
various github issues could be downloaded without any authentication!&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Turns out, all Volume Claims that were created on Azure between 1.6.0 and 1.6.5
were world readable.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;I reported the issue by following the &lt;a href=&quot;https://kubernetes.io/security/&quot;&gt;Kubernetes Security and
Disclosure&lt;/a&gt; guidelines. While the team was
responsive in general and the problem fixed quickly, I wasn’t very happy with
how the announcement was handled. It felt like it was kept under the radar and I
never got credited, let alone qualified for a bug bounty.&lt;/p&gt;
&lt;p&gt;Of course I’d love to get credited and get a bug bounty but I’m more
worried about what this handling means for the next person considering to
responsibly disclose similar issue.&lt;/p&gt;
&lt;p&gt;Kubernetes is my bread and butter right now and I have high expectations towards
it. I’ve contributed to several components and I have high regards for the
maintainers of the project and the companies involved. I too had the impression
that Microsoft changed and takes these things serious these days, so I was
surprised how this was handled. I also was quite disappointed by not getting any
response anymore around why this didn’t qualify for a bug bounty.&lt;/p&gt;
&lt;p&gt;I’ll continue to disclose issues responsibly but I fully understand people who
don’t want to jump through these hoops if they don’t even get credited for it.&lt;/p&gt;
&lt;h2 id=&quot;timeline&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#timeline&quot; aria-label=&quot;timeline permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Timeline&lt;/h2&gt;
&lt;h4 id=&quot;2017-06-15&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2017-06-15&quot; aria-label=&quot;2017 06 15 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2017-06-15&lt;/h4&gt;
&lt;p&gt;Initial Report and first response with promising to send a
follow up later that day.&lt;/p&gt;
&lt;h4 id=&quot;2017-06-17&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2017-06-17&quot; aria-label=&quot;2017 06 17 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2017-06-17&lt;/h4&gt;
&lt;p&gt;The issue was fixed in Kubernetes:
&lt;a href=&quot;https://github.com/kubernetes/kubernetes/pull/47605&quot;&gt;https://github.com/kubernetes/kubernetes/pull/47605&lt;/a&gt;&lt;/p&gt;
&lt;h4 id=&quot;2017-06-19&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2017-06-19&quot; aria-label=&quot;2017 06 19 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2017-06-19&lt;/h4&gt;
&lt;p&gt;After not hearing back, I asked again about a CVE and the plans
to announce the issue. I’ve got a response the same day, confirming that a CVE
will be issues and that they’re still working on identifying the affected
customers.&lt;/p&gt;
&lt;h4 id=&quot;2017-07-07&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2017-07-07&quot; aria-label=&quot;2017 07 07 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2017-07-07&lt;/h4&gt;
&lt;p&gt;So far, no CVE was issues so I asked again. I also asked if they
are okay with me blogging about it.&lt;/p&gt;
&lt;p&gt;In the response I was told that CVE was requested but not yet issued. I was also
asked to please not talk about this issue publically until they finished letting
affected customers know.&lt;/p&gt;
&lt;h4 id=&quot;2017-07-13&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2017-07-13&quot; aria-label=&quot;2017 07 13 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2017-07-13&lt;/h4&gt;
&lt;p&gt;I’ve got an update, letting me know that the security team is in their final
stages. They apologize for the “clearly no acceptable” time it took to process
the issue.&lt;/p&gt;
&lt;h4 id=&quot;2017-07-20&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2017-07-20&quot; aria-label=&quot;2017 07 20 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2017-07-20&lt;/h4&gt;
&lt;p&gt;CVE-2017-1002100 was assigned to the issue.&lt;/p&gt;
&lt;h4 id=&quot;2017-08-02&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2017-08-02&quot; aria-label=&quot;2017 08 02 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2017-08-02&lt;/h4&gt;
&lt;p&gt;I’ve asked again if there will be some sort of announcement which would also
credit me and encourage people to upgrade. I was pointed to &lt;a href=&quot;https://groups.google.com/forum/#!msg/kubernetes-security-announce/n3VBg_WJZic/-ddIqKXqAAAJ&quot;&gt;a post in
kubernetes-security-announce&lt;/a&gt;
which I never heard about before (it only includes three posts). After
searching, I also found it was noted in the &lt;a href=&quot;https://groups.google.com/forum/#!topic/kubernetes-announce/WodXsASu6y0&quot;&gt;1.6.6 notes on
kubernetes-announce&lt;/a&gt;.&lt;/p&gt;
&lt;h4 id=&quot;2017-08-03&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2017-08-03&quot; aria-label=&quot;2017 08 03 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2017-08-03&lt;/h4&gt;
&lt;p&gt;I’ve explained that I expected an announcement with discussion of risks and need
for upgrade, as well as credit me for my finding. Apparently though this is all
the announcemnts that will be done in such situation.&lt;/p&gt;
&lt;p&gt;I’ve also ask specifically if this qualifies for some of Microsoft’s bug
bounties.&lt;/p&gt;
&lt;h4 id=&quot;2017-09-19&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2017-09-19&quot; aria-label=&quot;2017 09 19 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2017-09-19&lt;/h4&gt;
&lt;p&gt;I’ve asked again about a bounty. Since I just launched &lt;a href=&quot;https://latency.at&quot;&gt;https://latency.at&lt;/a&gt;, some
Azure credits would be super useful to me.&lt;/p&gt;
&lt;p&gt;I’ve got the answer that “the MSRC folks didn’t think it matched”, but they’ll
look into some startup credits.&lt;/p&gt;
&lt;h4 id=&quot;2017-09-25&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2017-09-25&quot; aria-label=&quot;2017 09 25 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2017-09-25&lt;/h4&gt;
&lt;p&gt;I’ve asked why it didn’t qualified for a MSRC bounty, given that there is a
&lt;a href=&quot;https://technet.microsoft.com/en-us/dn800983&quot;&gt;Microsoft Cloud Bounty&lt;/a&gt;.&lt;/p&gt;
&lt;h4 id=&quot;2017-10-05&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2017-10-05&quot; aria-label=&quot;2017 10 05 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2017-10-05&lt;/h4&gt;
&lt;p&gt;Asked again.&lt;/p&gt;
&lt;h4 id=&quot;2018-01-19&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2018-01-19&quot; aria-label=&quot;2018 01 19 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2018-01-19&lt;/h4&gt;
&lt;p&gt;Asked “one last time”.&lt;/p&gt;
&lt;h4 id=&quot;2018-02-17&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#2018-02-17&quot; aria-label=&quot;2018 02 17 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;2018-02-17&lt;/h4&gt;
&lt;p&gt;Released this blog article&lt;/p&gt;</content:encoded></item><item><title><![CDATA[kubecfn: Cloudformation installer for reasonably secure multi-master Kubernetes Cluster]]></title><description><![CDATA[Introduction These days I’m helping koko to build their Kubernetes
infrastructure on AWS. Initially, we used kops to deploy the cluster but…]]></description><link>https://5pi.de/2018/02/01/kubecfn-cloudformation-installer-for-reasonably-secure-multi-master-kubernetes-cluster/</link><guid isPermaLink="false">https://5pi.de/2018/02/01/kubecfn-cloudformation-installer-for-reasonably-secure-multi-master-kubernetes-cluster/</guid><pubDate>Thu, 01 Feb 2018 14:07:16 GMT</pubDate><content:encoded>&lt;h1 id=&quot;introduction&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#introduction&quot; aria-label=&quot;introduction permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Introduction&lt;/h1&gt;
&lt;p&gt;These days I’m helping &lt;a href=&quot;https://itskoko.com/&quot;&gt;koko&lt;/a&gt; to build their Kubernetes
infrastructure on AWS. Initially, we used kops to deploy the cluster but weren’t
very happy. I’ve researched various option and &lt;a href=&quot;/2017/12/15/production-grade-kubernetes/&quot;&gt;blogged about
them&lt;/a&gt; earlier.&lt;/p&gt;
&lt;p&gt;tl;dr: There aren’t that many options that are secure, highly available and
don’t require buying into a vendor ecosystem.&lt;/p&gt;
&lt;p&gt;kubeadm is the official vendor independent solution to installer Kubernetes.
While it lacks automated setup of multi master clusters, &lt;a href=&quot;https://kubernetes.io/docs/setup/independent/high-availability/&quot;&gt;it’s
possible&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;To have a reliable and reproducable way to build clusters, we decided to create
&lt;a href=&quot;https://aws.amazon.com/cloudformation/&quot;&gt;Cloudformation&lt;/a&gt; templates to fully
automate this setup.&lt;/p&gt;
&lt;p&gt;All this is opend sourced and available on &lt;a href=&quot;https://github.com/itskoko/kubecfn&quot;&gt;https://github.com/itskoko/kubecfn&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;architecture&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#architecture&quot; aria-label=&quot;architecture permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Architecture&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;/2f7d38406a33c80962b9131bc20ee2bf/kubecfn.svg&quot; alt=&quot;kubecfn architecture diagram&quot;&gt;
The cluster consists of multiple components required for the cluster.&lt;/p&gt;
&lt;h3 id=&quot;offline-key-generation&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#offline-key-generation&quot; aria-label=&quot;offline key generation permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Offline key generation&lt;/h3&gt;
&lt;p&gt;The first step to create a new cluster is &lt;a href=&quot;https://github.com/itskoko/kubecfn/blob/e3cf1d21db72ca5467ac6f43abc02c5871fd444a/Makefile#L84&quot;&gt;generating the TLS keys for etcd and
kubeadm&lt;/a&gt;.
These credentials get uploaded to S3 and the instances get a IAM instance
profile with a &lt;a href=&quot;https://github.com/itskoko/kubecfn/blob/e3cf1d21db72ca5467ac6f43abc02c5871fd444a/kubernetes.yaml#L759&quot;&gt;policy allowing it to download
them&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;controller-instances&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#controller-instances&quot; aria-label=&quot;controller instances permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Controller Instances&lt;/h3&gt;
&lt;p&gt;The controller instances are managed by an autoscaling group.&lt;/p&gt;
&lt;p&gt;They are running etcd and the controller components like the apiserver,
scheduler and controller manager.
&lt;a href=&quot;https://coreos.com/ignition/docs/latest/&quot;&gt;ignition&lt;/a&gt; downloads the &lt;a href=&quot;https://github.com/itskoko/kubecfn/blob/e3cf1d21db72ca5467ac6f43abc02c5871fd444a/kubernetes.yaml#L859&quot;&gt;TLS
keys&lt;/a&gt;
and &lt;a href=&quot;https://github.com/itskoko/kubecfn/blob/e3cf1d21db72ca5467ac6f43abc02c5871fd444a/kubernetes.yaml#L978&quot;&gt;sets up systemd units for kubelet and
etcd&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;On initial cluster creation (&lt;code class=&quot;language-text&quot;&gt;make create-cluster&lt;/code&gt;), the ClusterState flag is
set to &lt;code class=&quot;language-text&quot;&gt;new&lt;/code&gt;, which enables etcd bootstrapping. To find the other etcd peers,
we’re using SRV record based &lt;a href=&quot;https://coreos.com/etcd/docs/latest/v2/clustering.html#dns-discovery&quot;&gt;DNS
Discovery&lt;/a&gt;.
This option give us one way to bootstap, as well as dynamically add and remove
members. On the other hand, the ‘static’ and ‘etcd’ discovery can be only used
for initial cluster configuration.&lt;/p&gt;
&lt;p&gt;Unfortunately AWS can’t automatically add DNS records for instances in an
autoscaling group. To solve this, we’re using a lambda to update a route53 zone
(see next section).&lt;/p&gt;
&lt;p&gt;Once etcd is up, &lt;code class=&quot;language-text&quot;&gt;kubeadm init&lt;/code&gt; creates the manifests and keys for the
controller components but use the pre-generated keys for the CA generated in the
first step. This makes sure all controller keys are signed with this trusted CA.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/itskoko/kubecfn/blob/e3cf1d21db72ca5467ac6f43abc02c5871fd444a/kubernetes.yaml#L1158&quot;&gt;An ELB&lt;/a&gt;
in front of the apiservers provide a stable endpoint for both the workers as
well as users of the cluster.&lt;/p&gt;
&lt;h3 id=&quot;route53-lambda&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#route53-lambda&quot; aria-label=&quot;route53 lambda permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Route53 Lambda&lt;/h3&gt;
&lt;p&gt;The cluster creates it’s own Route53 zone, which needs to be a subdomain of the
given &lt;code class=&quot;language-text&quot;&gt;ParentZoneID&lt;/code&gt; parameter. Beside a record pointing to the apiserver ELB,
this zone is updated &lt;a href=&quot;https://github.com/itskoko/kubecfn/blob/e3cf1d21db72ca5467ac6f43abc02c5871fd444a/kubernetes.yaml#L643&quot;&gt;by a
Lambda&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Each time a controller instances get added or removed by the autoscaling group,
the lambda gets triggered and adds/removes DNS records for etcd discovery.&lt;/p&gt;
&lt;h3 id=&quot;workers&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#workers&quot; aria-label=&quot;workers permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Workers&lt;/h3&gt;
&lt;p&gt;The worker setup is straight forward. It’s also managed by an autoscaling group.
The ignition config downloads credentials for the kubelet from S3&lt;/p&gt;
&lt;h3 id=&quot;conclusion-and-caveats&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#conclusion-and-caveats&quot; aria-label=&quot;conclusion and caveats permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Conclusion and Caveats&lt;/h3&gt;
&lt;p&gt;kubecfn wasn’t build by a big team nor as an end in itself. We focused on making
it easy to maintain, reliable and fail gracefully. That means there are some
&lt;a href=&quot;https://github.com/itskoko/kubecfn/labels/automation&quot;&gt;rough edges around
automation&lt;/a&gt;. The security
&lt;a href=&quot;https://github.com/itskoko/kubecfn/labels/security&quot;&gt;could be improved further&lt;/a&gt;
and I’m not very happy with the whole concept of IAM instance profiles which
effectively grants these privileges to every process running on a host. We
mitigate this by installing
&lt;a href=&quot;https://github.com/itskoko/kubecfn/blob/e3cf1d21db72ca5467ac6f43abc02c5871fd444a/manifests/kube2iam.yaml&quot;&gt;kube2iam&lt;/a&gt;
but this isn’t a robust as something like this should be. Unfortunately it’s
current best practice and there isn’t an easy way to improve. Let me know if you
know a better way.&lt;/p&gt;
&lt;p&gt;There is also &lt;a href=&quot;https://github.com/itskoko/kubecfn/blob/e3cf1d21db72ca5467ac6f43abc02c5871fd444a/kubernetes.yaml#L247&quot;&gt;the nasy
workaround&lt;/a&gt;
of patching the kube-proxy configmap after &lt;code class=&quot;language-text&quot;&gt;kubeadm init&lt;/code&gt; which requires
upstream fixes.&lt;/p&gt;
&lt;p&gt;That being said, thanks to CloudFormation with primitives like
&lt;a href=&quot;/2015/04/27/cloudformation-driven-consul-in-autoscalinggroup/&quot;&gt;WaitOnResourceSignals&lt;/a&gt;
and features like &lt;a href=&quot;https://github.com/itskoko/kubecfn#dry-run&quot;&gt;Change Sets&lt;/a&gt;, I
feel more comfortable operating this cluster than I was with any other installer
I used in the past.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[No title]]></title><description><![CDATA[Impressum Angaben gemäß § 5 TMG: Johannes Ziemke  Mittenwalder Str. 24  10961 Berlin, Germany E-Mail: inquiry+impressum@5pi.de Umsatzsteuer…]]></description><link>https://5pi.de/impressum/</link><guid isPermaLink="false">https://5pi.de/impressum/</guid><pubDate>Mon, 01 Jan 2018 00:00:00 GMT</pubDate><content:encoded>&lt;h1 id=&quot;impressum&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#impressum&quot; aria-label=&quot;impressum permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Impressum&lt;/h1&gt;
&lt;p&gt;Angaben gemäß § 5 TMG:&lt;/p&gt;
&lt;p&gt;Johannes Ziemke &lt;br&gt;
Mittenwalder Str. 24 &lt;br&gt;
10961 Berlin, Germany&lt;/p&gt;
&lt;p&gt;E-Mail: &lt;a href=&quot;mailto:inquiry+impressum@5pi.de&quot;&gt;inquiry+impressum@5pi.de&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Umsatzsteuer-ID: DE291967314&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Production Grade Kubernetes]]></title><description><![CDATA[About a year ago I blogged about how to build a $15 Production Kubernetes
Cluster on DigitalOcean
and submitted it to Hacker News. HN being…]]></description><link>https://5pi.de/2017/12/15/production-grade-kubernetes/</link><guid isPermaLink="false">https://5pi.de/2017/12/15/production-grade-kubernetes/</guid><pubDate>Fri, 15 Dec 2017 15:08:29 GMT</pubDate><content:encoded>&lt;p&gt;About a year ago I blogged about how to build a &lt;a href=&quot;/2016/11/20/15-producation-grade-kubernetes-cluster/&quot;&gt;$15 Production Kubernetes
Cluster on DigitalOcean&lt;/a&gt;
and submitted it to &lt;a href=&quot;https://news.ycombinator.com/&quot;&gt;Hacker News&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;HN being HN, soon after these comments trickled in:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 560px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/acfed1c5b7512a39140c4288b9d642b6/b06ae/hn-comment.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 20.245398773006134%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAArElEQVQI101P2QqDQBDz/7+ql9e6QqXFB31o672HuuvtWyMLpRAyYYbMZKxpaue505p3XdP3jVJca6EUG0e5LD1GAMRP/3esqnpzXtT1ByxE2TQZUJYv+LdNG6yrMmLfB8PoHGYUHHTdM6VuHN/D0PX9a5o+Pe8SRQGlNqUOIbckeUQRIcR2nFMQ2IxlMFomQNtWUpZSVrjPeY510AYYAQgCRjQhCsbyYTie+gKvHdkxzMfpiwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;What people call production nowadays... - pst&quot;
        title=&quot;What people call production nowadays... - pst&quot;
        src=&quot;/static/acfed1c5b7512a39140c4288b9d642b6/b06ae/hn-comment.png&quot;
        srcset=&quot;/static/acfed1c5b7512a39140c4288b9d642b6/222b7/hn-comment.png 163w,
/static/acfed1c5b7512a39140c4288b9d642b6/ff46a/hn-comment.png 325w,
/static/acfed1c5b7512a39140c4288b9d642b6/b06ae/hn-comment.png 560w&quot;
        sizes=&quot;(max-width: 560px) 100vw, 560px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Fair enough. If you only need $15 worth of resources, running a three node
Kubernetes cluster might not be the best idea. As explained in that article, I
was more referring to the way it’s deployed:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Highly available: Clustered etcd, multiple master/controller instances&lt;/li&gt;
&lt;li&gt;Secure: TLS for etcd clients and peers and apiserver+kubelet&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Personally I built it mainly to have a Kubernetes playground. But in the
meanwhile I founded &lt;a href=&quot;https://latency.at&quot;&gt;Latency.at&lt;/a&gt;. It’s a service to measures
performance and availability of sites and services from multiple global
locations and provides the results as Prometheus metrics. And of course it’s
running on Kubernetes, so I didn’t have the need for a playground and migrated
this blog to &lt;a href=&quot;https://github.com/gatsbyjs/gatsby&quot;&gt;Gatsby.js&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I’m also &lt;a href=&quot;/hire-me/&quot;&gt;consulting&lt;/a&gt; people on, among other things, how to build
production grade Kubernetes infrastructure. For this I looked into various way
to deploy Kubernetes today. There are &lt;em&gt;many&lt;/em&gt; and most claimed to be “production
grade”:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/kubernetes/kops&quot;&gt;https://github.com/kubernetes/kops&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/coreos/tectonic-installer&quot;&gt;https://github.com/coreos/tectonic-installer&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/aws-quickstart/quickstart-heptio&quot;&gt;https://github.com/aws-quickstart/quickstart-heptio&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/kubernetes-incubator/kube-aws&quot;&gt;https://github.com/kubernetes-incubator/kube-aws&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/kubernetes-incubator/kubespray&quot;&gt;https://github.com/kubernetes-incubator/kubespray&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/&quot;&gt;https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;highly-available&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#highly-available&quot; aria-label=&quot;highly available permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Highly available?&lt;/h3&gt;
&lt;p&gt;In my book, having a highly available cluster is a strict requirement for
production deployments. You might have specialized use case where this isn’t
necessary but if you run realtime, business critical applications this is a
requirement.&lt;/p&gt;
&lt;p&gt;While an outage of the controller components won’t affect running applications,
you can’t operate the cluster anymore: If your ingress controller gets restarted
during that time, it won’t know about your backends. If an important pod dies,
nobody will restart it.&lt;/p&gt;
&lt;p&gt;This requirement already rules out one of the most popular options:
&lt;a href=&quot;https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/&quot;&gt;kubeadm&lt;/a&gt;.
At least it doesn’t claim to be stable yet and everything except this looks very
promising.&lt;/p&gt;
&lt;p&gt;The same limitation applies to projects built upon kubeadm, like
&lt;a href=&quot;https://github.com/kris-nova/kubicorn&quot;&gt;kubicorn&lt;/a&gt; and the &lt;a href=&quot;https://github.com/aws-quickstart/quickstart-heptio&quot;&gt;hepio cloudformation
templates&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;secure&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#secure&quot; aria-label=&quot;secure permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Secure?&lt;/h3&gt;
&lt;p&gt;A Kubernetes cluster can be “(in)secure” on multiple layers. First etcd should
require peers and client certificates to be signed by a trusted CA. Next the
apiserver needs to verify that the certificate of the etcd endpoint it connects
to is signed by a trusted CA, as well as certificates of clients connecting to
the apiserver. Now the kubelet connecting to the apiserver needs to validate
that certificate too.&lt;/p&gt;
&lt;p&gt;Beside the transport level security provided by TLS, Kubernetes supports RBAC to
limit the access pods in the cluster have to the Kubernetes API. This needs to
be enabled too.&lt;/p&gt;
&lt;p&gt;Again, in my option all these are production requirements. Keep in mind that
just the ability to run a privileged container or mount a volume is enough to
compromise your infrastructure. This can be done on each of these layers with
different effort. Not require TLS on any connection should be consider missing
no authentication at all.&lt;/p&gt;
&lt;p&gt;There are setups which don’t require etcd TLS but limit it’s reachability to
controller nodes, then using tains to prevent “untrusted” containers to get
scheduled on the masters. While this is better than nothing, it’s still a risk
not worth taking.&lt;/p&gt;
&lt;p&gt;Unfortunately none of the more light-weight options fulfill these requirements.
Frankly, there are so many ‘installers’ out there, I can’t say this for sure but
the most popular options like kops are lacking. When running with calico
networking, it even requires etcd to be writable from all nodes without
authentication. Other options like kubespray don’t support full TLS either. Not
even the tectonic-installer, which in general looks very promising, supports TLS
out the box by default.&lt;/p&gt;
&lt;h3 id=&quot;self-sufficiency&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#self-sufficiency&quot; aria-label=&quot;self sufficiency permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;(Self-)Sufficiency?&lt;/h3&gt;
&lt;p&gt;The most common Kubernetes setups are not self-sufficient but depend often on
multiple external Docker registries and components during runtime. Since usually
these are referred to by mutable tags, there is also no way to guarantee that
nobody changes a dependency without you noticing.
Unfortunately this is something rarely discussed and there isn’t any
light-weight tooling I came across helping with this.&lt;/p&gt;
&lt;h3 id=&quot;conclusion&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#conclusion&quot; aria-label=&quot;conclusion permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Conclusion&lt;/h3&gt;
&lt;p&gt;I can’t claim I looked into every Kubernetes installer project and ignored
complex “enterprise” stacks like &lt;a href=&quot;http://www.projectatomic.io&quot;&gt;Red Hat’s Atomic&lt;/a&gt;
or &lt;a href=&quot;https://jujucharms.com/canonical-kubernetes/&quot;&gt;Canonical Kubernetes Juju&lt;/a&gt; but
I’m surprised how many different options there are, yet how few of them provide
what I’m looking for: A simple, immutable, secure and available cluster.&lt;/p&gt;
&lt;p&gt;As of right now, the
&lt;a href=&quot;https://github.com/coreos/tectonic-installer&quot;&gt;tectonic-installer&lt;/a&gt; looks like
the best option, especially if you need to deploy on bare metal or openstack.
But it’s a fast moving project and it could become a drag to keep up with
upstream changes. Another thing leaving a bad taste is that the component for
automated updates is closed source and not available for free.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubeadm/issues/261&quot;&gt;kubeadm works on HA&lt;/a&gt; but I
wouldn’t be surprised if it takes another year until this works reliably.
Fortunately you can build upon kubeadm to create secure and HA clusters. Since
this, to me, appears to be the best option, I implemented this based on
cloudformation for AWS for one of my clients. Hopefully I can share the results
as open source soon. For now you can find valuable hints on &lt;a href=&quot;https://github.com/kubernetes/kubeadm/issues/546&quot;&gt;this GitHub
issue&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;But should you even run your own Kubernetes cluster? Probably not! Kubernetes is
a incredibly fast moving project. As a rule of thumb, I’d say operating a
Kubernetes cluster is a full time job. Don’t assume any of the installers will
free you from developing a deep understanding of Kubernetes’ internals. If you
operate your own cluster, be prepared to read source code and fix bugs yourself.
This is especially true with all the managed solutions and &lt;a href=&quot;https://cloud.google.com/kubernetes-engine/&quot;&gt;Google Kubernetes
Engine&lt;/a&gt; now being available for
free.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Use Prometheus Vector Matching to get Kubernetes Utilization across any Pod Label]]></title><description><![CDATA[Prometheus was designed for dynamic environments like Kubernetes. Its powerful
service discovery and query language allows you to answer all…]]></description><link>https://5pi.de/2017/11/09/use-prometheus-vector-matching-to-get-kubernetes-utilization-across-any-pod-label/</link><guid isPermaLink="false">https://5pi.de/2017/11/09/use-prometheus-vector-matching-to-get-kubernetes-utilization-across-any-pod-label/</guid><pubDate>Thu, 09 Nov 2017 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Prometheus was designed for dynamic environments like Kubernetes. Its powerful
service discovery and query language allows you to answer all kind of questions
that come up while operating a Kubernetes cluster.&lt;/p&gt;
&lt;p&gt;This flexibility comes with a somewhat steeper learning curve than some
alternatives and hosted services, with &lt;a href=&quot;https://prometheus.io/docs/prometheus/latest/querying/operators/#vector-matching&quot;&gt;Vector
Matching&lt;/a&gt;
being one of the more advanced topics.&lt;/p&gt;
&lt;p&gt;I’m not going into the details which the excellent &lt;a href=&quot;https://prometheus.io/docs/prometheus/latest/querying/operators/#vector-matching&quot;&gt;Prometheus
Documentation&lt;/a&gt;
has already covered but walk you through some useful queries to get resource
utilization in a Kubernetes cluster.&lt;/p&gt;
&lt;h2 id=&quot;aggregated-memory-usage-per-label&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#aggregated-memory-usage-per-label&quot; aria-label=&quot;aggregated memory usage per label permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Aggregated memory usage per label&lt;/h2&gt;
&lt;p&gt;Kubernetes provides a &lt;code class=&quot;language-text&quot;&gt;container_memory_usage_bytes&lt;/code&gt; metric reflecting each pods
memory usage, e.g:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;...
container_memory_usage_bytes{beta_kubernetes_io_arch=&quot;amd64&quot;,beta_kubernetes_io_fluentd_ds_ready=&quot;true&quot;,beta_kubernetes_io_instance_type=&quot;g1-small&quot;,beta_kubernetes_io_os=&quot;linux&quot;,cloud_google_com_gke_nodepool=&quot;small-preemptible&quot;,cloud_google_com_gke_preemptible=&quot;true&quot;,container_name=&quot;POD&quot;,failure_domain_beta_kubernetes_io_region=&quot;us-east1&quot;,failure_domain_beta_kubernetes_io_zone=&quot;us-east1-c&quot;,id=&quot;/kubepods/burstable/pod13d4221c-c484-11e7-bff5-42010af0018b/67e5bb069ab9881ff8a55b8628ef4935b0d1ace09c18df20db059522bdfd5b7d&quot;,image=&quot;gcr.io/google_containers/pause-amd64:3.0&quot;,instance=&quot;gke-latency-at-small-preemptible-0c981b61-9489&quot;,job=&quot;kubernetes-cadvisor&quot;,kubernetes_io_hostname=&quot;gke-latency-at-small-preemptible-0c981b61-9489&quot;,name=&quot;k8s_POD_latency-api-971504058-jzs5h_default_13d4221c-c484-11e7-bff5-42010af0018b_0&quot;,namespace=&quot;default&quot;,pod_name=&quot;latency-api-971504058-jzs5h&quot;}	389120
container_memory_usage_bytes{beta_kubernetes_io_arch=&quot;amd64&quot;,beta_kubernetes_io_fluentd_ds_ready=&quot;true&quot;,beta_kubernetes_io_instance_type=&quot;g1-small&quot;,beta_kubernetes_io_os=&quot;linux&quot;,cloud_google_com_gke_nodepool=&quot;small-preemptible&quot;,cloud_google_com_gke_preemptible=&quot;true&quot;,container_name=&quot;POD&quot;,failure_domain_beta_kubernetes_io_region=&quot;us-east1&quot;,failure_domain_beta_kubernetes_io_zone=&quot;us-east1-c&quot;,id=&quot;/kubepods/burstable/pod81d0f651-c500-11e7-bff5-42010af0018b/309e05b118e618122c70ccf88538d13ca41c3b5a770d5d67882426854391c23c&quot;,image=&quot;gcr.io/google_containers/pause-amd64:3.0&quot;,instance=&quot;gke-latency-at-small-preemptible-0c981b61-9489&quot;,job=&quot;kubernetes-cadvisor&quot;,kubernetes_io_hostname=&quot;gke-latency-at-small-preemptible-0c981b61-9489&quot;,name=&quot;k8s_POD_latency-api-971504058-gszpw_default_81d0f651-c500-11e7-bff5-42010af0018b_0&quot;,namespace=&quot;default&quot;,pod_name=&quot;latency-api-971504058-gszpw&quot;}	372736
container_memory_usage_bytes{beta_kubernetes_io_arch=&quot;amd64&quot;,beta_kubernetes_io_fluentd_ds_ready=&quot;true&quot;,beta_kubernetes_io_instance_type=&quot;g1-small&quot;,beta_kubernetes_io_os=&quot;linux&quot;,cloud_google_com_gke_nodepool=&quot;small-preemptible&quot;,cloud_google_com_gke_preemptible=&quot;true&quot;,container_name=&quot;latency-api&quot;,failure_domain_beta_kubernetes_io_region=&quot;us-east1&quot;,failure_domain_beta_kubernetes_io_zone=&quot;us-east1-c&quot;,id=&quot;/kubepods/burstable/pod13d4221c-c484-11e7-bff5-42010af0018b/497e6fdf2217771cb3f52e6fef93734d023f0e7f23f92c58d22139fc18dc5f13&quot;,image=&quot;registry.gitlab.com/latency.at/latencyat@sha256:8ea057e064b64cc9c8459a68ef3f6d0fc26169b4f57aef193831779e1fe713d4&quot;,instance=&quot;gke-latency-at-small-preemptible-0c981b61-9489&quot;,job=&quot;kubernetes-cadvisor&quot;,kubernetes_io_hostname=&quot;gke-latency-at-small-preemptible-0c981b61-9489&quot;,name=&quot;k8s_latency-api_latency-api-971504058-jzs5h_default_13d4221c-c484-11e7-bff5-42010af0018b_1&quot;,namespace=&quot;default&quot;,pod_name=&quot;latency-api-971504058-jzs5h&quot;}	11014144
container_memory_usage_bytes{beta_kubernetes_io_arch=&quot;amd64&quot;,beta_kubernetes_io_fluentd_ds_ready=&quot;true&quot;,beta_kubernetes_io_instance_type=&quot;g1-small&quot;,beta_kubernetes_io_os=&quot;linux&quot;,cloud_google_com_gke_nodepool=&quot;small-preemptible&quot;,cloud_google_com_gke_preemptible=&quot;true&quot;,container_name=&quot;latency-api&quot;,failure_domain_beta_kubernetes_io_region=&quot;us-east1&quot;,failure_domain_beta_kubernetes_io_zone=&quot;us-east1-c&quot;,id=&quot;/kubepods/burstable/pod81d0f651-c500-11e7-bff5-42010af0018b/7b438a8e9df0cf1ab29d067fd36c97099f9f5e7e9257f6187c5be6bff846a62c&quot;,image=&quot;registry.gitlab.com/latency.at/latencyat@sha256:8ea057e064b64cc9c8459a68ef3f6d0fc26169b4f57aef193831779e1fe713d4&quot;,instance=&quot;gke-latency-at-small-preemptible-0c981b61-9489&quot;,job=&quot;kubernetes-cadvisor&quot;,kubernetes_io_hostname=&quot;gke-latency-at-small-preemptible-0c981b61-9489&quot;,name=&quot;k8s_latency-api_latency-api-971504058-gszpw_default_81d0f651-c500-11e7-bff5-42010af0018b_0&quot;,namespace=&quot;default&quot;,pod_name=&quot;latency-api-971504058-gszpw&quot;}	11448320
...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Unfortunately it doesn’t contain the pod labels. For that there is the
&lt;code class=&quot;language-text&quot;&gt;kube_pod_labels&lt;/code&gt; though which includes a static timeseries with all labels and
the pod name. This metric is provided by
&lt;a href=&quot;https://github.com/kubernetes/kube-state-metrics&quot;&gt;kube-state-metrics&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;We can use it to look up the labels for the pod from the
timeseries (&lt;code class=&quot;language-text&quot;&gt;pod_name=&quot;latency-api-971504058-jzs5h&quot;&lt;/code&gt;):&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;kube_pod_labels{instance=&quot;10.116.0.12:8080&quot;,job=&quot;kubernetes-service-endpoints&quot;,k8s_app=&quot;kube-state-metrics&quot;,kubernetes_name=&quot;kube-state-metrics&quot;,kubernetes_namespace=&quot;kube-system&quot;,label_app=&quot;latency-api&quot;,label_pod_template_hash=&quot;971504058&quot;,namespace=&quot;default&quot;,pod=&quot;latency-api-971504058-jzs5h&quot;} 1
kube_pod_labels{instance=&quot;10.116.1.26:8080&quot;,job=&quot;kubernetes-service-endpoints&quot;,k8s_app=&quot;kube-state-metrics&quot;,kubernetes_name=&quot;kube-state-metrics&quot;,kubernetes_namespace=&quot;kube-system&quot;,label_app=&quot;latency-api&quot;,label_pod_template_hash=&quot;971504058&quot;,namespace=&quot;default&quot;,pod=&quot;latency-api-971504058-jzs5h&quot;} 1&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Both metrics can be merged by using vector matching. We get this metric twice
because there are two instances of kube-state-metrics running. So before we
continue further, we aggregate both. Since they should be identical, we can use
min/max to aggregate. Since we later want to aggregate on &lt;code class=&quot;language-text&quot;&gt;label_app&lt;/code&gt;, we need
to keep that label. We also need to keep the &lt;code class=&quot;language-text&quot;&gt;pod&lt;/code&gt; label to join both metrics
on. We can preserve them by specifying them in the BY clause. Since the pod
label is called &lt;code class=&quot;language-text&quot;&gt;pod&lt;/code&gt; in &lt;code class=&quot;language-text&quot;&gt;kube_pod_labels&lt;/code&gt; but &lt;code class=&quot;language-text&quot;&gt;pod_name&lt;/code&gt; in
&lt;code class=&quot;language-text&quot;&gt;container_memory_usage_bytes&lt;/code&gt;, we need to also use label_replace to rename the
label. This gives us:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;max by (pod_name,label_app) (
  label_replace(kube_pod_labels{label_app!=&quot;&quot;},&quot;pod_name&quot;,&quot;$1&quot;,&quot;pod&quot;,&quot;(.*)&quot;)
)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Which returns something like:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;...
{label_app=&quot;latency-api&quot;,pod_name=&quot;latency-api-971504058-n8k6d&quot;}  1
{label_app=&quot;latency-api&quot;,pod_name=&quot;latency-api-971504058-jzs5h&quot;}  1
...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we can use vector matching to join &lt;code class=&quot;language-text&quot;&gt;container_memory_usage_bytes&lt;/code&gt; with the
result of our expression. We use the &lt;code class=&quot;language-text&quot;&gt;*&lt;/code&gt; operator which effectivly is a no-op
since it will multiply the memory usage by the matched timeseries value in
&lt;code class=&quot;language-text&quot;&gt;kube_pod_labels&lt;/code&gt; which is always 1.&lt;/p&gt;
&lt;p&gt;We need to specify &lt;code class=&quot;language-text&quot;&gt;group_left&lt;/code&gt; because there are multiple
&lt;code class=&quot;language-text&quot;&gt;container_memory_usage_bytes&lt;/code&gt; timeseries for each pod, one for each container.
Since we want to preserve the &lt;code class=&quot;language-text&quot;&gt;label_app&lt;/code&gt; label, we specify it as argument to &lt;code class=&quot;language-text&quot;&gt;group_left&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;This gives us:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;  container_memory_usage_bytes * on (pod_name) group_left(label_app)
  max by (pod_name,label_app) (
    label_replace(kube_pod_labels{label_app!=&quot;&quot;},&quot;pod_name&quot;,&quot;$1&quot;,&quot;pod&quot;,&quot;(.*)&quot;)
  )&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To aggregated the memory usage of all your pods, summed by a &lt;code class=&quot;language-text&quot;&gt;k8s-app&lt;/code&gt; label you
can use the following expression:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;sum by (label_app,namespace) (
  container_memory_usage_bytes * on (pod_name) group_left(label_app)
  max by (pod_name,label_app) (
    label_replace(kube_pod_labels{label_app!=&quot;&quot;},&quot;pod_name&quot;,&quot;$1&quot;,&quot;pod&quot;,&quot;(.*)&quot;)
  )
)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0f0a37acb794c49740014ce150e3ae1f/587b0/mem_per_app.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 79.14110429447852%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACRUlEQVQ4y5VUyW4aQRCdH+FEThxQ5EsYkrBJ7DayzJ2PiRBOlBz8E/HBETkn+Qf+AQzYVvAmM0t3z/JSVcMQO4ocUtJzd3VVv35VNdiK4xhBEMD3fVmVUvA8D67rYr1eQ2u9jTPYT+N8909Y/MdoQ9CIoghhGCIIAyExxojP5+wzJL6J8TmDOdK9FZGjPB/K8ZFaTIEnFuOvxnlRSI+RIO0rhEEIa/ui0kJqFAVdBe2p7eup8eWI8o2vt9AEJkpirHAjlY1fSkv01g6U6ws5nyvXk0pYSUDlBkZLLhuvYZi0wwrpslKUyNCkTCd733Pguw7urla0dwVJXFH/iDQwNCRXcpXvCbhSi5urKOlxadsSWX0cPdvKJy3hociU6RVDn4FmFbQaUmZozwg094oarhj0JfDXwCv5MbWCwWch5UQ8FCa8f7jHz5sVVrfXgutb2pPPZ46zxoNzh8XVHPOLORaXS8wvF5hdzDBdTDFdznC+PMdsMYNLAiyWOplM8Pn0FOOv4wTj3zj7cobvP75Rnz3pmdr0WlGvfe3Jqja+DIUJh8N32Nt7iVqthnKpjFKphEqlAtu2kc2+QL1ep0EE2MWEcDT6gGLxDXq9A7TbbXQ6HUG1WkUul8P+wb78MtIhPAchfP9xhOJbm0i6aDQaaDabaLVaojCTyaDb7f4n4fEIr21bVDFZSpqUnBXVjwn/WfJwdIxXBSKki0zG6rifhUIB+XyeWtGT/zI7E56cfCKCMo6O+jg8PBQwSb/fl4EMBoOdFf4CsVxyJpzLTv4AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;mem_per_app&quot;
        title=&quot;mem_per_app&quot;
        src=&quot;/static/0f0a37acb794c49740014ce150e3ae1f/a6d36/mem_per_app.png&quot;
        srcset=&quot;/static/0f0a37acb794c49740014ce150e3ae1f/222b7/mem_per_app.png 163w,
/static/0f0a37acb794c49740014ce150e3ae1f/ff46a/mem_per_app.png 325w,
/static/0f0a37acb794c49740014ce150e3ae1f/a6d36/mem_per_app.png 650w,
/static/0f0a37acb794c49740014ce150e3ae1f/587b0/mem_per_app.png 970w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;cpu-and-io-usage-per-label&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#cpu-and-io-usage-per-label&quot; aria-label=&quot;cpu and io usage per label permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;CPU and IO usage per label&lt;/h2&gt;
&lt;p&gt;Now that we know how to join the &lt;code class=&quot;language-text&quot;&gt;kube_pod_labels&lt;/code&gt; metric with cadvisor metrics,
we can figure out usage of other resources too.&lt;/p&gt;
&lt;h3 id=&quot;cpu&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#cpu&quot; aria-label=&quot;cpu permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;CPU&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;sum by (label_app,namespace) (
  rate(container_cpu_usage_seconds_total[2m]) * on (pod_name) group_left(label_app)
  max by (pod_name,label_app) (
    label_replace(kube_pod_labels{label_app!=&quot;&quot;},&quot;pod_name&quot;,&quot;$1&quot;,&quot;pod&quot;,&quot;(.*)&quot;)
  )
)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ee8bde4b930678ada8505a9cc8e749ba/587b0/cpu_per_app.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 79.14110429447852%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACPklEQVQ4y5WSTW9SURCG+0dYsWPRqBu5VbGQAC1UQsq+/8XYUI0u+ivsosa6K9amcWclKaDW9COKXKuUj1JaLvdyv+B1ZihKG2zoSd7MnIHz3HfOmYlerwfHcWAYhkTTNCXXdR2apsGyLKl3Oh0R7zny73z2qiZc1/17iHOOLNu2RcN13g/n3W5X9sNxYvAHXvyF69bV3weuBrnrOv+Ao+xfFTsYVeflOCa5NvtAtj8OcGBwFLDVqtC9nl44/A+Ql23pcB1L9hblhtEkNxbVDWrRhmW2RZXjXXrE2uU7NE2D2nIvXHQlWrZOX27Qy56hXjtApcIHq7Q/FzWbKur1Q6jqB+jtRh/YbmnQzzTUy2WcnTSgn7dR47x+ip/FPPa/buGolMe3gy2RWtyG+n0bpeJHlCge7m1ib3edgNQyt6KdN9GolUm/cVJVUT3+gUb1F+mIDmSxv/ceXz5tYmcng3wug0I+g2z2DQq5dXwuvJVaPrcBrUVAbiuX28HKykusrb0e0prE1dVX2Nh4J7NqmhZdAc2nzKorsu1+zjWZQwYuPnmMO7dvIRgMIRAIiKanp6EoCrxeL8LhsEzCOLMqwHT6Gaam7iOReITZ2VnEYjFRMBiEz+fD3NzcJeB1EuDT52lMPVAIEkckEkE0GsXMzIw49Hg8iMfjNwQupXFPUcQVwwbQQcvs+kYtL6aXcNdPQDrIMHYXCoXg9/sxOTlJV5GQRxkbuLz8ggAPMT+fQjKZFDEklUrJgywsLIzt8A+RU2fWIfC1jwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;cpu_per_app&quot;
        title=&quot;cpu_per_app&quot;
        src=&quot;/static/ee8bde4b930678ada8505a9cc8e749ba/a6d36/cpu_per_app.png&quot;
        srcset=&quot;/static/ee8bde4b930678ada8505a9cc8e749ba/222b7/cpu_per_app.png 163w,
/static/ee8bde4b930678ada8505a9cc8e749ba/ff46a/cpu_per_app.png 325w,
/static/ee8bde4b930678ada8505a9cc8e749ba/a6d36/cpu_per_app.png 650w,
/static/ee8bde4b930678ada8505a9cc8e749ba/587b0/cpu_per_app.png 970w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h3 id=&quot;disk-io&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#disk-io&quot; aria-label=&quot;disk io permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Disk IO&lt;/h3&gt;
&lt;p&gt;I wanted to show you some disk IO stats too. Unfortunately these are
&lt;a href=&quot;https://github.com/kubernetes/kubernetes/issues/55397&quot;&gt;broken&lt;/a&gt; once
&lt;a href=&quot;https://github.com/kubernetes/kubernetes/issues/55398&quot;&gt;again&lt;/a&gt; in Kubernetes.&lt;/p&gt;
&lt;h3 id=&quot;network&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#network&quot; aria-label=&quot;network permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Network&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;sum by (label_app,namespace) (
  rate(container_network_transmit_bytes_total[2m]) * on (pod_name) group_left(label_app)
  max by (pod_name,label_app) (
    label_replace(kube_pod_labels{label_app!=&quot;&quot;},&quot;pod_name&quot;,&quot;$1&quot;,&quot;pod&quot;,&quot;(.*)&quot;)
  )
)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/9cdc5336080b286047c358a645a9a8ed/587b0/net_per_app.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 79.14110429447852%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACAklEQVQ4y5WTzXISQRSFeRFWsGJBqRsZNAhU8Z9QVNjzLpYpoqWLPIWpuMA1D2FewnJlwjD8zv/xnjv0mIlWxK469J2e7u+ee3vIRVEE3/ex2+0QBAFc19V4s9lgvV7rM9f3+73K8zx9v91uEcfxH8oZCOcwDHVmAoqHH68zNu8ZPxTN5UhlYEYscSRO/ncYTs5kVMvyIgok+8rRmHDO4X6HKAz+WqIRYQrkD6FchAE6y0PWxHkgCbgeH5yoDsnMuYxD9ucpIJ8jPwEmewIE23UKygAJY/PTktlwx86UTGDo/97DOLPnYcl8MDcUMRa4t1xILAeDUA959gKxJE4Hq5I2PB5pDwOWw6azl1JyuFlrWZHn0wM8cbO8+wn7/g7O0oYt8eLHdzi2DWdxj5UkXMk6LzdH8u3tN1xff8ZsNkv19TB/ubnBfD7Xb3Uvt+26ycfts2wvkee5KlaqwIt3b/Hi+TM0mk3UajVVvV6HZVkoFototVqa/ZihwOn0A6rV1xgOz9Dr9dDv91WNRgOlUglnp6cpUG/VCFnpX4+b3n+conpiCWSAdruNTqeDbrerDvP5PAaDQQb4lBLg5RSvLEtdEWagBBYKBXWdcfivki+ml3hZEaAcJIzumtLPSqWCcrksrRjqRRwNvLr6JIA3OD8fYzQaqQgZj8d6IZPJ5GiHvwBjwXcCQ/PQaQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;net_per_app&quot;
        title=&quot;net_per_app&quot;
        src=&quot;/static/9cdc5336080b286047c358a645a9a8ed/a6d36/net_per_app.png&quot;
        srcset=&quot;/static/9cdc5336080b286047c358a645a9a8ed/222b7/net_per_app.png 163w,
/static/9cdc5336080b286047c358a645a9a8ed/ff46a/net_per_app.png 325w,
/static/9cdc5336080b286047c358a645a9a8ed/a6d36/net_per_app.png 650w,
/static/9cdc5336080b286047c358a645a9a8ed/587b0/net_per_app.png 970w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Frontend Testing Zoo - Or, Nightwatch without Selenium]]></title><description><![CDATA[What I always find hardest to figure it when it comes to unknown systems, it’s ‘how things fit together’. These project might have great…]]></description><link>https://5pi.de/2017/04/17/selenium-webdriver-chromedriver-nightwatch-chrome-headless/</link><guid isPermaLink="false">https://5pi.de/2017/04/17/selenium-webdriver-chromedriver-nightwatch-chrome-headless/</guid><pubDate>Mon, 17 Apr 2017 12:50:12 GMT</pubDate><content:encoded>&lt;p&gt;What I always find hardest to figure it when it comes to unknown systems, it’s ‘how things fit together’. These project might have great documentation, but how the ecosystem plays together is usually left as an exercise for the reader.
This happened to me again when diving into frontend testing. I figured out how to get nightwatch+selenium-standalone+chromedriver+chrome working somehow, without fully understanding each part in the puzzle. I went with Nightwatch because I like the syntax and it seems one of the obvious options nowadays. That works until I updated some dependencies and broke everything again. So I took some time to figure out how these things fit together and what is really needed for me tests.
I’ve learned that Selenium is the godmother of modern frontend testing. It’s a framework with bindings for multiple languages. To decouple the server from the actual browsers, it invented “Selenium RC” as a protocol. That lead to the development of the WebDriver W3C standard which replaces Selenium RC is newer versions and is implemented for the most common browsers (Chrome -&gt; Chromedriver, Firefox -&gt; FirefoxDriver).&lt;/p&gt;
&lt;h2 id=&quot;nightwatch-without-selenium&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#nightwatch-without-selenium&quot; aria-label=&quot;nightwatch without selenium permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Nightwatch without Selenium&lt;/h2&gt;
&lt;p&gt;Apparently WebDriver is also used for talking &lt;em&gt;to&lt;/em&gt; Selenium. I think this is called ‘hub’ or something, that’s about as deep as my ‘deep dive’ gets for now. Either way, this makes the big picture look like:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Nightwatch -[webdriver]-&gt; Selenium -[webdriver]-&gt; Chromedriver -&gt; Chrome&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Selenium comes in a server and standalone flavor, where the server apparently is only used for grid based testing where you would have a bunch of Selenium nodes running on different systems. Turns out, if you don’t need grid based testing or support for legacy browsers which don’t provide WebDriver adapter, there is little use for Selenium after all.&lt;/p&gt;
&lt;p&gt;Fortunately you can make Nightwatch talk directly to Chromedriver. This requires start&lt;em&gt;processto be set to false and selenium&lt;/em&gt;host/_port to point the address of Chromedriver:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;{
  &quot;output_folder&quot;: false,
  &quot;src_folders&quot;: [&quot;tests&quot;],
  &quot;selenium&quot;: {
    &quot;start_process&quot;: false
  },
  &quot;test_settings&quot;: {
    &quot;default&quot;: {
      &quot;selenium_host&quot;: &quot;127.0.0.1&quot;,
      &quot;selenium_port&quot;: &quot;9515&quot;,
      &quot;screenshots&quot;: {
        &quot;enabled&quot;: true,
        &quot;on_failure&quot;: true,
        &quot;on_error&quot; : true,
        &quot;path&quot;: &quot;results/screenshots&quot;
      },
      &quot;desiredCapabilities&quot;: {
        &quot;browserName&quot;: &quot;chrome&quot;,
        &quot;javascriptEnabled&quot; : true,
        &quot;acceptSslCerts&quot; : true,
        &quot;chromeOptions&quot; : {
          &quot;args&quot;: [
            &quot;--no-sandbox&quot;,
            &quot;start-fullscreen&quot;,
            &quot;window-size=1280,800&quot;
          ]
        }
      },
      &quot;launch_url&quot;: &quot;http://app&quot;
    }
  }
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The only caveat being, you need to run Chromedriver manually. I run all this in a Docker container with a entrypoint like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Xvfb :23 &amp;amp;
chromedriver --port=9515 --url-base=/wd/hub &amp;amp;
while ! curl localhost:9515; do echo -n .; sleep 1; done
nightwatch&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;chrome-headless&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#chrome-headless&quot; aria-label=&quot;chrome headless permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Chrome Headless&lt;/h2&gt;
&lt;p&gt;Recently Chrome got native support for running headless, controlled via a remote debugging API. Apparently this could further simplify things, but I couldn’t figure out in reasonable time what exactly it would replace. I suspected it would mean that chrome natively talks webdriver, but I can’t find anything about that in the sparse documentation and this issues sound like.
Which brings me to my initial observation: Figuring out how a thing works is hard, figuring out how things work &lt;em&gt;together&lt;/em&gt; is so much harder. Let’s all keep that in mind.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[$15 Production Kubernetes Cluster on DigitalOcean]]></title><description><![CDATA[Four sweets or production Kubernetes for a month Introduction As you might already know, I’m into containers, static configuration and self…]]></description><link>https://5pi.de/2016/11/20/15-producation-grade-kubernetes-cluster/</link><guid isPermaLink="false">https://5pi.de/2016/11/20/15-producation-grade-kubernetes-cluster/</guid><pubDate>Sun, 20 Nov 2016 10:36:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a title=&quot;By Charlotte Marillet (originally posted to Flickr as Quatre macarons) [CC BY-SA 2.0 (http://creativecommons.org/licenses/by-sa/2.0)], via Wikimedia Commons&quot; href=&quot;https://commons.wikimedia.org/wiki/File%3AQuatre_macarons%2C_October_2009.jpg&quot;&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 85.88957055214723%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAARABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAQCAwX/xAAXAQADAQAAAAAAAAAAAAAAAAAAAgMB/9oADAMBAAIQAxAAAAHPKyGVbFyi7hBPUGn/xAAcEAADAAEFAAAAAAAAAAAAAAABAgMTABEiMjT/2gAIAQEAAQUCIGRyrUVNwQM1HFKzHA94+nX/xAAZEQABBQAAAAAAAAAAAAAAAAABAAIQESH/2gAIAQMBAT8BFDUXT//EABYRAAMAAAAAAAAAAAAAAAAAAAEgMf/aAAgBAgEBPwEVP//EABsQAAIDAAMAAAAAAAAAAAAAAAABEBEhUWHh/9oACAEBAAY/An0cGDdGL0VqHH//xAAdEAACAgIDAQAAAAAAAAAAAAAAASExEVEQYXGB/9oACAEBAAE/IZgIQmi+ZJShqtsyxmK7D1FPRb5wXZ//2gAMAwEAAgADAAAAEMsHfP/EABgRAAMBAQAAAAAAAAAAAAAAAAABERAh/9oACAEDAQE/EHi3Sro8/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAEREP/aAAgBAgEBPxCm5BZ//8QAIBABAQABBAEFAAAAAAAAAAAAAREAECExQVFhgZGhwf/aAAgBAQABPxCU4uN4MDRmIvuvjCvNO2CQhW6LJ3MMwPIPn/DNyTL5B1fWaF9nS//Z&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Four tiny Macarones - or one month Kubernetes cluster&quot;
        title=&quot;Four tiny Macarones - or one month Kubernetes cluster&quot;
        src=&quot;/static/db5a9488a10ec170588bdbaab13f615a/6aca1/Quatre_macarons-_October_2009.jpg&quot;
        srcset=&quot;/static/db5a9488a10ec170588bdbaab13f615a/d2f63/Quatre_macarons-_October_2009.jpg 163w,
/static/db5a9488a10ec170588bdbaab13f615a/c989d/Quatre_macarons-_October_2009.jpg 325w,
/static/db5a9488a10ec170588bdbaab13f615a/6aca1/Quatre_macarons-_October_2009.jpg 650w,
/static/db5a9488a10ec170588bdbaab13f615a/7c09c/Quatre_macarons-_October_2009.jpg 975w,
/static/db5a9488a10ec170588bdbaab13f615a/01ab0/Quatre_macarons-_October_2009.jpg 1300w,
/static/db5a9488a10ec170588bdbaab13f615a/9c9b2/Quatre_macarons-_October_2009.jpg 2268w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
    &lt;/span&gt;&lt;/a&gt;
&lt;small&gt;Four sweets or production Kubernetes for a month&lt;/small&gt;&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#introduction&quot; aria-label=&quot;introduction permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Introduction&lt;/h2&gt;
&lt;p&gt;As you might already know, I’m into &lt;a href=&quot;https://5pi.de/2015/01/08/containerized-infrastructure/&quot;&gt;containers&lt;/a&gt;, &lt;a href=&quot;https://5pi.de/2015/08/31/dont-manage-config-unless-you-have-to/&quot;&gt;static configuration&lt;/a&gt; and &lt;a href=&quot;https://5pi.de/2015/04/22/scope-and-ownership-in-tech-companies/&quot;&gt;self-service infrastructures&lt;/a&gt;. Naturally, I love &lt;a href=&quot;http://kubernetes.io/&quot;&gt;Kubernetes&lt;/a&gt;, which I consider the most promising cluster scheduler around.&lt;/p&gt;
&lt;p&gt;In fact, the biggest reason to use containers is that they make it possible for something like Kubernetes to &lt;em&gt;operate your cluster&lt;/em&gt;. Cluster scheduler like Kubernetes, Mesos or Swarm take care of deploying and moving your applications around without requiring an Operator to allocate resources and redeploy services manually.&lt;/p&gt;
&lt;p&gt;Cluster schedulers are here to stay. They will become as ubiquitous as version control and getting experience with it is something I can encourage everyone in the DevOps world to do. Especially if your job is mainly &lt;em&gt;operating&lt;/em&gt;. Chances are, your job gets automated.&lt;/p&gt;
&lt;p&gt;Getting Kubernetes up &lt;em&gt;somehow&lt;/em&gt; is easy. There are tons of scripts for doing that. But those setups are intended as temporary test environments. Setting up a production environment is much harder and unfortunately not very well documented.&lt;/p&gt;
&lt;p&gt;Reading this you will realize that there are things you might not want to do this way in production and I agree. So I’m sorry if the title is a bit click-baity. The reason I’m still calling this ‘production’ is because this setup is highly available, TLS authenticated and has a way going forward which doesn’t require you to start from scratch like most Containers/Kubernetes getting started guides.&lt;/p&gt;
&lt;p&gt;You can find all code mentioned here: &lt;a href=&quot;https://github.com/5pi&quot;&gt;https://github.com/5pi&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;overview&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#overview&quot; aria-label=&quot;overview permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Overview&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;/020fc8ece35a34a40c4d951f78df9481/5pi-Infra.svg&quot; alt=&quot;Infrastructure Diagram&quot;&gt;
Mainly to keep things cheap, I choose &lt;a href=&quot;https://digitalocean.com&quot;&gt;DigitalOcean&lt;/a&gt; and use the smallest $5/month instances. For a highly available cluster, we need at least three hosts.&lt;/p&gt;
&lt;p&gt;Kubernetes doesn’t schedule containers directly, it schedules &lt;a href=&quot;http://kubernetes.io/docs/user-guide/pods/&quot;&gt;Pods&lt;/a&gt; which again can consist of multiple containers sharing the same storage volumes and IPs. The pods running on different hosts need to communicate with each other. There are several options to do this, like using overlay networks, routing IP ranges to each server on you routers or co-locating the servers on the same ethernet segment.&lt;/p&gt;
&lt;p&gt;Since static routes are least complex to setup and maintain, while allowing to grow easier than with one ethernet segment for all pod IPs, it’s the option I choose here.&lt;/p&gt;
&lt;p&gt;Because on DigitalOcean there is no way to have custom routes, I’m using &lt;a href=&quot;https://www.tinc-vpn.org/&quot;&gt;tinc&lt;/a&gt; to form a private, flat ethernet segment and route a /24 to each host.&lt;/p&gt;
&lt;p&gt;To consider the infrastructure immutable, we need to store state externally. Fortunately DigitalOcean just released their &lt;a href=&quot;https://www.digitalocean.com/products/storage/&quot;&gt;block storage&lt;/a&gt; product which we use to store pod volumes on.&lt;/p&gt;
&lt;p&gt;We will also create DNS names to make accessing the cluster easier:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;master0X.[domain] points to a hosts internal IP; Used for tinc to connect to peers&lt;/li&gt;
&lt;li&gt;edge0X.[domain] points to a hosts public IP; Used for remote access etc&lt;/li&gt;
&lt;li&gt;edge.[domain] points to edge float IP; Used to reach LB directly&lt;/li&gt;
&lt;li&gt;*.edge.[domain] also points to edge float IP; Used for virtual hosts on LB&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;kubernetes-deployment&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#kubernetes-deployment&quot; aria-label=&quot;kubernetes deployment permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Kubernetes Deployment&lt;/h2&gt;
&lt;h3 id=&quot;configuration&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#configuration&quot; aria-label=&quot;configuration permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Configuration&lt;/h3&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;https://asciinema.org/a/dgfb2mik71by4tkt5urd9lasj.js&quot; id=&quot;asciicast-dgfb2mik71by4tkt5urd9lasj&quot; async&gt;&lt;/script&gt;
&lt;p&gt;The &lt;a href=&quot;https://github.com/5pi/infra&quot;&gt;infra repository&lt;/a&gt; contains all sources needed to build the images and deploy the stack. Beside the committed configuration in the repository, there is also some cluster specific configuration required. While some of it only affects the cluster deployment, other is included in the images. This means changing this always requires rebuilding the images.
The configuration is kept in &lt;a href=&quot;https://github.com/5pi/infra/tree/master/config&quot;&gt;config/&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;To create a new cluster, first checkout the repo, edit &lt;code class=&quot;language-text&quot;&gt;config/env&lt;/code&gt; and run &lt;code class=&quot;language-text&quot;&gt;./mk_credentials&lt;/code&gt; to create credentials:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;$ git clone git@github.com:5pi/infra.git
$ cd infra
$ vi config/env
$ ./mk_credentials&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;building-images&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#building-images&quot; aria-label=&quot;building images permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Building Images&lt;/h3&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;https://asciinema.org/a/786ffzwvjdupff56ka5258ckk.js&quot; id=&quot;asciicast-786ffzwvjdupff56ka5258ckk&quot; async&gt;&lt;/script&gt;
&lt;p&gt;&lt;tty-player autoplay controls loop src=packer-k8s-build.rec&gt;&lt;/tty-player&gt;
I’m using &lt;a href=&quot;https://www.packer.io&quot;&gt;packer&lt;/a&gt; to build machine images. Since all our hosts are controller+worker nodes, we only have one image. This image includes tinc, etcd, kubernetes and the &lt;a href=&quot;https://prometheus.io&quot;&gt;Prometheus&lt;/a&gt; node-exporter for monitoring. Beside installing general configuration files and services, the &lt;a href=&quot;https://github.com/5pi/infra/blob/e8ccca5de9a5d7759c40355c860d3ed13e349fc7/packer/base.json#L22&quot;&gt;packer config&lt;/a&gt; also refers the cluster specific configuration. This means for each cluster you need to build custom images. It does &lt;strong&gt;not&lt;/strong&gt; include host specific configuration like a host’s TLS keys, or configuration that simply isn’t available before deployment, like a host’s IP address. This need to be configured at deployment.&lt;/p&gt;
&lt;p&gt;As described in the &lt;a href=&quot;https://github.com/5pi/infra#deploying-a-new-stack&quot;&gt;README&lt;/a&gt;, to build the images run &lt;code class=&quot;language-text&quot;&gt;make -C packer&lt;/code&gt; after you created the configuration and credentials.&lt;/p&gt;
&lt;h3 id=&quot;deploying-stack&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#deploying-stack&quot; aria-label=&quot;deploying stack permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Deploying Stack&lt;/h3&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;https://asciinema.org/a/1hpbxy5pcvmidxxuu1u6w39vr.js&quot; id=&quot;asciicast-1hpbxy5pcvmidxxuu1u6w39vr&quot; async&gt;&lt;/script&gt;
&lt;p&gt;Deployment is configured in &lt;a href=&quot;https://github.com/5pi/infra/tf&quot;&gt;tf/&lt;/a&gt; and uses &lt;a href=&quot;https://www.terraform.io&quot;&gt;terraform&lt;/a&gt;. It spins up hosts with the specified image and allows the provided ssh key to connect. It also creates the DNS records required for tinc to connect to peers and external users to access services on the cluster.&lt;/p&gt;
&lt;p&gt;Since we didn’t want to include all necessary configuration and credentials in the image for flexibility and security, we need to upload the remaining configuration, like TLS keys, after spinning up the host. To set general configuration, &lt;code class=&quot;language-text&quot;&gt;/etc/environment.tf&lt;/code&gt; is created and can be sourced by scripts in the image to get deploy-time configuration.&lt;/p&gt;
&lt;p&gt;To deploy a new cluster, you first probably want to change &lt;code class=&quot;language-text&quot;&gt;tf/id_rsa.pub&lt;/code&gt; to include your SSH public key. You need to run ssh-agent and the key needs to be added to it’s keyring with &lt;code class=&quot;language-text&quot;&gt;ssh-add&lt;/code&gt;. The key may not exist on DigitalOcean already. You can run &lt;code class=&quot;language-text&quot;&gt;ssh-keygen -f id_rsa &amp;amp;&amp;amp; ssh-add id_rsa&lt;/code&gt; in &lt;code class=&quot;language-text&quot;&gt;tf/&lt;/code&gt; to create a new keypair.&lt;/p&gt;
&lt;p&gt;You also need to create the domain you specified in &lt;code class=&quot;language-text&quot;&gt;config/env&lt;/code&gt; in DigitalOcean before proceeding. For whatever reason DO requires you to attach the records to some droplet. It doesn’t really matter which one.&lt;/p&gt;
&lt;p&gt;To spin up the configured cluster with the built image, run:&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;./terraform apply -var cluster_state=new -var &apos;image=&quot;image-id-from-last-step&quot;&apos;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;small&gt;Be careful to quote the image parameter properly like described here). &lt;code class=&quot;language-text&quot;&gt;cluster_state&lt;/code&gt; is required to make etcd not wait for consensus before spinning up the next instance.&lt;/small&gt;&lt;/p&gt;
&lt;p&gt;That’s it! After a few minutes, the cluster should be up and running.&lt;/p&gt;
&lt;p&gt;If you created a new domain for your cluster, it may take some time until the cluster is formed. If you run &lt;code class=&quot;language-text&quot;&gt;journalctl -fu tinc@default&lt;/code&gt; to watch the tinc log you should see that the DNS records are not resolvable yet. This should fix itself after a few minutes.
Once tinc is running, etcd should reach it peers. Run &lt;code class=&quot;language-text&quot;&gt;journalctl -fu etcd&lt;/code&gt; to see the etcd log.&lt;/p&gt;
&lt;h3 id=&quot;rolling-upgrades&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#rolling-upgrades&quot; aria-label=&quot;rolling upgrades permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Rolling Upgrades&lt;/h3&gt;
&lt;p&gt;Another thing most getting started guides are missing is upgrades. Most likely because they are often very environment specific and, well, hard. Which is also why while upgrades &lt;em&gt;should&lt;/em&gt; work, this is the most brittle part of it and one of the reason I hesitated to call it “Production Grade”. But heck, if Docker 1.0 was &lt;em&gt;production ready&lt;/em&gt; this here is as well.&lt;/p&gt;
&lt;p&gt;Since all pod volumes get stored on DO block storage, we consider the systems immutable. To upgrade the cluster, all instances get replaced while Kubernetes makes sure to reschedule services and maintain their availability. The tricky part is to orchestrate this with terraform which does &lt;a href=&quot;https://github.com/hashicorp/terraform/issues/2896&quot;&gt;not really support this&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Because of that we need a &lt;a href=&quot;https://github.com/5pi/infra/blob/master/tf/upgrade&quot;&gt;wrapper script&lt;/a&gt;. This script stops etcd on the first old server, which will cause it to remove itself from the cluster. Then it executes terraform and sets &lt;code class=&quot;language-text&quot;&gt;-target&lt;/code&gt; for each server individually. Unless &lt;code class=&quot;language-text&quot;&gt;cluster_state=new&lt;/code&gt; is given, the new instance’s provisioning script will block until etcd joined the existing cluster and the cluster is healthy. Only after that, the script continues with the next instance.&lt;/p&gt;
&lt;p&gt;Removing an instance from the cluster before replacing it is required. Otherwise the replacement instance can’t join the cluster. This means, if an instance ever dies, you need to manually remove it from the cluster with &lt;code class=&quot;language-text&quot;&gt;etcd member remove&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&quot;deployment-on-kubernetes&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#deployment-on-kubernetes&quot; aria-label=&quot;deployment on kubernetes permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Deployment on Kubernetes&lt;/h2&gt;
&lt;p&gt;A cluster without services doesn’t make much sense, so I’ll also show quickly how to deploy services to the cluster and make them accessible. I’m using just a bunch of yaml files I can apply with &lt;code class=&quot;language-text&quot;&gt;kubectl apply -f&lt;/code&gt;: &lt;a href=&quot;https://github.com/5pi/services&quot;&gt;https://github.com/5pi/services&lt;/a&gt;
They are pretty specific to my setup, so probably only useful as example. For real reusable components on top of Kubernetes have a look at &lt;a href=&quot;https://github.com/5pi/services&quot;&gt;helm&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Beside the public configuration, you need to require to setup some secrets:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;apiVersion: v1
kind: Secret
metadata:
  name: default
type: Opaque
data:
  pg-password:...
  pg-ghost-fish-password: ...
  pg-grafana-password: ...
  do-token: ...
  grafana-gauth-client-secret: ...
  smtp-infra-password: ...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;For the passwords, just generate something, base64 encode and put them into a file and apply it&lt;/li&gt;
&lt;li&gt;The &lt;code class=&quot;language-text&quot;&gt;do-token&lt;/code&gt; is a DigitalOcean API token required for floating IP and volume configuration&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;grafana-gauth-client-secret&lt;/code&gt; is a Google OAuth client secret for Google Auth based Grafana authentication&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;smtp-infra-password&lt;/code&gt; is the password for a Google Mail I use to send Prometheus alerts&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;skydns&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#skydns&quot; aria-label=&quot;skydns permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;SkyDNS&lt;/h3&gt;
&lt;p&gt;This is a core service providing DNS resolution for pods. I’m using an &lt;a href=&quot;https://github.com/5pi/services/blob/master/01_skydns-rc.yml&quot;&gt;adapted copy&lt;/a&gt; of the &lt;a href=&quot;https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/skydns-rc.yaml.in&quot;&gt;upstream config&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;traffic-tier&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#traffic-tier&quot; aria-label=&quot;traffic tier permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Traffic Tier&lt;/h3&gt;
&lt;p&gt;I’m using &lt;a href=&quot;https://github.com/containous/traefik&quot;&gt;traefik&lt;/a&gt; as reverse proxy / load balancer. It depends on a &lt;code class=&quot;language-text&quot;&gt;traefik-config&lt;/code&gt; ConfigMap where I specific TLS keys etc. It runs three replica and assumes a three node cluster, so we run one instance per host. The vhost configuration is part of the application yaml files.&lt;/p&gt;
&lt;p&gt;To have a stable entrypoint into our infrastructure while the host’s IPs change on every rolling upgrade, terraform deployed a floating IP. To assign this IP to any available traefik instance, I’ve created a simple &lt;a href=&quot;https://github.com/5pi/img-do-float-ip&quot;&gt;container image&lt;/a&gt; and this &lt;a href=&quot;https://github.com/5pi/services/blob/master/01_float_ip.yml&quot;&gt;yaml spec&lt;/a&gt; (The IP needs to get changed when using this spec).
This will make sure the float IP is always assigned to one of the running hosts.&lt;/p&gt;
&lt;p&gt;This requires the &lt;code class=&quot;language-text&quot;&gt;do-token&lt;/code&gt;.&lt;/p&gt;
&lt;h3 id=&quot;postgresql&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#postgresql&quot; aria-label=&quot;postgresql permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;PostgreSQL&lt;/h3&gt;
&lt;p&gt;PostgreSQL is used as main database powering this blog for instance. The &lt;a href=&quot;https://github.com/5pi/services/blob/master/20_postgres.yml&quot;&gt;configuration&lt;/a&gt; is straight forward but uses my custom DigitalOcean Storage flexvolume plugin. Before using it the first time, the volume needs to get created, attached, formatted and detached again. You can run the &lt;a href=&quot;https://github.com/5pi/infra/blob/master/packer/files/usr/libexec/kubernetes/kubelet-plugins/volume/exec/5pi.de~do-volume/do-volume&quot;&gt;flexvol plugin&lt;/a&gt; to do this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;do-volume create pgdata 10G my postgres volume
do-volume attach &apos;{ &quot;volume&quot;: &quot;pgdata&quot; }&apos;
mkfs.ext3 /dev/disk/by-id/scsi-0DO_Volume_pgdata&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After that, the yaml file can get applied and postgres should spin up.&lt;/p&gt;
&lt;h3 id=&quot;ghost&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ghost&quot; aria-label=&quot;ghost permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Ghost&lt;/h3&gt;
&lt;p&gt;Next is Ghost, the blogging platform powering this and &lt;a href=&quot;https://textkrieg.de&quot;&gt;textkrieg.de&lt;/a&gt;. It uses Postgres as database and another DO volume for assets.
Since the official Ghost image can’t be easily configured automatically and is huge, I’m using my own (&lt;a href=&quot;https://alpinelinux.org/&quot;&gt;alpine&lt;/a&gt; based) &lt;a href=&quot;https://hub.docker.com/r/fish/ghost/&quot;&gt;Docker image&lt;/a&gt;.
Although designed as a &lt;em&gt;modern&lt;/em&gt; blogging platform, it doesn’t fit particular well into the new container/12factor world. For example, it assumes that the current working directory is writable. Since we want to run ghost as unprivileged user, we need to make the volume writable by that user. Unfortunately there is no good way to do that. People often create images that run chown as root when starting, then dropping privileges. But this can become time consuming and has possible security implications. The upcoming &lt;a href=&quot;https://github.com/kubernetes/kubernetes/pull/26926&quot;&gt;flexvolume redesign&lt;/a&gt; will fix this issue. For now we need to make the volume world-writable initially:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;do-volume create ghost-fish 1
do-volume attach &apos;{ &quot;volume&quot;: &quot;ghost-fish&quot; }&apos;
mkfs.ext4 /dev/disk/by-id/scsi-0DO_Volume_ghost-fish

mount /dev/disk/by-id/scsi-0DO_Volume_ghost-fish /mnt
mkdir -m 777 /mnt/{apps,data,images} # See 5pi/infra#11
umount /mnt

do-volume detach /dev/disk/by-id/scsi-0DO_Volume_ghost-fish&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here I choose simplicity over security for the time being since I’m the only operator of this cluster anyway. You might want to make a different trade off.&lt;/p&gt;
&lt;p&gt;Now we still need to create databases and users, another thing that hasn’t been addressed by Kubernetes yet. For that we need to find the Postgres pod, then &lt;code class=&quot;language-text&quot;&gt;exec&lt;/code&gt; into it to create database and users:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;kubectl exec -ti postgres-2416409090-jf8uh -- psql -U postgres
create user ghost_fish with password &apos;pwd-from-secrets.yml&apos;;
create database ghost_fish;
grant all privileges on database ghost_fish to ghost_fish;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we can use the yaml file to deploy Ghost. Beside deploying the pods, we also create a &lt;a href=&quot;https://github.com/5pi/services/blob/df95f43b1db833a49b6693000787b44d9a92624d/50_ghost_fish.yml#L13&quot;&gt;Ingress to configure Traefik&lt;/a&gt;. This routes requests for &lt;code class=&quot;language-text&quot;&gt;5pi.de&lt;/code&gt; to service &lt;code class=&quot;language-text&quot;&gt;ghost-fish&lt;/code&gt; on port 80 which is defined above and maps to the Ghost deployment&lt;/p&gt;
&lt;p&gt;To access the blog, you still need to create an CNAME DNS record matching the Ingress route and pointing to the managed &lt;code class=&quot;language-text&quot;&gt;edge.[DOMAIN]&lt;/code&gt; DNS name.&lt;/p&gt;
&lt;h2 id=&quot;monitoring&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#monitoring&quot; aria-label=&quot;monitoring permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Monitoring&lt;/h2&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/a6e84b03bb42b9933c5e83d8b5943a97/0f882/grafana-kube.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 61.34969325153374%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAACAElEQVQozxVSyXLkIAz1ZwTMYjBCLAa8tJdOdyo5Zw6Zmut8wfz/D4y6SgfxVKC30C1B7Lf1uj/qehzn2WrNwaWUplJyyjFEAEDEEELOeZ6XuU5rSzl5Qjo1cMbE3uDXE9HZnnMqwblWKhSM2Q9SiRfItJDeu1B9RK+kYox1PRMF1b9v+3O5GbWWSklBFywOEByxCIYQqQnU0v8ZccLiraNz33eM9xXkVQamHA5aCQJ71YshSh8AzOjoqhCCC6nF+DAJozfGSMk57xwNhZK9MFIg+IBoXnteRfzBjWYYJBF2aikpIwp6VwlDW3rewThqpcOoMugJ1OT0PQ9ElDTTPMV4q2pO7Hl7+zzetsKPxvbKroU5wzo3uiW63+/jz/v49wt+Hu77bj8Wcy8WjPCA55o/1nDV8FjifS17wyXjVhNR60jmFsKe/JHDmcO9xC2GPeKRib/QWm+tbCVtU9xK3udK/VHTOU9kWQeUhRS8ZwAuUqwpjBRYz8k4UjWQ/eRVz2LwVDkiucA5oxE50qEDHMgOPypvpbPSW4VGJytBCRW8x8E5whVYaa1yVvuBLNJO97JDgA3De0pXCs8Jv1q8crpKeBYErciRBnEJeUuZ5KwptTit63zNGZTsKAnSczU4q783fC54VbwaPhb6HZShWLK9VXO0V53N3IrZ20iNFvw/cDBsLYIvOlcAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Grafana&quot;
        title=&quot;Grafana&quot;
        src=&quot;/static/a6e84b03bb42b9933c5e83d8b5943a97/a6d36/grafana-kube.png&quot;
        srcset=&quot;/static/a6e84b03bb42b9933c5e83d8b5943a97/222b7/grafana-kube.png 163w,
/static/a6e84b03bb42b9933c5e83d8b5943a97/ff46a/grafana-kube.png 325w,
/static/a6e84b03bb42b9933c5e83d8b5943a97/a6d36/grafana-kube.png 650w,
/static/a6e84b03bb42b9933c5e83d8b5943a97/e548f/grafana-kube.png 975w,
/static/a6e84b03bb42b9933c5e83d8b5943a97/3c492/grafana-kube.png 1300w,
/static/a6e84b03bb42b9933c5e83d8b5943a97/0f882/grafana-kube.png 1584w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Now that all this is running, it also needs to be monitored properly. Of course I’m using &lt;a href=&quot;https://prometheus.io&quot;&gt;Prometheus&lt;/a&gt; for this. The setup is straight forward now that Ingress and Volume configuration is nothing new. It tunes Prometheus to run better on small instances and create a DO Volume to store metrics on. To gather metrics about the services running on Kubernetes, the &lt;a href=&quot;https://github.com/kubernetes/kube-state-metrics&quot;&gt;kube-state-metrics&lt;/a&gt; exporter is deployed. To monitor website response times, I also deploy the &lt;a href=&quot;https://github.com/prometheus/blackbox_exporter&quot;&gt;blackbox-exporter&lt;/a&gt;.
To send out alerts, two instances of the HA Alertmanager are deployed.
&lt;a href=&quot;https://github.com/5pi/services/blob/df95f43b1db833a49b6693000787b44d9a92624d/prometheus/prometheus-config.yml&quot;&gt;This ConfigMap&lt;/a&gt; configures Prometheus, sets up alerts and configures the Alertmanager. The SMTP credentials get passed in at container startup.
The alerts are quite trigger happy, which is fine in such small cluster. In a bigger cluster you need to adjust those to limit noise. In the end you’re not interested even if whole nodes crash as long as Kubernetes can reschedule the pods. In my tiny cluster I would be surprised if a node crashes, so I alert on this for now.&lt;/p&gt;
&lt;p&gt;I’m also using Grafana to show metrics on dashboards. Grafana is configured to use Google OAuth authentication against my Google Apps account. This allows Grafana to be available on the public internet and allow everyone in my Google Apps Org to access it.&lt;/p&gt;
&lt;p&gt;Here is where the wildcard DNS domain comes in handy. Instead of having to add new DNS record for each new service like Grafana, we just access it via the wildcard domain: A request to &lt;code class=&quot;language-text&quot;&gt;anything.edge.[DOMAIN]&lt;/code&gt; ends up at the floating IP and is accepted by a traefik instance. So the only thing we need to configure is the host in the &lt;a href=&quot;https://github.com/5pi/services/blob/df95f43b1db833a49b6693000787b44d9a92624d/grafana.yml#L19&quot;&gt;Ingress definition&lt;/a&gt;.&lt;/p&gt;
&lt;h1 id=&quot;retrospective-and-future&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#retrospective-and-future&quot; aria-label=&quot;retrospective and future permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Retrospective and Future&lt;/h1&gt;
&lt;p&gt;I’ve started all this a few month ago already with the goal of building a small cluster from scratch. I didn’t want to use tons of bash scripts not running on a specific cloud. Back then there was &lt;a href=&quot;https://github.com/kubernetes/kops&quot;&gt;kops&lt;/a&gt;, which I would recommend to look at first if you’re deploying to AWS.&lt;/p&gt;
&lt;p&gt;Now there is also kubeadm which looks like a promising way to setup a cluster and I might change my deployment to use it instead. I’ll also consider using CoreOS and cloud-config to configure the Kubernetes components, as well as looking deeper into systemd units to coordinate stopping of services and draining of hosts.&lt;/p&gt;
&lt;p&gt;If you’re looking for reusable components on top of Kubernetes, there is &lt;a href=&quot;https://github.com/kubernetes/helm&quot;&gt;Helm&lt;/a&gt; which might be a better option than just keeping the services yaml files around. You might be also interested in CoreOS’s &lt;a href=&quot;https://coreos.com/blog/introducing-operators.html&quot;&gt;Operator&lt;/a&gt; to fully automate Prometheus operations.&lt;/p&gt;
&lt;p&gt;The most important next thing on my TODO list is proper tests though. I want a full integration test which spins up a new cluster, deploys services to it, runs blackbox tests, runs an rolling upgrade and tests that during and after that the cluster services are available.&lt;/p&gt;
&lt;p&gt;Pull requests to make this more generic and fix issues are welcome, but I won’t accept larger changes until I got the tests going.&lt;/p&gt;
&lt;hr&gt;
&lt;h4 id=&quot;update&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#update&quot; aria-label=&quot;update permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Update&lt;/h4&gt;
&lt;p&gt;Feel free to discuss and comment on &lt;a href=&quot;https://news.ycombinator.com/item?id=13006296&quot;&gt;Hacker News&lt;/a&gt;.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[The Future: Fabrication Cloud]]></title><description><![CDATA[The Cloud 
Given the ubiquity of “The Cloud” even in mainstream media, you might expect the readers of this blog know what it means. From my…]]></description><link>https://5pi.de/2015/10/05/the-future-fabrication-cloud/</link><guid isPermaLink="false">https://5pi.de/2015/10/05/the-future-fabrication-cloud/</guid><pubDate>Mon, 05 Oct 2015 11:50:49 GMT</pubDate><content:encoded>&lt;h1 id=&quot;the-cloud&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#the-cloud&quot; aria-label=&quot;the cloud permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;The Cloud&lt;/h1&gt;
&lt;p&gt;&lt;a data-flickr-embed=&quot;true&quot;  href=&quot;https://www.flickr.com/photos/horiavarlan/4777129318&quot; title=&quot;Single white cloud on a clear blue sky&quot;&gt;&lt;img src=&quot;https://farm5.staticflickr.com/4079/4777129318_934309e7af_b.jpg&quot; width=&quot;1024&quot; height=&quot;616&quot; alt=&quot;Single white cloud on a clear blue sky&quot;&gt;&lt;/a&gt;&lt;script async src=&quot;//embedr.flickr.com/assets/client-code.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
Given the ubiquity of “The Cloud” even in mainstream media, you might expect the readers of this blog know what it means. From my experience, that isn’t true. Too many consider it a meaningless buzzword, synonym for the Internet or the act of outsourcing handling of precious personal data. It has to do with outsourcing, the Internet and definitely is used as a buzzword but yet, the Cloud is a incredible concept. Indeed, it’s more a concept than anything technical. It’s the idea of abstracting all the nasty details and turning computing resources into a utility without any ramp-up costs.&lt;/p&gt;
&lt;p&gt;Before the Cloud, if you needed compute resources, you needed to build your own datacenter, figure out cooling, order racks and servers, build them together, figure out power supply, buy network gears, contract with a carrier. To make sure you can still operate, do that twice so if one datacenter explodes, you still enough resources available. To make sure you can serve customers world-wide with low latency, do this all over the world.
Cost for all that can runs in the millions and requires large teams to operate it.&lt;/p&gt;
&lt;p&gt;Granted, even before the Cloud, there were alternatives. Colocation centers, where you get all the basic DC setup and just need to take care of servers. Or even just rent out servers. Still, you take care of ordering them, setting them up, configuring network equipment (or have the provider do that) and provisioning of those resources usually takes days. With the Cloud, if you need to run software somewhere, store data somewhere, you can do simply that in the cloud. Depending on the level of abstraction you need, you can run a container in the Cloud, use virtual machines you can customize as you want or have a provider like Heroku run your code directly. Since you share resources with other customers in a Cloud, there is no need for dedicated provisioning which leads to a very scalable cost model: If you don’t require much resources, you almost pay nothing. You can get virtual machines for $5/month. A highly available stack in various regions to reach your customers with low latency is possible for ~$150/month.&lt;/p&gt;
&lt;p&gt;The Cloud is an abstraction, hiding away the physical world so you can focus on your virtual product. It makes writing a web service (almost) as easy as writing an app.&lt;/p&gt;
&lt;h1 id=&quot;fabrication-cloud&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#fabrication-cloud&quot; aria-label=&quot;fabrication cloud permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Fabrication Cloud&lt;/h1&gt;
&lt;p&gt;&lt;a data-flickr-embed=&quot;true&quot;  href=&quot;https://www.flickr.com/photos/kakissel/6165114664/&quot; title=&quot;3D Printer at the Fab Lab&quot;&gt;&lt;img src=&quot;https://farm7.staticflickr.com/6165/6165114664_5fab6e38ff_b.jpg&quot; width=&quot;1024&quot; height=&quot;678&quot; alt=&quot;3D Printer at the Fab Lab&quot;&gt;&lt;/a&gt;&lt;script async src=&quot;//embedr.flickr.com/assets/client-code.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
I believe that in the future we’ll see the same abstraction for other, physical resources and it will be huge.&lt;/p&gt;
&lt;p&gt;One thing that comes to mind are factories. Imaging we would share factories and everyone can build whatever they have in mind via well defined interfaces without any ramp-up costs. It will not only kill some established companies, it will end “industry” as we know it. There won’t be warehouses of goods and mass products. Not because all consumers start building their own products but because above the abstraction everything is just software, every company will be a software company and software can adapt to customer needs.&lt;/p&gt;
&lt;p&gt;There are already a few companies providing some form of API around production of physical goods. Custom printed merch like T-Shirts and ball pens, cereal mix and custom chocolate bars. But you can’t fabricate your own inventions beyond a custom design.&lt;/p&gt;
&lt;p&gt;We need to come up with something more generic to build physical things from digital data. The first thing which comes to mind is 3D printing. I would argue it’s doing for Fabrication Clouds what virtualization was doing for the compute Cloud: It’s not necessary the only way to do it, but it makes things easier.&lt;/p&gt;
&lt;h1 id=&quot;how-to-get-there&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#how-to-get-there&quot; aria-label=&quot;how to get there permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;How to get there&lt;/h1&gt;
&lt;p&gt;And there are already a few 3D printing services like &lt;a href=&quot;http://www.shapeways.com&quot;&gt;http://www.shapeways.com&lt;/a&gt; and &lt;a href=&quot;https://i.materialise.com&quot;&gt;https://i.materialise.com&lt;/a&gt; and what they are doing is amazing. Yet, 3D printers are far from being universal machines. They have some tight restrictions. You can’t (yet) 3D print your cereal mix with them.&lt;/p&gt;
&lt;p&gt;So what will happen next? There won’t be a universal factory able to build everything anytime soon, but if you don’t need to dedicate a factory to a specific product, you can share those resources.
Most electronic companies already build products based on the specification of their customers. The problem are still huge ramp-up costs, lack of continuous automation and well defined APIs. 3D printing can reduce those costs for small product batch series where advancements in robotics will make assembly flexible enough so mass production isn’t necessarily more efficient.&lt;/p&gt;
&lt;p&gt;Yet, given the complexity of the physical world, compared to the simplicity of computers, I don’t think somebody will flip a switch and we’ll suddenly be there. It will grow over time. On the small scale end, 3D printing services will get more and more sophisticated and eventually integrate with flexible manufacturers for parts where 3D printing doesn’t make sense. On the large scale end, factories will get more flexible to react to changing demands, more automation will further increase the flexibility and a growing number of startups will increase the demand in small batch series.&lt;/p&gt;
&lt;p&gt;I’m really not an expert on factories and industrial fabrication, so there are probably tons of problems I missed, but I don’t think the general idea violates any laws of physics and the impact and, it’s capitalism after all, business opportunity for the pioneers in this field is huge.&lt;/p&gt;
&lt;p&gt;Eventually everything will grow together and building a Smartphone, even a Car, will be (almost) as easy as writing an app.&lt;/p&gt;
&lt;p&gt;PS: Oh, and we’ll not only lose tons of jobs, we’ll lose tons of professions and if we don’t fix the system, &lt;a href=&quot;http://www.politico.com/magazine/story/2014/06/the-pitchforks-are-coming-for-us-plutocrats-108014&quot;&gt;the pitchforks will come&lt;/a&gt;.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[The Future]]></title><description><![CDATA[Since I was a kid, I was fascinated with sci-fi and today I’m thrilled to live
in the unique age of unprecedenced velocity of invention. A…]]></description><link>https://5pi.de/2015/10/02/the-future/</link><guid isPermaLink="false">https://5pi.de/2015/10/02/the-future/</guid><pubDate>Fri, 02 Oct 2015 10:57:53 GMT</pubDate><content:encoded>&lt;p&gt;Since I was a kid, I was fascinated with sci-fi and today I’m thrilled to live
in the unique age of unprecedenced velocity of invention.&lt;/p&gt;
&lt;p&gt;A few years ago, Elon Musk’s idea of building an electric car that can compete
with regular cars was a moonshot. It was close to impossible, yet he succeeded.&lt;/p&gt;
&lt;p&gt;From todays perspective, this seems like a nobrainer. I found myself recently
thinking: “Boohh, cars for individual transportation is to 1900”. Soon, you
won’t buy cars anymore. (Sure, that’s something Tesla knows as well and they are
still in a good position).&lt;/p&gt;
&lt;p&gt;Beside being incrediably fascinating, this velocity has another advantage: You
can think crazy sci-fi and see just a few years later how close you got. So I
thought I start blogging about a few crazy ideas. Maybe someone even finds
themself inspired by those.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Uploaded thousands of Photos to Google Photos, here are the best classification mistakes]]></title><description><![CDATA[I’m a lazy person who never took time to organize their photos so I got really excited about Google Photos and just finished uploading all…]]></description><link>https://5pi.de/2015/09/02/uploaded-thousands-of-photos-to-google-photos-here-are-the-best-classification-mistakes/</link><guid isPermaLink="false">https://5pi.de/2015/09/02/uploaded-thousands-of-photos-to-google-photos-here-are-the-best-classification-mistakes/</guid><pubDate>Wed, 02 Sep 2015 13:38:13 GMT</pubDate><content:encoded>&lt;p&gt;I’m a lazy person who never took time to organize their photos so I got really excited about Google Photos and just finished uploading all my Photos to it. I used flickr in the past but just dumping photos there, even if I can search for EXIF tag data doesn’t make much difference to storing them on a hard disk in a drawer.&lt;/p&gt;
&lt;p&gt;Google Photo on the other hand &lt;em&gt;understands&lt;/em&gt; what’s going on in a picture.
Google uses a &lt;a href=&quot;https://medium.com/backchannel/how-google-s-new-photos-app-can-tell-cats-from-dogs-ffd651dfcd80&quot;&gt;neural network&lt;/a&gt; which is trained by millions of photos on the web to identify objects in pictures.&lt;/p&gt;
&lt;p&gt;This works very well and when thinking about it’s mistakes, the uncanny feeling just amplifies: They are mistakes, they aren’t bugs. It’s not faulty, it’s just a little unexperienced - almost like a child.
In fact, I would be very interested in a catogorization standoff between a child and Google.&lt;/p&gt;
&lt;h1 id=&quot;concerts&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#concerts&quot; aria-label=&quot;concerts permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Concerts&lt;/h1&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/36bddfe74c91b79319b26a9fd726c4a5/a4f81/Screen-Shot-2015-09-02-at-14-42-18.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 92.02453987730061%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAAFBElEQVQ4yx2UZ1DUBxDF/7YYOUDugCvcwXEFrsAh0sQ7EARFEQU8NUFUBMEWsRBU7IiAiG0OMTr2MpYYo4hEEKJx1MQ6xtgbVbB8chLHTNqMv/zHTzu7s7Oz773dJzx8+IimxkZu3/iFn1uaafn+JJdOn+J6Uws3zzTSfOU+D/77yE9XLtNwtp5LF1q4KPa3NDTQUn+WCw2NNJ04TfO9LtoBYc2yxVgtJnHgVfbMzqTuiygOp0Uy00/NqRAHuZGFRH37DKnOyCRnBt8d3MnUIBnrw5Xk631I8RpIldKANmY2zronCJvKyxidlsHf//zL9ryZnMidyuGsVEpDwmiMz2JJ4EhGDMomQO5H5dYaHty6QbbVxobEWBYMMpDtr8Nli8fSS0VmyhSE0rJKfNXBpKaNwx4QRrTCSoKPkmkmK04PEybBC4fehFrlj1pvwRxsQuuhQv65lCCJG1FSBUbBg76CQPrIFHHD6o3IZT4YAvVYdUGEBxoIDdQR4a/HHmjFHGAl0mwhOtRGkFqDTuOPRasjVKvF7B+ATaMlQmfG31vJ5PTxCBWlpbj3EgiWy9F5y1B4eqJyd0fh4YlcKsV7gEzkJx97zDARgR+jTMEM0WgY5ONDhMybUIWKcL8A1D5ROEtOICxfuhSpuwfZE8fj0CqI9ZUQKZVg8PRicB8JCssUHDc/EmJPJDM5mVVzC8gbbGC6WUm6WslohZYMSSiaBfUsei+qvKK4iImTJvPhw3tyHTFUJkeyxG4lWa1is2kIkdrRaMetJcJk42xjC12P77MjO5MbK3KoGBnLqqAIfhhWgDGmlPHlDQglxUuIjE1m8+YaBmtCsOts2FVyYpVahnoakQsSzOIWloBg1m2oZePKCiaGpZETM5zcUAv5lkQmy4di6K1idkYOQtmaMnoL/Rjo5oFCIsN3wMBPHOplvihEJd36uqEXbzLcFI5Oqcfoo8HmbcA8UEW0UkWcnxGzpx5pXw+mpWcivH3zmnt379LZ0UlbWydPn7fx/HkrT54+pbu751Ottb2D7p5XdHT10Nn9hs6Xr+ns6qa1rYO29pf0dL/l2YsuOjpfItSdqWd+YSHbNlVx93I97x418vh6E+2/3sFVvoaGk8f57dI5zrgqOF1dwjnXCs7XlHBxbzXX6vZz9UAFh7eUcuvcAd6330I46FqP0+TFULU7+SMGs22qjV2rZ9C0YxemzwQWpg9h39J8srUSCg1ibhX4SowlDgW75ySxc4wnKWoB16wk2s5/g/Dj6SOUTk2gdnYC23PsHMwJ59CaLO4c28Ddk5VsyUtg+VgHixxBzIqSMTLUnwKbjA1pVg4vnsC+bCu5USo2zkzl1dUjCA8uHGXf6jhq1qVSt7uICwcq2b98Cq3NVfDXJfYWT2BhvInV4oAQWR+yUmJxTbGzdrgRV3Y0DUUOtk6PozovkRfNuxCuHd1EnnMAEyZ5ETeqP8dd8zi7eT41BUnUlU1jZVIQ650xjI0M/vSvVfPGc7G2kFWZdlwZZhGRjR1OK1tSDTTWLhMhH6qmxGmidlkOX8//kkc3j3OsfC4r4/1YmRhMgUVOZVoYYUY9/fv0ZcboaPJGRZGfGM7GUQa2JMmpilNQHu7GnpnjEH7vuce7p+d433WTP7tu8/GPF5wQFV0ep6E4TrQno5yiaNEwArRI3dzw6vcZQ00aZoxxUBzjT4Vd9MZ4OdVDJByaM5b/AbYzAyDOL9gIAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Screen Shot 2015 09 02 at 14 42 18&quot;
        title=&quot;Screen Shot 2015 09 02 at 14 42 18&quot;
        src=&quot;/static/36bddfe74c91b79319b26a9fd726c4a5/a6d36/Screen-Shot-2015-09-02-at-14-42-18.png&quot;
        srcset=&quot;/static/36bddfe74c91b79319b26a9fd726c4a5/222b7/Screen-Shot-2015-09-02-at-14-42-18.png 163w,
/static/36bddfe74c91b79319b26a9fd726c4a5/ff46a/Screen-Shot-2015-09-02-at-14-42-18.png 325w,
/static/36bddfe74c91b79319b26a9fd726c4a5/a6d36/Screen-Shot-2015-09-02-at-14-42-18.png 650w,
/static/36bddfe74c91b79319b26a9fd726c4a5/e548f/Screen-Shot-2015-09-02-at-14-42-18.png 975w,
/static/36bddfe74c91b79319b26a9fd726c4a5/3c492/Screen-Shot-2015-09-02-at-14-42-18.png 1300w,
/static/36bddfe74c91b79319b26a9fd726c4a5/a4f81/Screen-Shot-2015-09-02-at-14-42-18.png 1508w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;
I’m really not sure about this one.&lt;/p&gt;
&lt;h1 id=&quot;dessert&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#dessert&quot; aria-label=&quot;dessert permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Dessert&lt;/h1&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/305de6716396787bfbf295278dda2def/36eca/Screen-Shot-2015-09-02-at-14-44-38.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 80.98159509202453%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAAD4UlEQVQ4y32Sa0yTZxiGvx/7NZMl+7GZYRzonCzZHMHghGVKkMPAA4k76GIYAXToPIARFcY6tSKbDESojEJBUKBAwcmA2spJqBLAKCBiQEBGOmGWMSBqgRba79onEsfI4pPced/ndL9PnvcWpqeneYYnT54wPj6O0WhkbGwMq9WC1WJhanKSyYmJfyH5E9I5MXc3P5X6pHrbzAyIIsIzsoU2IyUfPzUzPDqGecqCxWbHarNhnbExabVik3ypm2mpbmauR5RglbiEzs5OTsjltBhqMTReJ1NdzJ+PHmEZGeSPG3qGO1ow993DPNCD2fgAxkfo6+6mvv4GPV09DLU1causgLaKYiZGRhDy8/IQBIEdX33O4ahI3l32Ni0tTVge9tL8yzGaFNHcLzjN4GUlfUVK8k/J8fYKZHvQfvIPhRPj8Q6hLkv4YsVrtJdrEArUhfi7r0IV6s29c3uJ2uRGVU0Npv5eTkbsIv9EOLUZR/i9Kp2ysz/g7eOH47IPcF8XSITPWg6sceSojwtfuq5Ao0yVCIs1eDsvJdfLAaNsA3kHN1FruMHInUYUX/tSlnKIWmUsHeWptFUqCA/Zjq/fZjx9tuK43In3l76Bl5szgZtWEBOzH6FQo2GDizMyz/fQ7/VDHvQp+roGRu82krV7I4XR2yg8E01rpYrGcgU7w4JxWf0xrms24Lzqw9l1OSx3QFsSiaH6CkJOTu5s0Gf1StycFrP41VeouFrNaIcBZfA6MkM+IX2fP78qokiK3omf70Zef9MJj/VbUCWdwcN9LWEhIeSdy6CmWI2g0+lwdXVFmxBJ2sFgvt0WQHfXPf66Y0Av20H52VguHt+LKiaESlUiiZIiDhyV8/3xBEpTf+RCSgIp8u/IjJcx2HYTYWpqShL14wVKFBHt4gvPJs7L2O3/qbTZJCXOiwm2SStPB8f42zjM8ICJoX4TjyQ87Bui9Eo5FXodXZ0PqCjXk6DI5GbbndlGu/SgKIovRG0Xn/uCyWTC0NBIe3s3zbc6aG6op6buGqHxkSxau4j4lFPSZ8QRsXElby1ZSmJ2ztxktlmChRDqm66xOXgLRcU53K8qoTk3gebL2YQdDcB/nycXMmWo4z7jt8LzbNm8npNxsrkJ7S8mnG/CcH8fhlwVty+pUR3ZzZ4Ady7G7kGr/BlDQRp1RXk06LUMdN3lcNIu0tUpLycc6GhFfSxKQiTxQX5EBKwmdutHJO70Izf2G64UZqMryaFOk0xRVjTVddrnexPF/ycc7O2mIi0JbUYy1Vlnuar8CV3GaapzUtFlJXJdd4mq0nx02cnUVZTQ1nr7pYT/ABOe1OoNVmZxAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Screen Shot 2015 09 02 at 14 44 38&quot;
        title=&quot;Screen Shot 2015 09 02 at 14 44 38&quot;
        src=&quot;/static/305de6716396787bfbf295278dda2def/a6d36/Screen-Shot-2015-09-02-at-14-44-38.png&quot;
        srcset=&quot;/static/305de6716396787bfbf295278dda2def/222b7/Screen-Shot-2015-09-02-at-14-44-38.png 163w,
/static/305de6716396787bfbf295278dda2def/ff46a/Screen-Shot-2015-09-02-at-14-44-38.png 325w,
/static/305de6716396787bfbf295278dda2def/a6d36/Screen-Shot-2015-09-02-at-14-44-38.png 650w,
/static/305de6716396787bfbf295278dda2def/e548f/Screen-Shot-2015-09-02-at-14-44-38.png 975w,
/static/305de6716396787bfbf295278dda2def/3c492/Screen-Shot-2015-09-02-at-14-44-38.png 1300w,
/static/305de6716396787bfbf295278dda2def/36eca/Screen-Shot-2015-09-02-at-14-44-38.png 1526w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;
Let’s finish this course with a nice bowl of raw chicken.&lt;/p&gt;
&lt;h1 id=&quot;dogs&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#dogs&quot; aria-label=&quot;dogs permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Dogs&lt;/h1&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 83.43558282208589%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAAEU0lEQVQ4y4WUC1BUZRTHr0EgNGFqmmWDj0F7oJYjCiLFQzTEF6KOgMCiYLqKk27GwxclOuSqoA05MCpppAji+ABdBBcQfJRaZi9IgXQBAUdGZBf2xe6vb3eGpqaZOjP/+80595z/nfOd/z2S2WxGr9fT1dVFW1sb3d3ddr+3t/d/0V9nNBrp6+vDarUiWSwWTCYTBoPBnmQ7jcI3Gk3YPtYnYLb7RjtsubZiG2zv+2MWy98I/8ts5BbrP2M2omeiE3Pfv2ul4sICylRlqCsqKFepUF0opUJdTeHZCtG+llZNEz/dquHs6XwunCumWfOAp087OXXyG6rKS7hff5fiogLUl0rRa7uQoiKW4zcjkHUfyknblk5aWjofJe0gRr6dp8+6KT1ZRELEEhSKTYSHhVNZVcmzlnqUSTKyMrZwNHcvJYfSKNoho/1BA5KXlx/jx09ghrcf586r2Z+dx/pPdpG8VSnaNZOTpcT//WDCI+W8PmoC51VqtI3fcyhZRn7uAXIy9/DjmSxKtoTRdO8+0jiPcbi5ueHk5Exw8By2fqokfEkMy6Ni0el6+PKLLCKi1xC3biv+odFcVNdi6ugkOyWFU8dzuf3tda7mJHFYPovGhkaksJDZuDg7MECSGOLqwGtDBjFmuBshAX7oxdRXr1nH7PC1pO47zZxIBSr1NR7V/44ydQO31Je4pr5M1bHP2RTmy717ouW9O9NJXLGM6AUBrFgUSNzCIOIXhyBbGoZO283+A9nErU4ldWcuseKsuX6b9qZGvs7ezcX8ExxU7qH8fCGJK1eKgbUgdXZ2gtVih1Wgz2zCJNAvCZt429vbhEZ7MBgNIgehOStarZbHT57Y/X6z69DH24fpPr4E+QfyQdAsEqOXc0yRQHrsAs7m59mFnrppLbt2b6dMyORqrZrHHR1oGu7y2YalRMo2INuYQ1LGCTSt7UjCbA9GDhvB0rmhTJ/sxbaYKNbPn0lephKtTsdMb09WLgtlVfRiIucHcLu2mkcPf2b/lnkEeYuhuroxauRo6n6rQ3J2dmHAc47Ex8RSdDSPqZOmsC8jk5REBds/TsZi1qOICSA+zp+5M70YPdSVkpIL3PmummmjnZk0digeI15k+vhXuV/3K9JAB2decBzIFM93SN+8mbkBwSjEZOMWLWRHcpK4WjNrZPPx8XQnbsk8Znm/y6G8fO7cuIK7q8SoIQPxfMWFwDeH01AvCAOmTSUhKoKMbSkUHDnImeN5fJWdyeHMXVSWnkGnNxC/Vo58gS8bE2J5y8ODyyJ+40olIx0l3hj8PBOGOvDe2EE01P2ClCRfxREhXlVxIVfLL3KzuoKbVy5TVlzAzZoqusUdek9+m9ApYwjx8cT9JUd+qCmjtlKNu5PExGEuTHzZCd8xg0XLgrCpsYHW5ha04r/tEcW9PTb0oLPtRSEVi1hTLRoNLc0aOtpaaW9tti8Ng0FP84M/xPJ4+BdMYpX9Ce8K1H6IE42aAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Screen Shot 2015 09 02 at 14 40 14&quot;
        title=&quot;Screen Shot 2015 09 02 at 14 40 14&quot;
        src=&quot;/static/b6300e467befbb18c0a227ecbbd91c04/a6d36/Screen-Shot-2015-09-02-at-14-40-14.png&quot;
        srcset=&quot;/static/b6300e467befbb18c0a227ecbbd91c04/222b7/Screen-Shot-2015-09-02-at-14-40-14.png 163w,
/static/b6300e467befbb18c0a227ecbbd91c04/ff46a/Screen-Shot-2015-09-02-at-14-40-14.png 325w,
/static/b6300e467befbb18c0a227ecbbd91c04/a6d36/Screen-Shot-2015-09-02-at-14-40-14.png 650w,
/static/b6300e467befbb18c0a227ecbbd91c04/e548f/Screen-Shot-2015-09-02-at-14-40-14.png 975w,
/static/b6300e467befbb18c0a227ecbbd91c04/3c492/Screen-Shot-2015-09-02-at-14-40-14.png 1300w,
/static/b6300e467befbb18c0a227ecbbd91c04/a8c87/Screen-Shot-2015-09-02-at-14-40-14.png 1538w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
    &lt;/span&gt;
To be fair, you could consider &lt;a href=&quot;https://en.wikipedia.org/wiki/British_Shorthair&quot;&gt;british shorthair&lt;/a&gt; the dogs of cats.&lt;/p&gt;
&lt;h1 id=&quot;birds&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#birds&quot; aria-label=&quot;birds permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Birds&lt;/h1&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/76ffd3846a9708abec735e4b77acd861/f098e/Screen-Shot-2015-09-02-at-14-39-47.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 80.98159509202453%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAAEFElEQVQ4y62T61PUZRTHf39AzfTaaizf2KhJTc44k6XpZGkwORTmhaDwjgQoICK7gLAgBMIilzW5eAHcC8iGwC4ScltWd5ebArvc2UXugYMYAnKRTz9onF72pjPzffM93+ec8zzf8wjz8/MsLS0xPT3N5OQkIyMjzM3NMTs7+594rZuammJxcXEVAiuxvMxK4ZcvX64KFhYWxKSIhX+411jRrPIiFub/za0UXlpaFMssI8zMzjE9M8f/Ea+WQXj1YhxVWhyB56WcD7lAeEQYprr7LEy0M2DRExMpQyK9iEQiIePaVSae2FgcbkaXlynyUYSFRYiQUlOh59UzB8JzexOxP+3Caf1atqx/m81r3+R6ahh2yx2MmaHsdlrHJxveZ9M7b3FgzxZsprt06lORn3Dmg/fWsHndGja9+wbJMn+edj9E6DJVUBYfxG/+B4k99g2R+zZx038PoUHelGUkcEdykkRvVy65f8Flt40opCeRSQKpkoeSEeBJ3IlviXT9mKvHd5CTmYJQoryJMj6YBLGj9+6NBO/fSn6SNzFBP5ASHkhB3Bn8936E79cfkhLkhirxFP7H3CiURxJ/1IWjOzYQ7LqVHJkXhYoQhKtJsfgc2stF3wP4HNiG3487SZccJvGMM14unyE7+zMB7js5tf9zLvm5khXhgZ/bVs4dP4zM9yABHl9yxnMPVy54oEkOQBjod1BbrqO3xcxEXxuOtkZGux4xOtBH+6Nmuh83iXwrAx1NOFpNoindDNp7aKk3M9RrY9xhxW5tYkQ88+zPYdGU6ec8nZpkeGIYa18jHY5WBsdG+evFDI6hXpptRhGN9Pb380xc/tGJMdq72ugf7KPVamN4bBz7k37MDWZsHVYEu6OXhiYTlsYqrmSGEHvpNGpVNhaLhaKSXM5JPZCe9+J6toI6QzX19QYS04OQp4WQlJCAtqCAIq2GX85+x+WkUISeni4sZgOjQ32kZ6Xi6XWEfLUKy8M6HD3tSGMCOXTYE43yNjWV5XTZHqPMv0FkdDiJcb+i1agxVlUiiwknMioCob3dSm11OYMOG8rbmTht38vl5GRRVE5fRwtp6XFs2eVC8pUUcXl1PKitwNnVk21fuRAhCaUg7xa/q5V8un0f37sfESfs7qTqvp7WxyZsoiFBUaeJT4miqkxPg8mAsaaCowHuJMhlVN3Trf6inFs38As5QXSUhLzsLEq0+cRGRxMQ6oPQ3dNJSWkhDfVGWkRHi/8oRJEtpzBfTbV4RaOhlsxcBdk5CvTFWurECR+Jb64rv0taqpyMtBSKCjSU3tWiVOciWLu7KC7VUm0ow2iupM5cjbJQg0qVK5qiobyimBJ9EfctDejulVJRWUxltY7aBzWUGSxkZV1Dpb4h6m+i0xfzN04NzQlgquujAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Screen Shot 2015 09 02 at 14 39 47&quot;
        title=&quot;Screen Shot 2015 09 02 at 14 39 47&quot;
        src=&quot;/static/76ffd3846a9708abec735e4b77acd861/a6d36/Screen-Shot-2015-09-02-at-14-39-47.png&quot;
        srcset=&quot;/static/76ffd3846a9708abec735e4b77acd861/222b7/Screen-Shot-2015-09-02-at-14-39-47.png 163w,
/static/76ffd3846a9708abec735e4b77acd861/ff46a/Screen-Shot-2015-09-02-at-14-39-47.png 325w,
/static/76ffd3846a9708abec735e4b77acd861/a6d36/Screen-Shot-2015-09-02-at-14-39-47.png 650w,
/static/76ffd3846a9708abec735e4b77acd861/e548f/Screen-Shot-2015-09-02-at-14-39-47.png 975w,
/static/76ffd3846a9708abec735e4b77acd861/3c492/Screen-Shot-2015-09-02-at-14-39-47.png 1300w,
/static/76ffd3846a9708abec735e4b77acd861/f098e/Screen-Shot-2015-09-02-at-14-39-47.png 1506w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;
Birds. That’s definitely correct.&lt;/p&gt;
&lt;h1 id=&quot;skylines&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#skylines&quot; aria-label=&quot;skylines permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Skylines&lt;/h1&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f9f2873c3d2aea66273e2893b6cf2f89/a8c87/Screen-Shot-2015-09-02-at-14-49-11.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 92.63803680981594%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAABYlAAAWJQFJUiTwAAAEjklEQVQ4y42UCUxUVxSGX5rURKuAgFLjyKoEq1itjdomSqPGuosCooCKqAQtRrSOghuylSU1YFVsjRrFplHjhiAKFcoi+yJLQVQEEcRBBpFhgAFm5usF1NCkbXqSL2d5eSf3vPPuLyFMr9fT29uLUqlEpVLxvvYBna6/8C7XoRO5Tqsd8F1dXQw16UZ8AgmJSdxOvEP87QTuJCWRnJJCiuD+/fukpaaSnpHF72kZpKVn8oeIc3LzKSgsoqi4mGJBWVkZVVVVqNVqJHdPb3btDUAecIQDh4MIPBpCUHAIYWFhREREEBMTTfRPsRwKjiQk4hjhP8YQc+I0sT+f4ey5c8TFxXHh4kUuX7lMe3s70tJVzjiv24CH51a2+fjis8MXv917kMv34e8fQOCRQI4EhbFl+y58/eT47fVnX8AhAoOCCQkNJTIyisioKE6ePEXbmzaku2LElORksjIzyH6QRV7OA/JzsyktKaK8tISqijIeP6qiID9PkEtRYT4PiwvEs2JBEX+Wl1BZ/pDqygp6NBqk+lYNCpWW5g542aalXtlDraKL6hdvqaxrpeJZK48a1NQqoaZFL4CngifNeh4rBK90gzRp0PT0IWUrekl+3MGV3EYupddx/FYFP/xWTFBcMXuOp+G+/wK7fykkKqWTsMS3BN5s4fCNFg5eayHg6msOXGnm8FUF4TebaGnvQeoRq36h0fPkLZQ395BZ08G1nDq85eEsc/Fi3ipXQi9lcTa9gRP3nnG+oJczeRpO52iIze4mNquLU5mdnM5Q0aoWJ6yrraXp1UsKS0vZe/AouwKO4umzE2OTMYz5VMakWXOR79uC956dBJw8T2EbpDZAynM9Sc/03K2FhBq4/qgXlUaHNOPzqSxZtJApk+0wNhqNkaEhBiNHMt3aHFtLS2T2M9no5sD6LZvYGRhObsVT4u8lczU+kWpFO3lVtdxITiW/ugZVhwrJUmbG5IlWTLebyBef2TLN1oapNpZ8M9mKL22tMRcNFy5ewqwFy7Cfu5jZc+aydPG3LHKYh7+PG/u3OXJM7sKtX6Npfd2ENEqcyGKCjHHGhliZmWBuOhoLEyPsTEdhKWKjCTZ8YjyOYSbWGFrY8/GI0QwbboCZmYwRw0diZWXDbDtTnOdPpaG+DmnBAgc2b/Vis6cHXh7ObHJ3wXO9E9vd17Bt41o2eG3CydmRVWsccXRxY6WjMytWu7Lc0ZVlK51Yu3EHruvckO/+DoXiFVJjo5pWpY5uDfTf8/d0Dom7u0Wu5n+ZZGqiw9xcx/jxWoFeoEMm6xvwgzXhZTrGjtUKwRCqg04o06DiaLXvlEc3qDz9aiRJkli11B+I7pK4OgM5Q2p8qN2KHxA2+vr0f5e3IUgTDcBgxOCLm+2bmSN7juGomoEmduMzkT7qfNe0i3tJvQNj/WdDlzEN+M54TfD8Sm56q/FbUUf0kgy+sqjFe1YpoQ5tfD8vnYPz71KS0TfQUEz4799wrFTGcptGPKa8wcpaI/5HDasnqXCwVvL1tAac7Fpwt69n5ow8ricJhaBHCGmXWFT3P/IX18FQyzy7jLsAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Screen Shot 2015 09 02 at 14 49 11&quot;
        title=&quot;Screen Shot 2015 09 02 at 14 49 11&quot;
        src=&quot;/static/f9f2873c3d2aea66273e2893b6cf2f89/a6d36/Screen-Shot-2015-09-02-at-14-49-11.png&quot;
        srcset=&quot;/static/f9f2873c3d2aea66273e2893b6cf2f89/222b7/Screen-Shot-2015-09-02-at-14-49-11.png 163w,
/static/f9f2873c3d2aea66273e2893b6cf2f89/ff46a/Screen-Shot-2015-09-02-at-14-49-11.png 325w,
/static/f9f2873c3d2aea66273e2893b6cf2f89/a6d36/Screen-Shot-2015-09-02-at-14-49-11.png 650w,
/static/f9f2873c3d2aea66273e2893b6cf2f89/e548f/Screen-Shot-2015-09-02-at-14-49-11.png 975w,
/static/f9f2873c3d2aea66273e2893b6cf2f89/3c492/Screen-Shot-2015-09-02-at-14-49-11.png 1300w,
/static/f9f2873c3d2aea66273e2893b6cf2f89/a8c87/Screen-Shot-2015-09-02-at-14-49-11.png 1538w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;
Bar graph or 8-bit skylines?&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Don't manage configuration unless you have to.]]></title><description><![CDATA[At my first job, there was no code driven infrastructure at all. A nightmare from today’s perspective. The next job, there were some perl…]]></description><link>https://5pi.de/2015/08/31/dont-manage-config-unless-you-have-to/</link><guid isPermaLink="false">https://5pi.de/2015/08/31/dont-manage-config-unless-you-have-to/</guid><pubDate>Mon, 31 Aug 2015 13:45:56 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a data-flickr-embed=&quot;true&quot; data-header=&quot;false&quot; data-footer=&quot;false&quot; data-context=&quot;false&quot;  href=&quot;https://www.flickr.com/photos/tuinkabouter/1884416825/in/photolist-3Sw8tg-4pYNoQ-5kuQnX-5gVeH1-sVYLE3-a3DqaD-9gzdMP-9Uspfa-2Xkkg8-8oZ8r-5aUCED-e4npy8-bn7jhK-ipQLm-4pZj1h-4xV1jk-5kuMV6-9sUBkF-b8nM3X-7tsJDh-9hY5PC-dUvDCG-4QZswm-4io4Y8-812A6f-qprAf-5ojVcV-5wUanj-9kNyLj-5GXFGx-5YFqsj-6VJnS6-dUmEaq-99qjSa-4QZsvG-4QZsuW-4QZsu7-4QZsuo-eL5jpe-4EWyKW-CXs86-etDrFm-4M5joL-jpb3gs-5knnT4-GAgoa-6d2TiA-63t6NF-7TRs3F-51XCQG&quot; title=&quot;Jungle&quot;&gt;&lt;img src=&quot;https://farm3.staticflickr.com/2037/1884416825_521e525758_o.jpg&quot; width=&quot;1024&quot; height=&quot;576&quot; alt=&quot;Jungle&quot;&gt;&lt;/a&gt;&lt;script async src=&quot;//embedr.flickr.com/assets/client-code.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;&lt;/p&gt;
&lt;p&gt;At my first job, there was no code driven infrastructure at all. A nightmare from today’s perspective.&lt;/p&gt;
&lt;p&gt;The next job, there were some perl scripts to massage systems in a imperative way.&lt;/p&gt;
&lt;p&gt;Then, at SoundCloud, I used modern configuration management for the first time. SoundCloud heavily invested into Chef which was, at some point, used to drive almost every aspect of the infrastructure. A new service? Add a cookbook.&lt;/p&gt;
&lt;p&gt;Compared to a world without any proper infrastructure automation this obviously was a great step in the right direction but it was a growing pile of technical debt and constant source of bikeshedding around how to actually use it.&lt;/p&gt;
&lt;p&gt;Maybe you don’t have those problems. Maybe you have strict guidelines on how to use your configuration management or some chief architect to tame the chaos but I argue that lot of larger companies with agile and independent teams run into similar problems. If you disagree, please leave a comment.&lt;/p&gt;
&lt;h3 id=&quot;issues-with-chef&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#issues-with-chef&quot; aria-label=&quot;issues with chef permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Issues with Chef&lt;/h3&gt;
&lt;p&gt;There are several categories of problems with this setup. Some are organizational nature, like the way it was ab(used) to drive the complete infrastructure. There are also very specific issues with chef, like its internal complexity both from a operational perspective as well as from its complex interface. Things like 15 unintuitive precedence levels for node attributes to its multistep execution flow and leaky cookbook abstractions it’s often frustrating to use and accumulates a lot of technical debt due to it being hard to test and refactor without potentially breaking your infrastructure.&lt;/p&gt;
&lt;h3 id=&quot;alternatives---or-the-lack-thereof&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#alternatives---or-the-lack-thereof&quot; aria-label=&quot;alternatives   or the lack thereof permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Alternatives - or the lack thereof&lt;/h3&gt;
&lt;p&gt;That being said, there isn’t an obvious better alternative. In the meanwhile I used ansible and salt which have their very own problems. Even though they try to be less complex than chef, they heavily depend on template driven metaprogramming and struggle with proper code reuse and testability similar to chef.&lt;/p&gt;
&lt;p&gt;Over the years I came to the conclusion that configuration management in it’s current form as used in reality has some fundamental design issues.&lt;/p&gt;
&lt;h3 id=&quot;design-challenges&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#design-challenges&quot; aria-label=&quot;design challenges permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Design challenges&lt;/h3&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/29dd07b878f06e9e5cece16d0d7a2b39/a3d69/Airplane_vortex_edit.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 81.59509202453987%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAQL/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAgP/2gAMAwEAAhADEAAAAe1zVTpowP/EABkQAAMBAQEAAAAAAAAAAAAAAAECAwARFP/aAAgBAQABBQJrNjQ99GI0hMokBz//xAAZEQADAAMAAAAAAAAAAAAAAAAAAQMCESH/2gAIAQMBAT8BpSa5gbkj/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAECIkH/2gAIAQIBAT8BinpY/8QAGxAAAgMAAwAAAAAAAAAAAAAAABEBAiEQMUH/2gAIAQEABj8C7NkwbFasP3j/xAAbEAEAAgMBAQAAAAAAAAAAAAABABEhMUFh0f/aAAgBAQABPyFVJReQmGvSeJUfiN6uZMLZ+xSz3s//2gAMAwEAAgADAAAAEJjf/8QAGREBAAIDAAAAAAAAAAAAAAAAAQARIXGx/9oACAEDAQE/EHQN0RxF7P/EABcRAAMBAAAAAAAAAAAAAAAAAAABIRH/2gAIAQIBAT8QZrGtT//EAB0QAQEAAgIDAQAAAAAAAAAAAAERACExcUFRYZH/2gAIAQEAAT8QhFyJ0Z8qwd4sZF0Ld4yBwAqvfrLDEai9n44yFSCBmp4c/9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;vortex&quot;
        title=&quot;vortex&quot;
        src=&quot;/static/29dd07b878f06e9e5cece16d0d7a2b39/6aca1/Airplane_vortex_edit.jpg&quot;
        srcset=&quot;/static/29dd07b878f06e9e5cece16d0d7a2b39/d2f63/Airplane_vortex_edit.jpg 163w,
/static/29dd07b878f06e9e5cece16d0d7a2b39/c989d/Airplane_vortex_edit.jpg 325w,
/static/29dd07b878f06e9e5cece16d0d7a2b39/6aca1/Airplane_vortex_edit.jpg 650w,
/static/29dd07b878f06e9e5cece16d0d7a2b39/7c09c/Airplane_vortex_edit.jpg 975w,
/static/29dd07b878f06e9e5cece16d0d7a2b39/01ab0/Airplane_vortex_edit.jpg 1300w,
/static/29dd07b878f06e9e5cece16d0d7a2b39/a3d69/Airplane_vortex_edit.jpg 2976w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;
The idea of defining a (distributed) systems state and mutating it to eventually converge to the desired state is sound but the interface the distributed systems provide is simply too complex.&lt;/p&gt;
&lt;p&gt;All the mentioned configuration management systems use some agent or ssh access to execute commands on the systems, similar to the imperative design of user interfaces: You run commands in a specific order to modify the state of the systems.
But since there is no unified interface to configure applications, how to achieve a specific state is highly dependent on the application.
Configuration management systems try to solve this by abstracting a “thing” in a system and give it a clear interface with some idempotent functions to move it into a given state like &lt;code class=&quot;language-text&quot;&gt;installed&lt;/code&gt;. Whether it’s called chef cookbook, salt state or (the most misleading name) ansible role.
If the “thing” is your web application, this might work very well but in reality you often have to configure third party applications that have subtle dependencies on specifics of other “things”. Or you have low level system configuration which affects and depends on other things installed. At this point, the abstractions usually break and you often end up introducing site specific changes to what is suppose to be reusable, generic components.&lt;/p&gt;
&lt;p&gt;The lack of a generic system configuration interface that can be used to configure every aspect of a system, imposes a lot of complexity on the configuration management.&lt;/p&gt;
&lt;h3 id=&quot;split-configuration-based-on-life-cycle&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#split-configuration-based-on-life-cycle&quot; aria-label=&quot;split configuration based on life cycle permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Split configuration based on life cycle&lt;/h3&gt;
&lt;p&gt;&lt;a data-flickr-embed=&quot;true&quot; data-header=&quot;false&quot; data-footer=&quot;false&quot; data-context=&quot;false&quot;  href=&quot;https://www.flickr.com/photos/chloeophelia/6633874815/in/photolist-b7dkRZ-j6g2XM-9hrBqG-aTDRwD-99nLPX-tm1pU-bn3u8p-qHs14o-qCjhgq-4HCs5T-r9mjBJ-9MyabW-q4629m-oCKk2V-7zyviy-7HivZw-8Wzh3Y-k2UGmz-iuChmC-dKHA-qe133d-itoizS-83TM-oHsMP1-bstTCp-iY9u4G-jdRX2T-5SY4oB-7wmEBq-Cv7Z2-t2Hab-7ofMcb-99Eqbu-r5sCGR-93jB3F-qyomNx-riyS2i-dNMQsp-91DhgW-4ahpVw-qHSWG3-keBc61-5SJkro-qixdjy-dSyxEq-8nmzni-4aKkPV-f2gfQ-q96Qs1-iyGqwU&quot; title=&quot;frozen in time&quot;&gt;&lt;img src=&quot;https://farm8.staticflickr.com/7142/6633874815_5d4ecf8b71_b.jpg&quot; width=&quot;1024&quot; height=&quot;684&quot; alt=&quot;frozen in time&quot;&gt;&lt;/a&gt;&lt;script async src=&quot;//embedr.flickr.com/assets/client-code.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;&lt;/p&gt;
&lt;p&gt;As long as there is configuration, there is configuration management. You will always have some form of desired state you want your infrastructure to be in. The question is not if but how to manage configuration. Since with configuration that changes rarely less things can go wrong, I believe the best way is so identify different configuration life cycles, find the right solution to manage this kind of configuration while compromising dynamically for correctness.&lt;/p&gt;
&lt;h4 id=&quot;buildinstall-time-configuration&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#buildinstall-time-configuration&quot; aria-label=&quot;buildinstall time configuration permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Build/install time configuration&lt;/h4&gt;
&lt;p&gt;If the lifetime of a single host or container image is lower than the lifetime of a configuration option, it often makes sense to move this configuration to install/build time. Since no change can happen during the life cycle of the host or container it’s easier to reason about the infrastructure since change to this set of configuration can be ruled out as reason for a given observation.&lt;/p&gt;
&lt;p&gt;Moving configuration to install time might mean making your bare metal installer preseed some configuration or building a static OS image for your cloud provider. The point is to bake in this configuration and just rebuild when changes are necessary.&lt;/p&gt;
&lt;h5 id=&quot;examples&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#examples&quot; aria-label=&quot;examples permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Examples&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;Operating system release&lt;/li&gt;
&lt;li&gt;Partition schema&lt;/li&gt;
&lt;li&gt;Hostname&lt;/li&gt;
&lt;li&gt;Installed packages / core services&lt;/li&gt;
&lt;li&gt;OS level configuration (sysctl, ssl keys)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;All configuration that is same across all environments (dev/test/prod) should be considered to be hardcoded where environment specific configuration (credentials, URLs / service identifiers) should be passed in on runtime so you can build, test and deploy the same static artifact.&lt;/p&gt;
&lt;p&gt;What in reality gets hardcoded is a case by case decision and depends on a lot of factors. On a bare metal infrastructure where all services are deployed straight to the host, there will be a lot of configuration that is site-wide and environment agnostic but simply is changed that often that reinstallation of the whole host isn’t feasible.&lt;/p&gt;
&lt;p&gt;But in a containerized infrastructure you have host image and container image life cycles. There is little host configuration, so usually it all can be hardcoded. Even if reinstalling the host takes 20 minutes, if it only happens every few weeks and is fully automated, it’s probably fine.
Building the container images in a continuous deployment pipeline might just take a minute from a change until the changes are deployed, so here again it’s feasible to bake in all suitable configuration.&lt;/p&gt;
&lt;h4 id=&quot;start-time-configuration&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#start-time-configuration&quot; aria-label=&quot;start time configuration permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Start time configuration&lt;/h4&gt;
&lt;p&gt;&lt;a data-flickr-embed=&quot;true&quot; data-header=&quot;false&quot; data-footer=&quot;false&quot; data-context=&quot;false&quot;  href=&quot;https://www.flickr.com/photos/storm-crypt/326228715/in/photolist-uQ1r2-t62c-jjzxu-pzhfMZ-7pBiCr-gKqR8Z-cqHKJS-hZsSz-522oaS-b3uw2-bXcpyw-5zdLNo-6wvjpw-nv1KL3-3aNjwL-cpBpTC-dbcLKt-4o3Qkk-9pyoHg-6dvJoB-hzvCsP-4o7SHY-aCL42j-4tGWBK-4wxATP-bX13ov-8MgTTH-cZKwvf-iKDCAd-jRyyK1-nb69S1-kvg2qy-kvdS8F-kveev8-kvdGta-kvdFzg-kvdxKi-kve2eV-bpcAmi-rbVVC-4gi4N-4rA5gu-aazkxv-o2XySp-dxnLQi-2oa9re-eC2cX3-8JA67v-8KYUaA-8JA6aB&quot; title=&quot;Sorting Facility&quot;&gt;&lt;img src=&quot;https://farm1.staticflickr.com/135/326228715_dea4917fda_b.jpg&quot; width=&quot;1024&quot; height=&quot;768&quot; alt=&quot;Sorting Facility&quot;&gt;&lt;/a&gt;&lt;script async src=&quot;//embedr.flickr.com/assets/client-code.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;&lt;/p&gt;
&lt;p&gt;Especially environment specific configuration like credentials should be passed to the services by whatever deploys your application.
Even though a lot people still deploy their applications with configuration management instead of cluster schedulers, I’m convinced that will change in the next few years. Whether you’re using &lt;a href=&quot;https://mesosphere.github.io/marathon/&quot;&gt;Mesos/Marathon&lt;/a&gt;, &lt;a href=&quot;http://kubernetes.io/&quot;&gt;kubernetes&lt;/a&gt; or &lt;a href=&quot;http://eurosys2013.tudos.org/wp-content/uploads/2013/paper/Schwarzkopf.pdf&quot;&gt;Omega&lt;/a&gt; the high level concepts are similar: You define your application and the scheduler decides based on the available resources where to run it.
Whether services are deployed by config management systems or the cluster scheduler, since it’s starting services, it’s the right place to pass configuration to your service. Instead of writing configuration files, &lt;a href=&quot;http://12factor.net/config&quot;&gt;12factor style configuration&lt;/a&gt; is usually better suited.&lt;/p&gt;
&lt;h4 id=&quot;runtime-configuration&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#runtime-configuration&quot; aria-label=&quot;runtime configuration permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Runtime configuration&lt;/h4&gt;
&lt;p&gt;Instead of configuring your systems on a regular interval with some configuration management daemon, it’s often a better pattern to have the application or a wrapper around it determine the configuration on runtime.
Instead of making configuration management orchestrate various services or instances, it’s more robust and arguably less cognitively challenging to consider the service as it’s own independent entity.
This only works well if site-wide configuration is built in. Determining all this on runtime leads to similar complexity as we have with full blown configuration management today.&lt;/p&gt;
&lt;h3 id=&quot;conclusion&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#conclusion&quot; aria-label=&quot;conclusion permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Conclusion&lt;/h3&gt;
&lt;p&gt;&lt;a data-flickr-embed=&quot;true&quot; data-header=&quot;false&quot; data-footer=&quot;false&quot; data-context=&quot;false&quot;  href=&quot;https://www.flickr.com/photos/ph0t0s/96911576/in/photolist-9yGrf-rf1xpg-iV3Hti-9yGuq-9mJACS-dF5fsX-4CYijn-96MGD7-4CYinT-rcHmFs-e3mfmk-7paoHV-e3rYs3-ebixTV-e3miwv-e3mehH-ebz9br-ebz6nv-9yGn2-maubuc-4eMsoq-gascSh-j448Si-bUvoKX-7tWwN9-8oTPht-fw2NWm-34Ydj3-zMTMt-9NFVNX-4q1pdk-9eX7xW-e72dfP-eb7MBt-4xMiAY-bznrxn-ze6qt-5GtxU5-bhCNRp-fw2NjN-fvMuU4-ebEQHU-fvMxdc-e3rZzd-ebiz6V-fw2Qn7-9NEtYQ-9NGKrb-u79vMN-9NGokq&quot; title=&quot;partly random&quot;&gt;&lt;img src=&quot;https://farm1.staticflickr.com/36/96911576_1a57864a0b_b.jpg&quot; width=&quot;1024&quot; height=&quot;768&quot; alt=&quot;partly random&quot;&gt;&lt;/a&gt;&lt;script async src=&quot;//embedr.flickr.com/assets/client-code.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
Isolating change to specific points in the life cycle of systems and services reduces the complexity of runtime configuration and simplifies the mental model when reasoning about the infrastructure.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[CloudFormation driven Consul in AutoScalingGroup]]></title><description><![CDATA[CloudFormation templates are a great way to manage AWS resources. All resources for a stack are configured in a json and CloudFormation…]]></description><link>https://5pi.de/2015/04/27/cloudformation-driven-consul-in-autoscalinggroup/</link><guid isPermaLink="false">https://5pi.de/2015/04/27/cloudformation-driven-consul-in-autoscalinggroup/</guid><pubDate>Mon, 27 Apr 2015 13:22:30 GMT</pubDate><content:encoded>&lt;p style=&quot;font-size:10px&quot;&gt;
&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; &quot;&gt;
      &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom: 74.84662576687117%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAQFAgP/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABm5qJWpnUP//EABkQAAIDAQAAAAAAAAAAAAAAAAABAgMSBP/aAAgBAQABBQLDTcWZH2USUrqjcD//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEv/aAAgBAgEBPwGlP//EABwQAAIABwAAAAAAAAAAAAAAAAACARAREiExQf/aAAgBAQAGPwLU6RVjFx0//8QAGRABAQEAAwAAAAAAAAAAAAAAAQARUaGx/9oACAEBAAE/IXB0NwpnVSJL6E73/9oADAMBAAIAAwAAABB3L//EABcRAQADAAAAAAAAAAAAAAAAAAEAESH/2gAIAQMBAT8QKTclE//EABYRAAMAAAAAAAAAAAAAAAAAAAEQIf/aAAgBAgEBPxCCn//EABwQAQADAAIDAAAAAAAAAAAAAAEAESFRYXGBsf/aAAgBAQABPxC97CqcqPFcnEW9Ii6d0PGzJSchf2NSD9E//9k=&apos;); background-size: cover; display: block;&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;dreamy consul 2&quot; title=&quot;dreamy consul 2&quot; src=&quot;/static/09a85130490779b28e2855643e68eb19/b4294/dreamy_consul-2.jpg&quot; srcset=&quot;/static/09a85130490779b28e2855643e68eb19/d2f63/dreamy_consul-2.jpg 163w,
/static/09a85130490779b28e2855643e68eb19/c989d/dreamy_consul-2.jpg 325w,
/static/09a85130490779b28e2855643e68eb19/b4294/dreamy_consul-2.jpg 600w&quot; sizes=&quot;(max-width: 600px) 100vw, 600px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot; loading=&quot;lazy&quot;&gt;
    &lt;/span&gt;&lt;br&gt;
&lt;span&gt;Jessie Eastland, &lt;a href=&quot;http://commons.wikimedia.org/wiki/File:Dreamy_Twilight.jpg&quot;&gt;„Dreamy Twilight“&lt;/a&gt;, Consul Logo added&lt;/span&gt;, &lt;a href=&quot;http://creativecommons.org/licenses/by-sa/3.0/legalcode/&quot;&gt;CC BY-SA 3.0&lt;/a&gt;
&lt;/p&gt;
&lt;p&gt;CloudFormation templates are a great way to manage AWS resources. All resources for a stack are configured in a json and CloudFormation takes care of creating or updating your stack.
Consul is a distributed, consistent data store for Service Discovery and configuration which also features health checks and supports for distributed locks.
Consul deployed and updated via CloudFormation provides a nice foundation for any kind of modern infrastructure.&lt;/p&gt;
&lt;h1 id=&quot;autoscalinggroup&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#autoscalinggroup&quot; aria-label=&quot;autoscalinggroup permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;AutoScalingGroup&lt;/h1&gt;
&lt;p&gt;If you specify instances in your stack directly by using the &lt;code class=&quot;language-text&quot;&gt;AWS::EC2::Instance&lt;/code&gt; resource, updating anything that requires recreation of the instance will bring up a new instance and terminate the old one. If you need more control over the recreation, the instances need to be managed via a AutoScalingGroup.&lt;/p&gt;
&lt;p&gt;By default, updating a AutoScalingGroup won’t affect the instances. You need to manually terminate them and let AutoScale spin up a new instance.
To automatically update the instances, you can specify a UpdatePolicy requiring at least n instances in service while doing a rolling upgrade.&lt;/p&gt;
&lt;p&gt;In the case of consul this isn’t enough. Without checking that a new consul node actually came up and connected successfully to the cluster we might lose to quorum and the cluster becomes stale.&lt;/p&gt;
&lt;p&gt;Fortunately CloudFormation offers a UpdatePolicy option WaitOnResourceSignals which can be used to signal that any new consul node coming up connects sucessfully to the cluster before the any new instance gets terminated.&lt;/p&gt;
&lt;h1 id=&quot;updatepolicy&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#updatepolicy&quot; aria-label=&quot;updatepolicy permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;UpdatePolicy&lt;/h1&gt;
&lt;p&gt;The changes to the CloudFormation template are straight forward. In the AutoScalingGroup we add a &lt;code class=&quot;language-text&quot;&gt;UpdatePolicy&lt;/code&gt; with &lt;code class=&quot;language-text&quot;&gt;WaitOnResourceSignals: true&lt;/code&gt; like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;&quot;UpdatePolicy&quot; : {
  &quot;AutoScalingRollingUpdate&quot; : {
    &quot;MinInstancesInService&quot; : 2,
    &quot;PauseTime&quot; : &quot;PT15M&quot;,
    &quot;WaitOnResourceSignals&quot; : true
  }
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If &lt;code class=&quot;language-text&quot;&gt;WaitOnResourceSignals&lt;/code&gt; is set,&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;AWS CloudFormation suspends the update of an Auto Scaling
group after any new Amazon EC2 instances are launched into
the group. AWS CloudFormation must receive a signal from
each new instance within the specified pause time before
AWS CloudFormation continues the update.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Now we simply need to make sure any new instance sends a success signal after it came up and consul connected successfully to the cluster.&lt;/p&gt;
&lt;h1 id=&quot;send-success-signal&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#send-success-signal&quot; aria-label=&quot;send success signal permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Send success signal&lt;/h1&gt;
&lt;p&gt;Once a new instance starts, we need to wait for consul to join the cluster and replicate. Since we need to guarantee that a new node actually joined the cluster, not some partition of it, we need something that goes through the raft log.
When looking at the consul documentation, there are a few endpoint we could use. Unfortunately the documentation doesn’t state what the consistency guarantees of status endpoints like &lt;code class=&quot;language-text&quot;&gt;peers&lt;/code&gt; are, so &lt;a href=&quot;https://github.com/hashicorp/consul/issues/880&quot;&gt;I had to ask&lt;/a&gt;. Turns out, we can trust &lt;code class=&quot;language-text&quot;&gt;peers&lt;/code&gt;.
With that knowing, we can simply wait for consul being ready as part of the UserData script, then signal success by using the &lt;code class=&quot;language-text&quot;&gt;cfn-signal&lt;/code&gt; tool:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;&quot;UserData&quot;: { &quot;Fn::Base64&quot; : { &quot;Fn::Join&quot; : [&quot;&quot;, [
  &quot;IP=$(ip addr show dev eth0|awk &apos;/inet /{print $2}&apos;|cut -d/ -f1)\n&quot;,
  &quot;while ! curl -s http://localhost:8500/v1/status/peers | grep -q $IP:; do echo Waiting for consul; sleep 1; done\n&quot;,
  &quot;cfn-signal --resource InfraScalingGroup --stack &quot;, {&quot;Ref&quot;: &quot;AWS::StackName&quot;}, &quot; --region &quot;, {&quot;Ref&quot; : &quot;AWS::Region&quot;}, &quot;\n&quot;
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h1 id=&quot;ami&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ami&quot; aria-label=&quot;ami permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;AMI&lt;/h1&gt;
&lt;p&gt;The ami runs consul on start and uses a IAM role with read-only EC2 access. Since we tagged all consul instances, this allows the init script to discover peers via the AWS API:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;URL=&quot;http://169.254.169.254/latest/&quot;
ID=$(curl $URL/meta-data/instance-id)
REGION=$(curl $URL/dynamic/instance-identity/document | \
  jq -r .region)

SERVERS=$(aws --region $REGION ec2 describe-instances \
  --filters \
  &quot;Name=tag:aws:cloudformation:stack-id,Values=$STACK_ID&quot; \
  &quot;Name=tag:role,Values=consul&quot; \
  &quot;Name=instance-state-name,Values=running&quot; | \
    jq -r &apos;.Reservations[].Instances[].PrivateIpAddress&apos; \
)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We also need to check that SERVERS include the necessary number of peers to form a cluster. Since we’re using runit which restarts failing jobs, we just fail if we found less peers than expected and wait to get restarted:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;if [ $(echo &quot;$SERVERS&quot; | wc -l) -lt $BOOTSTRAP_EXPECT ]
then
  echo &quot;Not enough peers, expected $BOOTSTRAP_EXPECT nodes but got $SERVERS&quot;
  exit 1
fi&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once all peers are up and running, we can start consul:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;exec /usr/bin/consul agent -data-dir /var/lib/consul \
  -config-dir=/etc/consul \
  $(echo &quot;$SERVERS&quot; | sed &apos;s/^/ -retry-join /&apos; | tr -d &apos;\n&apos;)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h1 id=&quot;updating-the-stack&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#updating-the-stack&quot; aria-label=&quot;updating the stack permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Updating the Stack&lt;/h1&gt;
&lt;p&gt;With all this in place you can do a fully automated rolling upgrade while keeping a quorum. Just update the stack and you should get something like this while having a fully operable cluster:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/e458b67bbb060e2f44d87934ff67c7cd/output_710_280.gif&quot; alt=&quot;Update Stack Log&quot;&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Scope and Ownership in Tech Companies]]></title><description><![CDATA[My first job was a typical corporate job at a financial service provider after which I worked at large hosting company before joining…]]></description><link>https://5pi.de/2015/04/22/scope-and-ownership-in-tech-companies/</link><guid isPermaLink="false">https://5pi.de/2015/04/22/scope-and-ownership-in-tech-companies/</guid><pubDate>Wed, 22 Apr 2015 12:19:36 GMT</pubDate><content:encoded>&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c3811564b5efa34e1c0c89eb4d18fbe8/d6d37/acient_jobs.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 57.668711656441715%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAf/EABUBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAF2KWXSTCf/xAAYEAEBAQEBAAAAAAAAAAAAAAABABESAv/aAAgBAQABBQLyzZl03Sg3/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGhAAAQUBAAAAAAAAAAAAAAAAAAEQESExQf/aAAgBAQAGPwLVktWjhbf/xAAaEAACAwEBAAAAAAAAAAAAAAAAAREhMUHB/9oACAEBAAE/Ia3wdWEnALDwcTrTCxsNaP/aAAwDAQACAAMAAAAQAA//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAwEBPxCn/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8Qiv/EABwQAAIDAQADAAAAAAAAAAAAAAERACExQWGRwf/aAAgBAQABPxB77cOote+YRkQEASdVOFYUV2z9SlFEkqrEVkBHX3n2MRW8qf/Z&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;ownership&quot;
        title=&quot;ownership&quot;
        src=&quot;/static/c3811564b5efa34e1c0c89eb4d18fbe8/6aca1/acient_jobs.jpg&quot;
        srcset=&quot;/static/c3811564b5efa34e1c0c89eb4d18fbe8/d2f63/acient_jobs.jpg 163w,
/static/c3811564b5efa34e1c0c89eb4d18fbe8/c989d/acient_jobs.jpg 325w,
/static/c3811564b5efa34e1c0c89eb4d18fbe8/6aca1/acient_jobs.jpg 650w,
/static/c3811564b5efa34e1c0c89eb4d18fbe8/7c09c/acient_jobs.jpg 975w,
/static/c3811564b5efa34e1c0c89eb4d18fbe8/01ab0/acient_jobs.jpg 1300w,
/static/c3811564b5efa34e1c0c89eb4d18fbe8/d6d37/acient_jobs.jpg 1338w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;
My first job was a typical corporate job at a financial service provider after which I worked at large hosting company before joining SoundCloud, a startup culture-wise closer to Silicon Valley startups before joining Docker end of 2013.&lt;/p&gt;
&lt;p&gt;Although I never was a manager, I was always interested in the company as a whole, how my work shapes it and how the environment impacts my work and how other companies are organized.&lt;/p&gt;
&lt;p&gt;On thing that strikes me most is that not only that we lot of companies can’t agree on &lt;em&gt;who should do what&lt;/em&gt; but that lot of companies don’t even think about this carefully and don’t realize that this affects everything else. They strives for a Microservice architecture without even knowing why and name their Ops team “DevOps” because that’s what people do.
I want to provide my thoughts on questions around Scope and Ownership but leave the implementation details to the reader. I’m happy to answer technical questions in the comments though and might blog about those implementation details eventually if interested.&lt;/p&gt;
&lt;h1 id=&quot;what-your-company-should-do&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#what-your-company-should-do&quot; aria-label=&quot;what your company should do permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;What your Company should do&lt;/h1&gt;
&lt;p&gt;&lt;a href=&quot;https://www.flickr.com/photos/jo-ghadban/3355654186/in/photostream/&quot;&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; &quot;
    &gt;
      &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 71.16564417177914%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAEDAgT/xAAVAQEBAAAAAAAAAAAAAAAAAAACAP/aAAwDAQACEAMQAAABWuVRmSCv/8QAGxAAAgIDAQAAAAAAAAAAAAAAAAECEQMSEzH/2gAIAQEAAQUCxt6Pwtxj0spn/8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQMBAT8Bh//EABYRAAMAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAgEBPwGhf//EABkQAAIDAQAAAAAAAAAAAAAAAAEQACGRMf/aAAgBAQAGPwLp2Gzqp//EABsQAQACAgMAAAAAAAAAAAAAAAEAERBBITGB/9oACAEBAAE/IVBqbhrd0bhrTgSuKewh/9oADAMBAAIAAwAAABCb7//EABURAQEAAAAAAAAAAAAAAAAAABEQ/9oACAEDAQE/EGs//8QAFhEBAQEAAAAAAAAAAAAAAAAAACER/9oACAECAQE/EJYj/8QAHBABAQEBAAIDAAAAAAAAAAAAAREhADFxQVGR/9oACAEBAAE/EESgrGZ+9OgxFWb9c68576Ri6t35nQ0FxDvRYge+/9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Scope of Company&quot;
        title=&quot;Scope of Company&quot;
        src=&quot;/static/63cb55515393f4a5fa21cf6acc6f6d5d/c08c5/3355654186_6751a40056_z.jpg&quot;
        srcset=&quot;/static/63cb55515393f4a5fa21cf6acc6f6d5d/d2f63/3355654186_6751a40056_z.jpg 163w,
/static/63cb55515393f4a5fa21cf6acc6f6d5d/c989d/3355654186_6751a40056_z.jpg 325w,
/static/63cb55515393f4a5fa21cf6acc6f6d5d/c08c5/3355654186_6751a40056_z.jpg 640w&quot;
        sizes=&quot;(max-width: 640px) 100vw, 640px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
    &lt;/span&gt;&lt;/a&gt;
No company does everything on their own. You don’t build your own servers, let alone CPUs and chances are high, you don’t even run servers on your own.
All this is fine. It’s not your business to build CPUs, so you shouldn’t. Same for managing datacenters and servers. If it’s not your core business, you probably won’t ever be as good at it as someone specialized in it.&lt;/p&gt;
&lt;p&gt;On the other hand, never outsource what makes up your company. You can’t have someone else build something crucial and tightly related to your companies overall business. If you don’t do your own Community Management, Support or PR, people will realize that your company and brand has nothing to do with your social media presence.
Outsourcing this is like outsourcing your face.&lt;/p&gt;
&lt;p&gt;If your product needs custom software, you should build it. It still seems like a lot of companies believe software can be bought in like car service parts without realizing software is never done. It’s not even ever bug free, so it needs constant attention by people who feel part of the company and see purpose in what they are doing.&lt;/p&gt;
&lt;p&gt;Software is also usually the interface with your customers and you don’t want something you don’t &lt;em&gt;own&lt;/em&gt; between you and your customers. Not only that you don’t understand and can’t control, but all feedback loops are much wider. You listen to your customers, explain your ideas to some agency, they explain it to their developers and after some time you get a result. For every problem with that piece of software, you need to go through the whole loop again. Every competitor doing this in-house will move &lt;em&gt;much&lt;/em&gt; faster due to their short feedback loops. You see a problem, you fix it.&lt;/p&gt;
&lt;p&gt;Even internally, think about what makes up your company and how much of the internal infrastructure and software you want to own. If you are a small web shop, you’re good to &lt;em&gt;use&lt;/em&gt; existing frameworks and services. You can usually expect them to work for your use cases. If not, you need to fill tickets and wait for someone to fix them.
Now if you are company operating at large scale, you need to actually &lt;em&gt;own&lt;/em&gt; those services since you will run into issues nobody else ran into. In our open source world, this doesn’t necessary mean to write your own software but have people to &lt;em&gt;own&lt;/em&gt; those components, people able to understand their internals and able to fix bugs without any vendor supporting them. You see a problem you fix it.&lt;/p&gt;
&lt;h1 id=&quot;what-your-teams-should-do&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#what-your-teams-should-do&quot; aria-label=&quot;what your teams should do permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;What your teams should do&lt;/h1&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/ce4c6510a30130413060085014fcb3b3/b8220/samurai.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 79.14110429447852%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAv/EABUBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAHE1C4VCxP/xAAZEAEBAQADAAAAAAAAAAAAAAACAREAEjH/2gAIAQEAAQUCRlqBwGdfajdqp5//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAaEAACAgMAAAAAAAAAAAAAAAAAARExEBKR/9oACAEBAAY/ApeKKkb14RR//8QAGRABAAMBAQAAAAAAAAAAAAAAAQARIVGh/9oACAEBAAE/IX9JhHNKlbcA7odgyYrCFPCf/9oADAMBAAIAAwAAABD3/wD/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPxBJ/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAERIf/aAAgBAgEBPxBOGn//xAAcEAEAAgIDAQAAAAAAAAAAAAABESEAMUFRYXH/2gAIAQEAAT8QN5YNkQBeCTKQ3m/jyzkhvoBLI+95c72AywF9e5uqHIsz/9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Team&quot;
        title=&quot;Team&quot;
        src=&quot;/static/ce4c6510a30130413060085014fcb3b3/6aca1/samurai.jpg&quot;
        srcset=&quot;/static/ce4c6510a30130413060085014fcb3b3/d2f63/samurai.jpg 163w,
/static/ce4c6510a30130413060085014fcb3b3/c989d/samurai.jpg 325w,
/static/ce4c6510a30130413060085014fcb3b3/6aca1/samurai.jpg 650w,
/static/ce4c6510a30130413060085014fcb3b3/b8220/samurai.jpg 733w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;
No matter how you build teams or how you call them, I believe they should be as independent from each other as possible while providing benefits to all other teams where possible.
As too many cooks spoil the broth, having many engineers working on the same code base usually isn’t working. You run into all kind of problems, from merge conflicts to bikeshedding and unclear escalation paths.&lt;/p&gt;
&lt;p&gt;The probably best way to avoid this is by splitting your monolithic application into (micro)services. Each teams develops their service independently. Since services depend on each other, you need to make your APIs backward compatible or introduce some kind of versioning.&lt;/p&gt;
&lt;h2 id=&quot;you-build-it-you-run-it&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#you-build-it-you-run-it&quot; aria-label=&quot;you build it you run it permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;You build it, you run it&lt;/h2&gt;
&lt;p&gt;Each team does not only develop their own service, they also deploy, operate and monitor it. You will never fully understand how an application behaves if you don’t run it on your own. With the right monitoring in place, it’s usually not that hard to isolate in which service’s domain a problem occurred. This guarantees short feedback loops and sets the right incentives to balance features and work on technical debt.
This also implies that there is &lt;em&gt;no ops team&lt;/em&gt;. Ops isn’t a team, it’s a role, something everyone should be doing.&lt;/p&gt;
&lt;h2 id=&quot;self-service&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#self-service&quot; aria-label=&quot;self service permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Self-service&lt;/h2&gt;
&lt;p&gt;The teams being able to own each aspect of their service requires a self-service infrastructure.
It depends on how similar the requirements of different teams are and how much operational experience they have.
If you’re running on AWS, you might just give every team their own login and ability to spin up machines and resources as they need. But this requires quite some operational experience to make this secure and reliable and there will be lot of pieces that every team needs to re-invent.
Therefore, the self-service platform should address all needs that are similar across all your services and support. It might look like Heroku or Elastic Beanstalk but might be more opinionated and specific to your company.
Those infrastructure services are the same as user facing services. Some team builds and operates them, it’s simply a service for which customers are other engineers within your company.
This isn’t Ops and it’s not DevOps either, although due to the nature of the service it might involve more systems knowledge than frontend development.&lt;/p&gt;
&lt;h2 id=&quot;scaling-beyond-that&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#scaling-beyond-that&quot; aria-label=&quot;scaling beyond that permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Scaling beyond that&lt;/h2&gt;
&lt;p&gt;At large scale funny things happen and in a large company, you want people specialized in those problem. If you have less than, let say, 200 engineers, you probably don’t.
Those scale issues are similar across services but nothing you can easily abstract away. To solve those problems, you need to look at the big picture. The problem domain is different which is why companies like Google and facebook introduced a new role. Whether you call it &lt;em&gt;Site Reliability Engineering&lt;/em&gt; or just &lt;em&gt;Production Engineering&lt;/em&gt;, please don’t call it Ops and don’t use it synonymous with. It’s not about &lt;em&gt;operating&lt;/em&gt; anything.&lt;/p&gt;
&lt;h1 id=&quot;conclusion&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#conclusion&quot; aria-label=&quot;conclusion permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Conclusion&lt;/h1&gt;
&lt;p&gt;Some things proposed here might not be trivial to implement. It’s hard to hire people with operational and development skills and a Microservice architecture opens up a whole new class of problems in the realm of distributed systems, but in the end most successfully companies seem to arrive at similar conclusions. If you disagree and choose a completely different approach, that’s fine as long as you do it deliberately.
Nothing is worse than having some specific form of organization without knowing why.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Building AWS AMIs from Scratch for Immutable Infrastructures]]></title><description><![CDATA[Why? I’m a big fan of what some might call “immutable infrastructures” which, to me, boils down to manging complexity by isolating change to…]]></description><link>https://5pi.de/2015/03/13/building-aws-amis-from-scratch/</link><guid isPermaLink="false">https://5pi.de/2015/03/13/building-aws-amis-from-scratch/</guid><pubDate>Fri, 13 Mar 2015 15:42:47 GMT</pubDate><content:encoded>&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7183da7353128252eb634f7ebc882360/29d31/Rahn_Kloster_Sanct_Gallen_nach_Lasius_700.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 60.122699386503065%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHXVzAkH//EABgQAQEBAQEAAAAAAAAAAAAAAAECABAR/9oACAEBAAEFAqvzFLhzJ3//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAZEAEBAQEBAQAAAAAAAAAAAAABEQAhEDH/2gAIAQEAAT8hqk+brBck6ZiKdNDz/9oADAMBAAIAAwAAABDDD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABsQAQACAgMAAAAAAAAAAAAAAAEAIRFBMVFx/9oACAEBAAE/EEWpVruWiC8Gogqj7A2NAwyBgA6gYn//2Q==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Image&quot;
        title=&quot;Image&quot;
        src=&quot;/static/7183da7353128252eb634f7ebc882360/6aca1/Rahn_Kloster_Sanct_Gallen_nach_Lasius_700.jpg&quot;
        srcset=&quot;/static/7183da7353128252eb634f7ebc882360/d2f63/Rahn_Kloster_Sanct_Gallen_nach_Lasius_700.jpg 163w,
/static/7183da7353128252eb634f7ebc882360/c989d/Rahn_Kloster_Sanct_Gallen_nach_Lasius_700.jpg 325w,
/static/7183da7353128252eb634f7ebc882360/6aca1/Rahn_Kloster_Sanct_Gallen_nach_Lasius_700.jpg 650w,
/static/7183da7353128252eb634f7ebc882360/29d31/Rahn_Kloster_Sanct_Gallen_nach_Lasius_700.jpg 700w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h1 id=&quot;why&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#why&quot; aria-label=&quot;why permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Why?&lt;/h1&gt;
&lt;p&gt;I’m a big fan of what some might call “immutable infrastructures” which, to me, boils down to manging complexity by isolating change to specific points in the life cycle of your services.
In practice this might mean you build your application image once and just recreate it if you need to update it.
Or you install your complete server once and just recreate it if you need to update it. Where this is harder on bare metal, AWS is a nice platform for this kind of immutable servers since it supports creating and running pre-built Amazon Machine Images.&lt;/p&gt;
&lt;p&gt;In general there are two ways to build AMIs: Spinning up a new instance, customize it and create a snapshot or build the AMI from scratch.&lt;/p&gt;
&lt;p&gt;The first option seems to be the most common case. There are several tools like &lt;a href=&quot;https://www.packer.io/&quot;&gt;packer&lt;/a&gt; or Netflix’ &lt;a href=&quot;https://github.com/Netflix/aminator&quot;&gt;aminator&lt;/a&gt; but since it requires to actually boot a existing AMIs, it has a few downsides. For once it requires a existing AMI which might include things you don’t need but I’m more worried about the fact that it requires to actually boot a machine. This breaks the clean separation of build- and runtime and might mess up your build artefacts. Think logfiles, dhcp/cloud-init configuration and so on. Sure, you can clean up those things but I prefer avoiding it in the first place by never entering the runtime before actual deployment.
Unfortunately, there isn’t very good tooling nor documentation around that, so I thought I share my findings with you.
Maybe it sparks the interest in building some good tooling around that - or maybe I get to it at some point.&lt;/p&gt;
&lt;h1 id=&quot;building-the-image&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#building-the-image&quot; aria-label=&quot;building the image permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Building the image&lt;/h1&gt;
&lt;p&gt;There are &lt;a href=&quot;http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/virtualization_types.html&quot;&gt;PV and HVM instances&lt;/a&gt; where from a AMI building perspective the biggest difference is that PV AMIs consist of a &lt;em&gt;filesystem&lt;/em&gt; image and a AKI (Amazon “kernel” image) reference. That kernel isn’t really a kernel but in fact pv-grub, a modified grub which, depending on the AKI, assumes a grub config in &lt;code class=&quot;language-text&quot;&gt;(hd0)/boot/grub/menu.lst&lt;/code&gt; to chainload the specified kernel.&lt;/p&gt;
&lt;p&gt;A HVM image on the other hand is a &lt;em&gt;disk&lt;/em&gt; image with a MBR that gets executed on boot.&lt;/p&gt;
&lt;h2 id=&quot;paravirtual&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#paravirtual&quot; aria-label=&quot;paravirtual permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Paravirtual&lt;/h2&gt;
&lt;p&gt;Apparently HVM is the future, so feel free to skip this section.&lt;/p&gt;
&lt;p&gt;Creating a PV image is simple. This creates a 10G sparse file with ext4 filesystem and a label ‘root’. &lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;dd if=/dev/zero of=filesystem.img bs=1 count=0 seek=10G
mkfs.ext4 -L root -F filesystem.img&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now you you can mount that image, install your OS (debootstrap comes handy) and create a menu.lst. You probably also want to install cloud-init to take care of your networking and fstab setup. You need to refer to the filesystem label you specified running &lt;code class=&quot;language-text&quot;&gt;mkfs.ext4 -L&lt;/code&gt;. Something like this should do it:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;default 0
fallback 1
timeout 0
hiddenmenu

title My-AMI
root (hd0)
kernel /boot/vmlinuz root=LABEL=root console=hvc0
initrd /boot/initrd.gz&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;hvm&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#hvm&quot; aria-label=&quot;hvm permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;HVM&lt;/h2&gt;
&lt;p&gt;HVM images are a bit more tricky, since we need to create a complete disk image including partition and MBR:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;dd if=/dev/zero of=disk.img bs=1 count=0 seek=$SIZE 
fdisk filesystem.img &amp;lt;&amp;lt; EOF
n
p
1


w
EOF
DEV_DISK=$(losetup -f --show disk.img)
DEV=/dev/mapper/$(kpartx -av $DEV_DISK | cut -d&apos; &apos; -f3)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now you can mount &lt;code class=&quot;language-text&quot;&gt;$DEV&lt;/code&gt; and install your OS. Running &lt;code class=&quot;language-text&quot;&gt;update-grub&lt;/code&gt;/&lt;code class=&quot;language-text&quot;&gt;grub-mkconfig&lt;/code&gt; should detect and use the disk images UUID. On some systems it seems to require a unmount/detach and remount of the disk image, otherwise you end up with &lt;code class=&quot;language-text&quot;&gt;root=&lt;/code&gt; pointing &lt;code class=&quot;language-text&quot;&gt;/dev/loopX&lt;/code&gt;. To detach the mappings and loop device once you’re done, run:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;kpartx -d $DEV_DISK
losetup -d $DEV_DISK&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After that, you need to install grub to the MBR of the disk image by running:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;grub-install disk.img --root-directory $PWD/mnt&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;Note: Took me some time to figure out that —root-directory needs an absolute path.&lt;/em&gt;&lt;/p&gt;
&lt;h1 id=&quot;bundle-upload-and-register-ami&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#bundle-upload-and-register-ami&quot; aria-label=&quot;bundle upload and register ami permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Bundle, Upload and register AMI&lt;/h1&gt;
&lt;p&gt;For some reasons there is no way to bundle and upload images with the new &lt;code class=&quot;language-text&quot;&gt;aws&lt;/code&gt; cli, so we’re using the old AWS tools.
&lt;code class=&quot;language-text&quot;&gt;ec2-bundle-image&lt;/code&gt; will turn the disk or filesystem images into bundles ready to be uploaded to S3 by &lt;code class=&quot;language-text&quot;&gt;ec2-upload-bundle&lt;/code&gt;. Now you just need to register your AMI with &lt;code class=&quot;language-text&quot;&gt;aws ec2 register-image&lt;/code&gt; and make sure &lt;code class=&quot;language-text&quot;&gt;--virtualization-type&lt;/code&gt; matches the kind of image you built.
If you run in multiple regions, you can use &lt;code class=&quot;language-text&quot;&gt;aws ec2 copy-image&lt;/code&gt; to replicate your AMIs across regions.&lt;/p&gt;
&lt;h1 id=&quot;debugging&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#debugging&quot; aria-label=&quot;debugging permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Debugging&lt;/h1&gt;
&lt;p&gt;If you’re AMI doesn’t boot, you can get the console output by running &lt;code class=&quot;language-text&quot;&gt;aws ec2 get-console-output --instance-id ...&lt;/code&gt;. This is encoded as json but you can use the great tool &lt;code class=&quot;language-text&quot;&gt;jq&lt;/code&gt; to get just the output including all it’s ANSI colored glory like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;aws ec2 get-console-output --instance-id ... | jq -r .Output&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you don’t want to wait for your ec2 instance at all, you can also just test the images locally. For HVM this is trivial. Just run &lt;code class=&quot;language-text&quot;&gt;kvm disk.img&lt;/code&gt; or &lt;code class=&quot;language-text&quot;&gt;qemu disk.img&lt;/code&gt;.&lt;/p&gt;
&lt;h1 id=&quot;automation-and-integration&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#automation-and-integration&quot; aria-label=&quot;automation and integration permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Automation and Integration&lt;/h1&gt;
&lt;p&gt;Right now I’m using a, pretty messy, Makefile to automate all this. It takes some files and a provisioner script to customize the AMIs. The general idea is to use some CI server to build fresh AMIs on every push and to just recreate your EC2 instances with the new AMIs once you want to roll out your changes.
It would be great to have proper tooling for all this. Packer looks promising, just misses a way to build from scratch.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Prometheus on Raspberry Pi]]></title><description><![CDATA[Prometheus Prometheus is a new open-source service monitoring system and time series database written in Go. Check out the announcement and…]]></description><link>https://5pi.de/2015/02/10/prometheus-on-raspberry-pi/</link><guid isPermaLink="false">https://5pi.de/2015/02/10/prometheus-on-raspberry-pi/</guid><pubDate>Tue, 10 Feb 2015 13:18:12 GMT</pubDate><content:encoded>&lt;h1 id=&quot;prometheus&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#prometheus&quot; aria-label=&quot;prometheus permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Prometheus&lt;/h1&gt;
&lt;p&gt;&lt;a href=&quot;http://prometheus.io&quot;&gt;Prometheus&lt;/a&gt; is a new open-source service monitoring system and time series database written in Go.&lt;/p&gt;
&lt;p&gt;Check out the &lt;a href=&quot;https://developers.soundcloud.com/blog/prometheus-monitoring-at-soundcloud&quot;&gt;announcement&lt;/a&gt; and my article about &lt;a href=&quot;/2015/01/26/monitor-docker-containers-with-prometheus&quot;&gt;monitoring Docker Containers with Prometheus&lt;/a&gt; if you don’t know what I’m talking about.&lt;/p&gt;
&lt;h1 id=&quot;my-stack&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#my-stack&quot; aria-label=&quot;my stack permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;My Stack&lt;/h1&gt;
&lt;p&gt;&lt;img src=&quot;http://upload.wikimedia.org/wikipedia/commons/thumb/d/d2/Raspberry_Pi_Photo.jpg/800px-Raspberry_Pi_Photo.jpg&quot; alt=&quot;RaspberryPi&quot;&gt;
I stopped running my own full blown server(s) a while ago. Nowadays I just have a old Raspberry Pi at home and two tiny DigitalOcean instances to host this blog and for general R&amp;#x26;D stuff.&lt;/p&gt;
&lt;p&gt;But I still want to monitor all this and, as showed earlier, Prometheus is the way to go. So I could now spin up another DigitalOcean instance and pay another $5/Mo, but given how cheap I am, I’d rather want to run it on my Raspberry Pi.&lt;/p&gt;
&lt;h1 id=&quot;cross-compiling-go&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#cross-compiling-go&quot; aria-label=&quot;cross compiling go permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Cross-Compiling Go&lt;/h1&gt;
&lt;p&gt;First you need to build Go with support for your target OS and architecture. If you installed Go from sources, you can do this by running:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;cd $GOROOT/src
GOARCH=arm ./make.bash&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;With pure Go, cross compilation is trivial. This example:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;package main

import &quot;fmt&quot;

func main() {
	fmt.Println(&quot;Hello World&quot;)
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;can be cross-compiling for arm with &lt;code class=&quot;language-text&quot;&gt;GOARCH=arm go build test.go&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Now things get much more complicated once you use CGO, meaning Go code calling C functions.&lt;/p&gt;
&lt;p&gt;The Prometheus server uses the &lt;a href=&quot;https://github.com/prometheus/client_golang&quot;&gt;Prometheus Go Client Library&lt;/a&gt; to provide metrics about itself. This client library uses &lt;a href=&quot;https://github.com/prometheus/procfs&quot;&gt;prometheus/procfs&lt;/a&gt; which requires CGO to get process metrics from procfs. Cross-compiling this for Raspberry Pi is a pain. ARM != ARM, there are several variants and when I tried to cross-compiling Prometheus with CGO, it just lead to segfaults or invalid instructions. It should be possible to cross-compile it with the CGO dependency, it’s just painful and I quickly gave up.&lt;/p&gt;
&lt;p&gt;Fortunately, we found an easy way to remove the dependency on procfs if CGO is disabled: &lt;a href=&quot;https://github.com/prometheus/client_golang/commit/93d11c8e35ffcd969fd881efe1873e715a6ef93b&quot;&gt;https://github.com/prometheus/client_golang/commit/93d11c8e35ffcd969fd881efe1873e715a6ef93b&lt;/a&gt;. This removes some useful process level metrics about prometheus itself, but it makes cross compiling prometheus is as easy as in the example above:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;cd $GOPATH/src/github.com/prometheus/prometheus
go get -u # Update your dependencies
GOARCH=arm go build -o prometheus.arm&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Since cross-compilation by default disables CGO, this builds a statically linked prometheus binary ready to be run on a Raspberry Pi. If you’re running a newer Pi, you can set GOARM to the version of your ARM processor. See &lt;a href=&quot;https://code.google.com/p/go-wiki/wiki/GoArm#Supported_architectures&quot;&gt;this&lt;/a&gt; for supported architectures.&lt;/p&gt;
&lt;h1 id=&quot;performance&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#performance&quot; aria-label=&quot;performance permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Performance&lt;/h1&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0c0309899e4000452ea789b5324129b0/e088a/rpi_gorouting.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 71.16564417177914%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsTAAALEwEAmpwYAAACAElEQVQoz31SyW4TQRCdj4JLLnDAsbAlyz9ATsHbNQf+iAsnTkgIKYjFFpaDYgNxwAZ7FjuDl5npmfFUr2Oq22AFlPDU6q5e3qtX3W1VKpVqtVoul0ulhwY4lIrFYuFB4ToODwt3Du7dPbiPwR5WlmWr1ZoQIqTM83x7E3bLT99Pn31w91OEJaVEPgBwLra3kP8BUqIoAqAWpQBMAFdG8lb8ZUQpSilKWLiMEeMaYDygf6kUNtAbjAuBi2ma5nv17TXbAmUYU1JgE5uUk4iTUKSxhIwnsZKSRYESQlLYcfEAI6Ehc56ML+ncYeFaJoTOXQVZLkTOWS4FW/1UFKJBjy18kcS7hJk7oUvfkIUI+71kOMi8afr9Mh0P0d2ufuyRLGISdN/EF+eZM8EY86ejC7hyf5PB98CbbqZj8uksm9laXCm8FRzpwk+/fl53TtfvXsVfPqajIczdzeQb+LNckxUeNKluely5SaKzdtB5vXj5nPS7pN9DFbQNVx5ekIVcvDLTax0jpaEDJHMenneD7ls0RQY9zLk8fbGZjFi4whNW/v+PgdvBUi19SUIsDWYOXrtiVAmubePzep7nuq5t247juAYY4FQHuDj5MbXtJElQSL8c2vljz4rj+MnJyePj40aj2TBoNnVQq9Wwr9frrVbr6NFRu93ZfUxlKsxNUb8AScPlhyxqFB4AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;goroutines&quot;
        title=&quot;goroutines&quot;
        src=&quot;/static/0c0309899e4000452ea789b5324129b0/a6d36/rpi_gorouting.png&quot;
        srcset=&quot;/static/0c0309899e4000452ea789b5324129b0/222b7/rpi_gorouting.png 163w,
/static/0c0309899e4000452ea789b5324129b0/ff46a/rpi_gorouting.png 325w,
/static/0c0309899e4000452ea789b5324129b0/a6d36/rpi_gorouting.png 650w,
/static/0c0309899e4000452ea789b5324129b0/e548f/rpi_gorouting.png 975w,
/static/0c0309899e4000452ea789b5324129b0/e088a/rpi_gorouting.png 1015w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;
I didn’t have time to benchmark it yet, but it seems to perform much better than I expected. Right now, it only scrapes itself, giving us ~250 time series. After running it for a few hours it already collected 137806 samples. Graphing a simple time series like &lt;code class=&quot;language-text&quot;&gt;process_goroutines&lt;/code&gt; for the past hour takes between 150-170ms. The probably most expensive operation you can do (and definitely shouldn’t do on a production system) is graphing &lt;em&gt;all&lt;/em&gt; time series by executing &lt;code class=&quot;language-text&quot;&gt;{job=~&quot;.*&quot;}&lt;/code&gt; this returns in about 30s on the Raspberry Pi.
&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/41ee3e1033ec4be8cbd8b134b87fc946/46e51/rpi_all-1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 66.25766871165644%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAABz0lEQVQoz5VSS08aURSeX+bKLliYmIaNESiEJU2jFrUdTVODxSE+FjaFSBTb2BCjQEnTqEBaki4MXZgYdQUsjFp5DAiOzus+ZnpmEDOxpI1fbu6c8+W87neGcXs8Xq/XY8LdheuZyzHssMLldDwZsPfZnjotYAghqqrq/4SmaXD/LLYSBxXNwjMIoVsTkiSBTXqBUqLr1DwaJUQUxVq9JggCoyqKJKuiSu5a/AVgZZVUW5KCCLjUACEYw4eBFBhbURSMsSzL0B/cTkMgZVnRCCpdtmP50nnj1qyvI6wriEIhBnIgrlPyvpvV7g5gPFYQb7jNhbHIWPTbChBMd7Y7VawKWV2oBgbf5ofeDtv8gzOxoCGYqQf9b3KHqfAtu2+l3xl+GUxjgh+XzDev2MAsOzMVnH9T5y97j219MTW2A+pi4AuHhWjUF98Y/bzhbzYuDMEwRtQMgBuOZqr14D8xV60Xfu2mEs9zmdfZPbbd/s30iNN0GWFBEpvXrWqjel45K58WT4pH3/d/JNNzuYw/uzeZy7CCUDH2fHRymMvv7mTTya/x+Pbap/iH1fWlcJR7HwksLU9zixPvuBEuNBIKvfi4Pv4lxW5vvUolp8rl4z+xpKOKjI8+2QAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;goroutines&quot;
        title=&quot;goroutines&quot;
        src=&quot;/static/41ee3e1033ec4be8cbd8b134b87fc946/a6d36/rpi_all-1.png&quot;
        srcset=&quot;/static/41ee3e1033ec4be8cbd8b134b87fc946/222b7/rpi_all-1.png 163w,
/static/41ee3e1033ec4be8cbd8b134b87fc946/ff46a/rpi_all-1.png 325w,
/static/41ee3e1033ec4be8cbd8b134b87fc946/a6d36/rpi_all-1.png 650w,
/static/41ee3e1033ec4be8cbd8b134b87fc946/e548f/rpi_all-1.png 975w,
/static/41ee3e1033ec4be8cbd8b134b87fc946/46e51/rpi_all-1.png 1003w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h1 id=&quot;downloads&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#downloads&quot; aria-label=&quot;downloads permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Downloads&lt;/h1&gt;
&lt;p&gt;&lt;strong&gt;Update:&lt;/strong&gt; There are now official images available:
&lt;a href=&quot;https://prometheus.io/download/&quot;&gt;https://prometheus.io/download/&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;checksums&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#checksums&quot; aria-label=&quot;checksums permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Checksums&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;$ shasum prometheus.armv?.gz
db42a3f568bbab1d8a7d183b336d0b50dccc80b6  prometheus.armv5.gz
b6fdd3a77e16359631a0daaf9c06cd93a9948932  prometheus.armv6.gz
8d3e6580ee4ed3d10b93d60c13009156a5600193  prometheus.armv7.gz

$  sha256sum prometheus.armv?.gz
e206202bb07cc139eaabac4c51c07f0a332337eb331bd79f19294c558fb3de62  prometheus.armv5.gz
99d864e4fee8ded6b0f9c117f839fdf0fa9d12fadfe27b98090bee04b88c48c0  prometheus.armv6.gz
baf550448174198c57f3a28e2b86d49ba523e5b15d9d4c087267021e4785299b  prometheus.armv7.gz&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[Find GHOSTs in your Docker images]]></title><description><![CDATA[A severe security vulnerability in glibc < 2.18, nicknamed GHOST was just reported.
Here is a handy one-liner (Debian/Ubuntu only though) to…]]></description><link>https://5pi.de/2015/01/27/find-ghosts-in-your-docker-images/</link><guid isPermaLink="false">https://5pi.de/2015/01/27/find-ghosts-in-your-docker-images/</guid><pubDate>Tue, 27 Jan 2015 17:30:17 GMT</pubDate><content:encoded>&lt;p&gt;A severe security vulnerability in glibc &amp;#x3C; 2.18, nicknamed &lt;a href=&quot;http://www.openwall.com/lists/oss-security/2015/01/27/9&quot;&gt;GHOST&lt;/a&gt; was just reported.
Here is a handy one-liner (Debian/Ubuntu only though) to walk through all your Docker images and see if they include a glibc older than 2.18:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;docker images -q | while read I; do V=`docker run --rm --entrypoint apt-cache $I policy libc6 2&gt;/dev/null | awk &apos; /Installed/ { print $2&quot;\n&quot;2.18 }&apos;|sort -V|head -1`; if [ -z &quot;$V&quot; ]; then echo &quot;$I not apt based&quot; &amp;amp;&amp;amp; continue; fi;  [ &quot;$V&quot; == &quot;2.18&quot; ] || echo &quot;$I is vulnerable&quot;; done&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[Monitor Docker Containers with Prometheus]]></title><description><![CDATA[Monitoring Docker Running all your services in containers makes it possible to get in-depth resource and performance characteristics, since…]]></description><link>https://5pi.de/2015/01/26/monitor-docker-containers-with-prometheus/</link><guid isPermaLink="false">https://5pi.de/2015/01/26/monitor-docker-containers-with-prometheus/</guid><pubDate>Mon, 26 Jan 2015 15:15:12 GMT</pubDate><content:encoded>&lt;h3 id=&quot;monitoring-docker&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#monitoring-docker&quot; aria-label=&quot;monitoring docker permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Monitoring Docker&lt;/h3&gt;
&lt;p&gt;Running all your services in containers makes it possible to get in-depth resource and performance characteristics, since every container runs in their own cgroup and the Linux kernel provides us with all kind of useful metrics.&lt;/p&gt;
&lt;p&gt;Although there are a few other Docker monitoring tools out there, I’ll show you why I think that SoundCloud’s &lt;a href=&quot;https://developers.soundcloud.com/blog/prometheus-monitoring-at-soundcloud&quot;&gt;newly released&lt;/a&gt; &lt;a href=&quot;https://prometheus.github.io/&quot;&gt;Prometheus&lt;/a&gt; is a perfect fit for monitoring container-based infrastructures.&lt;/p&gt;
&lt;p&gt;Prometheus features a highly dimensional &lt;a href=&quot;http://prometheus.github.io/docs/concepts/data_model/&quot;&gt;data model&lt;/a&gt; in which a time series is identified by a metric name and a set of key-value pairs. A flexible &lt;a href=&quot;http://prometheus.github.io/docs/querying/basics/&quot;&gt;query language&lt;/a&gt; allows querying and graphing this data. It features advanced &lt;a href=&quot;http://prometheus.github.io/docs/concepts/metric_types/&quot;&gt;metric types&lt;/a&gt; like summaries, building &lt;a href=&quot;http://prometheus.github.io/docs/querying/functions/#rate()&quot;&gt;rates&lt;/a&gt; from totals over specified time spans or &lt;a href=&quot;http://prometheus.github.io/docs/querying/rules/&quot;&gt;alerting&lt;/a&gt; on any expression and has no dependencies, making it a dependable system for debugging during outages.&lt;/p&gt;
&lt;p&gt;I will focus on why especially the data model and query language makes it such a good fit in a containerized, dynamic infrastructure where you think in clusters of services instead of single instances and servers as cattle instead of pets.&lt;/p&gt;
&lt;h3 id=&quot;classic-approach&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#classic-approach&quot; aria-label=&quot;classic approach permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Classic Approach&lt;/h3&gt;
&lt;p&gt;Let’s say you want to monitor the memory usage of your containers. Without support for dimensional data, such a metric for the container named &lt;code class=&quot;language-text&quot;&gt;webapp123&lt;/code&gt; might be called &lt;code class=&quot;language-text&quot;&gt;container_memory_usage_bytes_webapp123&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;But what if you want to show the memory usage of all your &lt;code class=&quot;language-text&quot;&gt;webapp123&lt;/code&gt; containers? More advanced monitoring solutions like &lt;a href=&quot;https://github.com/graphite-project&quot;&gt;graphite&lt;/a&gt; support that. It features a hierarchic, tree-like data model in which such metric might be called &lt;code class=&quot;language-text&quot;&gt;container.memory_usage_bytes.webapp123&lt;/code&gt;. Now you can use wildcards like &lt;code class=&quot;language-text&quot;&gt;container.memory_usage_bytes.webapp*&lt;/code&gt; to graph the memory usage of all your ‘webapp’ containers. Graphite also supports functions like &lt;code class=&quot;language-text&quot;&gt;sum()&lt;/code&gt; to aggregate the memory usage of your application across all your machines by using an expression like &lt;code class=&quot;language-text&quot;&gt;sum(container.memory_usage_bytes.webapp*)&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;That’s all great and very useful, but limited. What if you don’t want to aggregate all containers with a given name but with a given image? Or you want to compare the deployments to your canary with those on your prod machines?&lt;/p&gt;
&lt;p&gt;It’s possible to come up with a hierarchy for each use case, but not one to support them all. And reality shows, you often don’t know in advance which questions you need to answer once things go dark and you start investigating.&lt;/p&gt;
&lt;h3 id=&quot;prometheus&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#prometheus&quot; aria-label=&quot;prometheus permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Prometheus&lt;/h3&gt;
&lt;p&gt;With Prometheus’s support for dimensional data, you can have global and straightforward metric names like &lt;code class=&quot;language-text&quot;&gt;container_memory_usage_bytes&lt;/code&gt; with multiple dimensions to identify the specific instances of your service.&lt;/p&gt;
&lt;p&gt;I’ve created a simple &lt;a href=&quot;https://github.com/docker-infra/container_exporter&quot;&gt;container-exporter&lt;/a&gt; to gather Docker Container metrics and expose them for Prometheus to consume. This exporter uses the container’s name, id and image as dimensions. Additional per-exporter dimension can be set in the &lt;code class=&quot;language-text&quot;&gt;prometheus.conf&lt;/code&gt;.
If you use the metric name directly as a query expression, it will return all time series with their labels for this metric name:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;container_memory_usage_bytes{env=&quot;prod&quot;,id=&quot;23f731ee29ae12fef1ef6726e2fce60e5e37342ee9e35cb47e3c7a24422f9e88&quot;,instance=&quot;http://1.2.3.4:9088/metrics&quot;,job=&quot;container-exporter&quot;,name=&quot;haproxy-exporter-int&quot;,image=&quot;prom/haproxy-exporter:latest&quot;}	11468800.000000
container_memory_usage_bytes{env=&quot;prod&quot;,id=&quot;57690ddfd3bb954d59b2d9dcd7379b308fbe999bce057951aa3d45211c0b5f8c&quot;,instance=&quot;http://1.2.3.5:9088/metrics&quot;,job=&quot;container-exporter&quot;,name=&quot;haproxy-exporter&quot;,image=&quot;prom/haproxy-exporter:latest&quot;}	16809984.000000
container_memory_usage_bytes{env=&quot;prod&quot;,id=&quot;907ac267ebb3299af08a276e4ea6fd7bf3cb26632889d9394900adc832a302b4&quot;,instance=&quot;http://1.2.3.2:9088/metrics&quot;,job=&quot;container-exporter&quot;,name=&quot;node-exporter&quot;,image=&quot;prom/container-exporter:latest&quot;}
...
...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you run lot of containers, this looks something like this:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/065a19374aba5620f406a9361ff35444/2e237/container_memory_usage_bytes.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 71.16564417177914%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACK0lEQVQoz42S2U7bQBSG/bx9Gi6qUhUIS1upVGVpL6qC1ErQKEDsOBhCbGerU5yAstuefbF7bIgKUi/665M958yMz39mbLTbrUaj4eZqep43Go2VUkJwsRTnIkvl7QS/2OqsfAuzVEMyy7J6vW5MC41zTeJCGGOElmD8EBKMNSeC4iRBURRBAdM0jTAMYXMY3vaDAFx4rut7nu8XgBPP9ZZhs+lC0Gr5sCYIfh0fHxkT0HQ2ni0QYXf348HwfjqPE0whXERoeD+azqMYkfkiCW7DeYwolzCVZplVsw3OOIhQQhllHIAXLSD0WUiZ4A8D6AF6Ni3TgJakFFrLVCutVaqlzlEFUqsCvUTly+BA8wOzbYNSKiHUqU6zf6JS8PgsI5WGjF2/NBhjhJEFiWKWJAw9JS6ISBLTJ0maJBTD96qWVVSWf30WruSj58dQqKXzhykhKFSu1cy8cloY+39pndt2HCffPJqM2t1GO/CHo9/9vheEwSKeD8PW3aCFcNTr+277Ohx0e0FneDeI4jnBcZbJs7OKAX9fp3d9dVN2/fOaU3bcc9M+qlg/rjzr4vKkXD1ybk4uG+Vz+3uzW73yK1bjtO5Vreuf+18+GFJILuCWkwgtmCBcEsYxYVgqLhXDOIKnkHAjjAskeCwFQmjGeGxZF8YgHHw9PX61u7H6cWt9b3P7sLR5AIOd0uHOxsHbzc/v33zaWd/b3tovre2WXhes7pbWDt+trL38AxXh/ayjzJkcAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;container_memory_usage_bytes.png&quot;
        title=&quot;container_memory_usage_bytes.png&quot;
        src=&quot;/static/065a19374aba5620f406a9361ff35444/a6d36/container_memory_usage_bytes.png&quot;
        srcset=&quot;/static/065a19374aba5620f406a9361ff35444/222b7/container_memory_usage_bytes.png 163w,
/static/065a19374aba5620f406a9361ff35444/ff46a/container_memory_usage_bytes.png 325w,
/static/065a19374aba5620f406a9361ff35444/a6d36/container_memory_usage_bytes.png 650w,
/static/065a19374aba5620f406a9361ff35444/2e237/container_memory_usage_bytes.png 790w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;To help you make sense of this data, you can filter and/or aggregate these metrics&lt;/p&gt;
&lt;h4 id=&quot;slice--dice&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#slice--dice&quot; aria-label=&quot;slice  dice permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Slice &amp;#x26; Dice&lt;/h4&gt;
&lt;p&gt;With Prometheus’s query language, you can slice and dice data by any dimension you want. If you’re interested in all containers with a given name, you can use an expression like &lt;code class=&quot;language-text&quot;&gt;container_memory_usage_bytes{name=&quot;consul-server&quot;}&lt;/code&gt;, which would show only the time series for which &lt;code class=&quot;language-text&quot;&gt;name == &quot;consul-server&quot;&lt;/code&gt;.
Prometheus also supports regular expressions, so instead of matching the full script you can do &lt;code class=&quot;language-text&quot;&gt;container_memory_usage_bytes{name=~&quot;^consul&quot;}&lt;/code&gt;, which would show something like this:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/2a7a760e3618b0ac5e2f4d9ba57082c5/0fcea/container_memory_usage_bytes_consul.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 66.25766871165644%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABb0lEQVQoz41S207DMAztJ/NNPPAn/ACTGCtIPLBN6zatt1wc2005SbeWISFx5J0dN47tOCnq+nKoDmfgdK7rumlba62xNmboMIzj+HUJD0+fj88n6CHGMQOrBTZUxwr7q+pYNwld17VtC+4BaIiuY2dd3zdNiwCsglGjOFZH1Nzt9tvt9jWjLMv3DOi39RpuudmsVi/4/7gBer/fF0iAAiEEZkY1uKpoNsEYE4gosPV0aTrj2QWFWVLWdJwCoT6IJRjWxGVtfMhuCvWsxIIsYi0bAxYw+XRmVIjTDG6TuNNYCxS9A49xiZh2FaDgrO87Mv1si2vROWoroUERxzxxEEGuAkcl/FThgydb9AAbIKaacYz3lee2/0JeHRRpRAKDNTMSFeklJF8S3+walEVwGB2lL6KCj5JbEk2VBR0y/9yQNF/1kIPm1n63Pd3q+E/EedopY2qbNZA6h6uVdK8wz4sm8fl1EIyU0gsQzJ+R6Bsz5/EIIKlP0wAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;container_memory_usage_bytes_consul.png&quot;
        title=&quot;container_memory_usage_bytes_consul.png&quot;
        src=&quot;/static/2a7a760e3618b0ac5e2f4d9ba57082c5/a6d36/container_memory_usage_bytes_consul.png&quot;
        srcset=&quot;/static/2a7a760e3618b0ac5e2f4d9ba57082c5/222b7/container_memory_usage_bytes_consul.png 163w,
/static/2a7a760e3618b0ac5e2f4d9ba57082c5/ff46a/container_memory_usage_bytes_consul.png 325w,
/static/2a7a760e3618b0ac5e2f4d9ba57082c5/a6d36/container_memory_usage_bytes_consul.png 650w,
/static/2a7a760e3618b0ac5e2f4d9ba57082c5/0fcea/container_memory_usage_bytes_consul.png 851w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;You can use any other dimension for filtering as well, so you can get metrics about all containers on a given host, in a given environment or zone.&lt;/p&gt;
&lt;h4 id=&quot;aggregation&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#aggregation&quot; aria-label=&quot;aggregation permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Aggregation&lt;/h4&gt;
&lt;p&gt;Similar to Graphite, Prometheus supports aggregation functions but due to its dimensions this gets even more powerful. Summing up the memory usage of all your “consul-*” works as expected with &lt;code class=&quot;language-text&quot;&gt;sum(container_memory_usage_bytes{name=~&quot;^consul&quot;})&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Now let’s say you want to see the difference in average memory usage between your ‘consul’ and ‘consul-server’ containers. This is achieved by providing the dimensions to keep in the aggregated result like this &lt;code class=&quot;language-text&quot;&gt;avg(container_memory_usage_bytes{name=~&quot;^consul&quot;}) by (name)&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/b0d3d92bda3203b73787ae1285ca75bc/b2cef/container_memory_usage_bytes_consul_by_name-1.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 76.07361963190185%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAABj0lEQVQoz6WS22rCQBCG86y9s1LSitCrthcteKHv0dIDhfY1hCqoiZIbRRFPjW6y2XO2s7sqaYNX/ZjAn8n+O7OT9bbbeD6fr5bL9Xodx/Fms0EIpWm6s1BKtdaUq4fP6f3HVKocXs1j8ZIErQ7AaudMLGkBjHGamDyyuAXecrGAyrPZbDKZBEHQ6/XCMBhZ+oZBGA6BTrfbHwRRFI0KeFmWmfYIEUKYakkKgktKOP5GqzjZJGSHKVrHC4SRyqUu4CmLOQmgc6EYEZhJopTMTU7lB2DNKBrW6rXLmv/y/mjMUkjKMyoxhLEJAga3sTM4XAE4eeer0263x+OxNVv0b3I70aJ539oh4/byhOWPrVz5mHHFOOcnK5fNxbIAWOD1/2Zo20w618fBOq3UUevD3J0Gy94MZ1b2m4vC+U+i7L7GrAptQzVBMrgjECBYhp2GAH38RDMMfg8Mb69P1crZdb1+cV5pNhqcZDncMUYVY4ISxZkL0CZptWTMVLbm5yu/enN75/t+s9VynZf/U3mcP2pMVkPwmdHiAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;container_memory_usage_bytes_consul_by_name&quot;
        title=&quot;container_memory_usage_bytes_consul_by_name&quot;
        src=&quot;/static/b0d3d92bda3203b73787ae1285ca75bc/a6d36/container_memory_usage_bytes_consul_by_name-1.png&quot;
        srcset=&quot;/static/b0d3d92bda3203b73787ae1285ca75bc/222b7/container_memory_usage_bytes_consul_by_name-1.png 163w,
/static/b0d3d92bda3203b73787ae1285ca75bc/ff46a/container_memory_usage_bytes_consul_by_name-1.png 325w,
/static/b0d3d92bda3203b73787ae1285ca75bc/a6d36/container_memory_usage_bytes_consul_by_name-1.png 650w,
/static/b0d3d92bda3203b73787ae1285ca75bc/b2cef/container_memory_usage_bytes_consul_by_name-1.png 847w&quot;
        sizes=&quot;(max-width: 650px) 100vw, 650px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;If you have services in multiple zones and configure the zone name as an additional label pair, you can also keep that dimension to show the memory usage per name and zone by using an expression like &lt;code class=&quot;language-text&quot;&gt;avg(container_memory_usage_bytes{name=~&quot;^consul&quot;}) by (name,zone)&lt;/code&gt;.&lt;/p&gt;
&lt;h4 id=&quot;using-prometheus--container-exporter&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#using-prometheus--container-exporter&quot; aria-label=&quot;using prometheus  container exporter permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Using Prometheus + Container-Exporter&lt;/h4&gt;
&lt;p&gt;As you know, I like to run everything in containers, including the container-exporter and Prometheus itself. Running the &lt;a href=&quot;https://github.com/docker-infra/container_exporter&quot;&gt;container-exporter&lt;/a&gt; should be as easy as this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;docker run -p 8080:8080 -v /sys/fs/cgroup:/cgroup \
           -v /var/run/docker.sock:/var/run/docker.sock prom/container-exporter&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now you need to install Prometheus. For that refer to the &lt;a href=&quot;http://prometheus.github.io/docs/introduction/install/&quot;&gt;official documentation&lt;/a&gt;. To make Prometheus pull the metrics from the container-exporter, you need to add it as a target to the configuration. For example:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;job: {
  name: &quot;container-exporter&quot;
  scrape_interval: &quot;1m&quot;
  target_group: {
  	labels: {
	    label: {
    		name: &quot;zone&quot;
        	value: &quot;us-east-1&quot;
	    }
        label: {
        	name: &quot;env&quot;
            value: &quot;prod&quot;
        }
    }
    target: &quot;http://1.2.3.4:8080/metrics&quot;
  }
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now rebuild your image as described in the documentation and start it. Prometheus should now poll your container-exporter every 60s.&lt;/p&gt;
&lt;h3 id=&quot;conclusion&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#conclusion&quot; aria-label=&quot;conclusion permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Conclusion&lt;/h3&gt;
&lt;p&gt;Because of Prometheus flexibility, its performance and minimal requirements, it’s the monitoring system of my choice.
This is why I introduced Prometheus beginning last year at Docker where we use it as our primary monitoring system.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Containerize your Infrastructure]]></title><description><![CDATA[The Hype Everyone is talking about containers.
Containers are a great way to bundle your application with all dependencies and isolate it…]]></description><link>https://5pi.de/2015/01/08/containerized-infrastructure/</link><guid isPermaLink="false">https://5pi.de/2015/01/08/containerized-infrastructure/</guid><pubDate>Thu, 08 Jan 2015 14:43:00 GMT</pubDate><content:encoded>&lt;h3 id=&quot;the-hype&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#the-hype&quot; aria-label=&quot;the hype permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;The Hype&lt;/h3&gt;
&lt;p&gt;Everyone is talking about containers.
Containers are a great way to bundle your application with all dependencies and isolate it from other applications running on the same host.
That’s all great but we never cared that much about containerization even though it exists for quite some time: chroot() was born 1979 and IBM had tech similar to containers on S/370 over 40 years ago.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 540px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/771312892d96c881b4ae67cf16d6b28c/09d21/mainframe.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 71.77914110429448%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAQFA//EABYBAQEBAAAAAAAAAAAAAAAAAAIAAf/aAAwDAQACEAMQAAABej1UwsSsbf/EABoQAAMAAwEAAAAAAAAAAAAAAAECEQADEjL/2gAIAQEAAQUCaKGcnc3NNgUFPWf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAcEAACAQUBAAAAAAAAAAAAAAAAARECEiExUWH/2gAIAQEABj8C0WapnhjKIceC6ybaT//EABsQAQADAAMBAAAAAAAAAAAAAAEAESExQVFh/9oACAEBAAE/Ib5RQcz4MfVTWYOH2MrZWjqJrfYmXDFmn//aAAwDAQACAAMAAAAQPz//xAAWEQADAAAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8QqKz/xAAYEQACAwAAAAAAAAAAAAAAAAAAAREhQf/aAAgBAgEBPxCGUsP/xAAdEAEAAwEAAgMAAAAAAAAAAAABABEhMUFRcYHx/9oACAEBAAE/EHQkFRvIOobCECev1AKFFGmPc2s2CdHlF34mxivri6uWBFy38n//2Q==&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Grumpy Ops&quot;
        title=&quot;Grumpy Ops&quot;
        src=&quot;/static/771312892d96c881b4ae67cf16d6b28c/09d21/mainframe.jpg&quot;
        srcset=&quot;/static/771312892d96c881b4ae67cf16d6b28c/d2f63/mainframe.jpg 163w,
/static/771312892d96c881b4ae67cf16d6b28c/c989d/mainframe.jpg 325w,
/static/771312892d96c881b4ae67cf16d6b28c/09d21/mainframe.jpg 540w&quot;
        sizes=&quot;(max-width: 540px) 100vw, 540px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;So why all the hype right now? It’s not like we just started with all that.
There are various use cases for containers but here I’ll focus on use them as building blocks in modern IT infrastructures.&lt;/p&gt;
&lt;h3 id=&quot;infrastructure-evolution&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#infrastructure-evolution&quot; aria-label=&quot;infrastructure evolution permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Infrastructure evolution&lt;/h3&gt;
&lt;p&gt;If we look back 10 or maybe 15 years, things looked very differently.
It’s not particular news that software eats the world and every company today is, at least partially, an IT company. But back in the 90s, IT was still something for rather specialized companies. Finance, Insurance, Government, Health care. Basically companies juggling lots of numbers.&lt;/p&gt;
&lt;p&gt;Big and monolithic software and services designed by a waterfall model. Release cycles in the terms of months and large Ops departments managing them. All scaled mostly vertically by just buying bigger boxes.
Things happened really slow back in the days. Despite the fact that there are still lot of companies stuck back then, even in traditionally more conservative businesses like finance you see &lt;a href=&quot;https://www.youtube.com/watch?v=6FPXbQ2WpAM&quot;&gt;a radical shift towards agile development methodologies&lt;/a&gt;. Why this is a crucial move and I don’t belive any company will survive without being “agile” is probably a topic for another blog article.&lt;/p&gt;
&lt;p&gt;Fact is, today things are different. To be agile means to be fast, to be able to adapt to a changing environment quickly. The result is a infrastructure optimized for change. Instead of having monolithic application where every change needs to be coordinated with every stakeholder, such infrastructures consist of dozens of loosely coupled (micro)services with independent teams iterating on them, scaled horizontally across hybrid infrastructures with some workload on bare metal, other on cloud instances.
Instead of a release every few weeks, it’s not uncommon to deploy multiple times a day fully automated by CI/CD pipelines.&lt;/p&gt;
&lt;h3 id=&quot;challenges&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#challenges&quot; aria-label=&quot;challenges permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Challenges&lt;/h3&gt;
&lt;p&gt;Now we have more services, more changes, more systems and arguably less time to market. Fact is, it’s incredibly hard to really understand such infrastructure. Just think about what it means to manage a single service. To deploy it, monitor it, update it.  Now multiply by a few dozens. The millions of knobs and billions of permutations. Nobody can manage that.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 500px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7971ab1879abb9b42b152dd5b66ef7bf/0b533/automate.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 71.16564417177914%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAARlAAAEZQAGA43XUAAACpUlEQVQoz2WSX0hTURzHL71EPRQEYdKfJ+k5fCuwfyS9FNaDQVEvFSEpQUlGUVZvCaULs6WZzMVmbopbTofO6cY29ydszrurMzdpzrmbbq2pm3nv+Z3T2a6zsB+Xc7+/c87n9/2dw2FIPjwez/DwsMvlslqtHMfZbDYq3G43FXRpZGTE6XRSzbIs3YwxpiMj/QBAp9PV1b3o7OxUKpUqlYqmJpNJLpdrNBq73W42m2lpmUxmNBr/wpItTcbHvQZDn8fjnpzkHA67xWKhmjK0l6EhEx2dTrte3+vz+bfC+RBz39YQRbS6ms7JFUJSkt2/MNBaojghiHcwpBEkEVoBvIDQMp1f+z0bDPkQalsXqhEk/odzOSYIjiA4iuAj4FpBvA94lJDWTOZYfKkU450AY5KTBDB5SkQwm7u5egQMJrtisf2h0LVU6iofOxWNFiWTdGd97qSCZLvpjNNpgpARwT0E/Qj2YsJw3AWf72uH+p1aPehnn8XjJfTseIMCyTwLz89PBwINPB9B6JGItiPYLSImGHxYWVnDMMzFsvKF6JdIpIaQEAAGGBBRFybrG3AkMpFavrUYb8ysBQAKadt0Pr5U1PFJQ+HjpWdCVkeULSTkhiCUiWIFxmGp3ywsrIuJX99M2jrW9YaQkxgzP5M7wmHm+0yN/FWbTtsxV/w29vogJtuEtZbNq5acaStUGNyOCnl9lUp92mw+8Vn/dGDwrrLtvK5d0dOoMFxvGGh+3tNXbewfDc/dJqQWQSoPZws5LNbLvQZO1vBB232uubm1S8u2tFY1Nd5s79arbXo765c3aVreK/z+B4ToMc7k3nb2rSGqwmFVMHTAN1aseHl4anrf1OShYKzAe6l8as+TQMFjd8mVwOxZr9cxM/OD59M8vxhPJP4Am7mrZKG2PFsAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Automate all the things&quot;
        title=&quot;Automate all the things&quot;
        src=&quot;/static/7971ab1879abb9b42b152dd5b66ef7bf/0b533/automate.png&quot;
        srcset=&quot;/static/7971ab1879abb9b42b152dd5b66ef7bf/222b7/automate.png 163w,
/static/7971ab1879abb9b42b152dd5b66ef7bf/ff46a/automate.png 325w,
/static/7971ab1879abb9b42b152dd5b66ef7bf/0b533/automate.png 500w&quot;
        sizes=&quot;(max-width: 500px) 100vw, 500px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;So what do we do? We automate.
Historically, you had some (shell) scripts to manage things in a imperative way. Whether it’s creating some users or deploying an app.&lt;/p&gt;
&lt;p&gt;Nowadays almost everyone uses some sort of configuration management systems. The mother of modern configuration management is probably &lt;a href=&quot;http://en.wikipedia.org/wiki/CFEngine&quot;&gt;CFEngine&lt;/a&gt;, even though the idea goes back to the &lt;a href=&quot;http://en.wikipedia.org/wiki/Configuration_management#History&quot;&gt;50s&lt;/a&gt;.
As oppose to the imperative approach, the idea here is declarative. You describe the desired state of your infrastructure and have some logic in place to actual tune all those knobs. Running you config management tool &lt;em&gt;converges&lt;/em&gt; your infrastructure towards the desired state. In theory, no matter what state your system is in right now, the configuration management system will converge the system to the desired state eventually.&lt;/p&gt;
&lt;p&gt;A big advantage over the imperative approach. But in reality, there are just too many knobs and unexpected side effects for this to be very reliable.
In the end, state convergence helps with managing change in your infrastructure but it doesn’t make the infrastructure itself simpler. You still first need to understand all the dependencies and interactions between your knobs. You need to somehow reduce the complexity, the number of knobs.&lt;/p&gt;
&lt;h3 id=&quot;managing-complexity&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#managing-complexity&quot; aria-label=&quot;managing complexity permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Managing Complexity&lt;/h3&gt;
&lt;p&gt;The most important aspect of managing any kind of system is to understand it. To understand how various components influence each other, which parts are healthy and which not and ultimately understand the effects of every possible change to your infrastructure.
Containers help to manage complexity.&lt;/p&gt;
&lt;h4 id=&quot;abstraction&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#abstraction&quot; aria-label=&quot;abstraction permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Abstraction&lt;/h4&gt;
&lt;p&gt;Every time the cognitive overhead imposed by a system growing in complexity reaches a certain threshold, people start to &lt;em&gt;abstract&lt;/em&gt; things.
It probably started in human communication. We don’t have to be biologists to talk about cats. We don’t need to understand every intrinsic &lt;em&gt;implementation detail&lt;/em&gt;. Same for classes or modules in programming languages. And the same is true for containers: They are an abstraction around a specific application, abstracting all its implementation details and provide a generic interface shared by all other applications. All the knobs are still there, but you hide those you don’t care about.&lt;/p&gt;
&lt;p&gt;Given the common interface among all your applications, all your systems are doing is running containers. Your DB servers? Running containers. Your application servers? Running containers. Which means instead of having a bunch of servers for different use cases, you only have servers running containers. This allows for systems like cluster schedulers to abstract away the servers and just present a block of resources to run containers on.&lt;/p&gt;
&lt;p&gt;You might argue that the complexity isn’t gone, it’s just hidden and that’s true. But the same is true for abstractions in linguistics. Stereotypes are abstractions as well and they often do not accurately reflect reality. Just take Gender as an example. It’s important to keep in mind that &lt;a href=&quot;http://www.joelonsoftware.com/articles/LeakyAbstractions.html&quot;&gt;all abstractions are leaky&lt;/a&gt; and you still need to understand the implementation details or layers below. But you don’t need to think about them all the time.&lt;/p&gt;
&lt;h4 id=&quot;ownership&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#ownership&quot; aria-label=&quot;ownership permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Ownership&lt;/h4&gt;
&lt;p&gt;Especially if a company grows fast, bottlenecks arise. If your company started with five friends sitting around a desk and bouncing ideas back and forth, everything is fine. Every problem is apparent and can be solved quickly by whoever has the necessary time and skills.
Once you grow larger, this isn’t possible anymore. Suddenly you need to send mails to request resources from other teams or even pull out the &lt;em&gt;global write lock&lt;/em&gt; sledgehammer called “meeting” to coordinate change.
Containers can help by enforcing a clean separation of concern between the teams providing resources by operating systems to run containers and the teams running containers on them. If your develpment team needs to deploy a new application, it’s just another container. They don’t care where it runs. If the infrastructure team needs to provide more resources, they just provide a new system to run containers on.&lt;/p&gt;
&lt;h4 id=&quot;immutability&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#immutability&quot; aria-label=&quot;immutability permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Immutability&lt;/h4&gt;
&lt;p&gt;The great thing about computers is their versatility. It’s a general purpose device which can be programmed to solve specific tasks. You can install various software on your server, remove it again, change configuration files, set OS settings. You can change the &lt;em&gt;state&lt;/em&gt; of your machine whenever you want. Remember, this is how configuration management handles change in your infrastructure. Mutating the current state until you get to your desired state. The complexity arises from the fact that every state mutation leads to a new initial condition for all further operations in your system. Configuration management tries to account for all this, but in reality you often end up in states where your assumptions don’t apply anymore and you need to manually intervene.
Containers are usually, and as implemented by Docker, based on immutable images. Build- and runtime are clearly separated. Once built, your application, all its dependencies and even parts of your configuration are baked into your images. Even though &lt;a href=&quot;https://github.com/docker/docker/issues/7923&quot;&gt;Docker doesn’t enforce it yet&lt;/a&gt;, conceptually by default the container doesn’t change. From deployment to removal, it stays the same and there won’t be a new initial condition which need to be considered for further operations on the system.
Of course, your infrastructure isn’t immutable. You most likely store and process data and with every deploy the state of your infrastructure changes as well. And you probably want some dynamic configuration to avoid a redeploy just because some backend IP changes. But by keeping possibility for change small, having clear definitions of what can and what can’t change, what is state that is supposed to change during runtime as opposed to state frozen at built time, it reduces the cognitive overhead required to understand an infrastructure at a given point in time.&lt;/p&gt;
&lt;h3 id=&quot;container-vs-vms&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#container-vs-vms&quot; aria-label=&quot;container vs vms permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Container vs VMs&lt;/h3&gt;
&lt;p&gt;Some might argue that all this is possible with VMs already and conceptually this is entirely true. Although in practice the overhead imposed by virtualization make it less feasible to run every little service in their own VM. And once you start making exceptions, you need to manage those exceptions, so you need to account again for mutable systems and raw applications with all their knobs.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Using docker run --net=container:XX ... to debug network issues]]></title><description><![CDATA[Sharing the network namespace with a existing container is a less known feature of Docker. If you run: Your container runs in the same…]]></description><link>https://5pi.de/2014/11/13/using-docker-run-netcontainerxx-to-debug-network-issues/</link><guid isPermaLink="false">https://5pi.de/2014/11/13/using-docker-run-netcontainerxx-to-debug-network-issues/</guid><pubDate>Thu, 13 Nov 2014 23:04:22 GMT</pubDate><content:encoded>&lt;p&gt;Sharing the network namespace with a existing container is a less known feature of Docker. If you run:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;docker run --net=container:my-existing-container ...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Your container runs in the same network namespace, sharing the same network configuration as &lt;code class=&quot;language-text&quot;&gt;my-existing-container&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;This is very useful for debugging purposes: I just wanted to verify the current outgoing connections from a container in our infrastructure and realized that due to the network scoping that’s not easily possible. You can use &lt;code class=&quot;language-text&quot;&gt;ip netns exec&lt;/code&gt; but that assumes you have the namespace mounted to &lt;code class=&quot;language-text&quot;&gt;/var/run/netns&lt;/code&gt;. You can symlink things around but it’s ugly. Much nicer:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;docker run -t -i --net=container:my-existing-container --rm ubuntu netstat -anp&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[Running a highly available load balancer on Docker]]></title><description><![CDATA[For quite some time I felt like I should do a blog - again. Instead of spending time writting rants on facebook or commenting other peoples…]]></description><link>https://5pi.de/2014/11/10/running-a-highly-available-load-balancer-on-docker/</link><guid isPermaLink="false">https://5pi.de/2014/11/10/running-a-highly-available-load-balancer-on-docker/</guid><pubDate>Mon, 10 Nov 2014 19:18:57 GMT</pubDate><content:encoded>&lt;p&gt;For quite some time I felt like I should do a blog - again. Instead of spending time writting rants on facebook or commenting other peoples posting, I should write some blog articles!
Thing is, it’s not that easy. Where to start? What should I talk about? What are you interested in reading?&lt;/p&gt;
&lt;p&gt;Instead of diving into abstract thoughts about the universe and human kind, I’ll just present you how to run a highly available load balancer on Docker!&lt;/p&gt;
&lt;h3 id=&quot;components&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#components&quot; aria-label=&quot;components permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Components&lt;/h3&gt;
&lt;p&gt;For the load balancing part I’ve choosen haproxy. Since 1.5 it supports SSL termination. Since SSL is expensive, compared to running haproxy without it, we enable multiprocess support by specifying nbproc. Each request now may be handled by a different process. This is a problem for the stats endpoint: Since this endpoint exposes internal state which can’t be shared across multiple processes, you only get stats for the process which handles the current request.
To still get metrics for all processes, you need to create a listen endpoint for each process and pin it to that process like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;listen stats01 :8001
  stats uri /
  stats auth admin:foobar23
  bind-process 1
  stats enable

listen stats02 :8002
  stats uri /
  stats auth admin:foobar23
  bind-process 2
  stats enable

listen stats03 :8003
  stats uri /
  stats auth admin:foobar23
  bind-process 3
  stats enable
...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;With all that in place we can terminate SSL and load balance across multiple hosts but we still need to make this highly available.
There are several ways to do that. I really like ECMP routing but that requires access to the routing layer which I don’t have. Then there is IPVS which is a good fit if you need to scale to multiple load balancers but it’s also harder and more complex to setup in my opinion.
Because of that, I decided for UCARP which is a implementation of the CARP protocol for linux. CARP is similar to VRRP but patent free and uses cryptography to make it resilient against attackes on the protocol.
When running, it makes sure that there is only one CARP master and executes hooks to add or remove IP adresses.&lt;/p&gt;
&lt;h3 id=&quot;docker-image&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#docker-image&quot; aria-label=&quot;docker image permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Docker Image&lt;/h3&gt;
&lt;p&gt;I wrapped that all up in a easy to use &lt;a href=&quot;https://registry.hub.docker.com/u/fish/haproxy/&quot;&gt;Docker image&lt;/a&gt;.
To configure haproxy and nginx, you can bind-mount the config location like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;$ docker run \
-v /path/to/haproxy.cfg:/haproxy/haproxy.cfg \
-v /path/to/nginx.d:/haproxy/nginx.d/ \
--net=host --privileged fish/haproxy  \
10.0.1.201 foobar23 [...additional IPs]&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;—net=host is required to access the real hosts interfaces. Privileged is necessary to allow the container to bind IPs. Instead of privileged mode, you probably can use —cap-add=NET_ADMIN&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;This will run nginx+haproxy+ucarp and make it listen on 10.0.1.201. You can start the same on another host in the same network and ucarp will make sure only one listens on 10.0.1.201. If you kill the active container, the passive one will failover.&lt;/p&gt;
&lt;p&gt;Since bind-mounting makes things host dependent, I prefer using the fish/haproxy image as a base image and add my deployment specific configuration in a separated Dockerfile like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;FROM fish/haproxy
ADD  . /haproxy
RUN  haproxy -c -f /haproxy/haproxy.cfg&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;The last RUN serves as a cheap test; It will prevent the build from suceeding if the configs are malformed&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;This Dockerfile overwrites haproxy.cfg and nginx.d/ in the image by using the files in the local directory.
Just build it with:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;$ docker build -t my-lb .&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And run it as above. This has the downside that you need to rebuild the image on configuration changes and recreate the container to deploy it.&lt;/p&gt;
&lt;h3 id=&quot;service-discovery&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#service-discovery&quot; aria-label=&quot;service discovery permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Service Discovery&lt;/h3&gt;
&lt;p&gt;If you’re using some configuration management system, you can just render the config on the host and bind-mount it. Still better than running you CM inside a container.
A much better solution is to use some kind of service registry for discovery of your backends. I haven’t found time for that yet, but I would suggest looking into &lt;a href=&quot;http://consul.io&quot;&gt;consul&lt;/a&gt;, &lt;a href=&quot;https://github.com/progrium/registrator&quot;&gt;registrator&lt;/a&gt; and &lt;a href=&quot;https://github.com/kelseyhightower/confd&quot;&gt;confd&lt;/a&gt;.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Hire me]]></title><description><![CDATA[Did you know? You can hire me! I grew infrastructures from a handful engineers and thousands of users to platforms with hundreds of millions…]]></description><link>https://5pi.de/hire-me/</link><guid isPermaLink="false">https://5pi.de/hire-me/</guid><pubDate>Sat, 01 Jan 2000 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;&lt;a title=&quot;See page for author [Public domain], via Wikimedia Commons&quot; href=&quot;https://commons.wikimedia.org/wiki/File%3APetin_viewing_airship_platform.jpg&quot;&gt;&lt;img width=&quot;1024&quot; alt=&quot;Petin viewing airship platform&quot; src=&quot;https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/Petin_viewing_airship_platform.jpg/1024px-Petin_viewing_airship_platform.jpg&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;did-you-know-you-can-hire-me&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#did-you-know-you-can-hire-me&quot; aria-label=&quot;did you know you can hire me permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Did you know? You can hire me!&lt;/h2&gt;
&lt;p&gt;I grew infrastructures from a handful engineers and thousands of users to platforms with hundreds of millions of users and dozens of teams, each with dozens of engineers. This taught me valuable lessons about building, operating and scaling infrastructure.&lt;/p&gt;
&lt;p&gt;While one size does not fit all, doing things right the first time will not only save time refactoring. A good infrastructure is a resilient foundation for your service that supports the agility you need early on without much ramp up costs. A bad infrastructure not only requires manual operation but also slows down every single engineer, preventing them from being confident in changes, which leads to accumulation of technical debt and can end in a grid lock across engineering.&lt;/p&gt;
&lt;p&gt;I’ve seen them all. The good, the bad and the outright ugly. Enterprise and startup. And I’ve built, fixed and deployed technology like &lt;a href=&quot;/tag/docker/&quot;&gt;Docker&lt;/a&gt;, &lt;a href=&quot;/2016/11/20/15-producation-grade-kubernetes-cluster/&quot;&gt;Kubernetes&lt;/a&gt; and &lt;a href=&quot;/2015/01/26/monitor-docker-containers-with-prometheus/&quot;&gt;Prometheus&lt;/a&gt; to address those issues. I know &lt;a href=&quot;/2015/04/22/scope-and-ownership-in-tech-companies/&quot;&gt;what to buy and what to build&lt;/a&gt; and patterns to &lt;a href=&quot;http://5pi.de/2015/08/31/dont-manage-config-unless-you-have-to/&quot;&gt;manage complexity&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Now I want to help you with your infrastructure!&lt;/p&gt;
&lt;h2 id=&quot;inquiry&quot; style=&quot;position:relative;&quot;&gt;&lt;a href=&quot;#inquiry&quot; aria-label=&quot;inquiry permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Inquiry&lt;/h2&gt;
&lt;p&gt;Building something new and want to avoid the common and not-so-common pitfalls?
Your developers can’t iterate quickly, you miss deadlines and need help figuring out how to fix that?
Do you need help with your Kubernetes cluster, Prometheus monitoring or bare metal infrastructure automation?&lt;/p&gt;
&lt;p&gt;You can email me at &lt;a href=&quot;mailto:inquiry+hire@5pi.de?subject=Inquiry%3A&quot;&gt;inquiry+hire@5pi.de&lt;/a&gt; or use the following &lt;a href=&quot;https://formspree.io&quot;&gt;formspree.io&lt;/a&gt; form:&lt;/p&gt;
&lt;form method=&quot;POST&quot; action=&quot;https://formspree.io/inquiry+hire@5pi.de&quot;&gt;
  &lt;input name=&quot;email&quot; placeholder=&quot;Your email&quot; type=&quot;email&quot;&gt;&lt;br /&gt;
  &lt;textarea name=&quot;message&quot; placeholder=&quot;Your message&quot;&gt;&lt;/textarea&gt;&lt;br /&gt;
  &lt;button type=&quot;submit&quot;&gt;Send&lt;/button&gt;
&lt;/form&gt;&lt;br /&gt;
&lt;p&gt;Find my pgp key &lt;a href=&quot;https://keybase.io/fish/pgp_keys.asc&quot;&gt;here&lt;/a&gt; if you wish to encrypt the message.&lt;/p&gt;
&lt;p&gt;I’m located in Berlin but available to travel and used to work remotely (PT 1am-11am, UTC 9am-7pm).&lt;/p&gt;</content:encoded></item></channel></rss>