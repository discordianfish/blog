{"componentChunkName":"component---src-templates-blog-post-js","path":"/2018/12/18/why-kubernetes-at-small-scale/","result":{"data":{"site":{"siteMetadata":{"title":"5π Consulting","author":"Johannes 'fish' Ziemke"}},"markdownRemark":{"id":"97d14d69-d66a-53df-8b50-7885e796aebf","html":"<h2 id=\"google-scale-wannabes\" style=\"position:relative;\"><a href=\"#google-scale-wannabes\" aria-label=\"google scale wannabes permalink\" class=\"anchor before\"></a>Google Scale Wannabes</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/634d60838678047c8b9f6f323a3a9be1/00d43/wannabe.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.900000000000006%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABzElEQVQoz0WR7UtTcRTH77/Rf9F/YG+CkAgq9qKYLzJ6UUOpYSEWa1k0hfIhx6QszIYPueUSjFB28aEXW3iXA20lkjG1NZrObXfebe7+7qfb3dID5/wO53zOi9/3K3VOlWgf1+h4q5HMCEBgUAtD6Fb/P4UQ9Q50o8rQ2iSFslpjLV4gyV+r1qBYNiFRh3/tYKS2OYpi3BzWDnOaILlrUKwccjfSS05osLONKNb20r8ST+o8mc7zKgqZ8AL77juk2p2o82GqSTf7URv6ahNbqZT1k/tBDac/S8eyj83ACOm2VrK3Hejp30jftjTGh1/g7Apxtv8A5dp15rwPmQnOkWo5R+bTKbpdgyyPNeB7/oiBmQKRWIIzbTKn+y+zZGvky00n+akJxN4uUutwgavujzi8PxhcKjH7oItYw0kSzXbiPi8b8kU+PzvBvJlNjk5ckyqe93nO35Kx91xA6fOw2nyFPy99GNk9pHS2wo3Hi7gHwihr63yYXmDW1kLiXcjS5Ofmd0a9lwi86cX1NMi91xvYu+PYXQq+vh4WVxJE/BOoK8qxhlChrB2gFjXLWVNmDo8toazXX9O/IbmEJ6Qix3NEY+v4x4KMBEJH7F8Rm9MLcOmaHgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Google - Wannabe\"\n        title=\"Google - Wannabe\"\n        src=\"/static/634d60838678047c8b9f6f323a3a9be1/a6d36/wannabe.png\"\n        srcset=\"/static/634d60838678047c8b9f6f323a3a9be1/222b7/wannabe.png 163w,\n/static/634d60838678047c8b9f6f323a3a9be1/ff46a/wannabe.png 325w,\n/static/634d60838678047c8b9f6f323a3a9be1/a6d36/wannabe.png 650w,\n/static/634d60838678047c8b9f6f323a3a9be1/e548f/wannabe.png 975w,\n/static/634d60838678047c8b9f6f323a3a9be1/00d43/wannabe.png 1000w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\nI’ve frequently hear people say something like this:</p>\n<blockquote>\n<p>The number of people who adopt complicated stuff like Kubernetes for what is\nessentially a couple of web servers and a database is too high. They’re Google\nwannabies that thinks in Google’s scale but forget that it is utterly\nunnecessary in their case.</p>\n<p><cite>reacharavindh, <a href=\"https://news.ycombinator.com/item?id=18128235\">https://news.ycombinator.com/item?id=18128235</a></cite></p>\n</blockquote>\n<p>They have a point. Kubernetes is touted as container orchestration system. You\nrequest resources for your container and it will automatically figure out where\nto run it. This is important once you have more than a handful of systems to\nensure good utilization without having a human to play tetris shuffling your\napplications around. It’s API and <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/rbac/\">Role-based access\ncontrol</a> allows\nyou to support many developer without a Ops person or team becoming the\nbottleneck.</p>\n<p>These things are certainly more important at Google’s scale than in a small\nshop. You might have just 4 VMs, an application and a reverse proxy. A typical\nsmall web startup, maybe 2-3 developer. At that scale it wouldn’t be a problem\nto manually update the operating system, figure out where to run your\napplication and move it around when needed.</p>\n<p>That’s why people think introducing a complex system like Kubernetes can’t be\npossible worth it. I believe they miss something: Kubernetes is not only a\ncluster scheduler, it’s also an opinionated infrastructure framework.</p>\n<h2 id=\"kubernetes-love\" style=\"position:relative;\"><a href=\"#kubernetes-love\" aria-label=\"kubernetes love permalink\" class=\"anchor before\"></a>Kubernetes love</h2>\n<p>Let’s get this out the way first: I love Kubernetes and these days I make most\nof my money helping companies to build their infrastructure around Kubernetes.\nNot primarily because it’s hyped and lot of people want help migrating to it but\nbecause it’s my tool of choice after building infrastructure for a decade\nwithout it:\nI’ve built infrastructure in pre-config management enterprise environments, used\nchef to built infrastructure serving millions of\nusers and dabbled in Ansible and Salt.</p>\n<p>I concluded that robust abstractions are the key to manage large and complex\ninfrastructure. Making your <a href=\"https://5pi.de/2015/03/13/building-aws-amis-from-scratch/\">(virtual) machines\nimmutable</a> limits\nchange to your machines to the build time of your images. Running your\napplication in\n<a href=\"https://5pi.de/2015/01/08/containerized-infrastructure/\">containers</a> does the\nsame for your application. For configuration, you can <a href=\"https://5pi.de/2015/08/31/dont-manage-config-unless-you-have-to/\">bake\nin</a> site\nspecific config at build time to reduce what you need to worry about at runtime.</p>\n<p>These patterns are largely deployment agnostic. While immutable machine images\nare common on cloud providers, it’s reasonable to do the same when provisioning\nbare metal. Application images are made popular by Docker, but people used\n<a href=\"https://en.wikipedia.org/wiki/Chroot\">chroot</a> based deployment long before that\nto achieve similar goals.</p>\n<p>But Kubernetes is a opinionated, vendor agnostic framework based on all the\nconcepts I learned to help with managing infrastructure.</p>\n<h2 id=\"snowflake-infrastructure\" style=\"position:relative;\"><a href=\"#snowflake-infrastructure\" aria-label=\"snowflake infrastructure permalink\" class=\"anchor before\"></a>Snowflake Infrastructure</h2>\n<p>Let’s stay with the small web shop example for a moment:</p>\n<ul>\n<li>2x reverse proxies, terminating TLS and sending requests to..</li>\n<li>2x webservers which connect to..</li>\n<li>1x database</li>\n</ul>\n<p>For the sake of the argument, let say the database is a managed service. If it’s\nnot, even more reason to use Kubernetes. Let say you’re on AWS, but that doesn’t\nreally matter either.</p>\n<h3 id=\"provisioning\" style=\"position:relative;\"><a href=\"#provisioning\" aria-label=\"provisioning permalink\" class=\"anchor before\"></a>Provisioning</h3>\n<p>Without Kubernetes, you could click yourself two VMs and an ALB or ELB. Next you\nconfigure your TLS certificates, either by purchasing them or using AWS\nCertificate Manager to create one automatically.\nOr use Cloudformation to manage this if you want infrastructure-as-code. Now you\ncan give your VMs well-known DNS names and use rsync to deploy to it. Or do you\nappreciate Docker’s isolation? Then build, push, pull and run your images. Maybe\nwrite a shell script for that.</p>\n<p>Now copy your database secrets there somehow. You probably want to monitor this\nwith the tool of your choice.  Where to deploy it? Maybe create a new VM. Make\nsure it can reach the systems by allowing whatever protocol it uses. Hardcode\nthe well-known VM names into your monitoring. Or maybe use the AWS API to\nautomatically update this. You could write a small shell script for that. You\nmight also consider using configuration management at this time. Maybe you come\nup with good roles/cookbooks/scripts to configure monitoring, after deciding how\nto lay out your deployment. Maybe you create systemd unit, maybe you deploy\nrunit..</p>\n<h3 id=\"access-on-offboarding\" style=\"position:relative;\"><a href=\"#access-on-offboarding\" aria-label=\"access on offboarding permalink\" class=\"anchor before\"></a>Access, On-/Offboarding</h3>\n<p>Maybe you’re the move-fast-break-things kind of person and\ngrant each developer full access, so they can work on their own. At this point\nyou probably already need an informal ‘process’ like: “Ping people in #infra\nslack channel before deploying so we know what is going on.”.</p>\n<p>Maybe you’re more paranoid and you decide there is one person which full access\nacting as gatekeeper. But since you’re paranoid, you worry about the <a href=\"https://en.wikipedia.org/wiki/Bus_factor\">bus\nfactor</a>. You still need some sort of\nprocess to make sure changes aren’t conflicting.</p>\n<p>Now an engineer leaves the company. You need to rotate all secrets. You need to\nmake sure you remember all the secrets that are used. At this point you have\nwritten thousand lines of configuration management scripts that manages among\nothers all application secrets, managed database secrets, TLS keys. Or you have\nup-to-date documentation. Or you don’t and you need to think hard about all\nplaces you might have configured secrets.</p>\n<p>A new engineer needs onboarding. Maybe he is a senior engineer who did DevOps at\nmany places. If you have good, up-to-date documentation you might be able to\nfigure out how to contribute and deploy. With configuration management, he might\ntake a few days to understand how things are be done from that. Without any of\nthese, he’ll just pair with other engineers and eventually figure out how things\nare done. He needs to be careful to understand all the decisions implied by how\nthings are setup or risks driving development in the opposite direction.</p>\n<h3 id=\"no-problem-at-small-scale\" style=\"position:relative;\"><a href=\"#no-problem-at-small-scale\" aria-label=\"no problem at small scale permalink\" class=\"anchor before\"></a>No Problem at small scale</h3>\n<p>You’ll probably find a good way to make this work. New employees are onboarded\nquickly, everyone can work distraction free without stepping on each other toes.\nIt’s just a small team after all, especially if you’re sitting all in one office\nthis isn’t too hard.</p>\n<p>But given all the decisions you had to make, you certainly end up with a\ncloud provider specific <em>snowflake infrastructure</em>. Even in this small problem\nspace, there is probably not a single company out there with exactly your setup.</p>\n<h2 id=\"kubernetes-infrastructure\" style=\"position:relative;\"><a href=\"#kubernetes-infrastructure\" aria-label=\"kubernetes infrastructure permalink\" class=\"anchor before\"></a>Kubernetes Infrastructure</h2>\n<p>Kubernetes is an opinionated framework. Every resource in your infrastructure is\nabstracted as a <a href=\"https://kubernetes.io/docs/concepts/#kubernetes-objects\">Kubernetes\nObject</a>. Deployable\nworkloads on a single system are Pods. ReplicaSets are workloads that should be\nreplicated across systems. Deployments are versioned, replicated workloads.\nServices provide Endpoints which is how you connect to the Pods in your cluster.</p>\n<p>All these are complex, layered but powerful abstractions. They are powerful\nbecause from the infrastructure management perspective they cover all aspects of\nall possible resources in your cluster. If an abstraction doesn’t provide the\nbehaviour needed for your resources, you can define <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/\">Custom\nResources</a>\nand deploy/write an <a href=\"https://coreos.com/operators/\">Operator</a> for this.</p>\n<h3 id=\"now-how-does-this-help-with-the-concerns-a-small-shop-has\" style=\"position:relative;\"><a href=\"#now-how-does-this-help-with-the-concerns-a-small-shop-has\" aria-label=\"now how does this help with the concerns a small shop has permalink\" class=\"anchor before\"></a>Now how does this help with the concerns a small shop has?</h3>\n<p>Kubernetes is workload agnostic, so it allows you to deploy whatever you want on\nit. That means all Kubernetes cluster is all you need. You don’t need to setup\nVMs, ALB/EBS or any other infrastructure beside the Kubernetes cluster itself.\nThere is no need to run anything outside of Kubernetes. And most cloud providers\nthese days provide the cluster management to you for free.</p>\n<p>The biggest advantage though is that it’s not a <em>snowflake infrastructure</em>\nanymore:</p>\n<ul>\n<li>For everything in your infrastructure, you have a (ideally) version controlled\nmanifest</li>\n<li>Ingress objects are used to configure what can be reached under which names</li>\n<li>The TLS certificate is referred to explicitly and easy to find</li>\n<li>A deployment is always an image with a version/tag.</li>\n<li>The API tells you what is running and what is suppose to be running</li>\n<li>It also allows you to configure your monitoring automatically</li>\n<li>You allow developers to update their application without granting them access\nto secrets</li>\n<li>You have access to plenty of operators should you want to operate your own\ndatabase or want to automate and abstract message queue management</li>\n<li>Migrating to other cloud providers or bare metal is much easier</li>\n</ul>\n<p>A new hire who is familiar with Kubernetes will understand what deployments you\nhave, how much resources they need, how they access other systems and how\nrequests are routed. They know how to deploy changes and how to debug their\napplication.</p>\n<p>Since Kubernetes resources are configured entirely by YAML manifests, all\nconfiguration management need you might have boils down to manifest generation.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"></a>Conclusion</h2>\n<p>With Kubernetes we can build solution to infrastructure management problems that\nwork for everyone without having to resort to <a href=\"/2015/08/31/dont-manage-config-unless-you-have-to#issues-with-chef\">weak abstractions that regular\ninfrastructure-as-code solutions\nhave</a>.\nThere is no such thing as free lunch but these are ramp-up costs. The patterns\nyou applied to solve a problem once, can be applied to all future problems. And\nthis goes both ways: Engineers familiar with Kubernetes will benefit from that\nin all Kubernetes infrastructures. Companies that adopt Kubernetes will be able\nto hire people who know how their infrastructure work before you even started\nonboarding.</p>\n<p>So should <em>you</em> run on Kubernetes? It still depends. Maybe you want to do\nsomething more serverless. Then have a look at\n<a href=\"https://www.heroku.com/\">Heroku</a> or <a href=\"https://cloud.google.com/appengine/\">Google App\nEngine</a>. If your service is mostly a backendless\nweb project, check out <a href=\"https://www.netlify.com/\">netlify</a> and use <a href=\"https://aws.amazon.com/lambda/\">AWS\nLambda</a> for the necessary logic.</p>\n<p>But if you need to build, deploy, update, configure and monitor applications\nrunning on servers spend time understanding what it really takes to get you\nwhere you want and whether it’s really less work than adopting Kubernetes.</p>","frontmatter":{"title":"Why Kubernetes at small scale?","date":"December 18, 2018","image":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAByklEQVQozz2R70tTYRTH75/Qn5K9CaK/IRHfFYOCINDIykKbuhpuwSrMQBODsMZMJ1O8CM0W7ZfasiEz5ybO7hitzfXC/dC1u7nd+3E9S8/D4XzP+RweeL6PlMlrmOdVBucqWBdV8mUN0JunFbpWF1qkrosETbCVTBhPakVoMWkyyehU+a40xLDw93QV6tEIei7TaqrNehjkNKLpY4pH4Ep8ZjblabIKtURcMOm+QxXCt1XmsbPA26/Ni+1T7D81kTUNoUaWKG9d57f/GiQH+bBWx7JQxOjQ6JLdzHjHKJiekL5loOqWkR45a6zGSkyNv6B31MfVkSxxQyeLrvd4rWPkhi+yvWzA0jdMcqmNG7YwG7Ek5jc7nO8z8nzoCvH2TlLTdvTdGNLPPzoPHSU6+n10T2SYWT/A3fWA+OUL7N69zQ/PPAn5EpuT57Dda8NgDvLSXebmqzzt3Xd4vWAl2z9AtLcHbTOM9O+5xUMV26QfuytITEkSlAOELBOkFUXYEV7343Q8Y/njJ6zvIvSMb9Nh2WNkVMbtDfDFu4YS+tbysKHpZ2Y3GnUqlarQNc6+uVX+t7kS2AMVgjvH7KUPWA1tMD07x6/9nOAnpfDU7DiKVboAAAAASUVORK5CYII=","width":1000,"height":1000,"src":"/static/634d60838678047c8b9f6f323a3a9be1/69a04/wannabe.png","srcSet":"/static/634d60838678047c8b9f6f323a3a9be1/69a04/wannabe.png 1x"}}}}}},"pageContext":{"slug":"/2018/12/18/why-kubernetes-at-small-scale/","previous":{"fields":{"slug":"/2018/12/10/prometheus-blackbox-exporter-lambda/"},"frontmatter":{"title":"Run Prometheus Blackbox Exporter as Lambda"}},"next":{"fields":{"slug":"/2019/05/10/k8s-on-openwrt/"},"frontmatter":{"title":"Running Kubernetes on OpenWrt"}}}}}