{"componentChunkName":"component---src-templates-blog-post-js","path":"/2017/12/15/production-grade-kubernetes/","result":{"data":{"site":{"siteMetadata":{"title":"5π Consulting","author":"Johannes 'fish' Ziemke"}},"markdownRemark":{"id":"a6d5a46d-a342-5ddf-8ce1-1206ba6f3d4d","html":"<p>About a year ago I blogged about how to build a <a href=\"/2016/11/20/15-producation-grade-kubernetes-cluster/\">$15 Production Kubernetes\nCluster on DigitalOcean</a>\nand submitted it to <a href=\"https://news.ycombinator.com/\">Hacker News</a>.</p>\n<p>HN being HN, soon after these comments trickled in:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 560px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/acfed1c5b7512a39140c4288b9d642b6/b06ae/hn-comment.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.245398773006134%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsklEQVR42l2P2wqDMBBE/f+P6kUbjAoVWgR9aqWkSTRmN16yeWxV6ENhGJgDy85E02TmeUDsrJXWSgCN2AHocTTew5+WxS6L/cVIiKfWLylX73uhVCtlK8QDQBE5IgzBeQ9ESORCGDdf+XpMhACKsWOes6oqi4Kl6blp7oydyjLLsiTPL2ka1/XteuWcx0ly4DxWqiXCaC+AqAEUgBoGaczbuW6PG9eIeif7NGPEPA/fzx94+dkZYT6CNgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"What people call production nowadays... - pst\"\n        title=\"\"\n        src=\"/static/acfed1c5b7512a39140c4288b9d642b6/b06ae/hn-comment.png\"\n        srcset=\"/static/acfed1c5b7512a39140c4288b9d642b6/222b7/hn-comment.png 163w,\n/static/acfed1c5b7512a39140c4288b9d642b6/ff46a/hn-comment.png 325w,\n/static/acfed1c5b7512a39140c4288b9d642b6/b06ae/hn-comment.png 560w\"\n        sizes=\"(max-width: 560px) 100vw, 560px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>.</p>\n<p>Fair enough. If you only need $15 worth of resources, running a three node\nKubernetes cluster might not be the best idea. As explained in that article, I\nwas more referring to the way it’s deployed:</p>\n<ul>\n<li>Highly available: Clustered etcd, multiple master/controller instances</li>\n<li>Secure: TLS for etcd clients and peers and apiserver+kubelet</li>\n</ul>\n<p>Personally I built it mainly to have a Kubernetes playground. But in the\nmeanwhile I founded <a href=\"https://latency.at\">Latency.at</a>. It’s a service to measures\nperformance and availability of sites and services from multiple global\nlocations and provides the results as Prometheus metrics. And of course it’s\nrunning on Kubernetes, so I didn’t have the need for a playground and migrated\nthis blog to <a href=\"https://github.com/gatsbyjs/gatsby\">Gatsby.js</a>.</p>\n<p>I’m also <a href=\"/hire-me/\">consulting</a> people on, among other things, how to build\nproduction grade Kubernetes infrastructure. For this I looked into various way\nto deploy Kubernetes today. There are <em>many</em> and most claimed to be “production\ngrade”:</p>\n<ul>\n<li><a href=\"https://github.com/kubernetes/kops\">https://github.com/kubernetes/kops</a></li>\n<li><a href=\"https://github.com/coreos/tectonic-installer\">https://github.com/coreos/tectonic-installer</a></li>\n<li><a href=\"https://github.com/aws-quickstart/quickstart-heptio\">https://github.com/aws-quickstart/quickstart-heptio</a></li>\n<li><a href=\"https://github.com/kubernetes-incubator/kube-aws\">https://github.com/kubernetes-incubator/kube-aws</a></li>\n<li><a href=\"https://github.com/kubernetes-incubator/kubespray\">https://github.com/kubernetes-incubator/kubespray</a></li>\n<li><a href=\"https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/\">https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/</a></li>\n</ul>\n<h3 id=\"highly-available\" style=\"position:relative;\"><a href=\"#highly-available\" aria-label=\"highly available permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Highly available?</h3>\n<p>In my book, having a highly available cluster is a strict requirement for\nproduction deployments. You might have specialized use case where this isn’t\nnecessary but if you run realtime, business critical applications this is a\nrequirement.</p>\n<p>While an outage of the controller components won’t affect running applications,\nyou can’t operate the cluster anymore: If your ingress controller gets restarted\nduring that time, it won’t know about your backends. If an important pod dies,\nnobody will restart it.</p>\n<p>This requirement already rules out one of the most popular options:\n<a href=\"https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/\">kubeadm</a>.\nAt least it doesn’t claim to be stable yet and everything except this looks very\npromising.</p>\n<p>The same limitation applies to projects built upon kubeadm, like\n<a href=\"https://github.com/kris-nova/kubicorn\">kubicorn</a> and the <a href=\"https://github.com/aws-quickstart/quickstart-heptio\">hepio cloudformation\ntemplates</a>.</p>\n<h3 id=\"secure\" style=\"position:relative;\"><a href=\"#secure\" aria-label=\"secure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Secure?</h3>\n<p>A Kubernetes cluster can be “(in)secure” on multiple layers. First etcd should\nrequire peers and client certificates to be signed by a trusted CA. Next the\napiserver needs to verify that the certificate of the etcd endpoint it connects\nto is signed by a trusted CA, as well as certificates of clients connecting to\nthe apiserver. Now the kubelet connecting to the apiserver needs to validate\nthat certificate too.</p>\n<p>Beside the transport level security provided by TLS, Kubernetes supports RBAC to\nlimit the access pods in the cluster have to the Kubernetes API. This needs to\nbe enabled too.</p>\n<p>Again, in my option all these are production requirements. Keep in mind that\njust the ability to run a privileged container or mount a volume is enough to\ncompromise your infrastructure. This can be done on each of these layers with\ndifferent effort. Not require TLS on any connection should be consider missing\nno authentication at all.</p>\n<p>There are setups which don’t require etcd TLS but limit it’s reachability to\ncontroller nodes, then using tains to prevent “untrusted” containers to get\nscheduled on the masters. While this is better than nothing, it’s still a risk\nnot worth taking.</p>\n<p>Unfortunately none of the more light-weight options fulfill these requirements.\nFrankly, there are so many ‘installers’ out there, I can’t say this for sure but\nthe most popular options like kops are lacking. When running with calico\nnetworking, it even requires etcd to be writable from all nodes without\nauthentication. Other options like kubespray don’t support full TLS either. Not\neven the tectonic-installer, which in general looks very promising, supports TLS\nout the box by default.</p>\n<h3 id=\"self-sufficiency\" style=\"position:relative;\"><a href=\"#self-sufficiency\" aria-label=\"self sufficiency permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>(Self-)Sufficiency?</h3>\n<p>The most common Kubernetes setups are not self-sufficient but depend often on\nmultiple external Docker registries and components during runtime. Since usually\nthese are referred to by mutable tags, there is also no way to guarantee that\nnobody changes a dependency without you noticing.\nUnfortunately this is something rarely discussed and there isn’t any\nlight-weight tooling I came across helping with this.</p>\n<h3 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h3>\n<p>I can’t claim I looked into every Kubernetes installer project and ignored\ncomplex “enterprise” stacks like <a href=\"http://www.projectatomic.io\">Red Hat’s Atomic</a>\nor <a href=\"https://jujucharms.com/canonical-kubernetes/\">Canonical Kubernetes Juju</a> but\nI’m surprised how many different options there are, yet how few of them provide\nwhat I’m looking for: A simple, immutable, secure and available cluster.</p>\n<p>As of right now, the\n<a href=\"https://github.com/coreos/tectonic-installer\">tectonic-installer</a> looks like\nthe best option, especially if you need to deploy on bare metal or openstack.\nBut it’s a fast moving project and it could become a drag to keep up with\nupstream changes. Another thing leaving a bad taste is that the component for\nautomated updates is closed source and not available for free.</p>\n<p><a href=\"https://github.com/kubernetes/kubeadm/issues/261\">kubeadm works on HA</a> but I\nwouldn’t be surprised if it takes another year until this works reliably.\nFortunately you can build upon kubeadm to create secure and HA clusters. Since\nthis, to me, appears to be the best option, I implemented this based on\ncloudformation for AWS for one of my clients. Hopefully I can share the results\nas open source soon. For now you can find valuable hints on <a href=\"https://github.com/kubernetes/kubeadm/issues/546\">this GitHub\nissue</a>.</p>\n<p>But should you even run your own Kubernetes cluster? Probably not! Kubernetes is\na incredibly fast moving project. As a rule of thumb, I’d say operating a\nKubernetes cluster is a full time job. Don’t assume any of the installers will\nfree you from developing a deep understanding of Kubernetes’ internals. If you\noperate your own cluster, be prepared to read source code and fix bugs yourself.\nThis is especially true with all the managed solutions and <a href=\"https://cloud.google.com/kubernetes-engine/\">Google Kubernetes\nEngine</a> now being available for\nfree.</p>","frontmatter":{"title":"Production Grade Kubernetes","date":"December 15, 2017","image":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAACt0lEQVR42s1UW2saQRTe/9yH9JJLIRZMEROjmNISm2AjKZSUlBBMrBciaKvGS73r6mri6sa9jLszszu77iZFp81Tn/rSwnD4+M6N852ZYXQd/PVh/l2yaaqEqIYxe6QIUX+DGcYKdRnGDOOFJUTFWKExDM9zo1EfIRkhWdcBQoqqTjFWMF4AQlQA7gxjBoBgmqoo8izbIERtNn9grDDZbLpSKZRKuVwuw7KNQuFbLpfRNFEU+UzmqlYrFou5fD5bqRQ4riMIw0ajPJtNy+W8polMPp/NZq8SiVg+n0kmY91uI51OCsKw329fXJynUl8bjXI8flmpFFqt6nR622xWxuNBtVpcJN/csKI4EoSb0ai/rCfRKQC4m0yGPM8lk7FerzmZDBFSxmOuXi/bNioUshBKjGVphKimqUEoaZpIMVWIAknidR1YlmYYMwhlRREglGV5shAMY0XXwVLVX5JS5lF2aqmEdAWUNE2NoZuwLIiQPJ8j01x0sG2MsQKAQINopmVplgUJUW0bLecSGEmaaJrc6zXnc8yyDZ7nABDa7epg0D4+/qBp4mDQIUS1LDgcdjmuJUn87S3b77cCgR0mFHrr83lcrpd7e/5I5DAcDrndrnA4FAzuBoM+j8e9tvas06nxfD8Q2M5kUolEdH39+dHRgd+/zfh83pWVJycnH/3+7dPTT+Hw+9XVp6lUzO12bW292th4EYkc8ny/VisGAjudTtXrfe3xuDc3N3Z3vQzHtXq95tnZZwCEaPRLuZzb339zcPCu262zbL1U+h6LnSMkWxaMx6PJ5OX19bdUKpZOx0ulHOM4hmnChweTENVxyP292es1TRPatk4ItG18f090fXHJHYc4DrFt7DiG4xDLwgxCMsYKhJKuAwjlZRO0JBc8QjJ1Lb0S5SlASP7Dk3zc83/8GfwE7TMrZW2mtzwAAAAASUVORK5CYII=","width":560,"height":560,"src":"/static/acfed1c5b7512a39140c4288b9d642b6/830a0/hn-comment.png","srcSet":"/static/acfed1c5b7512a39140c4288b9d642b6/830a0/hn-comment.png 1x"}}}}}},"pageContext":{"slug":"/2017/12/15/production-grade-kubernetes/","previous":{"fields":{"slug":"/2017/11/09/use-prometheus-vector-matching-to-get-kubernetes-utilization-across-any-pod-label/"},"frontmatter":{"title":"Use Prometheus Vector Matching to get Kubernetes Utilization across any Pod Label"}},"next":{"fields":{"slug":"/impressum/"},"frontmatter":{"title":""}}}},"staticQueryHashes":[],"slicesMap":{}}