{"componentChunkName":"component---src-templates-blog-post-js","path":"/2019/05/10/k8s-on-openwrt/","result":{"data":{"site":{"siteMetadata":{"title":"5π Consulting","author":"Johannes 'fish' Ziemke"}},"markdownRemark":{"id":"49459945-cf40-59b8-a9bc-dd952bd96e62","html":"<h1 id=\"why\" style=\"position:relative;\"><a href=\"#why\" aria-label=\"why permalink\" class=\"anchor before\"></a>Why..</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/d2602/homeinfra.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.84662576687117%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABpvxphgoP/8QAGhAAAgMBAQAAAAAAAAAAAAAAAAECAxEEIf/aAAgBAQABBQJXtq2+MuffDTT/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAbEAABBAMAAAAAAAAAAAAAAAARAAECEiAhcf/aAAgBAQAGPwIVi3FTZx//xAAaEAADAQADAAAAAAAAAAAAAAAAAREhMVFh/9oACAEBAAE/IWhV+kHeYTZgkSUrRw9LP//aAAwDAQACAAMAAAAQlx//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPxBX/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8QR//EABoQAAIDAQEAAAAAAAAAAAAAAAERACFBMVH/2gAIAQEAAT8QCMdgMF5ewA3yEAYG9rYJGseQEON0215E8NT/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"&quot;Home Infrastructure&quot;\"\n        title=\"&quot;Home Infrastructure&quot;\"\n        src=\"/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/6aca1/homeinfra.jpg\"\n        srcset=\"/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/d2f63/homeinfra.jpg 163w,\n/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/c989d/homeinfra.jpg 325w,\n/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/6aca1/homeinfra.jpg 650w,\n/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/7c09c/homeinfra.jpg 975w,\n/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/01ab0/homeinfra.jpg 1300w,\n/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/d2602/homeinfra.jpg 4032w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<em>Me, better with clean software than clean hardware</em></p>\n<p>As you might know, I’m living in Berlin, Germany. Maybe you also know that <a href=\"https://www.npr.org/2019/01/03/678803790/berlin-is-a-tech-hub-so-why-are-germanys-internet-speeds-so-slow\">our\nInternet is\nslow</a>.\nBut I finally found a cable internet provider which is supposed to deliver up to\n400 MBit to my home. Unfortunately <a href=\"https://www.trustpilot.com/review/pyur.com\">their service seems to be really bad</a>.</p>\n<p>So instead of canceling my old DSL aka copper aka phone line based internet,\nI’m using both for redundancy reasons.</p>\n<p>To make use of both providers, I’d needed a new router.</p>\n<p>About 13 years ago I came across <a href=\"https://www.openwrt.org\">OpenWrt</a> and loved\nit. I’ve even made it my <a href=\"router.pdf\">final project as school (German)</a>. So I\nwanted to use it for this project again.</p>\n<p>As hardware I wanted something that has enough power to do VPN and NAT\noperations at line speed and has at least 3x 1GBit ports. After heaving heard\ngood things about “PC Engines” (thanks to <a href=\"https://twitter.com/zekjur\">Michael\nStapelberg</a> for the recommendation!), I’ve decided\nto buy a <a href=\"https://pcengines.ch/apu2d4.htm\">apu2d4</a> with 16GB mSATA SSD.\nUnfortunately there are no well supported and fast wifi chipsets, so I’ve\ndecided to use a Unifi AP for Wifi.</p>\n<p>Setting this up was a matter of minutes:</p>\n<ol>\n<li>Write openwrt <code class=\"language-text\">x86_64</code> image with <code class=\"language-text\">dd</code> to a USB drive</li>\n<li>Boot the apu2 from it</li>\n<li>Use <code class=\"language-text\">dd</code> to write USB drive to SSD</li>\n</ol>\n<p>That’s it. But now that I have this powerful router, I might as well run\n<a href=\"https://prometheus.io\">Prometheus</a> and other services not directly related to\nrouting on it. I could run these directly on OpenWrt but that would require packaging them as OpenWrt packages and requiring to build everything from source to be properly integrated with their buildroot. This, and for all other reasons containers are great I want to run these things as container images.</p>\n<h1 id=\"custom-kernel\" style=\"position:relative;\"><a href=\"#custom-kernel\" aria-label=\"custom kernel permalink\" class=\"anchor before\"></a>Custom Kernel</h1>\n<p>The default OpenWrt Kernel for <code class=\"language-text\">x86_64</code> doesn’t include the necessary features,\nso I had to build my own image. I’ve disabled some features I won’t use and\nenabled options for cgroups, namespaces, overlayfs and the required networking\noptions. You can find my config diff\n<a href=\"https://github.com/5pi-home/openwrt/blob/master/config\">here</a> (created by\n<code class=\"language-text\">./scripts/diffconfig.sh</code>). If you want to create your own image, you need the\nfollowing options:</p>\n<p><strong>For process and resource isolation:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">CONFIG_KERNEL_BLK_CGROUP=y\nCONFIG_KERNEL_CGROUPS=y\nCONFIG_KERNEL_CGROUP_CPUACCT=y\nCONFIG_KERNEL_CGROUP_DEVICE=y\nCONFIG_KERNEL_CGROUP_FREEZER=y\nCONFIG_KERNEL_CGROUP_PIDS=y\nCONFIG_KERNEL_CGROUP_SCHED=y\nCONFIG_KERNEL_CPUSETS=y\nCONFIG_KERNEL_DEVPTS_MULTIPLE_INSTANCES=y\nCONFIG_KERNEL_FAIR_GROUP_SCHED=y\nCONFIG_KERNEL_FREEZER=y\nCONFIG_KERNEL_IPC_NS=y\nCONFIG_KERNEL_KEYS=y\nCONFIG_KERNEL_LXC_MISC=y\nCONFIG_KERNEL_MEMCG=y\nCONFIG_KERNEL_NAMESPACES=y\nCONFIG_KERNEL_NETPRIO_CGROUP=y\nCONFIG_KERNEL_NET_CLS_CGROUP=y\nCONFIG_KERNEL_NET_NS=y\nCONFIG_KERNEL_PID_NS=y\nCONFIG_KERNEL_POSIX_MQUEUE=y\nCONFIG_KERNEL_PROC_PID_CPUSET=y\nCONFIG_KERNEL_RESOURCE_COUNTERS=y\nCONFIG_KERNEL_SECCOMP=y\nCONFIG_KERNEL_SECCOMP_FILTER=y\nCONFIG_KERNEL_USER_NS=y\nCONFIG_KERNEL_UTS_NS=y</code></pre></div>\n<p><strong>For networking:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">CONFIG_PACKAGE_ip-bridge=y\nCONFIG_PACKAGE_ip-full=y\nCONFIG_PACKAGE_ipset=y\nCONFIG_PACKAGE_iptables-mod-conntrack-extra=y\nCONFIG_PACKAGE_iptables-mod-extra=y\nCONFIG_PACKAGE_iptables-mod-ipopt=y\nCONFIG_PACKAGE_kmod-asn1-decoder=y\nCONFIG_PACKAGE_kmod-br-netfilter=y\nCONFIG_PACKAGE_kmod-ikconfig=y\nCONFIG_PACKAGE_kmod-ipt-conntrack-extra=y\nCONFIG_PACKAGE_kmod-ipt-extra=y\nCONFIG_PACKAGE_kmod-ipt-ipopt=y\nCONFIG_PACKAGE_kmod-ipt-ipset=y\nCONFIG_PACKAGE_kmod-ipt-raw=y\nCONFIG_PACKAGE_kmod-iptunnel=y\nCONFIG_PACKAGE_kmod-nf-conntrack-netlink=y\nCONFIG_PACKAGE_kmod-nf-ipvs=y\nCONFIG_PACKAGE_kmod-nfnetlink=y\nCONFIG_PACKAGE_kmod-nls-base=y\nCONFIG_PACKAGE_kmod-udptunnel4=y\nCONFIG_PACKAGE_kmod-udptunnel6=y\nCONFIG_PACKAGE_kmod-veth=y\nCONFIG_PACKAGE_kmod-vxlan=y\nCONFIG_PACKAGE_libnetfilter-conntrack=y\nCONFIG_PACKAGE_libnfnetlink=y</code></pre></div>\n<p>The required <code class=\"language-text\">overlayfs</code> module for the container engines storage driver should\nbe already enabled.</p>\n<h2 id=\"build-it-yourself\" style=\"position:relative;\"><a href=\"#build-it-yourself\" aria-label=\"build it yourself permalink\" class=\"anchor before\"></a>Build it yourself</h2>\n<p>To build your own image, start by cloning <code class=\"language-text\">git@github.com:openwrt/openwrt.git</code>\nand run <code class=\"language-text\">./scripts/feeds update -a</code> to include the package feeds.</p>\n<p>Then run <code class=\"language-text\">make menuconfig</code> to set your target hardware, exit again and run <code class=\"language-text\">make\ndefconfig</code>. That will set the default config for the target hardware.</p>\n<p>Now you can either run <code class=\"language-text\">make menuconfig</code> again and select the options from above\nmanually or just edit <code class=\"language-text\">.config</code> to paste the options from above.</p>\n<p>After that you should be able to build your image by running <code class=\"language-text\">make</code>.</p>\n<p>You should save the output of <code class=\"language-text\">./scripts/diffconfig.sh</code> somewhere so be able to\nrecreate your image in the future.</p>\n<p>Now it’s time to upgrade OpenWrt. I just <code class=\"language-text\">scp</code> the image to the router and use\n<a href=\"https://openwrt.org/docs/guide-user/installation/sysupgrade.cli\">sysupgrade</a> to\napply the new image.</p>\n<p>If you still have trouble starting docker you can run Docker’s <a href=\"https://github.com/moby/moby/blob/master/contrib/check-config.sh\">check-config.sh\nscript</a> to\nmake sure all necessary features are enabled. You’d need to install bash first\nand have <code class=\"language-text\">CONFIG_PACKAGE_kmod-ikconfig=y</code> enabled.</p>\n<h2 id=\"automate-it\" style=\"position:relative;\"><a href=\"#automate-it\" aria-label=\"automate it permalink\" class=\"anchor before\"></a>Automate it</h2>\n<p>There is nothing more frustrating than having such setup run for a few month,\nthen need to change something and realize there is no way to reproduce what you\ndid without starting all over. Many thing we learned when building resilient\ninfrastructure at scale can be applied at home too. Therefor <a href=\"https://github.com/5pi-home/openwrt\">I’ve codified the\nsetup and added it to CI</a>.\nAll I need to upgrade is bumping the version in the\n<a href=\"https://github.com/5pi-home/openwrt/blob/master/Dockerfile#L14\">Dockerfile</a> and\nwait for CircleCI to get a new OpenWrt image.</p>\n<h1 id=\"packaging\" style=\"position:relative;\"><a href=\"#packaging\" aria-label=\"packaging permalink\" class=\"anchor before\"></a>Packaging</h1>\n<h2 id=\"docker\" style=\"position:relative;\"><a href=\"#docker\" aria-label=\"docker permalink\" class=\"anchor before\"></a>Docker</h2>\n<p>Initially I thought, all I want is Docker. And while it’s possible to use just\nextract the official Docker binaries to /usr/bin and bring up Docker that way,\nusing proper packages for OpenWrt’s <code class=\"language-text\">opkg</code> package manager is a cleaner\nsolution. For that I’ve created\n<a href=\"https://github.com/discordianfish/docker-on-openwrt\">docker-on-openwrt</a> which\ncreates a <code class=\"language-text\">opkg</code> package for docker from the official Docker binaries and adds\nan init script and config to it. You can check it out and run <code class=\"language-text\">make</code> to build it\nyourself or one of use my\n<a href=\"https://github.com/discordianfish/docker-on-openwrt/releases\">releases</a>.</p>\n<h2 id=\"kubernetes-k3s\" style=\"position:relative;\"><a href=\"#kubernetes-k3s\" aria-label=\"kubernetes k3s permalink\" class=\"anchor before\"></a>Kubernetes (k3s)</h2>\n<p>But then <a href=\"https://k3s.io/\">k3s</a> was born. It’s lightweight Kubernetes which\nreplaces etcd3 by sqlite3 which trades high availability by easier operations.\nIt also includes containerd, so no need to install Docker.</p>\n<p>I already blogged about <a href=\"/2018/12/18/why-kubernetes-at-small-scale/\">why Kubernetes makes sense at small\nscale</a>, so this seems perfect!</p>\n<p>Similar to the Docker packages, I’ve created\n<a href=\"https://github.com/discordianfish/k3s-openwrt\">k3s-openwrt</a> which builds\nOpenWrt packages from k3s binaries. Again, feel free to use my\n<a href=\"https://github.com/discordianfish/k3s-openwrt/releases\">releases</a> if you don’t\nwant to build it yourself.</p>\n<p>Depending on your setup, you might need to configure your firewall properly to\nallow traffic from and to the pod network. In my case I’ve created a new\ninterface definition for the cni0 interface:</p>\n<p><strong>/etc/config/network</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">config interface &#39;k8s&#39;\n\toption proto &#39;none&#39;\n\toption ifname &#39;cni0&#39;</code></pre></div>\n<p>And a zone which allows input/output/forward traffic:\n<strong>/etc/config/firewall</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">config zone\n\toption name &#39;k8s&#39;\n\toption input &#39;ACCEPT&#39;\n\toption output &#39;ACCEPT&#39;\n\toption forward &#39;ACCEPT&#39;\n\toption network &#39;k8s&#39;</code></pre></div>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"></a>Summary</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0dfbce4d4f1b5751a08a7e3a269d237d/0d98f/grafana.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 85.2760736196319%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAACYklEQVQ4y01Ty27cMAz0dzTZ+CVZEvWiJMv2boqihwI9FijQ9DN66L3f3lG8TWMMDIoiqRE56upxLWuNKee1wnAhLkorbU5oQyFE7yPnwpw5NUROMSYfYjcIdenHp354eHz68HDB//HSn4D9hnPrPR4vQ6eUcS6SDfO8DKO4YxDTJLV2StthlH0vhkk2vAW0mLnTxnIEMwreblssxefkS/YxuLrGY+da477H5+d0XJlTSCmsa9h3Vkq3ZCJP5Cw5Ds7aZhBZYyw+711mn9gX9tE7Y1yLtC54L4TqlkWDM0g+XOanQYyTHEfRMDViINwPrwDPqfmHfh7aruyHqUMBuZAw9vNHtpbGUSJtnIWctAvB5yClRmk4WxfIxsrgBHuaRCelEsr8/mH/vLgvO2lFctHLaOxX53+Cqq0BHkIJpYmqNcntGbeiGbSnWaVofn0zV6ejMcnQJJUctH2x9N1qNptDphGzWpAR7e36KRMFbZDYYULojVQkxIKxGd0o4XD0BltCvu4ujTkEg4AZYYvRr2EdFjHmEHgcZgw8l9rKacepNP6LgfSUIjibHMi3XfLOc0s25Op2pFRwVGvVP6DVd4zze/8dp0hQHkpalAHOCZ3AEtwABPyvOM4nRqEwvDZnkGzNVNSiDRJwN0ghgKcPDEVgCYL4Y1nrjlfC9dDGdziWS44rpz0DseawssfjuZZ0Kx7+W4EHSNfMzOu6h9BeFYaKh0EMM7pa03rUzG7NoUDAJRTUgZF9znE7KlSN/r0BncOcpbdU2dUS15JWGMlv2W94HrHZNTkI+9hR0EEYQt6BxL9CjaX9jNZKfQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"grafana\"\n        title=\"grafana\"\n        src=\"/static/0dfbce4d4f1b5751a08a7e3a269d237d/a6d36/grafana.png\"\n        srcset=\"/static/0dfbce4d4f1b5751a08a7e3a269d237d/222b7/grafana.png 163w,\n/static/0dfbce4d4f1b5751a08a7e3a269d237d/ff46a/grafana.png 325w,\n/static/0dfbce4d4f1b5751a08a7e3a269d237d/a6d36/grafana.png 650w,\n/static/0dfbce4d4f1b5751a08a7e3a269d237d/e548f/grafana.png 975w,\n/static/0dfbce4d4f1b5751a08a7e3a269d237d/0d98f/grafana.png 1276w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\nAll this turned out to be very useful. It was never more fun to build things for\nmy home network. I’m running an ingress controller with the wildcard DNS record\n<code class=\"language-text\">*.d.42o.d</code> pointing to it, which means I can just create an ingress\n<code class=\"language-text\">foo.d.42o.de</code> for a new service without having to update DNS records.</p>\n<p>You might ask what services could I possibly be reasonable to run here. Here is\nwhat I managed to squeeze on this box:</p>\n<ul>\n<li>unifi-controller</li>\n<li>Prometheus, not only monitoring my systems but also temperature, humidity and\nair pressure using <a href=\"https://github.com/vonneudeck/mouldy\">mouldy</a></li>\n<li>Grafana for nice dashboards</li>\n<li>openhab2 to integrate 433Mhz RF sockets with Amazon Alexa</li>\n<li>Plex with sonarr, radarr and nzbget</li>\n</ul>\n<p>While I spend a few days getting the setup working, this works so reliable so\nfar, that it might actually pay off going forward.</p>\n<p>Next I’ve planned to switch all services to HTTPS because it’s about damn time\nto stop using HTTP event at home. Thanks to <a href=\"https://letsencrypt.org/\">let’s encrypt</a> and <a href=\"https://github.com/jetstack/cert-manager\">cert-manager</a> that should be feasible.</p>","frontmatter":{"title":"Running Kubernetes on OpenWrt","date":"May 10, 2019","image":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAAIDAAAAAAAAAAAAAAAAAAIDAQUG/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAaNhzcorBELgJ//EABsQAAEEAwAAAAAAAAAAAAAAAAIAAQMTERIg/9oACAEBAAEFAr2IRkCpMWFtz//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABwQAAEDBQAAAAAAAAAAAAAAAAEAAlEREjAxMv/aAAgBAQAGPwLgNpCtLhqcH//EABoQAAMAAwEAAAAAAAAAAAAAAAABERAhMUH/2gAIAQEAAT8heq8aC8rb4D6OFOxaNMef/9oADAMBAAIAAwAAABD3777/xAAYEQACAwAAAAAAAAAAAAAAAAABEBExQf/aAAgBAwEBPxCcRtf/xAAWEQADAAAAAAAAAAAAAAAAAAABIFH/2gAIAQIBAT8QNT//xAAdEAEBAQACAgMAAAAAAAAAAAABEQAhMUFxUYGh/9oACAEBAAE/EDIc70q8C/urGgng0efvjjFEPjXIzzivSqnx6ypUD24RDWEM97//2Q==","width":1200,"height":1200,"src":"/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/ebdd7/homeinfra.jpg","srcSet":"/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/ebdd7/homeinfra.jpg 1x,\n/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/b9876/homeinfra.jpg 1.5x,\n/static/f29a91b6451f3b7d2894b1bf8bb8e7b0/1dd11/homeinfra.jpg 2x"}}}}}},"pageContext":{"slug":"/2019/05/10/k8s-on-openwrt/","previous":{"fields":{"slug":"/2018/12/18/why-kubernetes-at-small-scale/"},"frontmatter":{"title":"Why Kubernetes at small scale?"}},"next":{"fields":{"slug":"/case-studies/styla/"},"frontmatter":{"title":"Styla: Content Experience Engine"}}}}}